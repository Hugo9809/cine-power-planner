# Schema Inventory

This inventory documents the persistent data shapes stored by Cine Power Planner.
Update it whenever storage logic changes so engineers, QA and documentation can
validate backups without inspecting code online.

## Top-level storage keys

| Key | Source module | Shape | Notes |
| --- | --- | --- | --- |
| `cameraPowerPlanner_devices` | `storage.js` (`loadDevices`) | Array of device objects `{ id, name, voltageFamily, wattDraw, notes, source }`. | Bundled catalog entries + user-added gear. |
| `cameraPowerPlanner_setups` | `storage.js` (`loadSetups`) | Array of rig setups `{ id, name, projectId, devices: [deviceId], accessories: [...] }`. | Drives runtime estimator tables. |
| `cameraPowerPlanner_sessionState` | `storage.js` (`loadSessionState`) | Object `{ selectedProjectId, selectedSetupId, lastVisitedView, theme, language }`. | Reset-safe; non-critical if missing. |
| `cameraPowerPlanner_feedback` | `storage.js` (`loadFeedback`) | Object keyed by ISO timestamp with `{ message, category }`. | Logged for rehearsal notes; exported in planner backup. |
| `cameraPowerPlanner_project` | `storage.js` (`loadProject`) | Object describing active project `{ id, name, notes, crew, requirements, scenarios }`. | Always cloned before mutation. |
| `cameraPowerPlanner_favorites` | `storage.js` (`loadFavorites`) | Array of device IDs and setup IDs pinned for quick access. |  |
| `cameraPowerPlanner_contacts` | `storage.js` (`loadContacts`) | Array of contact entries `{ id, name, role, phone, email, website, notes, createdAt, updatedAt, avatar? }`. | Sorted alphabetically; avatars must be data URIs. |
| `cameraPowerPlanner_ownGear` | `storage.js` (`loadOwnGear`) | Array of custom gear entries `{ id, name, mount, capacityWh, voltage, weight, notes, source }`. | Used by automatic gear rules. |
| `cameraPowerPlanner_userProfile` | `storage.js` (`loadUserProfile`) | Object `{ name, role, avatar, phone, email }`. | Avatar is a data URI. Empty values remove storage entry. |
| `cameraPowerPlanner_documentationTracker` | `storage.js` (`loadDocumentationTracker`) | Object `{ statusReports: [...], coverageMatrix: {...}, lastAudit: ISO }`. | Mirrors docs folder status; update when checklists change. |
| `cameraPowerPlanner_autoGearRules` | `storage.js` (`loadAutomaticGearRules`) | Object keyed by scenario ID with arrays of rule descriptors `{ id, deviceId, quantity, helper }`. | Generated by `modules/features/auto-gear-rules.js`. |
| `cameraPowerPlanner_autoGearBackups` | `storage.js` (`loadAutomaticGearBackups`) | Array of timestamped snapshots `{ createdAt, rules }`. | Populated before every rule change/import. |
| `cameraPowerPlanner_autoGearPresets` | `storage.js` (`loadAutomaticGearPresets`) | Object mapping preset IDs to scenario rule collections. | Imported/exported with project bundles. |
| `cameraPowerPlanner_autoGearMonitorDefaults` | `storage.js` (`loadAutomaticGearMonitorDefaults`) | Object storing preferred monitors `{ scenarioId: monitorId }`. | Keeps helper defaults deterministic. |
| `cameraPowerPlanner_schemaCache` | `storage.js` (`exportAllData`) | Stringified JSON cache of device schema records. | Maintained by `modules/core/device-schema.js`; exports capture the stored string verbatim. |
| `cameraPowerPlanner_customFonts` | `storage.js` (`readStoredCustomFonts`) | JSON string containing an array of `{ id, name, data }`. | Entries normalized through `normalizeCustomFontEntries`. |
| `cameraPowerPlanner_mountVoltages` | `storage.js` (`collectPreferenceSnapshot`) | JSON string (or legacy raw string) mapping mount names to `{ high, low }` numeric thresholds. | See `modules/core/mount-voltage.js` for defaults and validation. |
| `cameraPowerPlanner_cameraColors` | `storage.js` (`collectPreferenceSnapshot`) | JSON palette keyed by camera letters (`A`–`E`) with `#RRGGBB` values. | Managed by `getCameraLetterColorsSafeSession` in `app-session.js`. |
| `cameraPowerPlanner_temperatureUnit` | `storage.js` (`collectPreferenceSnapshot`) | String preference (normalized to `"celsius"`/`"fahrenheit"` when applied). | Normalized by `normalizeTemperatureUnitValue` in `app-session.js`. |
| `cameraPowerPlanner_focusScale` | `storage.js` (`collectPreferenceSnapshot`) | String token (resolved to `"metric"`/`"imperial"` during runtime). | Normalized via `normalizeFocusScale`/`normalizeFocusScaleValue` in `app-session.js`. |
| `cameraPowerPlanner_autoGearSeeded` | `storage.js` (`loadAutoGearSeedFlag`) | Boolean flag stored as `'1'` for seeded state. | Toggled by `saveAutoGearSeedFlag`. |
| `cameraPowerPlanner_autoGearActivePreset` | `storage.js` (`loadAutoGearActivePresetId`) | String preset ID. | Cleared when presets are removed. |
| `cameraPowerPlanner_autoGearAutoPreset` | `storage.js` (`loadAutoGearAutoPresetId`) | String preset ID automatically loaded on startup. | Maintains autosave slot, purging previous entry when overwritten. |
| `cameraPowerPlanner_autoGearShowBackups` | `storage.js` (`loadAutoGearBackupVisibility`) | Boolean flag stored as `'1'` when backups panel should be visible. | Managed by `saveAutoGearBackupVisibility`. |
| `cameraPowerPlanner_autoGearBackupRetention` | `storage.js` (`loadAutoGearBackupRetention`) | Number clamped between configured min/max. | `normalizeAutoGearBackupRetentionValue` coerces legacy payloads. |
| `cameraPowerPlanner_fullBackups` | `storage.js` (`loadFullBackupHistory`) | Array of `{ createdAt, fileName? }` entries. | Entries normalized by `normalizeFullBackupHistoryEntry`; legacy imports may provide `fullBackups`. |

### Preference snapshot fields

`collectPreferenceSnapshot()` exports a `preferences` object inside backups. In addition to basic toggles (dark mode, high contrast, etc.), several structured values require specific shapes:

- `mountVoltages`: Object keyed by supported mounts (V-Mount, Gold-Mount, B-Mount) with `{ high, low }` numbers, matching `normalizeMountVoltageSource` in `modules/core/mount-voltage.js`.
- `cameraColors`: Palette map (`A`–`E`) containing `#RRGGBB` strings as produced by `getCameraLetterColorsSafeSession` in `app-session.js`.
- `temperatureUnit`: String normalized to `"celsius"` or `"fahrenheit"` via `normalizeTemperatureUnitValue` in `app-session.js`.
- `focusScale`: String normalized to `"metric"` or `"imperial"` using `normalizeFocusScale` fallbacks in `app-session.js`.
- `showAutoBackups`: Boolean flag mirroring `autoGearShowBackups`; toggles visibility of automatic gear backups in the UI.
- `mountVoltages`, `cameraColors`, `temperatureUnit`, and `focusScale` accept legacy string payloads but are re-serialized following the helpers above during import.

## Planner backup structure

`planner-backup.json` contains:

```
{
  "version": "<semantic version>",
  "exportedAt": "<ISO timestamp>",
  "project": {...},
  "setups": [...],
  "devices": [...],
  "ownGear": [...],
  "favorites": [...],
  "contacts": [...],
  "autoGearRules": {...},
  "autoGearBackups": [...],
  "autoGearPresets": {...},
  "autoGearMonitorDefaults": {...},
  "autoGearSeeded": <boolean>,
  "autoGearActivePresetId": "<string>",
  "autoGearAutoPresetId": "<string>",
  "autoGearShowBackups": <boolean>,
  "autoGearBackupRetention": <number>,
  "session": {...},
  "feedback": {...},
  "userProfile": {...},
  "documentationTracker": {...},
  "preferences": {...},
  "customLogo": "<data URI>",
  "customFonts": [...],
  "schemaCache": "<stringified schema cache>",
  "fullBackupHistory": [...]
}
```

Legacy restore payloads may also include `fullBackups`; the importer maps that field through `normalizeFullBackupHistoryEntry` before persisting. All arrays/objects follow the shapes above. The backup also includes a checksum field inside the verification packet manifest, not in the JSON payload.

## Validation references

- `storage.js` defines `normalize*` helpers for each shape; review them when
  updating this inventory.
- `modules/helpers/schema/` contains JSON schema snippets reused by import
  validators.
- During restores, the runtime coerces unknown fields into safe defaults and
  logs discrepancies to the diagnostics timeline.

## Maintenance steps

1. Update this doc whenever new keys are added or structures change.
2. Sync the [Save, Share & Restore Reference](save-share-restore-reference.md)
   and [Documentation Coverage Matrix](documentation-coverage-matrix.md) after
   schema updates.
3. Store a copy of the updated schema inventory with the verification packet so
   offline audits can validate backups without code access.
