# Debugging Guide

> "It works on my machine" is not an acceptable status in a hybrid offline-first environment.

This guide explains how to debug the Cine Power Planner, specifically focusing on the complexity of its **Hybrid Architecture** (Vite + Legacy Globals) and **Offline-First** nature.

## 1. The Environment

The app runs in two simultaneous modes:
1.  **V2 Scope (Modern)**: ES Modules, `src/scripts/v2/`, bundled by Vite, strict mode.
2.  **Legacy Scope (Global)**: `window.cineModules`, `window.app`, `src/scripts/core/`.

### Identifying the Context
When looking at the DevTools Console:
*   **Vite/HMR logs** come from `client.ts` or `main.js`.
*   **Legacy logs** often come from `loader.js` or `app-core-*.js`.

To determine which "world" looks at what data:
*   **V2** reads from `view-manager.js` and mostly direct IDB access.
*   **Legacy** reads from `window.projectData`.

## 2. Debugging Data & Storage

Since we use the **Twin-Store Pattern** (IDB + Memory), data can desync.

### Console Cheatsheet
Run these in the browser console to inspect state:

```javascript
// 1. Check the Active Project in Memory (Legacy)
window.projectData

// 2. Check the V2 Session
cineModules.cineSession.getActiveProject()

// 3. Force a Save (Trigger persistence manager)
cineModules.cinePersistence.saveProject(window.projectData)

// 4. Inspect Storage Drivers
await cineModules.cineStorage.driver.getItems('projects')
```

### Common Storage Issues

**Issue:** "I reloaded and my changes are gone."
*   **Cause**: You likely wrote to `window.projectData` without triggering `app-events.js` or `persistence.js`.
*   **Fix**: Always verify `cineModules.cinePersistence.pendingSave` is true after an edit.

**Issue:** "Quota Exceeded."
*   **Cause**: Storing large images/blobs in IDB.
*   **Debug**: Run `navigator.storage.estimate()` in console.

## 3. Debugging Offline/Service Worker

The Service Worker (`sw.js`) is generated by `vite-plugin-pwa` (or custom script in legacy mode).

### forcing Updates
If the app acts "stale":
1.  Open DevTools > **Application** > **Service Workers**.
2.  Check **"Update on reload"**.
3.  Refresh the page.
OR
4.  Click **"Unregister"** to kill the SW entirely.

### Simulating Offline
**Do NOT** just unplug your wifi.
1.  DevTools > **Network**.
2.  Dropdown: **Offline**.
3.  Refresh.
*   *Verification*: The "Cloud" icon in the sidebar should turn red/slash.

## 4. Debugging The Hybrid Bridge

The `legacy-shim.js` is the most fragile part of the system. It reparents DOM nodes.

### "Ghost Elements"
*   **Symptom**: You click a button, but nothing happens, or querySelector returns null.
*   **Cause**: The element is still attached to the hidden `#legacy-app-container` instead of the V2 View.
*   **Debug**: Inspect Element. If it's inside `div#legacy-offscreen`, the reparenting failed.

## 5. Network & CSP

If you see `Refused to load script`:
*   Check `index.html` -> `<meta http-equiv="Content-Security-Policy">`.
*   We strictly block external scripts for security. If you added a CDN link, **remove it**. You must bundle the library.

## 6. Pink Mode (Theming)

If animations are missing:
1.  Check `window.cineModules.cinePinkMode`.
2.  Verify `src/assets/lottie` files exist.
3.  Run `npm run check:pink-mode-icons`.
