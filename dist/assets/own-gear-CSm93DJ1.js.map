{"version":3,"file":"own-gear-CSm93DJ1.js","sources":["../../src/scripts/modules/features/own-gear.js"],"sourcesContent":["/* global cineModuleBase */\n\n(function () {\n  function detectGlobalScope() {\n    if (typeof globalThis !== 'undefined') {\n      return globalThis;\n    }\n    if (typeof window !== 'undefined') {\n      return window;\n    }\n    if (typeof self !== 'undefined') {\n      return self;\n    }\n    if (typeof global !== 'undefined') {\n      return global;\n    }\n    return {};\n  }\n\n  const GLOBAL_SCOPE = detectGlobalScope();\n\n  const MODULE_BASE =\n    (typeof cineModuleBase === 'object' && cineModuleBase)\n    || (GLOBAL_SCOPE && typeof GLOBAL_SCOPE.cineModuleBase === 'object' ? GLOBAL_SCOPE.cineModuleBase : null);\n\n  const safeWarn = MODULE_BASE && typeof MODULE_BASE.safeWarn === 'function'\n    ? MODULE_BASE.safeWarn\n    : function fallbackWarn(message, error) {\n      if (typeof console === 'undefined' || !console || typeof console.warn !== 'function') {\n        return;\n      }\n      try {\n        if (typeof error === 'undefined') {\n          console.warn(message);\n        } else {\n          console.warn(message, error);\n        }\n      } catch (consoleError) {\n        void consoleError;\n      }\n    };\n\n  function dispatchOwnGearChanged(scope) {\n    const target = scope || GLOBAL_SCOPE;\n    if (!target || typeof target.document === 'undefined') {\n      return;\n    }\n    const { document } = target;\n    if (!document) {\n      return;\n    }\n    try {\n      if (typeof document.dispatchEvent === 'function' && typeof target.CustomEvent === 'function') {\n        document.dispatchEvent(new target.CustomEvent('own-gear-data-changed'));\n      }\n    } catch (error) {\n      safeWarn('cine.features.ownGear could not dispatch own gear change event.', error);\n    }\n  }\n\n  /**\n   * Generates a unique ID for an own-gear item.\n   * Uses crypto.randomUUID if available, otherwise falls back to a timestamp-based ID.\n   *\n   * @returns {string} A unique identifier string.\n   */\n  function generateOwnGearId() {\n    try {\n      if (typeof GLOBAL_SCOPE.crypto === 'object' && GLOBAL_SCOPE.crypto && typeof GLOBAL_SCOPE.crypto.randomUUID === 'function') {\n        return GLOBAL_SCOPE.crypto.randomUUID();\n      }\n    } catch (error) {\n      safeWarn('cine.features.ownGear could not use crypto.randomUUID.', error);\n    }\n    const timePart = Date.now().toString(36);\n    const randomPart = Math.floor(Math.random() * 1e8).toString(36);\n    return `own-${timePart}-${randomPart}`;\n  }\n\n  /**\n   * Normalizes an own-gear record to ensure it has a valid ID and name.\n   * Trims whitespace from string fields and converts quantity to string.\n   *\n   * @param {object} entry - The raw entry to normalize.\n   * @returns {object|null} The normalized entry, or null if invalid.\n   */\n  function normalizeOwnGearRecord(entry) {\n    // Normalisation keeps the stored own-gear data predictable. Rather than\n    // trusting arbitrary JSON we coerce strings and identifiers up front. This\n    // simplifies migrations and guarantees that backup snapshots always contain\n    // clean, serialisable values that can be restored without data loss.\n    if (!entry || typeof entry !== 'object') {\n      return null;\n    }\n    const rawName = typeof entry.name === 'string' ? entry.name.trim() : '';\n    if (!rawName) {\n      return null;\n    }\n    const normalized = {\n      id: typeof entry.id === 'string' && entry.id.trim() ? entry.id.trim() : generateOwnGearId(),\n      name: rawName,\n    };\n    if (typeof entry.quantity === 'string' && entry.quantity.trim()) {\n      normalized.quantity = entry.quantity.trim();\n    } else if (typeof entry.quantity === 'number' && Number.isFinite(entry.quantity)) {\n      normalized.quantity = String(entry.quantity);\n    }\n    if (typeof entry.notes === 'string' && entry.notes.trim()) {\n      normalized.notes = entry.notes.trim();\n    }\n    if (typeof entry.source === 'string' && entry.source.trim()) {\n      normalized.source = entry.source.trim();\n    }\n    return normalized;\n  }\n\n  /**\n   * Loads stored own-gear items from the global storage helper.\n   * Filters out duplicates and invalid entries.\n   *\n   * @returns {Array<object>} An array of normalized own-gear items.\n   */\n  function loadStoredOwnGearItems() {\n    // The storage helpers can be swapped during tests or legacy restore flows,\n    // so we probe the global helpers defensively. Returning an empty array on\n    // failure keeps the UI usable while ensuring we never accidentally throw\n    // away the original data.\n    if (typeof GLOBAL_SCOPE.loadOwnGear !== 'function') {\n      return [];\n    }\n    try {\n      const stored = GLOBAL_SCOPE.loadOwnGear();\n      if (!Array.isArray(stored)) {\n        return [];\n      }\n      const seenIds = new Set();\n      return stored\n        .map(normalizeOwnGearRecord)\n        .filter((item) => {\n          if (!item) {\n            return false;\n          }\n          if (seenIds.has(item.id)) {\n            return false;\n          }\n          seenIds.add(item.id);\n          return true;\n        });\n    } catch (error) {\n      safeWarn('cine.features.ownGear could not load own gear items.', error);\n      return [];\n    }\n  }\n\n  /**\n   * Persists a list of own-gear items to storage.\n   * Filters out invalid items and dispatches a change event.\n   *\n   * @param {Array<object>} items - The list of items to save.\n   * @returns {boolean} True if save was successful, false otherwise.\n   */\n  function persistOwnGearItems(items) {\n    // Persistence deliberately trims unknown properties so corrupted entries do\n    // not sneak into the autosave pipeline. Every successful write emits the\n    // change event used by autosave, backups and open windows to stay in sync.\n    if (typeof GLOBAL_SCOPE.saveOwnGear !== 'function') {\n      return false;\n    }\n    const payload = Array.isArray(items)\n      ? items\n        .filter((item) => item && typeof item === 'object')\n        .map((item) => {\n          const entry = {\n            id: item.id,\n            name: item.name,\n          };\n          if (item.quantity) {\n            entry.quantity = item.quantity;\n          }\n          if (item.notes) {\n            entry.notes = item.notes;\n          }\n          if (item.source) {\n            entry.source = item.source;\n          }\n          return entry;\n        })\n      : [];\n\n    try {\n      GLOBAL_SCOPE.saveOwnGear(payload);\n      dispatchOwnGearChanged(GLOBAL_SCOPE);\n      return true;\n    } catch (error) {\n      safeWarn('cine.features.ownGear could not persist own gear items.', error);\n      return false;\n    }\n  }\n\n  const moduleApi = Object.freeze({\n    generateOwnGearId,\n    normalizeOwnGearRecord,\n    loadStoredOwnGearItems,\n    persistOwnGearItems,\n  });\n\n  if (MODULE_BASE && typeof MODULE_BASE.registerOrQueueModule === 'function') {\n    try {\n      MODULE_BASE.registerOrQueueModule(\n        'cine.features.ownGear',\n        moduleApi,\n        {\n          category: 'features',\n          description: 'Shared helpers for personal gear persistence.',\n          replace: true,\n          connections: ['cineModuleBase', 'cineModuleGlobals', 'cinePersistence'],\n        },\n        (error) => safeWarn('Unable to register cine.features.ownGear module.', error),\n        GLOBAL_SCOPE,\n        MODULE_BASE.getModuleRegistry && MODULE_BASE.getModuleRegistry(GLOBAL_SCOPE),\n      );\n    } catch (error) {\n      safeWarn('cine.features.ownGear registration failed.', error);\n    }\n  }\n\n  if (MODULE_BASE && typeof MODULE_BASE.exposeGlobal === 'function') {\n    try {\n      MODULE_BASE.exposeGlobal('cineFeaturesOwnGear', moduleApi, GLOBAL_SCOPE, {\n        configurable: true,\n        enumerable: false,\n        writable: false,\n      });\n      return;\n    } catch (error) {\n      safeWarn('cine.features.ownGear could not expose global api.', error);\n    }\n  }\n\n  try {\n    GLOBAL_SCOPE.cineFeaturesOwnGear = moduleApi;\n  } catch (error) {\n    safeWarn('cine.features.ownGear could not assign global api.', error);\n  }\n\n  if (typeof module !== 'undefined' && module && module.exports) {\n    module.exports = moduleApi;\n  }\n})();\n"],"names":["require_own_gear_00a","__commonJSMin","exports","module","detectGlobalScope","GLOBAL_SCOPE","MODULE_BASE","safeWarn","message","error","dispatchOwnGearChanged","scope","target","document","generateOwnGearId","timePart","randomPart","normalizeOwnGearRecord","entry","rawName","normalized","loadStoredOwnGearItems","stored","seenIds","item","persistOwnGearItems","items","payload","moduleApi"],"mappings":"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"}