{"version":3,"mappings":"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","names":["global","isInitialized","isV2Enabled","V2_STORAGE_KEY","checkV2Enabled","params","urlEnabled","restoreThemeState","isDark","isPink","enableV2","legacyHeader","legacyMain","legacySidebar","menuOverlay","legacyLoader","legacyFooter","installBanner","offlineIndicator","notificationStack","v2Container","uiOnlyProvider","bindExitButton","hideV2Loader","showV2Loader","loader","disableV2","exitBtn","toggleV2","loadV2Assets","__vitePreload","n","viewManager","translations$1","legacyShim","projectDashboard","projectDetail","sidebarView","sidebar","rulesView","deviceLibraryView","avatarEditorModal","contactsView","settingsView","ownedGearView","helpData","helpService","helpView","backupsView","init","injectV2ToggleButton","settingsDialog","settingsContent","toggleSection","label","description","button","V2Bootstrap","VIEW_SELECTOR","ACTIVE_CLASS","DEFAULT_VIEW","VIEWS","currentView","currentParams","viewHistory","isV2Active","viewHandlers","registerView","viewName","handlers","getAppContainer","getAllViews","container","getViewElement","viewId","showView","viewConfig","viewElement","oldHandlers","e","view","updateHash","dispatchViewChange","updateDocumentTitle","newHandlers","goBack","previous","getCurrentView","getCurrentParams","hash","parseHash","config","match","handleHashChange","event","baseTitle","title","ViewManager","V2_REQUIRED_KEYS","verifyV2Translations","missing","key","isReady","translations","CRITICAL_IDS","ALL_CRITICAL_IDS","legacyContainer","syncEnabled","eventListeners","ensureLegacyContainer","shimToLegacyContainer","elementId","element","syncSelectValue","v2Id","legacyId","v2Element","legacyElement","dispatchNativeEvent","syncInputValue","syncToV2","eventType","options","triggerLegacyClick","loadProject","projectName","setupSelect","option","opt","nativeData","getProjectNames","saveProject","deleteProject","createProject","setupNameInput","cache","names","parts","setups","k","name","val","stored","data","setDeviceValue","deviceId","value","getDeviceValue","getDeviceSnapshot","snapshot","id","bindV2Select","handler","bindV2Input","listenLegacyChanges","cleanup","verifyLegacyIds","found","syncLegacyToNative","currentName","saveBtn","deleteBtn","projectToDelete","shareBtn","LegacyShim","GRID_CONTAINER_ID","VIEW_ID","STORAGE_KEY","TILE_COLORS","PROJECT_ICONS","currentFilter","_cachedProjectData","createDefaultDataProvider","v2Names","projectService","legacyNames","meta","project","projectData","metadata","getDataProvider","createUiOnlyDataProvider","escapeHtml","str","formatDate","dateStr","formatDateRange","rangeStr","_t","path","lang","root","resolve","obj","p","o","i","v","refreshProjectDataCache","provider","legacyData","getFilteredProjects","projects","getProjectMetadata","q","updateProjectMetadata","result","nextMetadata","createTileHtml","index","color","icon","escapedName","status","statusClass","statusKey","statusLabel","periodsHtml","range","fmt","createNewProjectTileHtml","createNoResultsHtml","query","renderProjectGrid","isInitial","_renderGridContent","main","createEmptyStateHtml","bindEmptyStateEvents","filteredProjects","clearBtn","searchInput","html","bindTileEvents","bindSearchEvents","tile","openProject","showContextMenu","btn","newProjectTile","showProjectDialog","closeContextMenu","menu","duplicateProject","archiveProject","rect","existing","createBtn","showCreateProjectDialog","updateProjectRevision","existingProject","isEditing","randomColorIndex","selectedColor","selectedIcon","existingMetadata","periods","pid","parseRange","type","start","end","d","periodCounter","PERIOD_TYPES","getColorVar","c","colorSwatchesHtml","iconOptionsHtml","buildPeriodsHtml","typeOptions","t","backdrop","input","errorEl","cancelBtn","closeBtn","periodsContainer","addPeriodBtn","colorTrigger","colorPopover","colorPreview","colorLabel","iconTrigger","iconPopover","swatch","s","iconPreview","updatePeriodData","periodId","field","period","typeInfo","removePeriod","renderPeriods","addPeriod","bindPeriodEvents","row","removeBtn","closeModal","handleCreate","existingNames","formatPeriod","prepDays","shootingDays","returnDays","renamed","REV_KEY","currentRev","createDashboardView","headerBtn","v2Main","ProjectDashboard","TABS","DEFAULT_TAB","currentProject","currentTab","switchTab","tabId","isActive","pane","renderV2Diagram","getCurrentTab","getProjectData","updateProjectStatus","statusUpdateError","didPersist","safeStorage","nameElement","statusSelect","updateStatusSelectStyle","statusSelectParent","newSelect","newStatus","getCurrentProject","createViewContainer","createDetailViewContent","renderCameraPackageTab","renderPowerSummaryTab","bindDetailViewEvents","reparentLegacyElements","tagName","wrapper","elementToMove","backBtn","printBtn","legacySaveBtn","openProjectRequirementsForm","v2Data","projectInfoForForm","mergedInfo","tab","headerReqsGearBtn","headerExportBtn","legacyExportBtn","headerOverviewBtn","legacyBtn","requirementsTabSaveBtn","collectedFormData","generatedHtml","gearHtmlSections","reqsContainer","kitContainer","gearTabGenerateBtn","downloadDiagramBtn","syntheticEvent","injectAddCustomButtons","context","dialog","css","style","selectElement","syncLegacyResultsToV2","map","legacyEl","v2El","setupPowerObserver","legacyResultContainer","handleViewChange","slugify","text","triggerLegacyAddCustom","translationKey","localizedLabel","slug","cardId","card","header","ProjectDetail","SIDEBAR_TEMPLATE","buildSidebar","app","template","mountSidebar","detectGlobalScope","GLOBAL_SCOPE","resolveModuleBase","scope","MODULE_BASE","safeWarn","message","error","ZERO_WIDTH_SPACES_PATTERN","SPACE_VARIANTS_PATTERN","COMBINING_MARKS_PATTERN","DASH_VARIANTS_PATTERN","APOSTROPHE_VARIANTS_PATTERN","QUOTE_VARIANTS_PATTERN","SLASH_VARIANTS_PATTERN","MULTIPLY_VARIANTS_PATTERN","DEGREE_VARIANTS_PATTERN","ELLIPSIS_PATTERN","TRADEMARK_PATTERN","GENERAL_PUNCTUATION_PATTERN","MEASUREMENT_DOUBLE_PRIME_VARIANTS_PATTERN","MEASUREMENT_SINGLE_PRIME_VARIANTS_PATTERN","MEASUREMENT_VALUE_PATTERN","MEASUREMENT_FOOT_WORD_PATTERN","MEASUREMENT_FOOT_PRIME_PATTERN","MEASUREMENT_INCH_WORD_PATTERN","MEASUREMENT_INCH_PRIME_PATTERN","cleanMeasurementValue","normalizeMeasurementUnits","normalized","cleaned","LIGATURE_ENTRIES","LIGATURE_PATTERNS","entry","normalizeSearchValue","ligatureIndex","pattern","moduleApi","V2_SEARCH_FLAG","MAX_RESULTS","EMPTY_SEARCH_ENTRIES","DEFAULT_CATEGORY_LABELS","normalizationApi","featureSearchNormalization","safeNormalize","tokenize","token","shouldEnableV2Search","enabled","resolveLegacyEntries","detail","display","keywords","buildDeviceEntries","catalog","results","pushEntry","categoryKey","categoryLabel","processCategory","subKey","subData","subLabel","fullLabel","buildSearchIndex","entries","addEntry","normalizedLabel","labelKey","normalizedKeywords","tokens","withMeta","devicesCatalog","getLegacyEntriesSnapshot","legacyEntries","createSearchIndexManager","buildIndex","getSnapshot","indexState","legacySnapshot","stale","nextSnapshot","referenceChanged","lengthChanged","resolveDefaultEntries","defaults","seen","entryKey","scoreEntry","queryTokens","score","matched","findMatches","normalizedQuery","a","b","ensureDropdown","dropdown","renderDropdown","list","optionId","contentDiv","labelSpan","detailSpan","getDropdownOptions","setActiveOption","bounded","optIndex","closeDropdown","openDropdown","dispatchV2SearchEvent","applySelection","queryValue","inputValue","legacyInput","resolveEntryFromOption","entryIndex","setupSearchEvents","indexManager","currentResults","hasCachedResults","handleIndexRefresh","updateResults","activeIndex","next","prev","activeElement","currentIndex","setupV2Search","inputId","SEARCH_CONTAINER_CLASS","SEARCH_INPUT_ID","DARK_MODE_KEY","PINK_MODE_KEY","FALLBACK_PINK_KEY","TEXT_TO_KEY_MAP","currentLang","initSidebar","injectSidebarHeader","injectTopControls","injectSearchInput","setupLegacySearchProxy","initThemes","initNavigationLogic","initMobileToggle","forceHelpCloseBinding","interceptLegacyHelp","legacySelect","updateSidebarTranslations","logo","controlsContainer","row1","injectLanguageSelector","injectThemeControls","injectHardRefresh","footer","keyEvent","searchContainer","nav","legacyDropdown","closeHelpModal","helpDialog","helpBtn","v1HelpNav","redirect","backupLink","autoRecover","navLinks","link","l","triggers","overlay","openSidebar","closeSidebar","select","newVal","el","originalText","applyStoredThemes","resolveThemeVariant","syncThemeVariantAttributes","body","variant","themeVariantSelect","darkBtn","toggleDarkMode","pinkBtn","togglePinkMode","updateDarkModeDisplay","updatePinkModeDisplay","newState","moon","sun","updateAppLogo","V2Sidebar","View","shortName","RulesView","rules","rulesCount","rule","idx","actionCount","conditionCount","count","importBtn","exportBtn","isNew","ruleIndex","currentRule","scenarioVal","r","close","tabs","contents","x","target","actionListEl","addItemBtn","newItemName","newItemQty","qty","updatedRule","selected","safeSelected","parent","items","item","CONTENT_CONTAINER_ID","LEGACY_CONTAINER_ID","isReparented","legacyVisibilityState","langSelect","dict","injectHeaderActions","viewSection","existingHeader","actionsContainer","reparentLegacyContent","placeholder","contentWrapper","formTile","listTile","child","tVal","applyV2Styles","attachActionListeners","triggerDeviceListPopulation","handleExportClick","handleImportClick","legacyImportBtn","resetBtn","handleResetClick","restoreLegacyContent","listContent","formContent","render","DeviceLibraryView","this","isOpen","modalElement","editState","onSaveCallback","onDeleteCallback","onCancelCallback","createModalHtml","hasExistingAvatar","initializeEditState","dataUrl","image","baseScale","parseDataUrlMimeType","updateEditMetrics","mimeEnd","clampOffsets","minX","minY","width","height","displayWidth","displayHeight","imageEl","exportCroppedResult","scale","cropSize","sourceX","sourceY","canvas","ctx","mime","handleZoomChange","prevWidth","prevHeight","centerX","centerY","ratioX","ratioY","targetCenterX","targetCenterY","handlePointerDown","viewport","handlePointerMove","deltaX","deltaY","handlePointerUp","handleKeyDown","step","moved","handleFileSelect","file","loadImageFile","handleDrop","handleDragOver","handleDragLeave","loadImageFromDataUrl","reader","controls","zoomInput","open","avatar","onSave","onDelete","onCancel","hasAvatar","fileInput","handleCancel","handleSave","handleDelete","AvatarEditorModal","downloadFile","content","fileName","blob","writable","err","url","USER_PROFILE_STORAGE_KEY","userProfile","profileSaveTimer","loadUserProfile","parsed","saveUserProfile","scheduleProfileSave","exportAllContacts","contactsModule","contacts","vcards","success","handleImportFile","msg","ContactsView","contentHtml","contact","initials","avatarHtml","roleOptions","phoneLink","emailLink","displayWebsite","websiteLink","addBtn","addBtnEmpty","importInput","nameInput","roleSelect","phoneInput","emailInput","avatarContainer","handleProfileInput","ev","contactId","module","filtered","existingModal","roles","avatarInput","avatarPreview","removeAvatarBtn","currentAvatar","avatarDropZone","handleAvatarFile","allContacts","updatedList","SETTINGS_MAP","SettingsView","legacyVersion","panels","targetId","legacyLogo","bindClick","v2Btn","diffBtn","modal","legBtn","rehearsalTrigger","rehearsalModal","closeRehearsalBtns","legacyClose","obsConfigs","observer","cfg","leg","v2","extraObsConfigs","extraObserver","legacyLogoPreview","v2LogoPreview","img","legacyDocList","v2DocList","clone","activeTab","targetPanel","v2Radios","legacyRadios","v2Radio","legRadio","browseBtn","legacyBrowse","proceedBtn","abortBtn","legProceed","legAbort","legacyTableBody","v2TableBody","legacyFilename","v2Filename","legacyProceedBtn","cells","metric","diff","newRow","v2Primary","v2Secondary","legPrimary","legSecondary","syncSelects","obs","legSummary","v2Summary","legList","v2List","li","v2Export","legExport","v2Notes","legNotes","OwnGearView","features","itemId","allItems","finalItem","v2HelpData","migratedTopics","V2_TOPICS","DEFAULT_HELP_ICON","HELP_ICON_KEYS","getTranslations","translate","resolveHelpIcon","iconKey","iconSet","normalizeV2Topic","topic","getCategorizedV2Topics","essentials","v2Topics","parseMarkdown","block","line","getV1Topics","localization","resolveKey","curr","texts","topicOrder","localizedTexts","localizedHelpTopics","availableKeys","localizedTopic","getAllSections","guideTopics","refTopics","getGroupedSections","TOC_ID","CONTENT_ID","SEARCH_ID","SEARCH_STATUS_ID","performSearch","getElement","formatSearchStatus","getIconMarkup","iconGlyph","className","iconMarkup","char","renderContent","tocInfo","service","grouped","categories","category","renderCategory","divider","emptyState","noResultsIcon","tocList","section","buildToc","tocContainer","ul","targetSection","updateActiveLink","initScrollSpy","callback","initSearch","updateTocHeaderVisibility","currentHeader","hasVisibleItems","liveRegion","term","sections","noResults","hasVisible","visibleCount","isVisible","listItem","div","statusTemplate","updateSearchLabels","enter","refresh","cineHelpView","formatTemplate","formatSnapshotLabel","filename","buildSafetySnapshotName","projectId","timestamp","createLoadingSpinner","spinner","createEmptyState","subtitle","titleEl","subtitleEl","createErrorState","createActionButton","onClick","ariaLabel","createSafetySnapshot","storageRepo","wrapped","snapshotName","dataVault","cineBackupsView","navItem","listContainer","snapshots","displayName","actions","restoreLabel","restoreAria","deleteLabel","deleteAria","confirmationMessage","unwrapMetadata","fallbackId","sanitizedMeta","reason"],"ignoreList":[],"sources":["../../src/scripts/v2/bootstrap.js","../../src/scripts/v2/view-manager.js","../../src/scripts/v2/translations.js","../../src/scripts/v2/legacy-shim.js","../../src/scripts/v2/project-dashboard.js","../../src/scripts/v2/project-detail.js","../../src/scripts/v2/views/sidebar-view.js","../../src/scripts/modules/features/feature-search-normalization.js","../../src/scripts/v2/search-module.js","../../src/scripts/v2/sidebar.js","../../src/scripts/v2/view.js","../../src/scripts/v2/views/rules-view.mjs","../../src/scripts/v2/views/device-library-view.js","../../src/scripts/v2/components/avatar-editor-modal.js","../../src/scripts/modules/helpers/download-manager.js","../../src/scripts/v2/views/contacts-view.js","../../src/scripts/v2/views/settings-view.js","../../src/scripts/v2/views/owned-gear-view.js","../../src/scripts/v2/help-data.js","../../src/scripts/v2/help-service.js","../../src/scripts/v2/views/help-view.js","../../src/scripts/v2/views/backups-view.js"],"sourcesContent":["/**\n * Cine Power Planner V2 - Bootstrap\n * ===================================\n * Entry point for V2 UI initialization.\n * \n * DEEP DIVE: The \"Hybrid Swap\" Strategy\n * \n * This module is responsible for the hot-swap between Legacy (V1) and Modern (V2) UIs.\n * It does NOT replace the entire page. Instead, it:\n * 1. Lazy-loads V2 CSS/JS assets (to keep initial bundle size low).\n * 2. Toggles the `v2-mode` class on `document.body`.\n * 3. Manually hides Legacy DOM elements (`#topBar`, `#sideMenu`).\n * 4. Initializes the React-like V2 View Manager.\n * \n * This strategy allows us to ship V2 incrementally without rewriting the V1 engine.\n */\n\n\n// Removed IIFE wrapper for ES Module conversion\n// (function (global) {\n//    'use strict';\n\n// Polyfill global for legacy code\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n\n// =====================\n// STATE\n// =====================\nlet isInitialized = false;\nlet isV2Enabled = false;\n\n// =====================\n// FEATURE FLAG\n// =====================\nconst V2_STORAGE_KEY = 'cine_use_v2_ui';\n\n/**\n * Check if V2 UI is enabled via feature flag\n */\nfunction checkV2Enabled() {\n    try {\n        // Check URL params first\n        const params = new URLSearchParams(window.location.search);\n        if (params.has('v2')) {\n            const urlEnabled = params.get('v2') === 'true';\n            localStorage.setItem(V2_STORAGE_KEY, urlEnabled.toString());\n            return urlEnabled;\n        }\n\n        return localStorage.getItem(V2_STORAGE_KEY) === 'true';\n    } catch (_e) {\n        void _e;\n        return false;\n    }\n}\n\n/**\n * Restore Theme State (Dark/Pink) immediately\n * \n * DEEP DIVE: Persistence Fix\n * When switching UIs, we risk losing the user's theme preference.\n * This function forces a re-read of localStorage to ensure the V2 UI\n * respects the existing specific Dark/Pink mode settings.\n */\nfunction restoreThemeState() {\n    const isDark = localStorage.getItem('darkMode') === 'true';\n    document.body.classList.toggle('dark-mode', isDark);\n\n    const isPink = localStorage.getItem('cameraPowerPlanner_pinkMode') === 'true' ||\n        localStorage.getItem('pinkMode') === 'true';\n    document.body.classList.toggle('pink-mode', isPink);\n}\n\n/**\n * Enable V2 UI\n */\nfunction enableV2() {\n    try {\n        localStorage.setItem(V2_STORAGE_KEY, 'true');\n        isV2Enabled = true;\n\n        // Activate V2 mode on body\n        document.body.classList.add('v2-mode');\n\n        // [Persistence Fix] Restore themes immediately\n        restoreThemeState();\n\n        // Hide legacy UI elements\n        const legacyHeader = document.getElementById('topBar');\n        const legacyMain = document.getElementById('mainContent');\n        const legacySidebar = document.getElementById('sideMenu');\n        const menuOverlay = document.getElementById('menuOverlay');\n\n        // [Fix] Hide Legacy Loader explicitly\n        const legacyLoader = document.getElementById('cineGlobalLoadingIndicator');\n        if (legacyLoader) legacyLoader.style.display = 'none';\n\n        if (legacyHeader) legacyHeader.style.display = 'none';\n        if (legacyMain) legacyMain.style.display = 'none';\n        if (legacySidebar) legacySidebar.style.display = 'none';\n        if (menuOverlay) menuOverlay.style.display = 'none';\n\n        // Hide footer\n        const legacyFooter = document.getElementById('siteFooter');\n        if (legacyFooter) legacyFooter.style.display = 'none';\n\n        // [Fix] Hide All Floating/Fixed Legacy Elements\n        const installBanner = document.getElementById('installPromptBanner');\n        const offlineIndicator = document.getElementById('offlineIndicator');\n        const notificationStack = document.getElementById('backupNotificationContainer');\n\n        if (installBanner) installBanner.style.display = 'none';\n        if (offlineIndicator) offlineIndicator.style.display = 'none';\n        if (notificationStack) notificationStack.style.display = 'none';\n\n        // Show V2 container\n        const v2Container = document.getElementById('v2-app');\n        if (v2Container) {\n            v2Container.style.display = '';\n            v2Container.setAttribute('aria-hidden', 'false');\n        }\n\n        // Initialize project detail FIRST (for view-change events)\n        // IMPORTANT: This must happen BEFORE cineViewManager.enableV2() because\n        // enableV2() dispatches v2:viewchange, and project-detail needs to have\n        // its listener attached to render the top bar correctly.\n        if (global.cineProjectDetail && typeof global.cineProjectDetail.init === 'function') {\n            global.cineProjectDetail.init();\n        }\n\n        // Initialize and render the project dashboard\n        if (global.cineProjectDashboard) {\n            if (typeof global.cineProjectDashboard.init === 'function') {\n                const uiOnlyProvider = typeof global.cineProjectDashboard.createUiOnlyDataProvider === 'function'\n                    ? global.cineProjectDashboard.createUiOnlyDataProvider()\n                    : null;\n                global.cineProjectDashboard.init({ dataProvider: uiOnlyProvider });\n            }\n            // renderProjectGrid handled by v2:viewchange event\n        }\n\n        // Initialize sidebar (search functionality)\n        if (global.cineV2Sidebar && typeof global.cineV2Sidebar.init === 'function') {\n            global.cineV2Sidebar.init();\n        }\n\n        // Initialize View Manager (this will dispatch v2:viewchange)\n        // IMPORTANT: Must happen LAST after all views are initialized so they can catch the event\n        if (global.cineViewManager && typeof global.cineViewManager.enableV2 === 'function') {\n            global.cineViewManager.enableV2();\n        }\n\n        // Bind Exit V2 button\n        bindExitButton();\n\n        // [Fix] Hide V2 Loader after successfully initializing\n        hideV2Loader();\n\n        console.log('[V2 Bootstrap] V2 UI enabled');\n        return true;\n    } catch (e) {\n        console.error('[V2 Bootstrap] Failed to enable V2:', e);\n        // If failed, make sure loader is gone so user sees error or backup\n        hideV2Loader();\n        return false;\n    }\n}\n\n/**\n * Show V2 Loader\n */\nfunction showV2Loader() {\n    let loader = document.getElementById('v2-loader');\n    if (!loader) {\n        loader = document.createElement('div');\n        loader.id = 'v2-loader';\n        loader.innerHTML = `\n                <div class=\"v2-loader-content\">\n                    <div class=\"v2-spinner\"></div>\n                    <div class=\"v2-loader-text\">Loading Cine Power Planner...</div>\n                </div>\n            `;\n        document.body.appendChild(loader);\n    }\n    loader.classList.add('visible');\n}\n\n/**\n * Hide V2 Loader\n */\nfunction hideV2Loader() {\n    const loader = document.getElementById('v2-loader');\n    if (loader) {\n        loader.classList.remove('visible');\n        setTimeout(() => {\n            if (loader.parentNode) loader.parentNode.removeChild(loader);\n        }, 500); // Wait for fade out\n    }\n}\n\n/**\n * Disable V2 UI\n */\nfunction disableV2() {\n    try {\n        localStorage.setItem(V2_STORAGE_KEY, 'false');\n        isV2Enabled = false;\n\n        // Remove V2 mode from body\n        document.body.classList.remove('v2-mode');\n\n        // Show legacy UI elements\n        const legacyHeader = document.getElementById('topBar');\n        const legacyMain = document.getElementById('mainContent');\n        const legacySidebar = document.getElementById('sideMenu');\n        const menuOverlay = document.getElementById('menuOverlay');\n        const legacyFooter = document.getElementById('siteFooter');\n\n        if (legacyHeader) legacyHeader.style.display = '';\n        if (legacyMain) legacyMain.style.display = '';\n        if (legacySidebar) legacySidebar.style.display = '';\n        if (menuOverlay) menuOverlay.style.display = '';\n        if (legacyFooter) legacyFooter.style.display = '';\n\n        // Hide V2 container\n        const v2Container = document.getElementById('v2-app');\n        if (v2Container) {\n            v2Container.style.display = 'none';\n            v2Container.setAttribute('aria-hidden', 'true');\n        }\n\n        // Disable View Manager\n        if (global.cineViewManager && typeof global.cineViewManager.disableV2 === 'function') {\n            global.cineViewManager.disableV2();\n        }\n\n        console.log('[V2 Bootstrap] V2 UI disabled');\n        return true;\n    } catch (e) {\n        console.error('[V2 Bootstrap] Failed to disable V2:', e);\n        return false;\n    }\n}\n\n/**\n * Bind the Exit V2 button in the sidebar\n */\nfunction bindExitButton() {\n    const exitBtn = document.getElementById('v2ExitBtn');\n    if (exitBtn && !exitBtn.dataset.bound) {\n        exitBtn.dataset.bound = 'true';\n        exitBtn.addEventListener('click', () => {\n            disableV2();\n            window.location.reload();\n        });\n    }\n}\n\n/**\n * Toggle V2 UI\n */\nfunction toggleV2() {\n    if (isV2Enabled) {\n        return disableV2();\n    } else {\n        return enableV2();\n    }\n}\n\n// =====================\n// LAZY LOADING\n// =====================\n\n\n\n\n\n/**\n * Load V2 assets (CSS and JS)\n */\n/**\n * Load V2 assets (CSS and JS)\n */\nasync function loadV2Assets() {\n    try {\n        console.log('[V2 Bootstrap] Loading V2 assets via Vite dynamic imports...');\n\n        // Load V2 CSS\n        // Vite injects styles when imported\n        await import('../../styles/v2/index.css');\n        await import('../../styles/v2/views/rules-view.css');\n        await import('../../styles/v2/views/contacts.css');\n        await import('../../styles/v2/views/settings.css');\n        await import('../../styles/v2/views/owned-gear.css');\n        console.log('[V2 Bootstrap] V2 CSS loaded');\n\n        // Load V2 JS modules\n        // We use specific relative paths for Vite to detect them\n        await import('./view-manager.js');\n        await import('./translations.js');\n        await import('./legacy-shim.js');\n\n        await import('../modules/features/auto-gear-rules.js');\n        await import('./project-dashboard.js');\n        await import('./project-detail.js'); // Also needed\n\n        await import('./views/sidebar-view.js');\n        await import('./sidebar.js');\n        await import('./views/rules-view.mjs');\n        await import('./views/device-library-view.js');\n\n        await import('../modules/features/contacts.js');\n        await import('../modules/features/own-gear.js');\n\n        await import('./components/avatar-editor-modal.js');\n        await import('./views/contacts-view.js');\n        await import('./views/settings-view.js');\n        await import('./views/owned-gear-view.js');\n        await import('./help-data.js');\n        await import('./help-service.js');\n        await import('./views/help-view.js');\n        await import('./views/backups-view.js');\n\n        // Initialize Backups View\n        if (window.cineBackupsView && typeof window.cineBackupsView.init === 'function') {\n            window.cineBackupsView.init();\n        }\n\n        console.log('[V2 Bootstrap] V2 JS modules loaded');\n\n        // Initialize components (checking globals that should be set by modules)\n        // Note: In a pure module system, we would return the exports, \n        // but we kept the global assignments in the modules for backward compatibility.\n\n        // Initialize Sidebar Shell + Logic\n        if (global.cineV2SidebarView && typeof global.cineV2SidebarView.mount === 'function') {\n            global.cineV2SidebarView.mount();\n        }\n        if (global.cineV2Sidebar && typeof global.cineV2Sidebar.init === 'function') {\n            global.cineV2Sidebar.init();\n        }\n\n        // Initialize Rules View\n        if (global.cineRulesView && typeof global.cineRulesView.init === 'function') {\n            global.cineRulesView.init();\n        }\n\n        // Initialize Device Library View\n        if (global.cineV2DeviceLibrary && typeof global.cineV2DeviceLibrary.init === 'function') {\n            global.cineV2DeviceLibrary.init();\n        }\n\n        // Initialize Contacts View\n        if (global.cineContactsView && typeof global.cineContactsView.init === 'function') {\n            global.cineContactsView.init();\n        }\n\n        // Initialize Settings View\n        if (global.cineSettingsView && typeof global.cineSettingsView.init === 'function') {\n            global.cineSettingsView.init();\n        }\n\n        // Initialize Owned Gear View\n        if (global.cineOwnGearView && typeof global.cineOwnGearView.init === 'function') {\n            global.cineOwnGearView.init();\n        }\n\n        // Initialize Help View\n        if (global.cineHelpView && typeof global.cineHelpView.init === 'function') {\n            global.cineHelpView.init();\n        }\n\n        return true;\n    } catch (e) {\n        console.error('[V2 Bootstrap] Failed to load V2 assets:', e);\n        return false;\n    }\n}\n\n\n// =====================\n// INITIALIZATION\n// =====================\n\n/**\n * Initialize V2 Bootstrap\n */\nasync function init() {\n    if (isInitialized) {\n        console.warn('[V2 Bootstrap] Already initialized');\n        return;\n    }\n\n    isInitialized = true;\n    isV2Enabled = checkV2Enabled();\n\n    console.log(`[V2 Bootstrap] Starting. V2 enabled: ${isV2Enabled}`);\n\n    // Only load V2 assets if V2 is enabled OR if we're in development\n    if (isV2Enabled) {\n        showV2Loader(); // [New] Show immediately\n        const loaded = await loadV2Assets();\n        if (loaded) {\n            enableV2(); // this eventually hides it\n        } else {\n            hideV2Loader(); // Fallback\n        }\n    }\n\n    // Add \"Try New UI\" button to settings (if not already present)\n    injectV2ToggleButton();\n\n    console.log('[V2 Bootstrap] Initialization complete');\n}\n\n/**\n * Inject a toggle button into the settings dialog\n */\nfunction injectV2ToggleButton() {\n    // Check if button already exists\n    if (document.getElementById('v2ToggleBtn')) {\n        return;\n    }\n\n    // Find the settings dialog\n    const settingsDialog = document.getElementById('settingsDialog');\n    if (!settingsDialog) {\n        return;\n    }\n\n    // Find a place to add the button (e.g., settings content area)\n    const settingsContent = settingsDialog.querySelector('.modal-content, .settings-content, .modal-surface');\n    if (!settingsContent) {\n        return;\n    }\n\n    // Create the toggle section\n    const toggleSection = document.createElement('div');\n    toggleSection.className = 'settings-row v2-toggle-section';\n    toggleSection.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd;';\n\n    const label = document.createElement('label');\n    label.textContent = 'Experimental UI';\n    label.style.cssText = 'font-weight: 600; display: block; margin-bottom: 8px;';\n\n    const description = document.createElement('p');\n    description.textContent = 'Try the new V2 interface design. This is experimental and can be toggled off at any time.';\n    description.style.cssText = 'font-size: 0.875rem; color: #666; margin-bottom: 12px;';\n\n    const button = document.createElement('button');\n    button.id = 'v2ToggleBtn';\n    button.type = 'button';\n    button.className = 'v2-btn v2-btn-secondary';\n    button.style.cssText = 'padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #4a90d9; color: white; border: none;';\n    button.textContent = isV2Enabled ? 'Return to Classic UI' : 'Try New UI';\n\n    button.addEventListener('click', () => {\n        toggleV2();\n        button.textContent = isV2Enabled ? 'Return to Classic UI' : 'Try New UI';\n        // Reload to apply changes\n        window.location.reload();\n    });\n\n    toggleSection.appendChild(label);\n    toggleSection.appendChild(description);\n    toggleSection.appendChild(button);\n    settingsContent.appendChild(toggleSection);\n}\n\n// =====================\n// EXPORTS\n// =====================\nexport const V2Bootstrap = {\n    init,\n    enableV2,\n    disableV2,\n    toggleV2,\n    isV2Enabled: () => isV2Enabled,\n    loadV2Assets\n};\n\n// Expose to global scope for legacy compatibility\nif (typeof globalThis !== 'undefined') {\n    globalThis.cineV2Bootstrap = V2Bootstrap;\n} else if (typeof window !== 'undefined') {\n    window.cineV2Bootstrap = V2Bootstrap;\n}\n\n// Auto-initialize\n// Auto-initialize\n// if (typeof document !== 'undefined') {\n//     if (document.readyState === 'loading') {\n//         document.addEventListener('DOMContentLoaded', init);\n//     } else {\n//         // Delay slightly to let other scripts load first\n//         setTimeout(init, 100);\n//     }\n// }\n","/**\n * Cine Power Planner V2 - View Manager\n * =====================================\n * Manages SPA-style view switching and URL hash routing.\n * \n * Core responsibilities:\n * 1. Toggle visibility of .app-view sections\n * 2. Manage URL hash routing (#projects, #project/:id, etc.)\n * 3. Dispatch custom events for view changes\n * 4. Handle browser back/forward navigation\n */\n\n\n// Polyfill global for legacy code inside this module\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n\n// =====================\n// CONFIGURATION\n// =====================\nconst VIEW_SELECTOR = '.app-view';\nconst ACTIVE_CLASS = 'active';\nconst DEFAULT_VIEW = 'projects';\n\n// View definitions\nconst VIEWS = {\n    projects: {\n        id: 'view-projects',\n        title: 'Projects',\n        pattern: /^#?\\/?projects?\\/?$/i\n    },\n    projectDetail: {\n        id: 'view-project-detail',\n        title: 'Project',\n        pattern: /^#?\\/?project\\/([^/]+)(\\/([a-z]+))?\\/?$/i\n    },\n    settings: {\n        id: 'view-settings',\n        title: 'Settings',\n        pattern: /^#?\\/?settings?\\/?$/i\n    },\n    contacts: {\n        id: 'view-contacts',\n        title: 'Contacts',\n        pattern: /^#?\\/?contacts?\\/?$/i\n    },\n    devices: {\n        id: 'view-devices',\n        title: 'Device Library',\n        pattern: /^#?\\/?devices?\\/?$/i\n    },\n    help: {\n        id: 'view-help',\n        title: 'Help',\n        pattern: /^#?\\/?help\\/?$/i\n    },\n    rules: {\n        id: 'view-rules',\n        title: 'Auto Gear Rules',\n        pattern: /^#?\\/?rules\\/?$/i\n    },\n    ownGear: {\n        id: 'view-own-gear',\n        title: 'Owned Gear',\n        pattern: /^#?\\/?own-gear\\/?$/i\n    },\n    backups: {\n        id: 'view-backups',\n        title: 'Cloud Backups',\n        pattern: /^#?\\/?backups\\/?$/i\n    }\n};\n\n// =====================\n// STATE\n// =====================\nlet currentView = null;\nlet currentParams = {};\nlet viewHistory = [];\nlet isV2Active = false;\nconst viewHandlers = {};\n\n/**\n * Register lifecycle handlers for a view\n * @param {string} viewName - The name of the view (must match VIEWS keys)\n * @param {object} handlers - Object containing onEnter/onLeave methods\n */\nfunction registerView(viewName, handlers) {\n    if (!VIEWS[viewName]) {\n        console.warn(`[ViewManager] Cannot register handlers for unknown view: ${viewName}`);\n        return;\n    }\n    viewHandlers[viewName] = handlers;\n}\n\n// =====================\n// DOM HELPERS\n// =====================\n\n/**\n * Get the main V2 app container\n */\nfunction getAppContainer() {\n    return document.querySelector('.v2-app') || document.getElementById('v2-app');\n}\n\n/**\n * Get all view elements\n */\nfunction getAllViews() {\n    const container = getAppContainer();\n    if (!container) return [];\n    return Array.from(container.querySelectorAll(VIEW_SELECTOR));\n}\n\n/**\n * Get a specific view element by ID\n */\nfunction getViewElement(viewId) {\n    return document.getElementById(viewId);\n}\n\n// =====================\n// VIEW SWITCHING\n// =====================\n\n/**\n * Show a specific view and hide all others\n *\n * DEEP DIVE: View Switching Architecture\n *\n * This is the core routing method of the V2 SPA (Single Page Application) layer.\n * Unlike the legacy tabular UI, V2 views are distinct screen states managed via the DOM.\n *\n * Lifecycle:\n * 1. VALIDATION: Ensures the requested view ID exists in the DOM.\n * 2. UNMOUNT (Visual): Removes the 'active' class from ALL views.\n * 3. MOUNT (Visual): Adds the 'active' class to the target view.\n * 4. HISTORY: Pushes the previous state to `viewHistory` stack for back navigation.\n * 5. URL SYNC: Updates the URL fragment (e.g. #/projects) without triggering a reload.\n * 6. EVENT BUS: Dispatches `v2:viewchange` to notify components (Sidebar, Dashboard) to react.\n *\n * @param {string} viewName - The name of the view to show (e.g., 'projects', 'projectDetail')\n * @param {object} params - Optional parameters (e.g., { projectId: 'my-project', tab: 'power' })\n * @returns {boolean} - Whether the view switch was successful\n */\nfunction showView(viewName, params = {}) {\n    const viewConfig = VIEWS[viewName];\n    if (!viewConfig) {\n        console.warn(`[ViewManager] Unknown view: ${viewName}`);\n        return false;\n    }\n\n    const viewElement = getViewElement(viewConfig.id);\n    if (!viewElement) {\n        console.warn(`[ViewManager] View element not found: ${viewConfig.id}`);\n        return false;\n    }\n\n    // --- LIFECYCLE: onLeave previous ---\n    if (currentView && currentView !== viewName) {\n        const oldHandlers = viewHandlers[currentView];\n        if (oldHandlers && typeof oldHandlers.onLeave === 'function') {\n            try {\n                oldHandlers.onLeave();\n            } catch (e) {\n                console.error(`[ViewManager] Error in onLeave for ${currentView}:`, e);\n            }\n        }\n    }\n\n    // Hide all views\n    getAllViews().forEach(view => {\n        view.classList.remove(ACTIVE_CLASS);\n    });\n\n    // Show the target view\n    viewElement.classList.add(ACTIVE_CLASS);\n\n    // Store previous view for history\n    if (currentView && currentView !== viewName) {\n        viewHistory.push({ view: currentView, params: currentParams });\n    }\n\n    // Update state\n    currentView = viewName;\n    currentParams = params;\n\n    // Update URL hash (without triggering hashchange)\n    updateHash(viewName, params);\n\n    // Dispatch view change event\n    dispatchViewChange(viewName, params);\n\n    // Update document title\n    updateDocumentTitle(viewConfig.title, params);\n\n    // --- LIFECYCLE: onEnter new ---\n    const newHandlers = viewHandlers[viewName];\n    if (newHandlers && typeof newHandlers.onEnter === 'function') {\n        try {\n            newHandlers.onEnter(params);\n        } catch (e) {\n            console.error(`[ViewManager] Error in onEnter for ${viewName}:`, e);\n        }\n    }\n\n    return true;\n}\n\n/**\n * Navigate back to the previous view\n */\nfunction goBack() {\n    if (viewHistory.length > 0) {\n        const previous = viewHistory.pop();\n        showView(previous.view, previous.params);\n        return true;\n    }\n    // Default to projects view\n    showView(DEFAULT_VIEW);\n    return false;\n}\n\n/**\n * Get the current view name\n */\nfunction getCurrentView() {\n    return currentView;\n}\n\n/**\n * Get the current view parameters\n */\nfunction getCurrentParams() {\n    return { ...currentParams };\n}\n\n// =====================\n// URL HASH ROUTING\n// =====================\n\n/**\n * Update the URL hash to reflect the current view\n */\nfunction updateHash(viewName, params) {\n    let hash = '';\n\n    // Dynamic pattern matching for registered views\n\n\n    switch (viewName) {\n        case 'projects':\n            hash = '#/projects';\n            break;\n        case 'projectDetail':\n            hash = `#/project/${encodeURIComponent(params.projectId || 'new')}`;\n            if (params.tab) {\n                hash += `/${params.tab}`;\n            }\n            break;\n        case 'settings':\n            hash = '#/settings';\n            break;\n        case 'contacts':\n            hash = '#/contacts';\n            break;\n        case 'devices':\n            hash = '#/devices';\n            break;\n        case 'help':\n            hash = '#/help';\n            break;\n        case 'rules':\n            hash = '#/rules';\n            break;\n        case 'ownGear':\n            hash = '#/own-gear';\n            break;\n        default:\n            // Generic hash generation for standard views\n            if (VIEWS[viewName]) {\n                // Convert camelCase to kebab-case or just use viewName\n                // Simple fallback: #/viewName\n                // Adjust specifically for known ones if needed\n                if (viewName === 'ownGear') hash = '#/own-gear';\n                else hash = `#/${viewName}`;\n            } else {\n                hash = '#/projects';\n            }\n    }\n\n    // Update hash without triggering navigation\n    if (window.location.hash !== hash) {\n        history.replaceState(null, '', hash);\n    }\n}\n\n/**\n * Parse the current hash and navigate to the matching view\n */\nfunction parseHash() {\n    const hash = window.location.hash || '#/projects';\n\n    for (const [viewName, config] of Object.entries(VIEWS)) {\n        const match = hash.match(config.pattern);\n        if (match) {\n            const params = {};\n\n            // Extract parameters based on view type\n            if (viewName === 'projectDetail' && match[1]) {\n                params.projectId = decodeURIComponent(match[1]);\n                if (match[3]) {\n                    params.tab = match[3];\n                }\n            }\n\n            return { viewName, params };\n        }\n    }\n\n    // Default to projects view\n    return { viewName: DEFAULT_VIEW, params: {} };\n}\n\n/**\n * Handle hash change events (browser back/forward)\n *\n * This serves as the \"Router Listener\". It ensures that if a user manually changes the URL\n * or uses the browser's Back/Forward buttons, the View Manager reacts appropriately.\n * Ideally, `showView` updates the URL via `replaceState` so this function is primarily\n * for *external* navigation events.\n */\nfunction handleHashChange() {\n    const { viewName, params } = parseHash();\n    showView(viewName, params);\n}\n\n// =====================\n// EVENTS\n// =====================\n\n/**\n * Dispatch a custom view change event\n */\nfunction dispatchViewChange(viewName, params) {\n    const event = new CustomEvent('v2:viewchange', {\n        bubbles: true,\n        detail: {\n            view: viewName,\n            params: params,\n            previousView: viewHistory.length > 0 ? viewHistory[viewHistory.length - 1] : null\n        }\n    });\n    document.dispatchEvent(event);\n}\n\n/**\n * Update the document title based on the current view\n */\nfunction updateDocumentTitle(baseTitle, params) {\n    let title = baseTitle;\n\n    if (params.projectId && params.projectId !== 'new') {\n        title = `${params.projectId} - ${baseTitle}`;\n    }\n\n    document.title = `${title} | Cine Power Planner`;\n}\n\n// =====================\n// V2 UI TOGGLE\n// =====================\n\n/**\n * Check if V2 UI is enabled\n */\nfunction isV2Enabled() {\n    try {\n        return localStorage.getItem('cine_use_v2_ui') === 'true';\n    } catch (_e) {\n        void _e;\n        return false;\n    }\n}\n\n/**\n * Enable the V2 UI\n */\nfunction enableV2() {\n    try {\n        localStorage.setItem('cine_use_v2_ui', 'true');\n        isV2Active = true;\n        document.body.classList.add('v2-mode');\n\n        // Hide legacy UI\n        const legacyMain = document.getElementById('mainContent');\n        if (legacyMain) {\n            legacyMain.style.display = 'none';\n        }\n\n        // Show V2 container\n        const v2Container = getAppContainer();\n        if (v2Container) {\n            v2Container.style.display = '';\n        }\n\n        // Navigate to current hash\n        handleHashChange();\n\n        return true;\n    } catch (e) {\n        console.error('[ViewManager] Failed to enable V2 UI:', e);\n        return false;\n    }\n}\n\n/**\n * Disable the V2 UI and return to legacy\n */\nfunction disableV2() {\n    try {\n        localStorage.setItem('cine_use_v2_ui', 'false');\n        isV2Active = false;\n        document.body.classList.remove('v2-mode');\n\n        // Show legacy UI\n        const legacyMain = document.getElementById('mainContent');\n        if (legacyMain) {\n            legacyMain.style.display = '';\n        }\n\n        // Hide V2 container\n        const v2Container = getAppContainer();\n        if (v2Container) {\n            v2Container.style.display = 'none';\n        }\n\n        return true;\n    } catch (e) {\n        console.error('[ViewManager] Failed to disable V2 UI:', e);\n        return false;\n    }\n}\n\n/**\n * Toggle V2 UI on/off\n */\nfunction toggleV2() {\n    if (isV2Active) {\n        return disableV2();\n    } else {\n        return enableV2();\n    }\n}\n\n// =====================\n// INITIALIZATION\n// =====================\n\n/**\n * Initialize the view manager\n */\nfunction init() {\n    // Listen for hash changes\n    window.addEventListener('hashchange', handleHashChange);\n\n    // Check if V2 is enabled\n    // BUT do not auto-enable here if we want to wait for bootstrap.\n    // If bootstrap is controlling, it will call enableV2().\n    // If standard legacy load (where bootstrap might be missing or different), we might need it.\n    // However, since bootstrap.js is the one loading this file now (mostly),\n    // we should defer to it to avoid race conditions with view containers being created.\n\n    // If we are NOT in the bootstrap flow (e.g. standalone dev), we might want to check.\n    // But usually bootstrap defines itself before loading assets?\n    // Actually assets are loaded async.\n    // Let's safe: Just don't auto-enable. bootstrap will do it.\n    if (isV2Enabled() && !global.cineV2Bootstrap) {\n        // Fallback: If no bootstrap global found, maybe we want to try?\n        // But usually bootstrap defines itself before loading assets?\n        // Actually assets are loaded async.\n        // Let's safe: Just don't auto-enable. bootstrap will do it.\n    }\n\n    console.log('[ViewManager] Initialized');\n}\n\n// =====================\n// EXPORTS\n// =====================\nexport const ViewManager = {\n    // View navigation\n    showView,\n    goBack,\n    getCurrentView,\n    getCurrentParams,\n    registerView, // Exported\n\n    // Hash routing\n    parseHash,\n\n    // V2 toggle\n    isV2Enabled,\n    enableV2,\n    disableV2,\n    toggleV2,\n\n    // Initialization\n    init,\n\n    // Constants\n    VIEWS,\n    DEFAULT_VIEW\n};\n\n// Expose to global scope\nif (typeof globalThis !== 'undefined') {\n    globalThis.cineViewManager = ViewManager;\n} else if (typeof window !== 'undefined') {\n    window.cineViewManager = ViewManager;\n}\n\n// Auto-initialize when DOM is ready (if not controlled by bootstrap)\n// NOTE: In module system, we prefer explicit init, but for now keeping this logic\nif (typeof document !== 'undefined') {\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', init);\n    } else {\n        init();\n    }\n}\n\n","/**\n * V2 Translations Bridge\n * \n * This module ensures V2 UI views can access translations from the main locale files.\n * Previously, this file contained hardcoded English strings. Now it simply verifies\n * that the main translation system has loaded the V2 keys.\n * \n * The actual V2 translations are now in:\n * - src/scripts/translations/en.js\n * - src/scripts/translations/de.js\n * - src/scripts/translations/es.js\n * - src/scripts/translations/fr.js\n * - src/scripts/translations/it.js\n */\n\n// Polyfill global for legacy code\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n// V2 required keys - used to verify translations are loaded\nconst V2_REQUIRED_KEYS = [\n    'contactsViewTitle',\n    'rulesViewTitle',\n    'ownGearViewTitle',\n    'deviceLibraryTitle',\n    'buttonAddContact',\n    'buttonAddRule',\n    'buttonAddGearItem'\n];\n\n/**\n * Verify V2 translations are available\n * Returns true if all required V2 keys are present\n */\nfunction verifyV2Translations() {\n    if (!global.texts || !global.texts.en) {\n        console.warn('[V2 Translations] Main translation system not loaded');\n        return false;\n    }\n\n    const missing = V2_REQUIRED_KEYS.filter(key => !(key in global.texts.en));\n\n    if (missing.length > 0) {\n        console.warn('[V2 Translations] Missing keys:', missing);\n        return false;\n    }\n\n    console.log('[V2 Translations] All V2 keys verified');\n    return true;\n}\n\n// Run verification on load\nconst isReady = verifyV2Translations();\n\n// Export for testing\nexport { verifyV2Translations, V2_REQUIRED_KEYS, isReady };\nexport default { verifyV2Translations, isReady };\n","/**\n * Cine Power Planner V2 - Legacy Shim Layer\n * ==========================================\n * Bridges V2 UI components with legacy DOM elements and event handlers.\n * \n * Core responsibilities:\n * 1. Keep legacy IDs (setupSelect, cameraSelect, etc.) functional in the DOM\n * 2. Sync V2 UI state  hidden legacy elements\n * 3. Dispatch native events to trigger legacy handlers\n * 4. Ensure legacy scripts can still find their expected elements\n */\n\n// Removed IIFE wrapper for ES Module conversion\n// (function (global) {\n//    'use strict';\n\n// Polyfill global for legacy code\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n\n// =====================\n// CRITICAL LEGACY IDS\n// =====================\n// These IDs are required by legacy scripts and must remain in the DOM.\nconst CRITICAL_IDS = {\n    // Project Management\n    project: [\n        'setupSelect',       // Project dropdown\n        'setupName',         // Project name input\n        'saveSetupBtn',      // Save project button\n        'deleteSetupBtn'     // Delete project button\n    ],\n\n    // Device Selectors (Camera Package)\n    devices: [\n        'cameraSelect',      // Camera dropdown\n        'monitorSelect',     // Monitor dropdown\n        'videoSelect',       // Wireless transmitter dropdown\n        'motor1Select',      // FIZ motor 1\n        'motor2Select',      // FIZ motor 2\n        'motor3Select',      // FIZ motor 3\n        'motor4Select',      // FIZ motor 4\n        'controller1Select', // FIZ controller 1\n        'controller2Select', // FIZ controller 2\n        'controller3Select', // FIZ controller 3\n        'controller4Select', // FIZ controller 4\n        'distanceSelect',    // Distance sensor\n        'batteryPlateSelect',// Battery plate\n        'batterySelect',     // Battery\n        'batteryHotswapSelect' // Hotswap battery\n    ],\n\n    // Hidden (used by gear list, not shown in Camera Package UI)\n    hidden: [\n        'cageSelect'         // Cage select (for kit list only)\n    ],\n\n    // Power Summary\n    power: [\n        'heroCard',\n        'heroTotalDraw',\n        'heroAvailablePower',\n        'heroRuntime',\n        'heroCurrent144',\n        'heroCurrent12',\n        'heroBatteryCount',\n        'breakdownList',\n        'pinWarning',\n        'dtapWarning',\n        'hotswapWarning'\n    ],\n\n    // Outputs\n    outputs: [\n        'projectRequirementsOutput',\n        'gearListOutput',\n        'batteryTable',\n        'powerDiagram'\n    ]\n};\n\n// All critical IDs flattened\nconst ALL_CRITICAL_IDS = Object.values(CRITICAL_IDS).flat();\n\n// =====================\n// STATE\n// =====================\nlet legacyContainer = null;\nlet syncEnabled = true;\nlet eventListeners = new Map();\n\n// =====================\n// LEGACY CONTAINER\n// =====================\n\n/**\n * Ensure the legacy context container exists\n * This is a hidden container that holds legacy elements for scripts to access\n */\nfunction ensureLegacyContainer() {\n    if (legacyContainer) return legacyContainer;\n\n    legacyContainer = document.getElementById('v2-legacy-context');\n    if (!legacyContainer) {\n        legacyContainer = document.createElement('div');\n        legacyContainer.id = 'v2-legacy-context';\n        legacyContainer.setAttribute('aria-hidden', 'true');\n        legacyContainer.style.cssText = 'position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0, 0, 0, 0);';\n        document.body.appendChild(legacyContainer);\n    }\n\n    return legacyContainer;\n}\n\n/**\n * Move a legacy element to the hidden container (for elements not visible in V2)\n */\nfunction shimToLegacyContainer(elementId) {\n    const element = document.getElementById(elementId);\n    if (!element) {\n        console.warn(`[LegacyShim] Element not found: ${elementId}`);\n        return null;\n    }\n\n    const container = ensureLegacyContainer();\n    container.appendChild(element);\n\n    return element;\n}\n\n// =====================\n// VALUE SYNCING\n// =====================\n\n/**\n * Sync a V2 select element's value to its legacy counterpart\n * @param {string} v2Id - The V2 element ID (e.g., 'v2-camera-select')\n * @param {string} legacyId - The legacy element ID (e.g., 'cameraSelect')\n */\nfunction syncSelectValue(v2Id, legacyId) {\n    if (!syncEnabled) return;\n\n    const v2Element = document.getElementById(v2Id);\n    const legacyElement = document.getElementById(legacyId);\n\n    if (!v2Element || !legacyElement) {\n        return;\n    }\n\n    // Set the legacy element's value\n    legacyElement.value = v2Element.value;\n\n    // Dispatch change event to trigger legacy handlers\n    dispatchNativeEvent(legacyElement, 'change');\n}\n\n/**\n * Sync a V2 input element's value to its legacy counterpart\n */\nfunction syncInputValue(v2Id, legacyId) {\n    if (!syncEnabled) return;\n\n    const v2Element = document.getElementById(v2Id);\n    const legacyElement = document.getElementById(legacyId);\n\n    if (!v2Element || !legacyElement) {\n        return;\n    }\n\n    legacyElement.value = v2Element.value;\n    dispatchNativeEvent(legacyElement, 'input');\n}\n\n/**\n * Sync legacy value TO a V2 element (for loading projects)\n */\nfunction syncToV2(legacyId, v2Id) {\n    const legacyElement = document.getElementById(legacyId);\n    const v2Element = document.getElementById(v2Id);\n\n    if (!legacyElement || !v2Element) {\n        return;\n    }\n\n    // Temporarily disable sync to prevent loops\n    syncEnabled = false;\n    v2Element.value = legacyElement.value;\n    syncEnabled = true;\n}\n\n// =====================\n// EVENT DISPATCHING\n// =====================\n\n/**\n * Dispatch a native DOM event on an element\n * This ensures legacy event handlers are triggered properly\n */\nfunction dispatchNativeEvent(element, eventType, options = {}) {\n    if (!element) return;\n\n    const event = new Event(eventType, {\n        bubbles: true,\n        cancelable: true,\n        ...options\n    });\n\n    element.dispatchEvent(event);\n}\n\n/**\n * Trigger a legacy button click\n */\nfunction triggerLegacyClick(elementId) {\n    const element = document.getElementById(elementId);\n    if (!element) {\n        console.warn(`[LegacyShim] Cannot trigger click, element not found: ${elementId}`);\n        return false;\n    }\n\n    dispatchNativeEvent(element, 'click');\n    return true;\n}\n\n// =====================\n// PROJECT OPERATIONS\n// =====================\n\n/**\n * Load a project by setting setupSelect and dispatching change\n * @param {string} projectName - The project name to load\n */\n/**\n * Load a project by setting setupSelect and dispatching change\n * @param {string} projectName - The project name to load\n */\nasync function loadProject(projectName) {\n    const setupSelect = document.getElementById('setupSelect');\n    if (!setupSelect) {\n        console.error('[LegacyShim] setupSelect not found');\n        return false;\n    }\n\n    // Find the option with this value\n    let option = Array.from(setupSelect.options).find(opt => opt.value === projectName);\n\n    // [V2 Fix] Hydration from Native IDB\n    if (!option) {\n        let nativeData = null;\n        if (global.cineProjectService) {\n            try {\n                nativeData = await global.cineProjectService.getProject(projectName);\n            } catch (e) { console.warn('[LegacyShim] IDB lookup failed', e); }\n        }\n\n        if (nativeData) {\n            console.log(`[LegacyShim] Hydrating native project: ${projectName}`);\n            option = document.createElement('option');\n            option.value = projectName;\n            option.textContent = projectName;\n            setupSelect.appendChild(option);\n            setupSelect.value = projectName;\n\n            // Inject Data into Legacy App Form\n            if (typeof window.populateProjectForm === 'function') {\n                window.populateProjectForm(nativeData);\n            }\n            if (typeof window.updateCalculations === 'function') {\n                window.updateCalculations();\n            }\n            // Trigger change to update other watchers (though they might not find data in legacy 'setups')\n            // dispatchNativeEvent(setupSelect, 'change'); \n            // Better NOT to trigger change if we manually populated, as 'change' might clear form if setups[name] is missing.\n\n            return true;\n        }\n\n        // Fallback checks (Legacy)\n        const availableProjects = getProjectNames();\n        if (availableProjects.includes(projectName)) {\n            console.log(`[LegacyShim] Creating missing option for legacy project: ${projectName}`);\n            option = document.createElement('option');\n            option.value = projectName;\n            option.textContent = projectName;\n            setupSelect.appendChild(option);\n        } else {\n            console.warn(`[LegacyShim] Project not found in storage: ${projectName}`);\n            return false;\n        }\n    }\n\n    setupSelect.value = projectName;\n    dispatchNativeEvent(setupSelect, 'change');\n\n    return true;\n}\n\n/**\n * Save the current project\n */\nfunction saveProject() {\n    return triggerLegacyClick('saveSetupBtn');\n}\n\n/**\n * Delete the current project\n */\nfunction deleteProject() {\n    return triggerLegacyClick('deleteSetupBtn');\n}\n\n/**\n * Create a new project\n * @param {string} projectName - The name for the new project\n */\nfunction createProject(projectName) {\n    const setupSelect = document.getElementById('setupSelect');\n    const setupNameInput = document.getElementById('setupName');\n\n    if (!setupSelect || !setupNameInput) {\n        console.error('[LegacyShim] Project elements not found');\n        return false;\n    }\n\n    // Select \"New Project\" option (empty value)\n    setupSelect.value = '';\n    dispatchNativeEvent(setupSelect, 'change');\n\n    // Set the project name\n    setupNameInput.value = projectName;\n    dispatchNativeEvent(setupNameInput, 'input');\n\n    // Save the project\n    return saveProject();\n}\n\n/**\n * Get all saved project names\n * Uses a fallback chain to ensure data availability even during initialization\n */\nfunction getProjectNames() {\n    // Priority 0: Use global cineStorage cache (New Architecture)\n    if (global.cineStorage && typeof global.cineStorage.getProjectMemoryCache === 'function') {\n        try {\n            const cache = global.cineStorage.getProjectMemoryCache();\n            if (cache) {\n                const names = [];\n                Object.keys(cache).forEach(key => {\n                    // Check for sharded projects (user_..._cameraPowerPlanner_prj_NAME)\n                    if (key.includes('cameraPowerPlanner_prj_')) {\n                        const parts = key.split('cameraPowerPlanner_prj_');\n                        if (parts.length > 1 && parts[1]) {\n                            names.push(parts[1]);\n                        }\n                    }\n                    // Check for monolith (cameraPowerPlanner_setups)\n                    // Note: The cache might contain the monolith object itself as a value for that key\n                    // But LegacyShim expects Names.\n                    // If the cache key is 'cameraPowerPlanner_setups' (or scoped), the value is the object of setups.\n                    if (key.includes('cameraPowerPlanner_setups') && !key.includes('backup')) {\n                        const setups = cache[key];\n                        if (setups && typeof setups === 'object') {\n                            Object.keys(setups).forEach(k => {\n                                if (k && !k.startsWith('auto-backup-')) names.push(k);\n                            });\n                        }\n                    }\n                });\n                if (names.length > 0) return [...new Set(names)];\n            }\n        } catch (e) {\n            console.warn('[LegacyShim] cineStorage cache check failed:', e);\n        }\n    }\n\n    // Priority 1: Use getSetups() if available (most authoritative source)\n    if (typeof window.getSetups === 'function') {\n        try {\n            const setups = window.getSetups() || {};\n            const names = Object.keys(setups).filter(name => name && !name.startsWith('auto-backup-'));\n            if (names.length > 0) return names;\n        } catch (e) {\n            console.warn('[LegacyShim] getSetups failed:', e);\n        }\n    }\n\n    // Priority 2: Read from setupSelect (if populated)\n    const setupSelect = document.getElementById('setupSelect');\n    if (setupSelect && setupSelect.options.length > 1) {\n        const names = Array.from(setupSelect.options)\n            .map(opt => opt.value)\n            .filter(val => val !== ''); // Exclude \"New Project\" option\n        if (names.length > 0) return [...new Set(names)]; // Deduplicate\n    }\n\n    // Priority 3: Direct localStorage fallback for robustness\n    try {\n        const stored = localStorage.getItem('cameraPowerPlanner_setups');\n        if (stored) {\n            const data = JSON.parse(stored);\n            if (data && typeof data === 'object') {\n                return Object.keys(data).filter(name => name && !name.startsWith('auto-backup-'));\n            }\n        }\n    } catch (e) {\n        console.warn('[LegacyShim] localStorage fallback failed:', e);\n    }\n\n    return [];\n}\n\n// =====================\n// DEVICE SELECTION\n// =====================\n\n/**\n * Set a device selection value and trigger legacy update\n */\nfunction setDeviceValue(deviceId, value) {\n    const element = document.getElementById(deviceId);\n    if (!element) {\n        console.warn(`[LegacyShim] Device element not found: ${deviceId}`);\n        return false;\n    }\n\n    element.value = value;\n    dispatchNativeEvent(element, 'change');\n\n    return true;\n}\n\n/**\n * Get a device selection value\n */\nfunction getDeviceValue(deviceId) {\n    const element = document.getElementById(deviceId);\n    if (!element) return null;\n    return element.value;\n}\n\n/**\n * Get all current device selections\n */\nfunction getDeviceSnapshot() {\n    const snapshot = {};\n\n    CRITICAL_IDS.devices.forEach(id => {\n        const element = document.getElementById(id);\n        if (element) {\n            snapshot[id] = element.value;\n        }\n    });\n\n    return snapshot;\n}\n\n// =====================\n// V2 BINDING HELPERS\n// =====================\n\n/**\n * Bind a V2 select to its legacy counterpart\n * When V2 select changes, legacy select is updated\n */\nfunction bindV2Select(v2Id, legacyId) {\n    const v2Element = document.getElementById(v2Id);\n    if (!v2Element) return;\n\n    const handler = () => syncSelectValue(v2Id, legacyId);\n    v2Element.addEventListener('change', handler);\n\n    // Store for cleanup\n    eventListeners.set(`${v2Id}:change`, { element: v2Element, handler });\n}\n\n/**\n * Bind a V2 input to its legacy counterpart\n */\nfunction bindV2Input(v2Id, legacyId) {\n    const v2Element = document.getElementById(v2Id);\n    if (!v2Element) return;\n\n    const handler = () => syncInputValue(v2Id, legacyId);\n    v2Element.addEventListener('input', handler);\n\n    eventListeners.set(`${v2Id}:input`, { element: v2Element, handler });\n}\n\n/**\n * Listen for legacy element changes to update V2\n * Used when loading projects\n */\nfunction listenLegacyChanges(legacyId, v2Id) {\n    const legacyElement = document.getElementById(legacyId);\n    if (!legacyElement) return;\n\n    const handler = () => syncToV2(legacyId, v2Id);\n    legacyElement.addEventListener('change', handler);\n\n    eventListeners.set(`${legacyId}:legacy:change`, { element: legacyElement, handler });\n}\n\n// =====================\n// CLEANUP\n// =====================\n\n/**\n * Remove all event listeners\n */\nfunction cleanup() {\n    eventListeners.forEach(({ element, handler }, key) => {\n        const eventType = key.split(':')[1];\n        element.removeEventListener(eventType, handler);\n    });\n    eventListeners.clear();\n}\n\n// =====================\n// INITIALIZATION\n// =====================\n\n/**\n * Verify all critical IDs are present in the DOM\n */\nfunction verifyLegacyIds() {\n    const missing = [];\n    const found = [];\n\n    ALL_CRITICAL_IDS.forEach(id => {\n        if (document.getElementById(id)) {\n            found.push(id);\n        } else {\n            missing.push(id);\n        }\n    });\n\n    if (missing.length > 0) {\n        console.warn(`[LegacyShim] Missing critical IDs:`, missing);\n    }\n\n    return { found, missing };\n}\n\n/**\n * Reverse Sync: Legacy LocalStorage -> Native IDB\n */\nasync function syncLegacyToNative() {\n    if (!global.cineProjectService) return;\n\n    // Read from legacy storage\n    try {\n        const stored = localStorage.getItem('cameraPowerPlanner_setups');\n        if (!stored) return;\n\n        const setups = JSON.parse(stored);\n\n        // Get current selected project\n        const setupSelect = document.getElementById('setupSelect');\n        const currentName = setupSelect ? setupSelect.value : null;\n\n        if (currentName && setups[currentName]) {\n            console.log(`[LegacyShim] Reverse Sync: Saving ${currentName} to Native IDB`);\n            await global.cineProjectService.saveProject(currentName, setups[currentName]);\n        }\n    } catch (e) {\n        console.warn('[LegacyShim] Reverse Sync failed', e);\n    }\n}\n\n/**\n * Initialize the shim\n */\nfunction init() {\n    if (document.body && document.body.dataset && document.body.dataset.shimInitialized) return;\n    if (document.body) document.body.dataset.shimInitialized = 'true';\n\n    console.log('[LegacyShim] Initializing...');\n\n    const { missing } = verifyLegacyIds();\n    if (missing.length > 0) {\n        console.warn(`[LegacyShim] Missing elements:`, missing);\n    }\n\n    // Hook Legacy Save Button for Reverse Sync\n    const saveBtn = document.getElementById('saveSetupBtn');\n    if (saveBtn) {\n        console.log('[LegacyShim] Hooking Save Button for Reverse Sync');\n        saveBtn.addEventListener('click', () => {\n            // Wait for legacy save to complete (localStorage write)\n            setTimeout(() => syncLegacyToNative(), 200);\n        });\n    }\n\n    // Hook Legacy Delete Button for Reverse Sync\n    const deleteBtn = document.getElementById('deleteSetupBtn');\n    if (deleteBtn) {\n        console.log('[LegacyShim] Hooking Delete Button for Reverse Sync');\n        deleteBtn.addEventListener('click', () => {\n            const setupSelect = document.getElementById('setupSelect');\n            const projectToDelete = setupSelect ? setupSelect.value : null;\n\n            if (!projectToDelete) return;\n\n            // Wait for legacy delete/confirm flow\n            setTimeout(async () => {\n                // Check if it's gone from LocalStorage\n                const stored = localStorage.getItem('cameraPowerPlanner_setups');\n                if (stored) {\n                    const setups = JSON.parse(stored);\n                    if (!setups[projectToDelete]) {\n                        console.log(`[LegacyShim] Reverse Sync: Deleting ${projectToDelete} from Native IDB`);\n                        if (global.cineProjectService) {\n                            await global.cineProjectService.deleteProject(projectToDelete);\n                        }\n                    }\n                }\n            }, 500); // Give enough time for confirm dialog + operation.\n            // Note: Confirm dialog blocks main thread, so timeout starts AFTER dialog closes.\n        });\n    }\n\n    // Hook Legacy Share Button for Pre-Share Persistence\n    // Ensures that if the project was hydrated but not yet saved to legacy memory,\n    // we force a save so the export link generation works correctly.\n    const shareBtn = document.getElementById('shareSetupBtn');\n    if (shareBtn && saveBtn) {\n        console.log('[LegacyShim] Hooking Share Button for Pre-Export Save');\n        shareBtn.addEventListener('click', () => {\n            console.log('[LegacyShim] Pre-Share: Triggering Save to ensure memory consistency');\n            saveBtn.click();\n        }, true); // Capture phase to run BEFORE legacy share handler\n    }\n}\n\n// =====================\n// PUBLIC API\n// =====================\nconst LegacyShim = {\n    // Container management\n    ensureLegacyContainer,\n    shimToLegacyContainer,\n\n    // Value syncing\n    syncSelectValue,\n    syncInputValue,\n    syncToV2,\n    syncLegacyToNative,\n\n    // Event dispatching\n    dispatchNativeEvent,\n    triggerLegacyClick,\n\n    // Project operations\n    loadProject,\n    saveProject,\n    deleteProject,\n    createProject,\n    getProjectNames,\n\n    // Device operations\n    setDeviceValue,\n    getDeviceValue,\n    getDeviceSnapshot,\n\n    // V2 binding\n    bindV2Select,\n    bindV2Input,\n    listenLegacyChanges,\n\n    // Utilities\n    verifyLegacyIds,\n    cleanup,\n    init,\n\n    // Constants\n    CRITICAL_IDS,\n    ALL_CRITICAL_IDS\n};\n\n// Expose to global scope\nif (typeof global !== 'undefined') {\n    global.cineLegacyShim = LegacyShim;\n}\n\nif (typeof window !== 'undefined') {\n    window.cineLegacyShim = LegacyShim;\n}\n\n// Auto-initialize when DOM is ready\nif (typeof document !== 'undefined') {\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', init);\n    } else {\n        init();\n    }\n}\n\n// Module export\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = LegacyShim;\n}\n\n// Removed IIFE end\nexport { LegacyShim };\n\n","/**\n * Cine Power Planner V2 - Project Dashboard Component\n * =====================================================\n * Renders the project grid with tiles for each saved project.\n */\n\n// Polyfill global for legacy code\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n\n// =====================\n// CONFIGURATION\n// =====================\nconst GRID_CONTAINER_ID = 'projectGrid';\nconst VIEW_ID = 'view-projects';\nconst STORAGE_KEY = 'cameraPowerPlanner_setups';\n\n// Color palette for project tiles\nconst TILE_COLORS = [\n    'blue', 'green', 'orange', 'purple', 'red', 'pink', 'teal', 'indigo',\n    'yellow', 'amber', 'lime', 'emerald', 'cyan', 'sky',\n    'violet', 'fuchsia', 'rose',\n    'slate', 'stone', 'neutral',\n    'gold', 'crimson', 'navy', 'aquamarine'\n];\n\n// Icon options\nconst PROJECT_ICONS = [\n    '', '', '', '', '', '', '', '', '', '', '', '',\n    '', '', '', '', '', '', '', '', '', '', '', '',\n    '', '', '', '', '', '', '', '', '', ''\n];\n\n// =====================\n// STATE\n// =====================\nlet isInitialized = false;\n// let colorIndex = 0;\nlet currentFilter = {\n    query: '',\n    type: 'active' // 'active' | 'archived'\n};\n\n// Cache for project data to avoid O(N) localStorage parsing\nlet _cachedProjectData = null;\nlet dataProvider = null;\n\n// =====================\n// DATA PROVIDERS\n// =====================\n\n\n\nimport { projectService } from '../modules/persistence/ProjectService.js';\n\nfunction createDefaultDataProvider() {\n    return {\n        loadProjectMetadata: () => {\n            console.warn('[V2] Synchronous metadata load requested - this is a legacy pattern. Using empty default.');\n            return {};\n        },\n        async getProjectNames() {\n            const v2Names = await projectService.getProjectNames();\n            let legacyNames = [];\n\n            // Legacy Fallback\n            if (global.cineLegacyShim && typeof global.cineLegacyShim.getProjectNames === 'function') {\n                legacyNames = global.cineLegacyShim.getProjectNames();\n            } else {\n                try {\n                    const stored = localStorage.getItem(STORAGE_KEY);\n                    if (stored) legacyNames = Object.keys(JSON.parse(stored));\n                } catch (e) {\n                    console.warn('[Dashboard] Failed to read legacy storage:', e);\n                }\n            }\n\n            // Merge, Deduplicate, and Filter\n            return [...new Set([...v2Names, ...legacyNames])].filter(n => n && !n.startsWith('auto-backup-'));\n        },\n        async getProjectMetadata(projectName) {\n            let meta = await projectService.getProjectMetadata(projectName);\n\n            // If empty in V2, try Legacy\n            if (!meta || Object.keys(meta).length === 0) {\n                try {\n                    const stored = localStorage.getItem(STORAGE_KEY);\n                    if (stored) {\n                        const data = JSON.parse(stored);\n                        if (data[projectName]) return data[projectName];\n                    }\n                } catch (e) {\n                    console.warn('[Dashboard] Failed to read legacy project metadata:', e);\n                }\n            }\n            return meta;\n        },\n        async loadProject(projectName) {\n            let project = await projectService.getProject(projectName);\n            if (!project) {\n                // Fallback to legacy\n                try {\n                    const stored = localStorage.getItem(STORAGE_KEY);\n                    if (stored) {\n                        const data = JSON.parse(stored);\n                        if (data[projectName]) return data[projectName];\n                    }\n                } catch (e) {\n                    console.warn('[Dashboard] Failed to fallback load legacy project:', e);\n                }\n            }\n            return project;\n        },\n        async saveProject(projectName, projectData) {\n            // This implicitly migrates legacy projects to V2 storage format on save\n            return await projectService.saveProject(projectName, projectData);\n        },\n        async updateProjectMetadata(projectName, metadata = {}) {\n            // Try to load from Service first\n            let project = await projectService.getProject(projectName);\n\n            // If not in service, try loading from legacy (implicit migration)\n            if (!project) {\n                try {\n                    const stored = localStorage.getItem(STORAGE_KEY);\n                    if (stored) {\n                        const data = JSON.parse(stored);\n                        project = data[projectName];\n                    }\n                } catch (e) {\n                    console.warn('[Dashboard] Failed to read legacy project for update:', e);\n                }\n            }\n\n            if (project) {\n                if (metadata.color) project.color = metadata.color;\n                if (metadata.icon) project.icon = metadata.icon;\n                if (metadata.prepDays) project.prepDays = metadata.prepDays;\n                if (metadata.shootingDays) project.shootingDays = metadata.shootingDays;\n                if (metadata.returnDays) project.returnDays = metadata.returnDays;\n                if (typeof metadata.archived !== 'undefined') project.archived = metadata.archived;\n                if (metadata.status) project.status = metadata.status;\n\n                // Save back to V2 (Implicit Migration)\n                const success = await projectService.saveProject(projectName, project);\n                return { success, lastModified: project.lastModified };\n            }\n            return { success: false };\n        },\n        async deleteProject(projectName) {\n            // Delete from V2\n            await projectService.deleteProject(projectName);\n            // Also try delete from Legacy\n            try {\n                const stored = localStorage.getItem(STORAGE_KEY);\n                if (stored) {\n                    const data = JSON.parse(stored);\n                    if (data[projectName]) {\n                        delete data[projectName];\n                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));\n                    }\n                }\n            } catch (e) {\n                console.warn('[Dashboard] Failed to delete legacy project:', e);\n            }\n            return true;\n        },\n        async duplicateProject(projectName) {\n            // If project is legacy only, we need to ensure it's loaded before duplication\n            // ProjectService.duplicateProject might fail if it only checks V2.\n            // For now, let's rely on ProjectService but if it fails, handle manual duplication?\n            // Actually, best to let the user open -> save (migrate) -> duplicate.\n            // Or strictly:\n            return await projectService.duplicateProject(projectName);\n        },\n        renameProject: () => ({ success: false }), // Not implemented yet in Service\n        async createProject(projectName) {\n            return await projectService.createProject(projectName);\n        }\n    };\n}\n\nfunction getDataProvider() {\n    return createDefaultDataProvider();\n}\n\n/**\n * Set the data provider\n */\nfunction setDataProvider(provider) {\n    dataProvider = provider;\n}\n\n/**\n * Create a UI-only data provider (wrapper for default provider for now)\n */\nfunction createUiOnlyDataProvider() {\n    return createDefaultDataProvider();\n}\n\n// =====================\n// HELPERS\n// =====================\n\n/**\n * Get the next color in the palette\n */\n// Unused helper - keeping for future color cycling if needed\n// function getNextColor() {\n//     const color = TILE_COLORS[colorIndex % TILE_COLORS.length];\n//     colorIndex++;\n//     return color;\n// }\n\n/**\n * Escape HTML to prevent XSS\n */\nfunction escapeHtml(str) {\n    if (typeof str !== 'string') return '';\n    return str\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&#039;');\n}\n\n/**\n * Format a date for display\n */\nfunction formatDate(dateStr) {\n    if (!dateStr) return '';\n    try {\n        const date = new Date(dateStr);\n        return date.toLocaleDateString(undefined, {\n            month: 'short',\n            day: 'numeric',\n            year: 'numeric'\n        });\n    } catch (_e) {\n        void _e;\n        return '';\n    }\n}\n\n/**\n * Format a date range string \"YYYY-MM-DD to YYYY-MM-DD\"\n */\nfunction formatDateRange(rangeStr) {\n    if (!rangeStr || typeof rangeStr !== 'string') return '';\n    const parts = rangeStr.split(' to ');\n    if (parts.length === 1) return formatDate(parts[0]);\n    if (parts.length === 2) {\n        return `${formatDate(parts[0])} - ${formatDate(parts[1])}`;\n    }\n    return rangeStr;\n}\n\n/**\n * Translation Helper\n */\nfunction _t(path, params = {}) {\n    const lang = document.documentElement.lang || 'en';\n    let root = (window.texts && window.texts[lang]) ? window.texts[lang] : null;\n    if (!root && window.texts) root = window.texts['en'];\n\n    // Simple resolve\n    const resolve = (obj, p) => p.split('.').reduce((o, i) => o ? o[i] : null, obj);\n\n    let val = root ? resolve(root, path) : null;\n\n    // Fallback to English if missing in current lang\n    if (!val && lang !== 'en' && window.texts && window.texts['en']) {\n        val = resolve(window.texts['en'], path);\n    }\n\n    if (!val) return path;\n\n    if (typeof val === 'string') {\n        for (const [k, v] of Object.entries(params)) {\n            val = val.replace(`{${k}}`, v);\n        }\n    }\n    return val;\n}\n\n// =====================\n// PROJECT DATA\n// =====================\n\n/**\n * Refresh the project data cache.\n * Uses the optimized loadProjectMetadata API from storage.js if available.\n */\n/**\n * Refresh the project data cache.\n * Uses the optimized loadProjectMetadata API from storage.js if available.\n */\nasync function refreshProjectDataCache() {\n    const provider = getDataProvider();\n\n    // 1. Try sync legacy load first (fast path for synchronous providers)\n    let legacyData = provider.loadProjectMetadata();\n    // Only use if it actually returned data, AND didn't warn/stub\n    if (legacyData && Object.keys(legacyData).length > 0) {\n        _cachedProjectData = legacyData;\n        return;\n    }\n\n    // 2. Async path (for ProjectService)\n    try {\n        const names = await provider.getProjectNames();\n        const cache = {};\n\n        // Parallel load of metadata\n        await Promise.all(names.map(async name => {\n            if (name && !name.startsWith('auto-backup-')) {\n                const meta = await provider.getProjectMetadata(name);\n                cache[name] = meta || { lastModified: Date.now() }; // Fallback date\n            }\n        }));\n\n        _cachedProjectData = cache;\n    } catch (e) {\n        console.error('[Dashboard] Failed to refresh project cache:', e);\n        _cachedProjectData = {};\n    }\n}\n\n/**\n * Get all saved project names from legacy system\n * Uses a fallback chain to ensure data availability even during initialization\n */\nfunction getProjectNames() {\n    if (_cachedProjectData) {\n        return Object.keys(_cachedProjectData).filter(name => name && !name.startsWith('auto-backup-'));\n    }\n    // If called synchronously without cache, we return empty array.\n    // The render loop must await refreshProjectDataCache() first.\n    return [];\n}\n\n/**\n * Get filtered projects based on current state\n */\n/**\n * Get filtered projects based on current state\n */\nfunction getFilteredProjects() {\n    let projects = getProjectNames();\n\n    // 0. Filter by Archive Status\n    const showArchived = (currentFilter.type === 'archived');\n    projects = projects.filter(name => {\n        const metadata = getProjectMetadata(name);\n        const isArchived = !!metadata.archived;\n        return showArchived ? isArchived : !isArchived;\n    });\n\n    // 1. Filter by Query\n    if (currentFilter.query) {\n        const q = currentFilter.query.toLowerCase();\n        projects = projects.filter(name => name.toLowerCase().includes(q));\n    }\n\n    return [...new Set(projects)];\n}\n\n/**\n * Get project metadata (color, icon, last modified)\n * Uses module-level cache for performance\n */\nfunction getProjectMetadata(projectName) {\n    // Initialize cache if needed (though it should be primed by render)\n    if (_cachedProjectData === null) {\n        refreshProjectDataCache();\n    }\n\n    const project = _cachedProjectData[projectName];\n    if (project) {\n        return {\n            lastModified: project.lastModified || null,\n            color: project.color || null,\n            icon: project.icon || null,\n            prepDays: project.prepDays || [],\n            shootingDays: project.shootingDays || [],\n            returnDays: project.returnDays || [],\n            archived: project.archived || false,\n            status: project.status || (project.archived ? 'Archived' : 'Planning')\n        };\n    }\n\n    return { lastModified: null, color: null, icon: null, prepDays: [], shootingDays: [], returnDays: [], archived: false, status: 'Planning' };\n}\n\n/**\n * Update project metadata (color, icon, dates)\n */\nfunction updateProjectMetadata(projectName, metadata = {}) {\n    const provider = getDataProvider();\n    const result = provider.updateProjectMetadata(projectName, metadata);\n    if (result && result.success) {\n        if (_cachedProjectData) {\n            if (!_cachedProjectData[projectName]) {\n                _cachedProjectData[projectName] = {};\n            }\n            const nextMetadata = { ...metadata };\n            if (result.lastModified) {\n                nextMetadata.lastModified = result.lastModified;\n            }\n            Object.assign(_cachedProjectData[projectName], nextMetadata);\n        }\n        return true;\n    }\n    return false;\n}\n\n// =====================\n// TILE RENDERING\n// =====================\n\n/**\n * Create a project tile HTML\n */\nfunction createTileHtml(projectName, index) {\n    const metadata = getProjectMetadata(projectName);\n\n    // Use stored color or cycle through palette based on index\n    let color = metadata.color || TILE_COLORS[index % TILE_COLORS.length];\n\n    // Security: Validate color is in the allowed list to prevent injection\n    if (!TILE_COLORS.includes(color)) {\n        color = TILE_COLORS[index % TILE_COLORS.length];\n    }\n\n    // Use stored icon or default\n    // Security: Sanitize icon to prevent XSS\n    const icon = escapeHtml(metadata.icon || '');\n\n    const dateStr = metadata.lastModified ? formatDate(metadata.lastModified) : '';\n    const escapedName = escapeHtml(projectName);\n    const status = metadata.status || 'Planning';\n    const statusClass = status.toLowerCase().replace(/\\s+/g, '-');\n\n    // Translate Status\n    let statusKey = status.toLowerCase().replace(/\\s+/g, '');\n    if (statusKey === 'waitingforapproval') statusKey = 'waitingForApproval'; // Handle capitalization mismatch\n    const statusLabel = _t(`v2.dashboard.status.${statusKey}`) === `v2.dashboard.status.${statusKey}` ? status : _t(`v2.dashboard.status.${statusKey}`);\n\n\n    let periodsHtml = '';\n    const hasDates = (metadata.prepDays?.length > 0) || (metadata.shootingDays?.length > 0) || (metadata.returnDays?.length > 0);\n\n    if (hasDates) {\n        periodsHtml = `<div class=\"v2-tile-periods\">`;\n\n        // Render all Prep dates\n        if (Array.isArray(metadata.prepDays)) {\n            metadata.prepDays.forEach(range => {\n                const fmt = formatDateRange(range);\n                if (fmt) periodsHtml += `<span class=\"v2-period-badge prep\" title=\"${_t('v2.dashboard.projectTile.prep')} ${fmt}\"><span class=\"period-icon\"></span> ${fmt}</span>`;\n            });\n        }\n\n        // Render all Shoot dates\n        if (Array.isArray(metadata.shootingDays)) {\n            metadata.shootingDays.forEach(range => {\n                const fmt = formatDateRange(range);\n                if (fmt) periodsHtml += `<span class=\"v2-period-badge shoot\" title=\"${_t('v2.dashboard.projectTile.shoot')} ${fmt}\"><span class=\"period-icon\"></span> ${fmt}</span>`;\n            });\n        }\n\n        // Render all Return dates\n        if (Array.isArray(metadata.returnDays)) {\n            metadata.returnDays.forEach(range => {\n                const fmt = formatDateRange(range);\n                if (fmt) periodsHtml += `<span class=\"v2-period-badge return\" title=\"${_t('v2.dashboard.projectTile.return')} ${fmt}\"><span class=\"period-icon\"></span> ${fmt}</span>`;\n            });\n        }\n\n        periodsHtml += `</div>`;\n    }\n\n    return `\n      <div class=\"v2-project-tile\" data-project=\"${escapedName}\" tabindex=\"0\" role=\"button\" aria-label=\"${_t('v2.dashboard.projectTile.actionsFor', { project: escapedName })}\">\n        <div class=\"v2-tile-header\">\n          <div class=\"v2-tile-icon color-${color}\">${icon}</div>\n            <div class=\"v2-tile-info\">\n            <h3 class=\"v2-tile-title\">${escapedName}</h3>\n            <div style=\"display: flex; align-items: center; gap: 8px; margin-top: 4px;\">\n                 ${dateStr ? `<span class=\"v2-tile-meta\">${dateStr}</span>` : ''}\n                 <span class=\"v2-status-badge ${statusClass}\">${statusLabel}</span>\n            </div>\n            ${periodsHtml}\n          </div>\n          <div class=\"v2-tile-actions\">\n            <button type=\"button\" class=\"v2-tile-action-btn\" data-action=\"menu\" data-project=\"${escapedName}\" title=\"${_t('v2.dashboard.projectTile.moreOptions')}\" aria-label=\"${_t('v2.dashboard.projectTile.actionsFor', { project: escapedName })}\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                <circle cx=\"12\" cy=\"12\" r=\"1\"></circle>\n                <circle cx=\"12\" cy=\"5\" r=\"1\"></circle>\n                <circle cx=\"12\" cy=\"19\" r=\"1\"></circle>\n              </svg>\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n}\n\n/**\n * Create the \"New Project\" tile HTML\n */\nfunction createNewProjectTileHtml() {\n    return `\n      <div class=\"v2-project-tile new-project\" id=\"v2CreateProjectTile\" tabindex=\"0\" role=\"button\" aria-label=\"${_t('v2.dashboard.newProject')}\">\n        <div class=\"v2-tile-header center\">\n          <div class=\"v2-tile-icon-add\">\n            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n              <path d=\"M12 5v14M5 12h14\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n            </svg>\n          </div>\n          <h3 class=\"v2-tile-title\">${_t('v2.dashboard.newProject')}</h3>\n        </div>\n      </div>\n    `;\n}\n\n/**\n * Create Empty State HTML (No Projects)\n */\n\n\n/**\n * Create No Results HTML (Search)\n */\nfunction createNoResultsHtml(query) {\n    return `\n      <div class=\"view-empty-state\">\n        <div class=\"view-empty-state-icon\" style=\"font-size: 48px; display: flex; align-items: center; justify-content: center;\"></div>\n        <h2>${_t('v2.dashboard.search.noResults.title')}</h2>\n        <p class=\"text-muted\">${_t('v2.dashboard.search.noResults.subtitle', { query: escapeHtml(query) })}</p>\n        <button id=\"v2ClearSearchBtn\" class=\"v2-btn-secondary\">\n          ${_t('v2.dashboard.search.clear')}\n        </button>\n      </div>\n    `;\n}\n\n// =====================\n// DASHBOARD RENDERING\n// =====================\n\n/**\n * Render the project grid\n *\n * Core Rendering Logic:\n * 1. Clears the existing grid container.\n * 2. Retrieves the list of projects (from legacy storage or shim).\n * 3. Applies current filters (Search Query).\n * 4. Renders the appropriate state:\n *    - GLOBAL EMPTY STATE: If no projects exist at all.\n *    - NO RESULTS STATE: If projects exist but the search query matches nothing.\n *    - PROJECT GRID: Renders a tile for each matching project.\n * 5. Appends the \"New Project\" tile at the end (unless searching).\n * 6. Re-binds all click/keyboard events to the new DOM elements.\n *\n * Triggered by:\n/**\n * Render Project Grid\n * Can be triggered from:\n * - Initial Load\n * - 'v2:viewchange' event (when switching to the Projects view)\n * - 'v2:search' event (real-time filtering from the Sidebar)\n */\nasync function renderProjectGrid(isInitial = false) {\n    // Release any held project lock when returning to dashboard\n    if (global.cineProjectLockManager) {\n        global.cineProjectLockManager.releaseLock();\n    }\n\n    const container = document.getElementById(GRID_CONTAINER_ID);\n    if (!container) return;\n\n    // Show loading state if initial\n    if (isInitial) {\n        container.innerHTML = `<div style=\"display: flex; justify-content: center; align-items: center; padding: 40px; color: var(--v2-text-secondary);\">Loading projects...</div>`;\n    }\n\n    // Prime the cache asynchronously\n    await refreshProjectDataCache();\n\n    // Render immediately\n    _renderGridContent(container);\n}\n\n/**\n * Internal render logic\n */\nfunction _renderGridContent(container) {\n    // Reset container to be sure\n    container.innerHTML = '';\n    container.className = 'v2-project-grid';\n    container.style = '';\n\n    // Check if we have ANY projects at all (Global Empty State)\n    const allProjects = getProjectNames();\n    if (allProjects.length === 0) {\n        container.classList.add('v2-grid-empty');\n\n        // Force styles logic...\n        container.style.display = 'flex';\n        container.style.flexDirection = 'column';\n        container.style.alignItems = 'center';\n        container.style.justifyContent = 'flex-start';\n        container.style.paddingTop = '10vh';\n        container.style.minHeight = '100%';\n        container.style.flex = '1';\n\n        const main = container.closest('.v2-main');\n        if (main) main.classList.add('align-top'); // Fix layout\n\n        container.innerHTML = createEmptyStateHtml();\n        bindEmptyStateEvents(container);\n        return;\n    }\n\n    // Get Filtered Projects\n    const filteredProjects = getFilteredProjects();\n\n    // Check if Search returned nothing\n    if (filteredProjects.length === 0) {\n        container.classList.add('v2-grid-empty');\n\n        // Force styles logic...\n        container.style.display = 'flex';\n        container.style.flexDirection = 'column';\n        container.style.alignItems = 'center';\n        container.style.justifyContent = 'flex-start';\n        container.style.paddingTop = '10vh';\n        container.style.minHeight = '100%';\n        container.style.flex = '1';\n\n        const main = container.closest('.v2-main');\n        if (main) main.classList.add('align-top'); // Fix layout\n\n        container.innerHTML = createNoResultsHtml(currentFilter.query);\n\n        // Bind Clear Search\n        const clearBtn = container.querySelector('#v2ClearSearchBtn');\n        if (clearBtn) {\n            clearBtn.addEventListener('click', () => {\n                // Dispatch clear event or manually clear\n                const searchInput = document.getElementById('v2SidebarSearchInput');\n                if (searchInput) {\n                    searchInput.value = '';\n                    searchInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger update\n                }\n            });\n        }\n        return;\n    }\n\n    // Has Projects - Render Grid\n    const main = container.closest('.v2-main');\n    if (main) main.classList.remove('align-top'); // Reset layout\n\n    let html = '';\n    filteredProjects.forEach((name, index) => {\n        html += createTileHtml(name, index);\n    });\n\n    // Always show \"New Project\" tile at the end, unless searching\n    if (!currentFilter.query) {\n        html += createNewProjectTileHtml();\n    }\n\n    container.innerHTML = html;\n    bindTileEvents(container);\n}\n\n\n\n// =====================\n// EVENT HANDLING\n// =====================\n\n/**\n * Bind Search Events\n * Listens for the custom 'v2:search' event dispatched by the Sidebar's search input.\n * This decouples the Sidebar component from the Dashboard component.\n */\nfunction bindSearchEvents() {\n    window.addEventListener('v2:search', (e) => {\n        currentFilter.query = e.detail?.query || '';\n        renderProjectGrid();\n    });\n}\n\n/**\n * Bind events to project tiles\n */\n/**\n * Bind events to project tiles\n */\nfunction bindTileEvents(container) {\n    // Click on tile (open project)\n    container.querySelectorAll('.v2-project-tile').forEach(tile => {\n        // Left Click\n        tile.addEventListener('click', (e) => {\n            // Don't trigger if clicking on menu button\n            if (e.target.closest('[data-action=\"menu\"]')) return;\n\n            const projectName = tile.dataset.project;\n            if (projectName) {\n                openProject(projectName);\n            }\n        });\n\n        // Right Click (Context Menu)\n        tile.addEventListener('contextmenu', (e) => {\n            e.preventDefault();\n            const projectName = tile.dataset.project;\n            if (projectName) {\n                showContextMenu(e, projectName);\n            }\n        });\n\n        // Keyboard support\n        tile.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter' || e.key === ' ') {\n                e.preventDefault();\n                tile.click();\n            }\n        });\n    });\n\n    // Click on menu button\n    container.querySelectorAll('[data-action=\"menu\"]').forEach(btn => {\n        btn.addEventListener('click', (e) => {\n            e.stopPropagation();\n            const projectName = btn.dataset.project;\n            if (projectName) {\n                showContextMenu(e, projectName);\n            }\n        });\n    });\n\n    // Click on new project tile\n    const newProjectTile = container.querySelector('#v2CreateProjectTile');\n    if (newProjectTile) {\n        newProjectTile.addEventListener('click', () => showProjectDialog()); // No arg = new\n        newProjectTile.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter' || e.key === ' ') {\n                e.preventDefault();\n                showProjectDialog();\n            }\n        });\n    }\n}\n\n/**\n * Show Context Menu\n */\n/**\n * Show Context Menu\n */\nfunction showContextMenu(e, projectName) {\n    // Close existing\n    closeContextMenu();\n\n    const menu = document.createElement('div');\n    menu.className = 'v2-context-menu';\n    menu.innerHTML = `\n            <button class=\"v2-context-menu-item\" data-action=\"open\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <path d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                    <path d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\n                </svg>\n                ${_t('v2.dashboard.contextMenu.open')}\n            </button>\n            <button class=\"v2-context-menu-item\" data-action=\"edit\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"></path>\n                    <path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"></path>\n                </svg>\n                ${_t('v2.dashboard.contextMenu.rename')}\n            </button>\n            <button class=\"v2-context-menu-item\" data-action=\"print\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <polyline points=\"6 9 6 2 18 2 18 9\"></polyline>\n                    <path d=\"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2\"></path>\n                    <rect x=\"6\" y=\"14\" width=\"12\" height=\"8\"></rect>\n                </svg>\n                ${_t('v2.dashboard.contextMenu.print')}\n            </button>\n            <button class=\"v2-context-menu-item\" data-action=\"duplicate\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"></rect>\n                    <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"></path>\n                </svg>\n                ${_t('v2.dashboard.contextMenu.duplicate')}\n            </button>\n            <button class=\"v2-context-menu-item\" data-action=\"archive\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <polyline points=\"21 8 21 21 3 21 3 8\"></polyline>\n                    <rect x=\"1\" y=\"3\" width=\"22\" height=\"5\"></rect>\n                    <line x1=\"10\" y1=\"12\" x2=\"14\" y2=\"12\"></line>\n                </svg>\n                ${_t('v2.dashboard.contextMenu.archive')}\n            </button>\n             <div style=\"height: 1px; background: var(--v2-border-default); margin: 4px 0;\"></div>\n            <button class=\"v2-context-menu-item danger\" data-action=\"delete\">\n                <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <path d=\"M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2\"/>\n                </svg>\n                ${_t('v2.dashboard.contextMenu.delete')}\n            </button>\n        `;\n\n    // Position\n    menu.style.left = `${e.clientX}px`;\n    menu.style.top = `${e.clientY}px`;\n\n    // Bind Actions\n    menu.querySelector('[data-action=\"open\"]').addEventListener('click', () => {\n        openProject(projectName);\n        closeContextMenu();\n    });\n\n    menu.querySelector('[data-action=\"edit\"]').addEventListener('click', () => {\n        closeContextMenu();\n        showProjectDialog(projectName); // Pass name = edit mode\n    });\n\n    menu.querySelector('[data-action=\"print\"]').addEventListener('click', () => {\n        openProject(projectName, { action: 'print' });\n        closeContextMenu();\n    });\n\n    menu.querySelector('[data-action=\"duplicate\"]').addEventListener('click', () => {\n        duplicateProject(projectName);\n        closeContextMenu();\n    });\n\n    menu.querySelector('[data-action=\"archive\"]').addEventListener('click', () => {\n        archiveProject(projectName);\n        closeContextMenu();\n    });\n\n    menu.querySelector('[data-action=\"delete\"]').addEventListener('click', async () => {\n        await deleteProject(projectName);\n        closeContextMenu();\n    });\n\n    document.body.appendChild(menu);\n\n    // Adjust constraints (keep onscreen)\n    const rect = menu.getBoundingClientRect();\n    if (rect.right > window.innerWidth) menu.style.left = `${window.innerWidth - rect.width - 10}px`;\n    if (rect.bottom > window.innerHeight) menu.style.top = `${window.innerHeight - rect.height - 10}px`;\n\n    // Bind Close\n    setTimeout(() => {\n        document.addEventListener('click', closeContextMenu, { once: true });\n        document.addEventListener('contextmenu', closeContextMenu, { once: true });\n    }, 0);\n}\n\n/**\n * Close Context Menu\n */\nfunction closeContextMenu() {\n    const existing = document.querySelector('.v2-context-menu');\n    if (existing) existing.remove();\n    document.removeEventListener('click', closeContextMenu);\n}\n\n/**\n * Bind events for empty state\n */\nfunction bindEmptyStateEvents(container) {\n    const createBtn = container.querySelector('#v2EmptyStateCreateBtn');\n    if (createBtn) {\n        createBtn.addEventListener('click', () => showCreateProjectDialog());\n    }\n}\n\n// =====================\n// PROJECT OPERATIONS\n// =====================\n\n/**\n * Open a project (navigate to detail view)\n */\nasync function openProject(projectName, options = {}) {\n    // Check for cross-tab lock\n    if (global.cineProjectLockManager) {\n        const locked = await global.cineProjectLockManager.requestLock(projectName);\n        if (!locked) {\n            alert(_t('v2.dashboard.projectLocked', { projectName: projectName }));\n            return;\n        }\n    }\n\n    // Load the project via legacy shim\n    if (global.cineLegacyShim) {\n        global.cineLegacyShim.loadProject(projectName);\n    }\n\n    // Navigate to project detail view\n    if (global.cineViewManager) {\n        global.cineViewManager.showView('projectDetail', {\n            projectId: projectName,\n            tab: 'camera',\n            ...options\n        });\n    }\n}\n\n/**\n * Create Empty State HTML (No Projects)\n */\nfunction createEmptyStateHtml() {\n    if (currentFilter.type === 'archived') {\n        return `\n              <div class=\"view-empty-state\">\n                <div class=\"view-empty-state-icon\" style=\"font-size: 64px; opacity: 0.8; margin-bottom: 16px;\">\n                  \n                </div>\n                <h2>${_t('v2.dashboard.emptyState.archiveTitle')}</h2>\n                <p class=\"text-muted\">${_t('v2.dashboard.emptyState.archiveSubtitle')}</p>\n              </div>\n            `;\n    }\n\n    return `\n      <div class=\"view-empty-state\">\n        <div class=\"view-empty-state-icon\" style=\"font-size: 64px; opacity: 0.8; margin-bottom: 16px;\">\n          <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n            <path d=\"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z\"/>\n            <polyline points=\"3.27 6.96 12 12.01 20.73 6.96\"/>\n            <line x1=\"12\" y1=\"22.08\" x2=\"12\" y2=\"12\"/>\n          </svg>\n        </div>\n        <h2>${_t('v2.dashboard.emptyState.title')}</h2>\n        <p class=\"text-muted\">${_t('v2.dashboard.emptyState.subtitle')}</p>\n        <div class=\"v2-empty-actions\">\n            <button id=\"v2EmptyStateCreateBtn\" class=\"v2-btn-primary\">\n              + ${_t('v2.dashboard.newProject')}\n            </button>\n            <p class=\"v2-help-link-container\">\n                <a href=\"#/help\" class=\"v2-link-subtle\">${_t('v2.dashboard.emptyState.help')}</a>\n            </p>\n        </div>\n      </div>\n    `;\n}\n\n/**\n * Delete a project\n */\nasync function deleteProject(projectName) {\n    if (!confirm(_t('v2.dashboard.confirmDelete', { project: projectName }) || `Are you sure you want to delete project \"${projectName}\"?`)) {\n        return;\n    }\n\n    try {\n        const provider = getDataProvider();\n        const deleted = await provider.deleteProject(projectName);\n        if (deleted) {\n            updateProjectRevision();\n            refreshProjectDataCache();\n        }\n\n        // 2. Notify legacy shim if available (to clean up its internal state if any)\n        if (global.cineLegacyShim && typeof global.cineLegacyShim.deleteProject === 'function') {\n            // We typically just need to refresh, but if the shim has specific delete logic, call it.\n            // However, since we manually deleted from storage, we might just need to refresh.\n            if (typeof global.cineLegacyShim.refreshProjects === 'function') {\n                global.cineLegacyShim.refreshProjects();\n            }\n        }\n\n        // 3. Update UI\n        renderProjectGrid();\n\n    } catch (e) {\n        console.error('[V2] Failed to delete project:', e);\n        alert(_t('v2.common.error') || 'An error occurred.');\n    }\n}\n\n/**\n * Archive Project\n */\nfunction archiveProject(projectName) {\n    updateProjectMetadata(projectName, { archived: true, status: 'Archived' });\n    renderProjectGrid();\n}\n\n/**\n * Duplicate Project\n */\nfunction duplicateProject(projectName) {\n    const provider = getDataProvider();\n    const result = provider.duplicateProject(projectName);\n    if (result && result.success) {\n        updateProjectRevision();\n        refreshProjectDataCache();\n        renderProjectGrid();\n\n        if (global.cineLegacyShim && typeof global.cineLegacyShim.refreshProjects === 'function') {\n            global.cineLegacyShim.refreshProjects();\n        }\n    }\n}\n\n/**\n * Show create project dialog using internal modal\n */\nfunction showProjectDialog(projectName = null) {\n    showCreateProjectDialog(projectName);\n}\n\n/**\n * Internal implementation for showing the modal\n */\nfunction showCreateProjectDialog(existingProject = null) {\n    const isEditing = !!existingProject;\n    const randomColorIndex = Math.floor(Math.random() * TILE_COLORS.length);\n    let selectedColor = TILE_COLORS[randomColorIndex];\n    let selectedIcon = '';\n\n    let existingMetadata = null;\n\n    // If editing, load existing data\n    if (isEditing) {\n        refreshProjectDataCache();\n        existingMetadata = getDataProvider().getProjectMetadata(existingProject);\n        if (existingMetadata) {\n            if (existingMetadata.color) selectedColor = existingMetadata.color;\n            if (existingMetadata.icon) selectedIcon = existingMetadata.icon;\n        }\n    }\n\n    // Dynamic periods state\n    let periods = [];\n\n    if (isEditing && existingMetadata) {\n        // Reconstruct periods from V1 structure\n        let pid = 1;\n\n        // Helpers\n        const parseRange = (str, type, name) => {\n            if (!str) return;\n            let start = '', end = '';\n            if (str.includes(' to ')) {\n                [start, end] = str.split(' to ');\n            } else {\n                start = str;\n                end = str; // Single day range\n            }\n            periods.push({\n                id: `period-${pid++}`,\n                type,\n                name,\n                startDate: start,\n                endDate: end\n            });\n        };\n\n        if (Array.isArray(existingMetadata.prepDays)) existingMetadata.prepDays.forEach(d => parseRange(d, 'prep', 'Prep'));\n        if (Array.isArray(existingMetadata.shootingDays)) existingMetadata.shootingDays.forEach(d => parseRange(d, 'shoot', 'Shoot'));\n        if (Array.isArray(existingMetadata.returnDays)) existingMetadata.returnDays.forEach(d => parseRange(d, 'return', 'Return'));\n    }\n\n    // Default for new projects\n    if (!isEditing && periods.length === 0) {\n        periods = [\n            { id: 'period-1', type: 'prep', name: 'Prep', startDate: '', endDate: '' },\n            { id: 'period-2', type: 'shoot', name: 'Shoot', startDate: '', endDate: '' },\n            { id: 'period-3', type: 'return', name: 'Return', startDate: '', endDate: '' }\n        ];\n    }\n\n    let periodCounter = periods.length > 0 ? periods.length : 3;\n\n    const PERIOD_TYPES = [\n        { value: 'prep', label: 'Prep', icon: '' },\n        { value: 'shoot', label: 'Shoot', icon: '' },\n        { value: 'return', label: 'Return', icon: '' }\n    ];\n\n    // Modal styles moved to src/styles/v2/views/project-dashboard.css\n\n    const getColorVar = (c) => `var(--v2-color-${c})`;\n\n    // Build HTML for swatches\n    const colorSwatchesHtml = TILE_COLORS.map(c => `\n            <button type=\"button\" class=\"v2-color-swatch-sm color-${c} ${c === selectedColor ? 'selected' : ''}\" \n                    data-color=\"${c}\" aria-label=\"Select ${c} color\">\n            </button>\n        `).join('');\n\n    // Build HTML for icons\n    const iconOptionsHtml = PROJECT_ICONS.map(i => `\n            <button type=\"button\" class=\"v2-icon-option-sm ${i === selectedIcon ? 'selected' : ''}\" \n                    data-icon=\"${i}\" aria-label=\"Select icon ${i}\">\n                ${i}\n            </button>\n        `).join('');\n\n    // Build HTML for periods\n    const buildPeriodsHtml = () => {\n        if (periods.length === 0) {\n            return `<div class=\"v2-empty-state\" style=\"padding: 16px; font-size: 13px;\">No dates added yet.</div>`;\n        }\n        return periods.map(p => {\n            const typeOptions = PERIOD_TYPES.map(t =>\n                `<option value=\"${t.value}\" ${p.type === t.value ? 'selected' : ''}>${t.icon} ${t.label}</option>`\n            ).join('');\n\n            return `\n                <div class=\"v2-period-row\" data-period-id=\"${p.id}\">\n                    <div class=\"v2-period-name\">\n                        <select class=\"v2-period-type-select\" data-field=\"type\">\n                            ${typeOptions}\n                        </select>\n                    </div>\n                    <input type=\"date\" class=\"v2-date-input\" value=\"${p.startDate}\" data-field=\"startDate\" aria-label=\"${p.name} Start Date\">\n                    <span class=\"v2-date-separator\">to</span>\n                    <input type=\"date\" class=\"v2-date-input\" value=\"${p.endDate}\" data-field=\"endDate\" aria-label=\"${p.name} End Date\">\n                    <button type=\"button\" class=\"v2-period-remove\" data-period-id=\"${p.id}\" aria-label=\"Remove period\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                            <path d=\"M18 6L6 18M6 6l12 12\"/>\n                        </svg>\n                    </button>\n                </div>\n            `}).join('');\n    }\n\n    // Create modal backdrop\n    const backdrop = document.createElement('div');\n    backdrop.className = 'v2-modal-backdrop';\n    backdrop.innerHTML = `\n            <div class=\"v2-modal\" style=\"max-width: 520px;\">\n                <div class=\"v2-modal-header\">\n                    <h3 class=\"v2-modal-title\">${isEditing ? 'Edit Project' : 'Create New Project'}</h3>\n                    <button type=\"button\" class=\"v2-modal-close v2-btn v2-btn-ghost\" aria-label=\"Close\">\n                        <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                            <path d=\"M6 18L18 6M6 6l12 12\"/>\n                        </svg>\n                    </button>\n                </div>\n                <div class=\"v2-modal-body\">\n                    <!-- Project Name -->\n                    <div style=\"margin-bottom: var(--v2-space-lg);\">\n                        <label for=\"v2NewProjectName\" class=\"v2-form-section-label\" style=\"font-size: var(--v2-font-size-base); color: var(--v2-text-primary);\">\n                            Project Name\n                        </label>\n                        <input type=\"text\" id=\"v2NewProjectName\" class=\"v2-input\" placeholder=\"Enter project name...\" \n                               value=\"${isEditing ? existingProject : ''}\"\n                               style=\"width: 100%; padding: var(--v2-space-sm) var(--v2-space-md); border: 1px solid var(--v2-border-default); border-radius: var(--v2-radius-md); font-size: var(--v2-font-size-base);\">\n                        ${isEditing ? '<p class=\"text-muted\" style=\"font-size: 12px; margin-top: 4px;\">Warning: Renaming will create a new entry.</p>' : ''}\n                        <p id=\"v2NewProjectError\" style=\"color: var(--v2-status-error); font-size: var(--v2-font-size-sm); margin-top: var(--v2-space-sm); display: none;\"></p>\n                    </div>\n\n                    <!-- Color & Icon Pickers Row -->\n                    <div class=\"v2-picker-row\" style=\"margin-bottom: var(--v2-space-lg);\">\n                        <div class=\"v2-picker-group\">\n                            <label class=\"v2-form-section-label\">Color</label>\n                            <button type=\"button\" class=\"v2-picker-trigger\" id=\"v2ColorPickerTrigger\">\n                                <span class=\"v2-picker-preview\" id=\"v2ColorPreview\" style=\"background-color: ${getColorVar(selectedColor)};\"></span>\n                                <span class=\"v2-picker-label\">${selectedColor.charAt(0).toUpperCase() + selectedColor.slice(1)}</span>\n                                <svg class=\"v2-picker-arrow\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                                    <polyline points=\"6 9 12 15 18 9\"/>\n                                </svg>\n                            </button>\n                            <div class=\"v2-picker-popover\" id=\"v2ColorPopover\">\n                                <div class=\"v2-picker-popover-grid\">\n                                    ${colorSwatchesHtml}\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"v2-picker-group\">\n                            <label class=\"v2-form-section-label\">Icon</label>\n                            <button type=\"button\" class=\"v2-picker-trigger\" id=\"v2IconPickerTrigger\">\n                                <span class=\"v2-picker-icon-preview\" id=\"v2IconPreview\">${selectedIcon}</span>\n                                <span class=\"v2-picker-label\">Icon</span>\n                                <svg class=\"v2-picker-arrow\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                                    <polyline points=\"6 9 12 15 18 9\"/>\n                                </svg>\n                            </button>\n                            <div class=\"v2-picker-popover\" id=\"v2IconPopover\" style=\"min-width: 280px;\">\n                                <div class=\"v2-picker-popover-grid\" style=\"grid-template-columns: repeat(7, 1fr);\">\n                                    ${iconOptionsHtml}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Project Periods -->\n                    <div style=\"margin-bottom: var(--v2-space-md);\">\n                        <label class=\"v2-form-section-label\">Project Roadmap</label>\n                        <div class=\"v2-periods-container\" id=\"v2PeriodsContainer\">\n                            ${buildPeriodsHtml()}\n                        </div>\n                        <button type=\"button\" class=\"v2-add-period-btn\" id=\"v2AddPeriodBtn\" style=\"margin-top: var(--v2-space-sm); width: 100%;\">\n                            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                                <path d=\"M12 5v14M5 12h14\"/>\n                            </svg>\n                            Add Period\n                        </button>\n                    </div>\n                </div>\n                <div class=\"v2-modal-footer\">\n                    <button type=\"button\" class=\"v2-btn v2-btn-secondary\" id=\"v2CancelProjectBtn\">Cancel</button>\n                    <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"v2CreateProjectBtn\">${isEditing ? 'Save Changes' : 'Create Project'}</button>\n                </div>\n            </div>\n        `;\n\n    document.body.appendChild(backdrop);\n\n    // Animate open\n    requestAnimationFrame(() => {\n        backdrop.classList.add('open');\n    });\n\n    const input = backdrop.querySelector('#v2NewProjectName');\n    const errorEl = backdrop.querySelector('#v2NewProjectError');\n    const createBtn = backdrop.querySelector('#v2CreateProjectBtn');\n    const cancelBtn = backdrop.querySelector('#v2CancelProjectBtn');\n    const closeBtn = backdrop.querySelector('.v2-modal-close');\n    const periodsContainer = backdrop.querySelector('#v2PeriodsContainer');\n    const addPeriodBtn = backdrop.querySelector('#v2AddPeriodBtn');\n\n    // Color picker logic\n    const colorTrigger = backdrop.querySelector('#v2ColorPickerTrigger');\n    const colorPopover = backdrop.querySelector('#v2ColorPopover');\n    const colorPreview = backdrop.querySelector('#v2ColorPreview');\n    const colorLabel = colorTrigger.querySelector('.v2-picker-label');\n\n    colorTrigger.addEventListener('click', (e) => {\n        e.stopPropagation();\n        colorTrigger.classList.toggle('open');\n        colorPopover.classList.toggle('open');\n        // Close icon popover\n        iconTrigger.classList.remove('open');\n        iconPopover.classList.remove('open');\n    });\n\n    colorPopover.querySelectorAll('.v2-color-swatch-sm').forEach(swatch => {\n        swatch.addEventListener('click', (e) => {\n            e.stopPropagation();\n            colorPopover.querySelectorAll('.v2-color-swatch-sm').forEach(s => s.classList.remove('selected'));\n            swatch.classList.add('selected');\n            selectedColor = swatch.dataset.color;\n            colorPreview.style.backgroundColor = getColorVar(selectedColor);\n            colorLabel.textContent = selectedColor.charAt(0).toUpperCase() + selectedColor.slice(1);\n            colorTrigger.classList.remove('open');\n            colorPopover.classList.remove('open');\n        });\n    });\n\n    // Icon picker logic\n    const iconTrigger = backdrop.querySelector('#v2IconPickerTrigger');\n    const iconPopover = backdrop.querySelector('#v2IconPopover');\n    const iconPreview = backdrop.querySelector('#v2IconPreview');\n\n    iconTrigger.addEventListener('click', (e) => {\n        e.stopPropagation();\n        iconTrigger.classList.toggle('open');\n        iconPopover.classList.toggle('open');\n        // Close color popover\n        colorTrigger.classList.remove('open');\n        colorPopover.classList.remove('open');\n    });\n\n    iconPopover.querySelectorAll('.v2-icon-option-sm').forEach(opt => {\n        opt.addEventListener('click', (e) => {\n            e.stopPropagation();\n            iconPopover.querySelectorAll('.v2-icon-option-sm').forEach(o => o.classList.remove('selected'));\n            opt.classList.add('selected');\n            selectedIcon = opt.dataset.icon;\n            iconPreview.textContent = selectedIcon;\n            iconTrigger.classList.remove('open');\n            iconPopover.classList.remove('open');\n        });\n    });\n\n    // Close popovers when clicking outside\n    backdrop.addEventListener('click', () => {\n        colorTrigger.classList.remove('open');\n        colorPopover.classList.remove('open');\n        iconTrigger.classList.remove('open');\n        iconPopover.classList.remove('open');\n    });\n\n    // Periods management\n    function updatePeriodData(periodId, field, value) {\n        const period = periods.find(p => p.id === periodId);\n        if (period) {\n            if (field === 'type') {\n                const typeInfo = PERIOD_TYPES.find(t => t.value === value);\n                if (typeInfo) {\n                    period.type = value;\n                    period.name = typeInfo.label;\n                }\n            } else {\n                period[field] = value;\n            }\n        }\n    }\n\n    function removePeriod(periodId) {\n        periods = periods.filter(p => p.id !== periodId);\n        renderPeriods();\n    }\n\n    function addPeriod() {\n        periodCounter++;\n        periods.push({\n            id: `period-${periodCounter}`,\n            type: 'shoot',\n            name: 'Shoot',\n            startDate: '',\n            endDate: ''\n        });\n        renderPeriods();\n        // Focus new date input? Or scroll to bottom\n    }\n\n    function renderPeriods() {\n        periodsContainer.innerHTML = buildPeriodsHtml();\n        bindPeriodEvents();\n    }\n\n    function bindPeriodEvents() {\n        periodsContainer.querySelectorAll('.v2-period-row').forEach(row => {\n            const periodId = row.dataset.periodId;\n\n            // Inputs\n            row.querySelectorAll('input, select').forEach(input => {\n                input.addEventListener('change', () => {\n                    updatePeriodData(periodId, input.dataset.field, input.value);\n                });\n                input.addEventListener('input', () => {\n                    updatePeriodData(periodId, input.dataset.field, input.value);\n                });\n            });\n\n            // Remove button\n            const removeBtn = row.querySelector('.v2-period-remove');\n            if (removeBtn) {\n                removeBtn.addEventListener('click', () => {\n                    removePeriod(periodId);\n                });\n            }\n        });\n    }\n\n    // Initial bind\n    bindPeriodEvents();\n\n    // Add period button\n    addPeriodBtn.addEventListener('click', addPeriod);\n\n    // Focus input (unless editing)\n    if (!isEditing) {\n        setTimeout(() => input.focus(), 100);\n    }\n\n    function closeModal() {\n        backdrop.classList.remove('open');\n        setTimeout(() => backdrop.remove(), 200);\n    }\n\n    async function handleCreate() {\n        const projectName = input.value.trim();\n\n        if (!projectName) {\n            errorEl.textContent = 'Please enter a project name.';\n            errorEl.style.display = 'block';\n            input.focus();\n            return;\n        }\n\n        const existingNames = getProjectNames();\n\n        // Check duplicates\n        if (isEditing) {\n            // If named changed, check if new name exists\n            if (projectName !== existingProject && existingNames.includes(projectName)) {\n                errorEl.textContent = 'A project with this name already exists.';\n                errorEl.style.display = 'block';\n                input.focus();\n                return;\n            }\n        } else {\n            // New Project\n            if (existingNames.includes(projectName)) {\n                errorEl.textContent = 'A project with this name already exists.';\n                errorEl.style.display = 'block';\n                input.focus();\n                return;\n            }\n        }\n\n        // Show loading state\n        createBtn.disabled = true;\n        createBtn.textContent = isEditing ? 'Saving...' : 'Creating...';\n\n        // Collect period data into V1 structures\n        const formatPeriod = (period) => {\n            if (!period) return null;\n            const s = period.startDate;\n            const e = period.endDate;\n            if (!s && !e) return null;\n            if (s && e) return `${s} to ${e}`;\n            if (s) return s;\n            if (e) return e;\n            return null;\n        };\n\n        const prepDays = periods.filter(p => p.type === 'prep').map(formatPeriod).filter(Boolean);\n        const shootingDays = periods.filter(p => p.type === 'shoot').map(formatPeriod).filter(Boolean);\n        const returnDays = periods.filter(p => p.type === 'return').map(formatPeriod).filter(Boolean);\n\n        const metadata = {\n            color: selectedColor,\n            icon: selectedIcon,\n            prepDays,\n            shootingDays,\n            returnDays\n        };\n\n        if (isEditing) {\n            // Rename Checks\n            if (projectName !== existingProject) {\n                const provider = getDataProvider();\n                const renamed = provider.renameProject(existingProject, projectName, metadata);\n                if (renamed && renamed.success) {\n                    updateProjectRevision();\n                    refreshProjectDataCache();\n\n                    const setupSelect = document.getElementById('setupSelect');\n                    if (setupSelect && setupSelect.value === existingProject) {\n                        // Refresh the grid to reflect the rename in the dashboard UI.\n                    }\n\n                    renderProjectGrid();\n\n                    if (global.cineLegacyShim && typeof global.cineLegacyShim.refreshProjects === 'function') {\n                        global.cineLegacyShim.refreshProjects();\n                    }\n                }\n            } else {\n                // UPDATE Existing (Same Name)\n                updateProjectMetadata(projectName, metadata);\n                renderProjectGrid(); // Refresh grid\n            }\n            closeModal();\n        } else {\n            // CREATE New\n            // Wait for creation to complete (it handles navigation)\n            await createProject(projectName, metadata);\n            closeModal();\n        }\n    }\n\n    // Event listeners\n    createBtn.addEventListener('click', handleCreate);\n    cancelBtn.addEventListener('click', closeModal);\n    closeBtn.addEventListener('click', closeModal);\n\n    // Close on backdrop click\n    backdrop.addEventListener('click', (e) => {\n        if (e.target === backdrop) closeModal();\n    });\n\n    // Enter key to create\n    input.addEventListener('keydown', (e) => {\n        if (e.key === 'Enter') handleCreate();\n        if (e.key === 'Escape') closeModal();\n    });\n\n    // Clear error on typing\n    input.addEventListener('input', () => {\n        errorEl.style.display = 'none';\n    });\n}\n\n\n// Expose ProjectService for Legacy Shim\nif (typeof global !== 'undefined') {\n    global.cineProjectService = projectService;\n}\n\n/**\n * Handle \"Create Project\" action\n */\nasync function createProject(projectName, metadata = {}) {\n    const provider = getDataProvider();\n\n    // Use Native V2 Creation (IndexedDB via ProjectService)\n    const created = await provider.createProject(projectName);\n\n    if (!created) {\n        return false;\n    }\n\n    // Apply metadata\n    updateProjectMetadata(projectName, metadata);\n\n    // Refresh grid\n    renderProjectGrid();\n\n    // Navigate to detail view\n    if (global.cineViewManager) {\n        global.cineViewManager.showView('projectDetail', {\n            projectId: projectName,\n            tab: 'camera'\n        });\n    }\n\n    return true;\n}\n\n/**\n * Helper to update the project revision key for cross-tab sync\n */\nfunction updateProjectRevision() {\n    try {\n        const REV_KEY = 'cameraPowerPlanner_project_rev';\n        const currentRev = parseInt(localStorage.getItem(REV_KEY) || '0', 10);\n        localStorage.setItem(REV_KEY, (currentRev + 1).toString());\n    } catch (e) {\n        console.error('[V2] Failed to update project revision:', e);\n    }\n}\n\n// =====================\n// VIEW MANAGEMENT\n// =====================\n\n/**\n * Create the dashboard view HTML structure\n */\nfunction createDashboardView() {\n    // Check if view already exists\n    if (document.getElementById(VIEW_ID)) {\n        return document.getElementById(VIEW_ID);\n    }\n\n    const view = document.createElement('section');\n    view.id = VIEW_ID;\n    view.className = 'app-view';\n    view.innerHTML = `\n      <header class=\"view-header\">\n        <button class=\"v2-mobile-menu-toggle\" aria-label=\"Open menu\">\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\"></line>\n            <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\"></line>\n            <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\"></line>\n          </svg>\n        </button>\n        <h1>${_t('v2.dashboard.header.title')}</h1>\n        <div class=\"view-header-actions\">\n          <button type=\"button\" class=\"v2-btn v2-btn-secondary\" id=\"v2HeaderImportBtn\" style=\"margin-right: 8px;\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"margin-right: 6px;\">\n              <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\" />\n              <polyline points=\"7 10 12 15 17 10\" />\n              <line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\" />\n            </svg>\n            ${_t('v2.dashboard.actions.importProject')}\n          </button>\n          <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"v2HeaderCreateBtn\">\n            + ${_t('v2.dashboard.actions.newProject')}\n          </button>\n        </div>\n      </header>\n      <div class=\"view-content\">\n        <div class=\"v2-project-grid\" id=\"${GRID_CONTAINER_ID}\">\n          <!-- Tiles will be rendered here -->\n        </div>\n      </div>\n    `;\n\n    // Bind header create button\n    const headerBtn = view.querySelector('#v2HeaderCreateBtn');\n    if (headerBtn) {\n        headerBtn.addEventListener('click', showCreateProjectDialog);\n    }\n\n    return view;\n}\n\n/**\n * Initialize the project dashboard\n */\nfunction init(options = {}) {\n    if (isInitialized) {\n        console.warn('[ProjectDashboard] Already initialized, skipping.');\n        return;\n    }\n    isInitialized = true;\n\n    if (options.dataProvider) {\n        setDataProvider(options.dataProvider);\n        _cachedProjectData = null;\n    } else if (!dataProvider) {\n        setDataProvider(createDefaultDataProvider());\n    }\n\n    console.log('[ProjectDashboard] init() called');\n\n    // Create dashboard view if it doesn't exist\n    const view = createDashboardView();\n\n    // Find main content area and append\n    const v2Main = document.querySelector('.v2-main');\n\n    if (v2Main && !document.getElementById(VIEW_ID)) {\n        v2Main.appendChild(view);\n    }\n\n    // Bind the header button event (Delegated for robustness)\n    document.addEventListener('click', (e) => {\n        if (e.target) {\n            if (e.target.closest('#v2HeaderCreateBtn')) {\n                showCreateProjectDialog();\n            } else if (e.target.closest('#v2HeaderImportBtn')) {\n                // Trigger legacy import\n                if (global.cineLegacyShim) {\n                    global.cineLegacyShim.triggerLegacyClick('applySharedLinkBtn');\n                }\n            }\n        }\n    });\n\n    // If we are already on the projects view, render\n    const currentView = document.querySelector('.v2-view.active');\n    if (currentView && currentView.id === VIEW_ID) {\n        renderProjectGrid(true); // Pass true for initial load\n    }\n\n    // Listen for view changes\n    window.addEventListener('v2:viewchange', (e) => {\n        if (e.detail.view === 'projects') {\n            // If switching to this view, treat as initial load\n            renderProjectGrid(true);\n        }\n    });\n\n    bindSearchEvents();\n}\n\n// =====================\n// PUBLIC API\n// =====================\nconst ProjectDashboard = {\n    init,\n    renderProjectGrid,\n    createProject,\n    deleteProject,\n    openProject,\n    getProjectNames,\n    createDashboardView,\n    formatDate,\n    formatDateRange,\n    createDefaultDataProvider,\n    createUiOnlyDataProvider\n};\n\n// Expose to global scope\nif (typeof global !== 'undefined') {\n    global.cineProjectDashboard = ProjectDashboard;\n}\n\nif (typeof window !== 'undefined') {\n    window.cineProjectDashboard = ProjectDashboard;\n}\n\n// Auto-initialize when DOM is ready\n// BUT only if not already initialized by V2 Bootstrap\nif (typeof document !== 'undefined') {\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', () => {\n            // Delay init to let other V2 modules load first\n            setTimeout(() => {\n                if (!isInitialized) {\n                    console.log('[ProjectDashboard] Auto-initializing (Fallback)');\n                    init();\n                }\n            }, 200);\n        });\n    } else {\n        setTimeout(() => {\n            if (!isInitialized) {\n                console.log('[ProjectDashboard] Auto-initializing (Fallback)');\n                init();\n            }\n        }, 200);\n    }\n}\n\nexport { ProjectDashboard };\n","/**\n * Cine Power Planner V2 - Project Detail View\n * =============================================\n * Handles the project detail view with tabs for Camera Package, \n * Power Summary, Requirements, and Gear List.\n */\n\n// Polyfill global for legacy code\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n\n// =====================\n// CONFIGURATION\n// =====================\n// =====================\n// CONFIGURATION\n// =====================\nconst VIEW_ID = 'view-project-detail';\nconst STORAGE_KEY = 'cameraPowerPlanner_setups';\nconst TABS = ['camera', 'power', 'requirements', 'kit'];\nconst DEFAULT_TAB = 'camera';\n\n// =====================\n// STATE\n// =====================\nlet currentProject = null;\nlet currentTab = DEFAULT_TAB;\nlet isInitialized = false;\nlet _cachedProjectData = null; // Cache for current project data\n\n// =====================\n// TAB MANAGEMENT\n// =====================\n\n/**\n * Switch to a specific tab\n */\nfunction switchTab(tabId) {\n  if (!TABS.includes(tabId)) {\n    console.warn(`[ProjectDetail] Invalid tab: ${tabId}`);\n    return;\n  }\n\n  currentTab = tabId;\n\n  // Update tab buttons\n  const tabBtns = document.querySelectorAll('#view-project-detail .v2-tab-btn');\n  tabBtns.forEach(btn => {\n    const isActive = btn.dataset.tab === tabId;\n    btn.classList.toggle('active', isActive);\n    btn.setAttribute('aria-selected', isActive ? 'true' : 'false');\n  });\n\n  // Update tab panes\n  const tabPanes = document.querySelectorAll('#view-project-detail .v2-tab-pane');\n  tabPanes.forEach(pane => {\n    const isActive = pane.id === `tab-${tabId}`;\n    pane.classList.toggle('active', isActive);\n    pane.hidden = !isActive;\n  });\n\n  // Dispatch event\n  document.dispatchEvent(new CustomEvent('v2:tabchange', {\n    detail: { tab: tabId, project: currentProject }\n  }));\n\n  if (tabId === 'power') {\n    // Slight delay to ensure visibility transitions finish if any\n    setTimeout(() => renderV2Diagram(), 10);\n  }\n}\n\n/**\n * Get current tab\n */\nfunction getCurrentTab() {\n  return currentTab;\n}\n\n// =====================\n// DATA HELPERS\n// =====================\n\n/**\n * Format a date for display\n */\nfunction formatDate(dateStr) {\n  if (!dateStr) return '';\n  try {\n    const date = new Date(dateStr);\n    return date.toLocaleDateString(undefined, {\n      month: 'short',\n      day: 'numeric',\n      year: 'numeric'\n    });\n  } catch (_e) {\n    void _e;\n    return '';\n  }\n}\n\n/**\n * Format a date range string \"YYYY-MM-DD to YYYY-MM-DD\"\n */\nfunction formatDateRange(rangeStr) {\n  if (!rangeStr || typeof rangeStr !== 'string') return '';\n  const parts = rangeStr.split(' to ');\n  if (parts.length === 1) return formatDate(parts[0]);\n  if (parts.length === 2) {\n    return `${formatDate(parts[0])} - ${formatDate(parts[1])}`;\n  }\n  return rangeStr;\n}\n\n/**\n * Translation Helper\n */\nfunction _t(path, params = {}) {\n  const lang = document.documentElement.lang || 'en';\n  let root = (window.texts && window.texts[lang]) ? window.texts[lang] : null;\n  if (!root && window.texts) root = window.texts['en'];\n\n  const resolve = (obj, p) => p.split('.').reduce((o, i) => o ? o[i] : null, obj);\n\n  let val = root ? resolve(root, path) : null;\n\n  if (!val && lang !== 'en' && window.texts && window.texts['en']) {\n    val = resolve(window.texts['en'], path);\n  }\n\n  if (!val) return path;\n\n  if (typeof val === 'string') {\n    for (const [k, v] of Object.entries(params)) {\n      val = val.replace(`{${k}}`, v);\n    }\n  }\n  return val;\n}\n\n/**\n * Get project data from storage\n */\n/**\n * Refresh the project data cache\n */\nfunction refreshProjectDataCache() {\n  // [Fix] Try to load from centralized cineStorage cache first (supports IndexedDB/Migration)\n  if (global.cineStorage && typeof global.cineStorage.getProjectMemoryCache === 'function') {\n    try {\n      const cache = global.cineStorage.getProjectMemoryCache();\n      if (cache) {\n        _cachedProjectData = {};\n        Object.keys(cache).forEach(key => {\n          let name = key;\n          // Handle sharded keys like user_uuid_cameraPowerPlanner_prj_TestProject\n          if (key.includes('cameraPowerPlanner_prj_')) {\n            const parts = key.split('cameraPowerPlanner_prj_');\n            if (parts.length > 1 && parts[1]) {\n              name = parts[1];\n            }\n          }\n          // Handle monolith if expanded (unlikely in memory cache but possible?)\n          // Memory cache keys are storage keys. \n\n          // Map to simple name for this view\n          _cachedProjectData[name] = cache[key];\n        });\n        console.log('[ProjectDetail] Cache refreshed from cineStorage. Keys:', Object.keys(_cachedProjectData).length);\n        return;\n      }\n    } catch (e) {\n      console.warn('[ProjectDetail] Failed to read from cineStorage cache:', e);\n    }\n  }\n\n  try {\n    const stored = localStorage.getItem(STORAGE_KEY);\n    if (stored) {\n      _cachedProjectData = JSON.parse(stored);\n    } else {\n      _cachedProjectData = {};\n    }\n  } catch (e) {\n    console.error('[ProjectDetail] Failed to parse project data:', e);\n    _cachedProjectData = {};\n  }\n}\n\n/**\n * Get project data from storage (via cache)\n */\nfunction getProjectData(projectName) {\n  if (_cachedProjectData === null) {\n    refreshProjectDataCache();\n  }\n\n  if (_cachedProjectData && _cachedProjectData[projectName]) {\n    const project = _cachedProjectData[projectName];\n    return {\n      prepDays: project.prepDays || [],\n      shootingDays: project.shootingDays || [],\n      returnDays: project.returnDays || [],\n      status: project.status || (project.archived ? 'Archived' : 'Planning')\n    };\n  }\n\n  return { prepDays: [], shootingDays: [], returnDays: [], status: 'Planning' };\n}\n\n/**\n * Update project status\n */\n/**\n * Update project status\n */\nfunction updateProjectStatus(projectName, status) {\n  try {\n    // Ensure cache is fresh\n    refreshProjectDataCache();\n    const data = _cachedProjectData || {};\n\n    if (data && data[projectName]) {\n      data[projectName].status = status;\n\n      // Sync archived flag\n      if (status === 'Archived') {\n        data[projectName].archived = true;\n      } else {\n        data[projectName].archived = false;\n      }\n\n      const statusUpdateError = _t('v2.detail.errors.statusUpdateFailed');\n      let didPersist = false;\n\n      if (global.cineStorage && typeof global.cineStorage.saveProject === 'function') {\n        global.cineStorage.saveProject(projectName, data[projectName]);\n        didPersist = true;\n      } else if (typeof global.saveProject === 'function') {\n        global.saveProject(projectName, data[projectName]);\n        didPersist = true;\n      } else if (typeof global.resolveSafeLocalStorage === 'function') {\n        const safeStorage = global.resolveSafeLocalStorage();\n        if (safeStorage) {\n          safeStorage.setItem(STORAGE_KEY, JSON.stringify(data));\n          didPersist = true;\n        }\n      } else if (global.cineStorage && typeof global.cineStorage.safeSetLocalStorage === 'function') {\n        global.cineStorage.safeSetLocalStorage(STORAGE_KEY, JSON.stringify(data));\n        didPersist = true;\n      }\n\n      if (!didPersist) {\n        alert(statusUpdateError);\n        return false;\n      }\n\n      // Update cache - strictly not needed as we modified the object in place, but safe\n      _cachedProjectData = data;\n\n      return true;\n    }\n  } catch (e) {\n    console.error('[ProjectDetail] Failed to update status:', e);\n    alert(_t('v2.detail.errors.statusUpdateFailed'));\n  }\n  return false;\n}\n\n// =====================\n// PROJECT LOADING\n// =====================\n\n/**\n * Load project data into the detail view\n */\nasync function loadProject(projectName) {\n  if (!projectName) {\n    console.warn('[ProjectDetail] No project name provided');\n    return false;\n  }\n\n  // Force refresh cache to ensure we have the latest data from persistence\n  refreshProjectDataCache();\n\n  currentProject = projectName;\n\n  // Update project name in header\n  const nameElement = document.getElementById('v2ProjectName');\n  if (nameElement) {\n    nameElement.textContent = projectName;\n  }\n\n  // Load project via legacy shim\n  if (global.cineLegacyShim) {\n    await global.cineLegacyShim.loadProject(projectName);\n  }\n\n  // Update Project Periods in Header\n  const projectData = getProjectData(projectName);\n  const periodsContainer = document.getElementById('v2ProjectPeriods');\n  const statusSelect = document.getElementById('v2ProjectStatus');\n\n  // Update Status Select\n  if (statusSelect) {\n    statusSelect.value = projectData.status;\n    updateStatusSelectStyle(statusSelect);\n\n    // Remove old listeners to prevent duplicates (cloning is a quick hack)\n    const statusSelectParent = statusSelect.parentNode;\n    const newSelect = statusSelectParent ? statusSelect.cloneNode(true) : statusSelect;\n    if (statusSelectParent) {\n      statusSelectParent.replaceChild(newSelect, statusSelect);\n    }\n\n    newSelect.addEventListener('change', (e) => {\n      const newStatus = e.target.value;\n      updateProjectStatus(projectName, newStatus);\n      updateStatusSelectStyle(newSelect);\n\n      // If archived, maybe we should warn or just do it?\n      // For now just do it.\n    });\n  }\n\n  if (periodsContainer) {\n    let html = '';\n\n    // Render all Prep dates\n    if (Array.isArray(projectData.prepDays)) {\n      projectData.prepDays.forEach(range => {\n        const fmt = formatDateRange(range);\n        if (fmt) html += `<span class=\"v2-header-badge prep\" title=\"Prep Dates: ${fmt}\"><span class=\"period-icon\"></span> ${fmt}</span>`;\n      });\n    }\n\n    // Render all Shoot dates\n    if (Array.isArray(projectData.shootingDays)) {\n      projectData.shootingDays.forEach(range => {\n        const fmt = formatDateRange(range);\n        if (fmt) html += `<span class=\"v2-header-badge shoot\" title=\"Shooting Dates: ${fmt}\"><span class=\"period-icon\"></span> ${fmt}</span>`;\n      });\n    }\n\n    // Render all Return dates\n    if (Array.isArray(projectData.returnDays)) {\n      projectData.returnDays.forEach(range => {\n        const fmt = formatDateRange(range);\n        if (fmt) html += `<span class=\"v2-header-badge return\" title=\"Return Dates: ${fmt}\"><span class=\"period-icon\"></span> ${fmt}</span>`;\n      });\n    }\n\n    periodsContainer.innerHTML = html;\n    periodsContainer.style.display = html ? 'flex' : 'none';\n  }\n\n  // No need to manually sync if we are reparenting the actual live elements\n  // But we might want to trigger a refresh just in case\n\n  console.log(`[ProjectDetail] Loaded project: ${projectName}`);\n  return true;\n}\n\n/**\n * Get current project name\n */\nfunction getCurrentProject() {\n  return currentProject;\n}\n\n// =====================\n// BACK NAVIGATION\n// =====================\n\n/**\n * Navigate back to projects dashboard\n */\nfunction goBack() {\n  if (global.cineViewManager) {\n    global.cineViewManager.showView('projects');\n  }\n}\n\n// =====================\n// VIEW RENDERING\n// =====================\n\n/**\n * Create the project detail view container if it doesn't exist\n */\nfunction createViewContainer() {\n  if (document.getElementById(VIEW_ID)) return document.getElementById(VIEW_ID);\n\n  const view = document.createElement('section');\n  view.id = VIEW_ID;\n  view.className = 'app-view';\n  // Initially hidden\n\n  const v2Main = document.querySelector('.v2-main');\n  if (v2Main) {\n    v2Main.appendChild(view);\n  }\n  return view;\n}\n\n/**\n * Create the project detail view HTML\n */\nfunction createDetailViewContent() {\n  const view = createViewContainer();\n  if (!view) return;\n\n  // ... rest of content generation ...\n\n  view.innerHTML = `\n      <header class=\"view-header view-header-with-back\">\n        <button type=\"button\" class=\"v2-back-btn\" id=\"v2BackToProjects\" aria-label=\"${_t('v2.detail.backButton')}\">\n          <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <path d=\"M15 18l-6-6 6-6\"/>\n          </svg>\n          <span>${_t('v2.detail.backButton')}</span>\n        </button>\n        <h1 id=\"v2ProjectName\" class=\"view-header-title\">Project</h1>\n        <div class=\"v2-header-status\">\n            <select id=\"v2ProjectStatus\" class=\"v2-status-select\">\n                <option value=\"Draft\">${_t('v2.dashboard.status.draft')}</option>\n                <option value=\"Planning\">${_t('v2.dashboard.status.planning')}</option>\n                <option value=\"Waiting for Approval\">${_t('v2.dashboard.status.waitingForApproval')}</option>\n                <option value=\"Approved\">${_t('v2.dashboard.status.approved')}</option>\n                <option value=\"Shooting\">${_t('v2.dashboard.status.shooting')}</option>\n                <option value=\"Completed\">${_t('v2.dashboard.status.completed')}</option>\n                <option value=\"Archived\">${_t('v2.dashboard.status.archived')}</option>\n            </select>\n        </div>\n        <div id=\"v2ProjectPeriods\" class=\"v2-header-periods\" style=\"display: none;\"></div>\n        <div class=\"view-header-actions\">\n          <button type=\"button\" class=\"v2-btn v2-btn-ghost\" id=\"v2PrintProjectBtn\" title=\"${_t('v2.detail.header.print')}\">\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n              <polyline points=\"6 9 6 2 18 2 18 9\"></polyline>\n              <path d=\"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2\"></path>\n              <rect x=\"6\" y=\"14\" width=\"12\" height=\"8\"></rect>\n            </svg>\n          </button>\n          <button type=\"button\" class=\"v2-btn v2-btn-ghost\" id=\"v2GenerateReqsGearBtn\" title=\"${_t('v2.detail.header.generateReqs')}\">\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n               <path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path>\n               <polyline points=\"14 2 14 8 20 8\"></polyline>\n               <line x1=\"16\" y1=\"13\" x2=\"8\" y2=\"13\"></line>\n               <line x1=\"16\" y1=\"17\" x2=\"8\" y2=\"17\"></line>\n               <line x1=\"10\" y1=\"9\" x2=\"8\" y2=\"9\"></line>\n            </svg>\n            <span class=\"v2-btn-label\">${_t('v2.detail.header.generateReqs')}</span>\n          </button>\n          <button type=\"button\" class=\"v2-btn v2-btn-ghost\" id=\"v2ExportProjectBtn\" title=\"${_t('v2.detail.header.export')}\">\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n               <path d=\"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8\"/>\n               <polyline points=\"16 6 12 2 8 6\"/>\n               <line x1=\"12\" y1=\"2\" x2=\"12\" y2=\"15\"/>\n            </svg>\n            <span class=\"v2-btn-label\">${_t('v2.detail.header.export')}</span>\n          </button>\n          <button type=\"button\" class=\"v2-btn v2-btn-ghost\" id=\"v2GenerateOverviewBtn\" title=\"${_t('v2.detail.header.generateOverview')}\">\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n               <path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"></path>\n               <polyline points=\"14 2 14 8 20 8\"></polyline>\n               <line x1=\"16\" y1=\"13\" x2=\"8\" y2=\"13\"></line>\n               <line x1=\"16\" y1=\"17\" x2=\"8\" y2=\"17\"></line>\n               <line x1=\"10\" y1=\"9\" x2=\"8\" y2=\"9\"></line>\n            </svg>\n            <span class=\"v2-btn-label\">${_t('v2.detail.header.generateOverview')}</span>\n          </button>\n          <button type=\"button\" class=\"v2-btn v2-btn-secondary\" id=\"v2SaveProjectBtn\">\n            ${_t('v2.detail.header.save')}\n          </button>\n        </div>\n      </header>\n\n\n      \n      <!-- Tab Navigation (Sticky Top) -->\n      <nav class=\"v2-tabs-nav\" role=\"tablist\" aria-label=\"Project sections\">\n        <button type=\"button\" class=\"v2-tab-btn active\" data-tab=\"camera\" role=\"tab\" aria-selected=\"true\" aria-controls=\"tab-camera\">\n          ${_t('v2.detail.tabs.cameraPackage')}\n        </button>\n        <button type=\"button\" class=\"v2-tab-btn\" data-tab=\"power\" role=\"tab\" aria-selected=\"false\" aria-controls=\"tab-power\">\n          ${_t('v2.detail.tabs.powerSummary')}\n        </button>\n        <button type=\"button\" class=\"v2-tab-btn\" data-tab=\"requirements\" role=\"tab\" aria-selected=\"false\" aria-controls=\"tab-requirements\">\n          ${_t('v2.detail.tabs.requirements')}\n        </button>\n        <button type=\"button\" class=\"v2-tab-btn\" data-tab=\"kit\" role=\"tab\" aria-selected=\"false\" aria-controls=\"tab-kit\">\n          ${_t('v2.detail.tabs.gearList')}\n        </button>\n      </nav>\n\n      <div class=\"view-content\">\n        <!-- Tab Content -->\n        <div class=\"v2-tab-content\" style=\"padding-top: var(--v2-space-lg);\">\n          <!-- Camera Package Tab -->\n          <section id=\"tab-camera\" class=\"v2-tab-pane active\" role=\"tabpanel\" aria-labelledby=\"tab-camera-btn\">\n            ${renderCameraPackageTab()}\n          </section>\n          \n          <!-- Power Summary Tab -->\n          <section id=\"tab-power\" class=\"v2-tab-pane\" role=\"tabpanel\" aria-labelledby=\"tab-power-btn\" hidden>\n            ${renderPowerSummaryTab()}\n          </section>\n          \n          <!-- Requirements Tab -->\n          <section id=\"tab-requirements\" class=\"v2-tab-pane\" role=\"tabpanel\" aria-labelledby=\"tab-requirements-btn\" hidden>\n            <div class=\"v2-card\">\n              <div class=\"v2-card-header\">\n                <h2>${_t('v2.detail.actions.projectRequirements')}</h2>\n                <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"v2GenerateRequirementsBtn\">\n                  ${_t('v2.detail.actions.generateRequirements')}\n                </button>\n              </div>\n              <div class=\"v2-card-body\" id=\"v2RequirementsContainer\">\n                <p class=\"v2-text-muted\">${_t('v2.detail.actions.generateRequirementsHelp')}</p>\n                <div data-reparent=\"projectForm\"></div>\n                <div id=\"v2RequirementsOutput\" class=\"v2-requirements-output\" style=\"margin-top: var(--v2-space-md);\"></div>\n              </div>\n            </div>\n          </section>\n          \n          <!-- Gear List Tab -->\n          <section id=\"tab-kit\" class=\"v2-tab-pane\" role=\"tabpanel\" aria-labelledby=\"tab-kit-btn\" hidden>\n            <div class=\"v2-card\">\n              <div class=\"v2-card-header\">\n                <h2>${_t('v2.detail.actions.gearList')}</h2>\n                <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"v2GenerateGearListBtn\">\n                  ${_t('v2.detail.actions.generateGearList')}\n                </button>\n              </div>\n              <div class=\"v2-card-body\" id=\"v2KitListContainer\">\n                <p class=\"v2-text-muted\">${_t('v2.detail.actions.generateGearListHelp')}</p>\n              </div>\n            </div>\n          </section>\n        </div>\n      </div>\n    `;\n\n  bindDetailViewEvents(view);\n\n  // Reparent legacy elements immediately\n  setTimeout(() => reparentLegacyElements(view), 0);\n}\n\n/**\n * Render Camera Package tab content\n * Note: We render *containers* for the legacy selects, not the selects themselves.\n */\nfunction renderCameraPackageTab() {\n  return `\n      <div id=\"v2-setup-config\" style=\"padding: 0; margin: 0;\">\n        <div class=\"form-row\">\n          <label for=\"cameraSelect\" id=\"cameraLabel\">Camera:</label>\n          <div data-reparent=\"cameraSelect\"></div>\n        </div>\n        \n        <div class=\"form-row\" id=\"monitorSelectRow\">\n          <label for=\"monitorSelect\" id=\"monitorLabel\">Monitor:</label>\n          <div data-reparent=\"monitorSelect\"></div>\n        </div>\n        \n        <div class=\"form-row\" id=\"wirelessVideoRow\">\n          <label for=\"videoSelect\" id=\"videoLabel\">Wireless Transmitter:</label>\n          <div data-reparent=\"videoSelect\"></div>\n        </div>\n\n        <fieldset id=\"fizFieldset\">\n          <legend id=\"fizLegend\">FIZ (Follow Focus) Systems</legend>\n          <div class=\"form-row\">\n            <label for=\"motor1Select\" id=\"fizMotorsLabel\">FIZ Motors:</label>\n            <div data-reparent=\"motor1Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"motor2Select\"></label>\n            <div data-reparent=\"motor2Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"motor3Select\"></label>\n            <div data-reparent=\"motor3Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"motor4Select\"></label>\n            <div data-reparent=\"motor4Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"controller1Select\" id=\"fizControllersLabel\">FIZ Controllers:</label>\n            <div data-reparent=\"controller1Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"controller2Select\"></label>\n            <div data-reparent=\"controller2Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"controller3Select\"></label>\n            <div data-reparent=\"controller3Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"controller4Select\"></label>\n            <div data-reparent=\"controller4Select\"></div>\n          </div>\n          <div class=\"form-row\">\n            <label for=\"distanceSelect\" id=\"distanceLabel\">Distance Sensor:</label>\n            <div data-reparent=\"distanceSelect\"></div>\n          </div>\n        </fieldset>\n\n        <div class=\"form-row\" id=\"batteryPlateRow\">\n          <label for=\"batteryPlateSelect\" id=\"batteryPlateLabel\">Battery Plate:</label>\n          <div data-reparent=\"batteryPlateSelect\"></div>\n        </div>\n\n        <div class=\"form-row\" id=\"batterySelectRow\">\n          <label for=\"batterySelect\" id=\"batteryLabel\">Battery:</label>\n          <div data-reparent=\"batterySelect\"></div>\n        </div>\n\n        <div class=\"form-row\" id=\"batteryHotswapRow\">\n          <label for=\"batteryHotswapSelect\" id=\"batteryHotswapLabel\">Battery Hotswap:</label>\n          <div data-reparent=\"batteryHotswapSelect\"></div>\n        </div>\n      </div>\n    `;\n}\n\n/**\n * Re-parent legacy elements into the V2 view\n */\nfunction reparentLegacyElements(view) {\n  const containers = view.querySelectorAll('[data-reparent]');\n  containers.forEach(container => {\n    const legacyId = container.dataset.reparent;\n    const legacyElement = document.getElementById(legacyId);\n\n    if (legacyElement) {\n      // Ensure it's visible (legacy might hide it)\n      // ONLY force display block for inputs/selects which are expected to be always visible in V2 forms.\n      // For dynamic containers (results), preserve their existing display state (handled by CSS/JS).\n      const tagName = legacyElement.tagName.toLowerCase();\n      if (['select', 'input', 'textarea'].includes(tagName)) {\n        legacyElement.style.display = 'block';\n        legacyElement.classList.add('v2-' + tagName); // Add v2-input class etc\n\n        // For inputs, we generally want 100% width in V2 forms\n        legacyElement.style.width = '100%';\n        legacyElement.style.height = '';\n        legacyElement.style.minHeight = '';\n      } else if (tagName === 'form') {\n        // Special handling for the project details form\n        legacyElement.style.display = 'block';\n        legacyElement.style.position = 'static'; // Reset modal positioning\n        legacyElement.style.visibility = 'visible';\n        legacyElement.style.width = '100%';\n        legacyElement.classList.add('v2-reparented-form');\n      } else {\n        // For divs, uls, etc., do NOT reset display or width blindly as it breaks flex layouts (hero card)\n        // Just ensure they aren't constrained by previous inline styles if reasonable, \n        // but 'display' should be left to CSS classes (.hidden handling).\n\n        // Optional: if we want to ensure full width container:\n        // legacyElement.style.width = '100%'; \n\n        // Check if it's one of the result elements? \n        // Actually, for results we want them to behave naturally.\n      }\n\n      legacyElement.style.whiteSpace = '';\n\n      // Check if the element has a wrapper (which holds the favorite button)\n\n      // Check if the element has a wrapper (which holds the favorite button)\n      const wrapper = legacyElement.closest('.select-wrapper');\n      const elementToMove = wrapper || legacyElement;\n\n      // Ensure wrapper also behaves if present\n      if (wrapper) {\n        wrapper.classList.add('v2-select-container'); // Helper class if needed in CSS\n        wrapper.style.width = '100%';\n      }\n\n      // Replace the placeholder container with the legitimate legacy wrapper/element\n      // This ensures the DOM structure matches V1 exactly: .form-row > .select-wrapper > select\n      container.parentNode.replaceChild(elementToMove, container);\n\n    } else {\n      console.warn(`[ProjectDetail] Legacy element not found: ${legacyId}`);\n      container.innerHTML = '<span class=\"v2-error-text\">Element missing</span>';\n    }\n  });\n}\n\n/**\n * Render Power Summary tab content  \n */\nfunction renderPowerSummaryTab() {\n  return `\n      <div class=\"v2-power-grid\">\n        <!-- V1 Results Reparented -->\n        <div id=\"v2-results-legacy-wrapper\" class=\"v2-results-reparented\">\n          <!-- Hero Card -->\n          <div data-reparent=\"heroCard\"></div>\n\n          <!-- Warnings -->\n          <div data-reparent=\"pinWarning\"></div>\n          <div data-reparent=\"dtapWarning\"></div>\n          <div data-reparent=\"hotswapWarning\"></div>\n\n          <!-- Breakdown List -->\n          <ul data-reparent=\"breakdownList\"></ul>\n\n          <!-- Power Diagram -->\n          <div data-reparent=\"powerDiagram\"></div>\n\n          <!-- Plain Summary -->\n          <div data-reparent=\"resultsPlainSummary\"></div>\n\n          <!-- Temperature Note -->\n          <div data-reparent=\"temperatureNote\"></div>\n          \n          <!-- Feedback Button -->\n          <div data-reparent=\"runtimeFeedbackBtn\"></div>\n          <div data-reparent=\"feedbackTableContainer\"></div>\n        </div>\n\n        <!-- Connection Diagram Card (V2 Wrapper) -->\n        <div class=\"v2-card v2-diagram-card\" style=\"margin-top: var(--v2-space-lg);\">\n          <div class=\"v2-card-header v2-card-header-with-actions\">\n            <h3>Connection Diagram</h3>\n            <div class=\"v2-diagram-toolbar\">\n               <button type=\"button\" class=\"v2-btn v2-btn-sm v2-btn-ghost\" id=\"v2ZoomOut\" title=\"${_t('v2.detail.diagram.zoomOut')}\">\n                 <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"></line></svg>\n               </button>\n               <button type=\"button\" class=\"v2-btn v2-btn-sm v2-btn-ghost\" id=\"v2ResetView\" title=\"${_t('v2.detail.diagram.resetView')}\">\n                 <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"11\" cy=\"11\" r=\"8\"></circle><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"></line></svg>\n               </button>\n               <button type=\"button\" class=\"v2-btn v2-btn-sm v2-btn-ghost\" id=\"v2ZoomIn\" title=\"${_t('v2.detail.diagram.zoomIn')}\">\n                 <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"></line><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"></line></svg>\n               </button>\n               <div class=\"v2-vr\"></div>\n               <button type=\"button\" class=\"v2-btn v2-btn-sm v2-btn-ghost\" id=\"v2DownloadDiagram\" title=\"${_t('v2.detail.diagram.download')}\">\n                 <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"></path><polyline points=\"7 10 12 15 17 10\"></polyline><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"></line></svg>\n               </button>\n            </div>\n          </div>\n          <div class=\"v2-card-body v2-diagram-body\">\n            <div id=\"v2-diagram-area\" class=\"v2-diagram-area\"></div>\n            <div id=\"v2-diagram-legend\" class=\"v2-diagram-legend\"></div>\n            <!-- Hidden containers required by module -->\n            <div id=\"v2-diagram-hint\" style=\"display:none;\"></div>\n          </div>\n        </div>\n\n        <!-- Battery Comparison -->\n        <div class=\"v2-card\" style=\"margin-top: var(--v2-space-lg);\">\n          <div class=\"v2-card-body\" style=\"padding: 0;\">\n             <div data-reparent=\"batteryComparison\" class=\"v2-reparent-full-width\"></div>\n          </div>\n        </div>\n      </div>\n    `;\n}\n\n/**\n * Bind events for the Detail View\n */\nfunction bindDetailViewEvents(view) {\n  // Back button\n  const backBtn = view.querySelector('#v2BackToProjects');\n  if (backBtn) {\n    backBtn.addEventListener('click', goBack);\n  }\n\n  // Print button\n  const printBtn = view.querySelector('#v2PrintProjectBtn');\n  if (printBtn) {\n    printBtn.addEventListener('click', () => {\n      // Intercept for Status Check\n      if (confirm('Do you want to set the project status to \"Waiting for Approval\"?')) {\n        updateProjectStatus(currentProject, 'Waiting for Approval');\n        const statusSelect = document.getElementById('v2ProjectStatus');\n        if (statusSelect) {\n          statusSelect.value = 'Waiting for Approval';\n          updateStatusSelectStyle(statusSelect);\n        }\n      }\n\n      console.log('[ProjectDetail] Triggering Print/Export');\n      if (typeof window.openLegacyPrintDialog === 'function') {\n        window.openLegacyPrintDialog();\n        return;\n      }\n\n      // Fallback\n      if (global.cineFeaturePrint && typeof global.cineFeaturePrint.triggerOverviewPrintWorkflow === 'function') {\n        global.cineFeaturePrint.triggerOverviewPrintWorkflow({}, { reason: 'export' });\n      } else if (typeof global.triggerOverviewPrintWorkflow === 'function') {\n        global.triggerOverviewPrintWorkflow({}, { reason: 'export' });\n      } else {\n        window.print();\n      }\n    });\n  }\n\n  // Save button\n  const saveBtn = view.querySelector('#v2SaveProjectBtn');\n  if (saveBtn) {\n    saveBtn.addEventListener('click', () => {\n      if (global.cineLegacyShim && currentProject) {\n        const legacySaveBtn = document.getElementById('saveSetupBtn');\n        if (legacySaveBtn) legacySaveBtn.click();\n      }\n    });\n  }\n\n\n\n  /**\n   * Helper to open the Requirements Form with synced dates\n   */\n  function openProjectRequirementsForm() {\n    if (!currentProject) return;\n\n    // 1. Get V2 Project Data\n    const v2Data = getProjectData(currentProject);\n\n    // 2. Get Legacy Info\n    let projectInfoForForm = {};\n    if (global.getCurrentProjectInfo && typeof global.getCurrentProjectInfo === 'function') {\n      projectInfoForForm = global.getCurrentProjectInfo();\n    } else {\n      // Fallback if global info not ready (shouldn't happen if project loaded)\n      projectInfoForForm = { projectName: currentProject };\n    }\n\n    // 3. Merge Dates\n    // We use Object.assign to create a fresh object with enforced V2 dates\n    const mergedInfo = Object.assign({}, projectInfoForForm, {\n      prepDays: v2Data.prepDays || [],\n      shootingDays: v2Data.shootingDays || [],\n      returnDays: v2Data.returnDays || [],\n      projectName: currentProject\n    });\n\n    // 4. Populate Form\n    if (global.populateProjectForm && typeof global.populateProjectForm === 'function') {\n      global.populateProjectForm(mergedInfo);\n    } else {\n      console.warn('[ProjectDetail] populateProjectForm not found');\n    }\n\n    // 5. Switch to Tab\n    switchTab('requirements');\n\n    // Scroll top\n    const tab = document.getElementById('tab-requirements');\n    if (tab) tab.scrollIntoView({ behavior: 'smooth' });\n  }\n\n  // Generate Requirements & Gear List Button (Header)\n  const headerReqsGearBtn = view.querySelector('#v2GenerateReqsGearBtn');\n  if (headerReqsGearBtn) {\n    headerReqsGearBtn.addEventListener('click', () => {\n      openProjectRequirementsForm();\n    });\n  }\n\n  // Export button (header icon)\n  const headerExportBtn = view.querySelector('#v2ExportProjectBtn');\n  if (headerExportBtn) {\n    headerExportBtn.addEventListener('click', () => {\n      const legacyExportBtn = document.getElementById('shareSetupBtn');\n      if (legacyExportBtn) legacyExportBtn.click();\n    });\n  }\n\n  // Generate Overview Button (action bar)\n  const headerOverviewBtn = view.querySelector('#v2GenerateOverviewBtn');\n  if (headerOverviewBtn) {\n    headerOverviewBtn.addEventListener('click', () => {\n      const legacyBtn = document.getElementById('generateOverviewBtn');\n      if (legacyBtn) legacyBtn.click();\n    });\n  }\n\n  // Requirements Tab \"Save & Generate\" Button\n  const requirementsTabSaveBtn = view.querySelector('#v2GenerateRequirementsBtn');\n  if (requirementsTabSaveBtn) {\n    requirementsTabSaveBtn.innerHTML = '<i class=\"fas fa-save\"></i> Save & Generate Gear List';\n    requirementsTabSaveBtn.addEventListener('click', () => {\n      // 1. Collect Form Data\n      let collectedFormData = {};\n      if (global.collectProjectFormData && typeof global.collectProjectFormData === 'function') {\n        collectedFormData = global.collectProjectFormData();\n      } else {\n        console.warn('[ProjectDetail] collectProjectFormData not found');\n      }\n\n      // 2. Update Global State\n      // Note: generateGearListHtml uses the passed argument, but we should also ensure app state is consistent if possible.\n      // But relying on formData passed to generator is the safest V1 patterns.\n\n      // 3. Generate Content\n      let generatedHtml = '';\n      if (global.generateGearListHtml && typeof global.generateGearListHtml === 'function') {\n        generatedHtml = global.generateGearListHtml(collectedFormData);\n      } else {\n        alert('Error: Generator module not found.');\n        return;\n      }\n\n      // 4. Split and Inject\n      if (global.getSafeGearListHtmlSections && typeof global.getSafeGearListHtmlSections === 'function') {\n        const gearHtmlSections = global.getSafeGearListHtmlSections(generatedHtml);\n\n\n        // Inject Project Requirements Output\n        const reqsContainer = document.getElementById('v2RequirementsOutput');\n        if (reqsContainer) {\n          if (gearHtmlSections.projectHtml) {\n            reqsContainer.innerHTML = gearHtmlSections.projectHtml;\n            reqsContainer.style.display = 'block';\n          } else {\n            reqsContainer.style.display = 'none';\n          }\n        }\n\n        // Inject Gear List\n        const kitContainer = document.getElementById('v2KitListContainer');\n        if (kitContainer && gearHtmlSections.gearHtml) {\n          kitContainer.innerHTML = gearHtmlSections.gearHtml;\n        } else if (kitContainer) {\n          kitContainer.innerHTML = '<p class=\"v2-text-muted\">No gear list items generated.</p>';\n        }\n\n        alert('Requirements Saved & Gear List Generated!');\n      }\n    });\n  }\n\n  // Gear List Tab \"Generate\" Button\n  const gearTabGenerateBtn = view.querySelector('#v2GenerateGearListBtn');\n  if (gearTabGenerateBtn) {\n    gearTabGenerateBtn.addEventListener('click', () => {\n      openProjectRequirementsForm();\n    });\n  }\n\n  // Tab buttons\n  const tabBtns = view.querySelectorAll('.v2-tab-btn');\n  tabBtns.forEach(btn => {\n    btn.addEventListener('click', () => {\n      const tabId = btn.dataset.tab;\n      switchTab(tabId);\n    });\n  });\n\n  // Download Diagram button\n  const downloadDiagramBtn = view.querySelector('#v2DownloadDiagram');\n  if (downloadDiagramBtn) {\n    downloadDiagramBtn.addEventListener('click', (e) => {\n      // Trigger the legacy download handler from app-session.js\n      const legacyBtn = document.getElementById('downloadDiagram');\n      if (legacyBtn) {\n        // Create a new event with the same shiftKey state for JPG export\n        const syntheticEvent = new MouseEvent('click', {\n          bubbles: true,\n          cancelable: true,\n          shiftKey: e.shiftKey\n        });\n        legacyBtn.dispatchEvent(syntheticEvent);\n      } else {\n        console.warn('[ProjectDetail] Legacy download button not found');\n      }\n    });\n  }\n\n\n  // Inject Add Custom Buttons\n  setTimeout(() => injectAddCustomButtons(view), 0);\n}\n\n// =====================\n// DIAGRAM RENDERING\n// =====================\n\n\n\n/**\n * Initialize and render the Connection Diagram in V2 container\n */\nfunction renderV2Diagram() {\n  if (!currentProject) return;\n\n  // Check if module is available\n  if (!global.cineFeaturesConnectionDiagram || typeof global.cineFeaturesConnectionDiagram.createConnectionDiagram !== 'function') {\n    console.warn('[ProjectDetail] Connection Diagram module not found.');\n    return;\n  }\n\n  const container = document.getElementById('v2-diagram-area');\n  if (!container) return; // Tab might be hidden or not rendered\n\n  console.log('[ProjectDetail] Rendering Power Diagram...');\n\n  // If we already have an instance, we might want to just let it update?\n  // The current module helper creates a new one every time, but handles cleanups internally if we re-call it?\n  // Actually createConnectionDiagram returns an object with { enableDiagramInteractions, ... }\n  // It clears the container.\n\n  // Ensure the legacy dialog elements are accessible in V2 mode\n  // Move them to the V2 container if they're currently hidden in mainContent\n  const ensureDialogAccessible = () => {\n    const dialog = document.getElementById('diagramDetailDialog');\n    if (dialog && dialog.closest('#mainContent')) {\n      // Move dialog to body so it's not hidden when mainContent is display:none\n      document.body.appendChild(dialog);\n    }\n    return dialog;\n  };\n\n  const context = {\n    // Override UI getters to point to V2 elements\n    getSetupDiagramContainer: () => document.getElementById('v2-diagram-area'),\n    getDiagramLegend: () => document.getElementById('v2-diagram-legend'),\n    getDiagramHint: () => document.getElementById('v2-diagram-hint'),\n    getDownloadDiagramBtn: () => document.getElementById('v2DownloadDiagram'),\n    getZoomInBtn: () => document.getElementById('v2ZoomIn'),\n    getZoomOutBtn: () => document.getElementById('v2ZoomOut'),\n    getResetViewBtn: () => document.getElementById('v2ResetView'),\n\n    // Explicit dialog getters to ensure accessibility in V2 mode\n    getDiagramDetailDialog: ensureDialogAccessible,\n    getDiagramDetailContent: () => document.getElementById('diagramDetailDialogContent'),\n\n    // Use existing global getters for data inputs (since we reparented the actual elements)\n    // The module defaults to GLOBAL_SCOPE.cameraSelect etc. which still works.\n  };\n\n  // Inject diagram CSS if needed\n  if (!document.getElementById('v2-diagram-css')) {\n    const css = (typeof global.cineFeaturesConnectionDiagram.getDiagramCss === 'function')\n      ? global.cineFeaturesConnectionDiagram.getDiagramCss(false)\n      : '';\n\n    if (css) {\n      const style = document.createElement('style');\n      style.id = 'v2-diagram-css';\n      style.textContent = css;\n      document.head.appendChild(style);\n    }\n  }\n\n  try {\n    global.cineFeaturesConnectionDiagram.createConnectionDiagram(context);\n  } catch (e) {\n    console.error('[ProjectDetail] Error rendering diagram:', e);\n  }\n}\n\n/**\n * Helper to update status select style\n */\nfunction updateStatusSelectStyle(selectElement) {\n  const status = selectElement.value;\n  const statusClass = status.toLowerCase().replace(/\\s+/g, '-');\n\n  // Remove all status classes\n  selectElement.classList.remove('draft', 'planning', 'waiting-for-approval', 'approved', 'shooting', 'completed', 'archived');\n\n  // Add current\n  selectElement.classList.add(statusClass);\n}\n\n// =====================\n// DATA SYNC\n// =====================\n\n/**\n * Sync legacy calculation results to V2 UI\n */\nfunction syncLegacyResultsToV2() {\n  // Legacy IDs: heroTotalDraw, heroRuntime, heroBatteryCount, heroCurrent144, heroCurrent12\n  // V2 IDs: v2TotalDraw, v2Runtime, v2BatteryCount, v2Current144, v2Current12\n\n  const map = {\n    'heroTotalDraw': 'v2TotalDraw',\n    'heroRuntime': 'v2Runtime',\n    'heroBatteryCount': 'v2BatteryCount',\n    'heroCurrent144': 'v2Current144',\n    'heroCurrent12': 'v2Current12'\n  };\n\n  Object.keys(map).forEach(legacyId => {\n    const legacyEl = document.getElementById(legacyId);\n    const v2El = document.getElementById(map[legacyId]);\n\n    if (legacyEl && v2El) {\n      v2El.textContent = legacyEl.textContent;\n    }\n  });\n\n  // Also refresh diagram if visible\n  if (getCurrentTab() === 'power') {\n    // Debounce slightly to allow legacy calculations to settle if they modify DOM attributes\n    setTimeout(() => renderV2Diagram(), 50);\n  }\n}\n\n/**\n * Setup observer to watch for legacy DOM changes (calculation updates)\n */\nfunction setupPowerObserver() {\n  // Note: We observe the results container, not a specific node.\n  // The observer callback doesn't need to inspect mutations, just re-sync.\n  const legacyResultContainer = document.getElementById('results');\n\n  if (!legacyResultContainer) {\n    console.warn('[ProjectDetail] Legacy results container not found. Auto-sync disabled.');\n    return;\n  }\n\n  const observer = new MutationObserver(() => {\n    syncLegacyResultsToV2();\n  });\n\n  observer.observe(legacyResultContainer, {\n    childList: true,\n    subtree: true,\n    characterData: true\n  });\n\n  console.log('[ProjectDetail] Power observer started');\n}\n\n// =====================\n// INITIALIZATION\n// =====================\n\n/**\n * Initialize module\n */\nfunction init() {\n  if (isInitialized) return;\n  isInitialized = true;\n\n  // Setup power observer\n  setupPowerObserver();\n\n  // [Added by Agent] Initial sync to capture state that existed before observer started\n  syncLegacyResultsToV2();\n\n  // Listen for view changes\n  document.addEventListener('v2:viewchange', handleViewChange);\n\n  // Check if we're already on projectDetail view (handles race condition on page refresh)\n  // ViewManager may have already dispatched the event before we attached our listener\n  if (global.cineViewManager && typeof global.cineViewManager.getCurrentView === 'function') {\n    const currentView = global.cineViewManager.getCurrentView();\n    if (currentView === 'projectDetail') {\n      const currentParams = global.cineViewManager.getCurrentParams ? global.cineViewManager.getCurrentParams() : {};\n      if (currentParams && currentParams.projectId) {\n        console.log('[ProjectDetail] Already on projectDetail, triggering render');\n        handleViewChange({ detail: { view: 'projectDetail', params: currentParams } });\n      }\n    }\n  }\n\n  console.log('[ProjectDetail] Initialized');\n}\n\n/**\n * Handle view change events\n */\nasync function handleViewChange(event) {\n  const { view, params } = event.detail || {};\n\n  if (view === 'projectDetail' && params && params.projectId) {\n    console.log('[ProjectDetail] View change detected, loading:', params.projectId);\n\n    // Get the view container\n    const viewElement = document.getElementById(VIEW_ID);\n    if (!viewElement) {\n      console.warn('[ProjectDetail] View element not found:', VIEW_ID);\n      return;\n    }\n\n    // Create content if not already created\n    // Note: createDetailViewContent() sets innerHTML directly, doesn't return a value\n    if (!viewElement.querySelector('.view-header')) {\n      createDetailViewContent();\n    }\n\n    // Load the project\n    await loadProject(params.projectId);\n\n    // Switch to the requested tab if provided\n    if (params.tab) {\n      switchTab(params.tab);\n    }\n\n    // Handle specific actions (e.g. print)\n    if (params.action === 'print') {\n      console.log('[ProjectDetail] Auto-triggering print workflow');\n      setTimeout(() => {\n        if (global.cineFeaturePrint && typeof global.cineFeaturePrint.triggerOverviewPrintWorkflow === 'function') {\n          global.cineFeaturePrint.triggerOverviewPrintWorkflow({}, { reason: 'export' });\n        } else if (typeof global.triggerOverviewPrintWorkflow === 'function') {\n          global.triggerOverviewPrintWorkflow({}, { reason: 'export' });\n        } else {\n          window.print();\n        }\n      }, 800); // Wait for transitions/render\n    }\n  }\n}\n\n// =====================\n// LEGACY MODAL INTEGRATION\n// =====================\n\n/**\n * Slugify a string (matching legacy logic)\n */\nfunction slugify(text) {\n  if (typeof text !== 'string') return '';\n  return text.trim().toLowerCase()\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-+/, '')\n    .replace(/-+$/, '');\n}\n\n/**\n * Trigger the legacy \"Add Custom Item\" dialog for a specific category\n */\nfunction triggerLegacyAddCustom(translationKey) {\n  // 1. Get localized label\n  const localizedLabel = global.texts ? global.texts[translationKey] : null;\n  if (!localizedLabel) {\n    console.warn(`[ProjectDetail] Translation key not found: ${translationKey}`);\n    return;\n  }\n\n  // 2. Generate slug\n  const slug = slugify(localizedLabel);\n  console.log(`[ProjectDetail] Triggering Add Custom for: ${localizedLabel} (${slug})`);\n\n  // 3. Find the legacy button\n  // The legacy button is in the hidden #gearListOutput table\n  const legacyBtn = document.querySelector(`[data-gear-custom-add=\"${slug}\"]`);\n\n  if (legacyBtn) {\n    legacyBtn.click();\n  } else {\n    console.warn(`[ProjectDetail] Legacy Add Button not found for slug: ${slug}`);\n    // Fallback: If the row doesn't exist yet (empty category), we might need to find the \"Add Custom Item\"\n    // button in a different way or force the category to appear.\n    // However, usually \"Add Custom\" buttons are always present in the legacy view if the category is valid.\n    alert(`Could not open Add Custom dialog for ${localizedLabel}. Legacy element missing.`);\n  }\n}\n\n/**\n * Inject \"+\" buttons into V2 cards\n */\nfunction injectAddCustomButtons(view) {\n  // Definition of where to inject buttons and mapped categories\n  const targets = [\n    { cardId: 'v2-camera-card', key: 'category_cameras' },\n    { cardId: 'v2-power-card', key: 'category_batteries' },\n    // Add more as needed:\n    // { cardId: 'v2-monitor-card', key: 'category_monitors' },\n    // { cardId: 'v2-wireless-card', key: 'category_video' }\n  ];\n\n  targets.forEach(({ cardId, key }) => {\n    const card = view.querySelector(`#${cardId}`);\n    if (!card) return;\n\n    const header = card.querySelector('.v2-card-header');\n    if (!header) return;\n\n    // Prevent duplicate injection\n    if (header.querySelector('.v2-add-custom-btn')) return;\n\n    const btn = document.createElement('button');\n    btn.type = 'button';\n    btn.className = 'v2-btn v2-btn-sm v2-btn-ghost v2-add-custom-btn';\n    btn.title = 'Add Custom Item';\n    btn.innerHTML = `\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"></line>\n          <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"></line>\n        </svg>\n      `;\n\n    btn.addEventListener('click', (e) => {\n      e.stopPropagation();\n      triggerLegacyAddCustom(key);\n    });\n\n    header.appendChild(btn);\n  });\n}\n\n// =====================\n// EXPORTS\n// =====================\n\n// Define the ProjectDetail API object\nconst ProjectDetail = {\n  init,\n  createDetailViewContent,\n  loadProject,\n  getCurrentProject,\n  switchTab,\n  getCurrentTab,\n  syncLegacyResultsToV2\n};\n\n// Expose to global scope for legacy compatibility\nif (typeof global !== 'undefined') {\n  global.cineProjectDetail = ProjectDetail;\n}\n\nif (typeof window !== 'undefined') {\n  window.cineProjectDetail = ProjectDetail;\n}\n\n// ESM export\nexport { ProjectDetail };\n","/**\n * Cine Power Planner V2 - Sidebar View\n * ===================================\n * Builds and mounts the V2 sidebar shell inside #v2-app.\n */\n\n(function (global) {\n    'use strict';\n\n    const SIDEBAR_TEMPLATE = `\n        <nav class=\"v2-sidebar\" aria-label=\"V2 Navigation\">\n          <div class=\"v2-sidebar-header\">\n            <img src=\"src/icons/Icon Bluenew.svg\" alt=\"\" class=\"v2-sidebar-logo\" />\n            <h1 class=\"v2-sidebar-title\">Cine Power Planner</h1>\n          </div>\n          <div class=\"v2-sidebar-nav\">\n            <div class=\"v2-sidebar-section\">\n              <div class=\"v2-sidebar-section-title\">Projects</div>\n\n              <a href=\"#/projects\" class=\"v2-sidebar-link active\" data-view=\"projects\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <path d=\"M3 7v4a1 1 0 001 1h3m10-5v4a1 1 0 01-1 1h-3m-4-5v4M8 12v8m8-8v8M3 12h18\" />\n                  <rect x=\"5\" y=\"3\" width=\"14\" height=\"4\" rx=\"1\" />\n                </svg>\n                <span class=\"v2-sidebar-link-text\">All Projects</span>\n              </a>\n\n              <a href=\"#/projects?filter=active\" class=\"v2-sidebar-link\" data-view=\"projects-active\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <circle cx=\"12\" cy=\"12\" r=\"10\"></circle>\n                  <polyline points=\"12 6 12 12 16 14\"></polyline>\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Active Projects</span>\n              </a>\n\n              <a href=\"#/projects?filter=archive\" class=\"v2-sidebar-link\" data-view=\"projects-archive\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <polyline points=\"21 8 21 21 3 21 3 8\"></polyline>\n                  <rect x=\"1\" y=\"3\" width=\"22\" height=\"5\"></rect>\n                  <line x1=\"10\" y1=\"12\" x2=\"14\" y2=\"12\"></line>\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Archive</span>\n              </a>\n\n              <a href=\"#/backups\" class=\"v2-sidebar-link\" id=\"navAutoBackups\" style=\"display:none;\" data-view=\"backups\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <path d=\"M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5\" />\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Auto Backups</span>\n              </a>\n            </div>\n\n            <div class=\"v2-sidebar-section\">\n              <div class=\"v2-sidebar-section-title\">Tools</div>\n\n              <a href=\"#/devices\" class=\"v2-sidebar-link\" data-view=\"devices\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" ry=\"2\" />\n                  <line x1=\"8\" y1=\"21\" x2=\"16\" y2=\"21\" />\n                  <line x1=\"12\" y1=\"17\" x2=\"12\" y2=\"21\" />\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Device Library</span>\n              </a>\n\n              <a href=\"#/contacts\" class=\"v2-sidebar-link\" data-view=\"contacts\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <path d=\"M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2\" />\n                  <circle cx=\"12\" cy=\"7\" r=\"4\" />\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Contacts</span>\n              </a>\n\n              <a href=\"#/rules\" class=\"v2-sidebar-link\" data-view=\"rules\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <path\n                    d=\"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z\">\n                  </path>\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Auto Gear Rules</span>\n              </a>\n\n              <a href=\"#/own-gear\" class=\"v2-sidebar-link\" data-view=\"ownGear\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <rect x=\"2\" y=\"7\" width=\"20\" height=\"14\" rx=\"2\" ry=\"2\"></rect>\n                  <path d=\"M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16\"></path>\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Owned Gear</span>\n              </a>\n            </div>\n\n            <div class=\"v2-sidebar-section\">\n              <div class=\"v2-sidebar-section-title\">Support</div>\n              <a href=\"#/settings\" class=\"v2-sidebar-link\" data-view=\"settings\">\n                <svg class=\"v2-sidebar-link-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                  <circle cx=\"12\" cy=\"12\" r=\"3\" />\n                  <path\n                    d=\"M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z\" />\n                </svg>\n                <span class=\"v2-sidebar-link-text\">Settings</span>\n              </a>\n              <a href=\"#/help\" class=\"v2-sidebar-link\" data-view=\"help\">\n                <span class=\"v2-sidebar-link-icon icon-glyph icon-text\" aria-hidden=\"true\" data-icon-font=\"uicons\">?</span>\n                <span class=\"v2-sidebar-link-text\">Help</span>\n              </a>\n            </div>\n          </div>\n          <div class=\"v2-sidebar-footer\">\n            <div class=\"v2-sidebar-legal\">\n              <a href=\"legal/impressum-en.html\">Imprint</a>\n              <span class=\"v2-legal-separator\">&middot;</span>\n              <a href=\"legal/datenschutz-en.html\">Privacy Policy</a>\n              <span class=\"v2-legal-separator\">&middot;</span>\n              <button type=\"button\" id=\"v2ExitBtn\" title=\"Return to Classic UI\">Exit V2</button>\n            </div>\n          </div>\n        </nav>\n        <div class=\"v2-sidebar-overlay\"></div>\n    `;\n\n    function buildSidebar() {\n        const app = document.getElementById('v2-app');\n        if (!app) {\n            return false;\n        }\n\n        if (app.querySelector('.v2-sidebar')) {\n            return true;\n        }\n\n        const main = app.querySelector('.v2-main');\n        const template = document.createElement('template');\n        template.innerHTML = SIDEBAR_TEMPLATE.trim();\n\n        if (main) {\n            app.insertBefore(template.content, main);\n        } else {\n            app.appendChild(template.content);\n        }\n\n        return true;\n    }\n\n    function mountSidebar() {\n        if (buildSidebar()) {\n            return;\n        }\n\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', () => {\n                buildSidebar();\n            }, { once: true });\n        }\n    }\n\n    const sidebarView = {\n        mount: mountSidebar\n    };\n\n    global.cineV2SidebarView = sidebarView;\n    if (typeof window !== 'undefined') {\n        window.cineV2SidebarView = sidebarView;\n    }\n})(typeof globalThis !== 'undefined' ? globalThis : window);\n","/* global cineModuleBase */\n\n// (function () {\nfunction detectGlobalScope() {\n  if (typeof globalThis !== 'undefined') {\n    return globalThis;\n  }\n  if (typeof window !== 'undefined') {\n    return window;\n  }\n  if (typeof self !== 'undefined') {\n    return self;\n  }\n  if (typeof global !== 'undefined') {\n    return global;\n  }\n  return {};\n}\n\nconst GLOBAL_SCOPE = detectGlobalScope();\n\nfunction resolveModuleBase(scope) {\n  if (typeof cineModuleBase === 'object' && cineModuleBase) {\n    return cineModuleBase;\n  }\n\n  /*\n  if (typeof require === 'function') {\n    try {\n      const required = require('../base.js');\n      if (required && typeof required === 'object') {\n        return required;\n      }\n    } catch (error) {\n      void error;\n    }\n  }\n  */\n\n  if (scope && typeof scope.cineModuleBase === 'object') {\n    return scope.cineModuleBase;\n  }\n\n  return null;\n}\n\nconst MODULE_BASE = resolveModuleBase(GLOBAL_SCOPE);\n\nconst safeWarn = (MODULE_BASE && typeof MODULE_BASE.safeWarn === 'function')\n  ? MODULE_BASE.safeWarn\n  : function fallbackWarn(message, error) {\n    if (typeof console === 'undefined' || !console || typeof console.warn !== 'function') {\n      return;\n    }\n    if (typeof error === 'undefined') {\n      console.warn(message);\n    } else {\n      console.warn(message, error);\n    }\n  };\n\n/* eslint-disable no-control-regex, no-misleading-character-class */\nconst ZERO_WIDTH_SPACES_PATTERN = /[\\u200B\\u200C\\u200D\\u2060]/g;\nconst SPACE_VARIANTS_PATTERN = /[\\u0009-\\u000D\\u00A0\\u1680\\u180E\\u2000-\\u200A\\u2028\\u2029\\u202F\\u205F\\u3000]/g;\nconst COMBINING_MARKS_PATTERN = /[\\u0300-\\u036F]/g;\nconst DASH_VARIANTS_PATTERN = /[\\u2010-\\u2015\\u2212\\uFE58\\uFE63\\uFF0D]/g;\nconst APOSTROPHE_VARIANTS_PATTERN = /[\\u2018\\u2019\\u201A\\u201B\\u2032\\u2035]/g;\nconst QUOTE_VARIANTS_PATTERN = /[\\u201C\\u201D\\u201E\\u201F\\u2033\\u2036]/g;\nconst SLASH_VARIANTS_PATTERN = /[\\u2044\\u2215]/g;\nconst MULTIPLY_VARIANTS_PATTERN = /[]/g;\nconst DEGREE_VARIANTS_PATTERN = /[]/g;\nconst ELLIPSIS_PATTERN = /[\\u2026]/g;\nconst TRADEMARK_PATTERN = /[\\u00AE\\u2122]/g;\nconst GENERAL_PUNCTUATION_PATTERN = /[!#$%()*,:;<=>?@[\\]^{|}~._]/g;\nconst MEASUREMENT_DOUBLE_PRIME_VARIANTS_PATTERN = /[]/g;\nconst MEASUREMENT_SINGLE_PRIME_VARIANTS_PATTERN = /[]/g;\nconst MEASUREMENT_VALUE_PATTERN = String.raw`\\d+(?:\\s*[.,/-]\\s*\\d+)*(?:\\s+\\d+(?:\\s*[.,/-]\\s*\\d+)*)*`;\nconst MEASUREMENT_FOOT_WORD_PATTERN = new RegExp(\n  String.raw`(${MEASUREMENT_VALUE_PATTERN})[\\s-]*(?:feet|foot|ft\\.?)(?![a-z])`,\n  'gi',\n);\nconst MEASUREMENT_FOOT_PRIME_PATTERN = new RegExp(\n  String.raw`(${MEASUREMENT_VALUE_PATTERN})\\s*['](?=\\s|[\\d\"'-]|$)`,\n  'g',\n);\nconst MEASUREMENT_INCH_WORD_PATTERN = new RegExp(\n  String.raw`(${MEASUREMENT_VALUE_PATTERN})[\\s-]*(?:inches|inch|in\\.?)(?![a-z])`,\n  'gi',\n);\nconst MEASUREMENT_INCH_PRIME_PATTERN = new RegExp(\n  String.raw`(${MEASUREMENT_VALUE_PATTERN})\\s*[\"](?=\\s|[\\d'\"-]|$)`,\n  'g',\n);\n/* eslint-enable no-control-regex, no-misleading-character-class */\n\nfunction cleanMeasurementValue(value) {\n  return typeof value === 'string' ? value.replace(/\\s+/g, ' ').trim() : value;\n}\n\nfunction normalizeMeasurementUnits(str) {\n  if (typeof str !== 'string' || !str) {\n    return str;\n  }\n\n  let normalized = str\n    .replace(MEASUREMENT_DOUBLE_PRIME_VARIANTS_PATTERN, '\"')\n    .replace(MEASUREMENT_SINGLE_PRIME_VARIANTS_PATTERN, \"'\");\n\n  normalized = normalized.replace(MEASUREMENT_FOOT_WORD_PATTERN, (match, value) => {\n    void match;\n    const cleaned = cleanMeasurementValue(value);\n    return cleaned ? `${cleaned} ft ` : value;\n  });\n\n  normalized = normalized.replace(MEASUREMENT_FOOT_PRIME_PATTERN, (match, value) => {\n    void match;\n    const cleaned = cleanMeasurementValue(value);\n    return cleaned ? `${cleaned} ft ` : value;\n  });\n\n  normalized = normalized.replace(MEASUREMENT_INCH_WORD_PATTERN, (match, value) => {\n    void match;\n    const cleaned = cleanMeasurementValue(value);\n    return cleaned ? `${cleaned} inch ` : value;\n  });\n\n  normalized = normalized.replace(MEASUREMENT_INCH_PRIME_PATTERN, (match, value) => {\n    void match;\n    const cleaned = cleanMeasurementValue(value);\n    return cleaned ? `${cleaned} inch ` : value;\n  });\n\n  return normalized;\n}\n\nconst LIGATURE_ENTRIES = [\n  ['', 'ss'],\n  ['', 'ae'],\n  ['', 'oe'],\n  ['', 'o'],\n  ['', 'th'],\n  ['', 'd'],\n  ['', 'd'],\n  ['', 'h'],\n  ['', 'i'],\n  ['', 'ij'],\n  ['', 'ng'],\n  ['', 'l'],\n  ['', 's'],\n];\nconst LIGATURE_PATTERNS = LIGATURE_ENTRIES.map(entry => new RegExp(entry[0], 'g'));\n\nfunction normalizeSearchValue(value) {\n  if (typeof value !== 'string') {\n    return '';\n  }\n\n  let normalized = value.replace(ZERO_WIDTH_SPACES_PATTERN, '');\n\n  if (typeof normalized.normalize === 'function') {\n    try {\n      normalized = normalized.normalize('NFKD');\n    } catch (error) {\n      void error;\n    }\n  }\n\n  normalized = normalized.toLowerCase();\n  normalized = normalizeMeasurementUnits(normalized);\n\n  normalized = normalized\n    .replace(SPACE_VARIANTS_PATTERN, ' ')\n    .replace(APOSTROPHE_VARIANTS_PATTERN, ' ')\n    .replace(QUOTE_VARIANTS_PATTERN, ' ')\n    .replace(DASH_VARIANTS_PATTERN, ' ')\n    .replace(SLASH_VARIANTS_PATTERN, ' ')\n    .replace(MULTIPLY_VARIANTS_PATTERN, ' x ')\n    .replace(DEGREE_VARIANTS_PATTERN, ' deg ')\n    .replace(/\\bdegrees?\\b/gi, ' deg ')\n    .replace(/&/g, ' and ')\n    .replace(/\\+/g, ' plus ')\n    .replace(/@/g, ' at ')\n    .replace(TRADEMARK_PATTERN, ' ')\n    .replace(ELLIPSIS_PATTERN, ' ')\n    .replace(GENERAL_PUNCTUATION_PATTERN, ' ');\n\n  normalized = normalized.replace(COMBINING_MARKS_PATTERN, '');\n\n  for (let ligatureIndex = 0; ligatureIndex < LIGATURE_ENTRIES.length; ligatureIndex += 1) {\n    const entry = LIGATURE_ENTRIES[ligatureIndex];\n    const pattern = LIGATURE_PATTERNS[ligatureIndex];\n    normalized = normalized.replace(pattern, entry[1]);\n  }\n\n  normalized = normalized\n    .replace(/['\"`]/g, ' ')\n    .replace(/\\s+/g, ' ')\n    .trim();\n\n  return normalized;\n}\n\nconst moduleApi = Object.freeze({\n  normalizeMeasurementUnits,\n  normalizeSearchValue,\n});\n\nif (MODULE_BASE) {\n  MODULE_BASE.registerOrQueueModule(\n    'cine.features.featureSearchNormalization',\n    moduleApi,\n    {\n      category: 'features',\n      description: 'Shared normalization helpers for feature search, including measurement units and punctuation folding.',\n      replace: true,\n      connections: ['cineModuleBase', 'cineModuleContext', 'cineUi'],\n    },\n    error => safeWarn('Unable to register cine.features.featureSearchNormalization module.', error),\n    GLOBAL_SCOPE,\n    MODULE_BASE.getModuleRegistry && MODULE_BASE.getModuleRegistry(GLOBAL_SCOPE),\n  );\n\n  if (typeof MODULE_BASE.exposeGlobal === 'function') {\n    MODULE_BASE.exposeGlobal('cineFeaturesFeatureSearchNormalization', moduleApi, GLOBAL_SCOPE, {\n      configurable: true,\n      enumerable: false,\n      writable: false,\n    });\n  } else {\n    try {\n      GLOBAL_SCOPE.cineFeaturesFeatureSearchNormalization = moduleApi;\n    } catch (error) {\n      void error;\n    }\n  }\n}\n// })();\n\nexport default moduleApi;\n","/**\n * Cine Power Planner V2 - Search Module\n * ====================================\n * Powers the V2 sidebar search with a dedicated index built from\n * legacy feature search data, device manifests, and shared normalization.\n */\n\nimport featureSearchNormalization from '../modules/features/feature-search-normalization.js';\nimport devicesCatalog from '../../data/devices/index.js';\n\nconst V2_SEARCH_FLAG = 'cine_use_v2_search';\nconst MAX_RESULTS = 40;\nconst EMPTY_SEARCH_ENTRIES = [];\n\nconst DEFAULT_CATEGORY_LABELS = {\n    cameras: 'Cameras',\n    monitors: 'Monitors',\n    video: 'Video',\n    fiz: 'FIZ',\n    batteries: 'Batteries',\n    batteryHotswaps: 'Battery Hot Swap',\n    carts: 'Carts',\n    wirelessReceivers: 'Wireless',\n    audio: 'Audio',\n    lights: 'Lights',\n    gimbals: 'Gimbals',\n    drones: 'Drones',\n    actionCameras: 'Action Cameras',\n    accessories: 'Accessories',\n    viewfinders: 'Viewfinders',\n    directorMonitors: 'Director Monitors',\n    iosVideo: 'iOS Video',\n    videoAssist: 'Video Assist',\n    media: 'Media',\n    lenses: 'Lenses',\n    filterOptions: 'Filters',\n    recordingMediaBrands: 'Recording Media Brands',\n    recordingMediaSizes: 'Recording Media Sizes',\n    gearList: 'Gear List'\n};\n\nconst normalizationApi = featureSearchNormalization\n    && typeof featureSearchNormalization.normalizeSearchValue === 'function'\n    ? featureSearchNormalization\n    : {\n        normalizeSearchValue: value => (typeof value === 'string' ? value.trim().toLowerCase() : '')\n    };\n\nconst safeNormalize = value => normalizationApi.normalizeSearchValue(value || '');\n\nconst tokenize = value => safeNormalize(value)\n    .split(' ')\n    .map(token => token.trim())\n    .filter(Boolean);\n\nfunction shouldEnableV2Search() {\n    try {\n        const params = new URLSearchParams(window.location.search);\n        if (params.has('v2Search')) {\n            const enabled = params.get('v2Search') === 'true';\n            localStorage.setItem(V2_SEARCH_FLAG, enabled.toString());\n            return enabled;\n        }\n        const stored = localStorage.getItem(V2_SEARCH_FLAG);\n        if (stored === null) {\n            return true;\n        }\n        return stored === 'true';\n    } catch (error) {\n        void error;\n        return true;\n    }\n}\n\nfunction resolveLegacyEntries() {\n    const legacyEntries = Array.isArray(window.featureSearchEntries)\n        ? window.featureSearchEntries\n        : EMPTY_SEARCH_ENTRIES;\n\n    return legacyEntries.map(entry => {\n        const label = entry?.optionLabel || entry?.display || entry?.label || '';\n        const detail = entry?.detail || entry?.value?.detail || '';\n        const display = entry?.display || label;\n        const key = entry?.key || safeNormalize(display);\n        const type = entry?.type || entry?.entryType || entry?.value?.type || 'feature';\n        const keywords = [label, detail, display].filter(Boolean).join(' ');\n\n        return {\n            key: `legacy:${key}`,\n            legacyKey: entry?.key || null,\n            type,\n            label,\n            display,\n            detail,\n            keywords,\n            legacyEntry: entry,\n            legacyQuery: display || label\n        };\n    });\n}\n\nfunction buildDeviceEntries(catalog) {\n    const results = [];\n    if (!catalog || typeof catalog !== 'object') {\n        return results;\n    }\n\n    const pushEntry = (label, categoryKey, categoryLabel) => {\n        if (!label) return;\n        const keywords = [label, categoryLabel, categoryKey].filter(Boolean).join(' ');\n        results.push({\n            key: `device:${safeNormalize(label)}:${safeNormalize(categoryKey)}`,\n            type: 'device',\n            label,\n            display: label,\n            detail: categoryLabel ? `Device  ${categoryLabel}` : 'Device',\n            keywords,\n            legacyQuery: label\n        });\n    };\n\n    const processCategory = (categoryKey, data, categoryLabel) => {\n        if (!data || typeof data !== 'object') return;\n        Object.keys(data).forEach(name => {\n            if (!name || name === 'accessories') return;\n            pushEntry(name, categoryKey, categoryLabel);\n        });\n    };\n\n    Object.entries(catalog).forEach(([categoryKey, data]) => {\n        const label = DEFAULT_CATEGORY_LABELS[categoryKey] || categoryKey;\n        if (categoryKey === 'accessories' && data && typeof data === 'object') {\n            Object.entries(data).forEach(([subKey, subData]) => {\n                const subLabel = DEFAULT_CATEGORY_LABELS[subKey] || subKey;\n                const fullLabel = `${label}  ${subLabel}`;\n                processCategory(`accessories:${subKey}`, subData, fullLabel);\n            });\n            return;\n        }\n        processCategory(categoryKey, data, label);\n    });\n\n    return results;\n}\n\nfunction buildSearchIndex() {\n    const entries = [];\n    const index = new Map();\n    const addEntry = entry => {\n        if (!entry || !entry.label) return;\n        const normalizedLabel = safeNormalize(entry.label);\n        if (!normalizedLabel) return;\n        const labelKey = `label:${normalizedLabel}`;\n        const normalizedKeywords = safeNormalize(entry.keywords || '');\n        const tokens = new Set([...tokenize(entry.label), ...tokenize(entry.keywords || '')]);\n        const withMeta = {\n            ...entry,\n            normalizedLabel,\n            normalizedKeywords,\n            tokens\n        };\n        if (!index.has(withMeta.key)) {\n            entries.push(withMeta);\n        }\n        index.set(withMeta.key, withMeta);\n        if (entry.legacyKey) {\n            index.set(`legacyKey:${entry.legacyKey}`, withMeta);\n        }\n        if (!index.has(labelKey)) {\n            index.set(labelKey, withMeta);\n        }\n    };\n\n    resolveLegacyEntries().forEach(addEntry);\n    buildDeviceEntries(devicesCatalog).forEach(addEntry);\n\n    return { entries, index };\n}\n\nfunction getLegacyEntriesSnapshot() {\n    const legacyEntries = Array.isArray(window.featureSearchEntries)\n        ? window.featureSearchEntries\n        : EMPTY_SEARCH_ENTRIES;\n    return {\n        ref: legacyEntries,\n        length: legacyEntries.length\n    };\n}\n\n/**\n * Creates a cached search index manager with lightweight invalidation checks.\n * @param {Object} params\n * @param {Function} params.buildIndex Function that builds the search index.\n * @param {Function} params.getSnapshot Function that returns the legacy entry snapshot.\n * @returns {{getIndexState: Function, refreshIfStale: Function, markStale: Function}}\n */\nfunction createSearchIndexManager({ buildIndex = buildSearchIndex, getSnapshot = getLegacyEntriesSnapshot } = {}) {\n    let indexState = buildIndex();\n    let legacySnapshot = getSnapshot();\n    let stale = false;\n\n    const markStale = () => {\n        stale = true;\n    };\n\n    const refreshIfStale = () => {\n        const nextSnapshot = getSnapshot();\n        const referenceChanged = nextSnapshot.ref !== legacySnapshot.ref;\n        const lengthChanged = nextSnapshot.length !== legacySnapshot.length;\n\n        if (stale || referenceChanged || lengthChanged) {\n            indexState = buildIndex();\n            legacySnapshot = nextSnapshot;\n            stale = false;\n        }\n    };\n\n    const getIndexState = () => indexState;\n\n    return {\n        getIndexState,\n        refreshIfStale,\n        markStale\n    };\n}\n\nfunction resolveDefaultEntries(index) {\n    const defaults = Array.isArray(window.featureSearchDefaultOptions)\n        ? window.featureSearchDefaultOptions\n        : [];\n    if (!defaults.length) return [];\n\n    const results = [];\n    const seen = new Set();\n\n    defaults.forEach(option => {\n        if (!option) return;\n        const entryKey = option.entryKey ? `legacyKey:${option.entryKey}` : null;\n        const label = option.label || option.value || '';\n        const normalizedLabel = label ? `label:${safeNormalize(label)}` : null;\n        const entry = (entryKey && index.get(entryKey))\n            || (normalizedLabel && index.get(normalizedLabel));\n        if (entry && !seen.has(entry.key)) {\n            results.push(entry);\n            seen.add(entry.key);\n        }\n    });\n\n    return results;\n}\n\nfunction scoreEntry(entry, query, queryTokens) {\n    if (!entry) return 0;\n    if (!query) return 0;\n    if (entry.normalizedLabel === query) return 1000;\n    if (entry.normalizedLabel.startsWith(query)) return 820;\n    if (entry.normalizedLabel.includes(query)) return 650;\n    let score = 0;\n    if (entry.normalizedKeywords.includes(query)) {\n        score += 120;\n    }\n    if (queryTokens.length) {\n        let matched = 0;\n        queryTokens.forEach(token => {\n            if (entry.tokens.has(token)) matched += 1;\n        });\n        score += matched * 60;\n    }\n    if (entry.type === 'action') {\n        score += 10;\n    }\n    return score;\n}\n\nfunction findMatches(entries, query) {\n    const normalizedQuery = safeNormalize(query);\n    if (!normalizedQuery) return [];\n    const queryTokens = tokenize(query);\n    return entries\n        .map(entry => ({\n            entry,\n            score: scoreEntry(entry, normalizedQuery, queryTokens)\n        }))\n        .filter(result => result.score > 0)\n        .sort((a, b) => b.score - a.score || a.entry.label.localeCompare(b.entry.label))\n        .slice(0, MAX_RESULTS)\n        .map(result => result.entry);\n}\n\nfunction ensureDropdown(input) {\n    if (!input) return null;\n    const wrapper = input.closest('.v2-search-input-wrapper') || input.parentElement;\n    if (!wrapper) return null;\n\n    let dropdown = document.getElementById('featureSearchDropdown');\n    if (!dropdown) {\n        dropdown = document.createElement('div');\n        dropdown.id = 'featureSearchDropdown';\n        dropdown.className = 'feature-search-dropdown';\n        dropdown.setAttribute('role', 'listbox');\n    }\n\n    if (!wrapper.contains(dropdown)) {\n        wrapper.appendChild(dropdown);\n    }\n\n    return dropdown;\n}\n\nfunction renderDropdown(dropdown, entries) {\n    if (!dropdown) return;\n    dropdown.innerHTML = '';\n\n    if (!entries.length) {\n        dropdown.dataset.count = '0';\n        dropdown.dataset.open = 'false';\n        dropdown.hidden = true;\n        dropdown.setAttribute('aria-expanded', 'false');\n        return;\n    }\n\n    const list = document.createElement('div');\n    list.className = 'feature-search-dropdown-list';\n\n    entries.forEach((entry, index) => {\n        const button = document.createElement('button');\n        button.type = 'button';\n        button.className = 'feature-search-option';\n        const optionId = `v2-feature-search-${entry.key.replace(/[^a-z0-9_-]+/gi, '-')}`;\n        button.id = optionId;\n        button.setAttribute('role', 'option');\n        button.setAttribute('tabindex', index === 0 ? '0' : '-1');\n        button.setAttribute('data-value', entry.display || entry.label);\n        button.setAttribute('data-entry-key', entry.key);\n        button.setAttribute('aria-label', entry.label);\n        button.setAttribute('aria-selected', 'false');\n\n        const contentDiv = document.createElement('div');\n        contentDiv.className = 'feature-search-option-content';\n\n        const labelSpan = document.createElement('span');\n        labelSpan.className = 'feature-search-option-label';\n        labelSpan.textContent = entry.label;\n        contentDiv.appendChild(labelSpan);\n\n        if (entry.detail) {\n            const detailSpan = document.createElement('span');\n            detailSpan.className = 'feature-search-option-value';\n            detailSpan.textContent = entry.detail;\n            contentDiv.appendChild(detailSpan);\n        }\n\n        button.appendChild(contentDiv);\n        list.appendChild(button);\n    });\n\n    dropdown.appendChild(list);\n    dropdown.dataset.count = String(entries.length);\n    dropdown.dataset.activeIndex = '0';\n    dropdown.dataset.open = 'true';\n    dropdown.hidden = false;\n    dropdown.setAttribute('aria-expanded', 'true');\n}\n\nfunction getDropdownOptions(dropdown) {\n    if (!dropdown) return [];\n    return Array.from(dropdown.querySelectorAll('[role=\"option\"]'));\n}\n\nfunction setActiveOption(input, dropdown, index) {\n    const options = getDropdownOptions(dropdown);\n    if (!options.length) return null;\n    const bounded = Math.max(0, Math.min(index, options.length - 1));\n    options.forEach((option, optIndex) => {\n        const isActive = optIndex === bounded;\n        option.setAttribute('tabindex', isActive ? '0' : '-1');\n        option.setAttribute('aria-selected', isActive ? 'true' : 'false');\n        if (isActive && input && option.id) {\n            input.setAttribute('aria-activedescendant', option.id);\n        }\n    });\n    dropdown.dataset.activeIndex = String(bounded);\n    return options[bounded];\n}\n\nfunction closeDropdown(input, dropdown) {\n    if (!dropdown) return;\n    dropdown.dataset.open = 'false';\n    dropdown.hidden = true;\n    dropdown.setAttribute('aria-expanded', 'false');\n    dropdown.dataset.activeIndex = '';\n    if (input && input.hasAttribute('aria-activedescendant')) {\n        input.removeAttribute('aria-activedescendant');\n    }\n}\n\nfunction openDropdown(dropdown) {\n    if (!dropdown || dropdown.dataset.count === '0') return;\n    dropdown.dataset.open = 'true';\n    dropdown.hidden = false;\n    dropdown.setAttribute('aria-expanded', 'true');\n}\n\nfunction dispatchV2SearchEvent(query) {\n    window.dispatchEvent(new CustomEvent('v2:search', {\n        detail: { query }\n    }));\n}\n\nfunction applySelection(entry, queryValue, input) {\n    if (!entry) return;\n    const inputValue = entry.display || entry.label || queryValue || '';\n    const query = entry.legacyQuery || inputValue;\n    if (!query) return;\n\n    if (input) {\n        input.value = inputValue;\n        input.dispatchEvent(new Event('input', { bubbles: true }));\n        input.dispatchEvent(new Event('change', { bubbles: true }));\n    }\n\n    if (typeof window.runFeatureSearch === 'function') {\n        window.runFeatureSearch(query);\n        return;\n    }\n\n    const legacyInput = document.getElementById('featureSearch');\n    if (legacyInput) {\n        legacyInput.value = query;\n        legacyInput.dispatchEvent(new Event('input', { bubbles: true }));\n        legacyInput.dispatchEvent(new Event('change', { bubbles: true }));\n    }\n}\n\nfunction resolveEntryFromOption(option, entryIndex) {\n    if (!option) return null;\n    const entryKey = option.getAttribute('data-entry-key');\n    if (entryKey && entryIndex.has(entryKey)) {\n        return entryIndex.get(entryKey);\n    }\n    const label = option.getAttribute('data-value') || '';\n    if (!label) return null;\n    return entryIndex.get(`label:${safeNormalize(label)}`) || null;\n}\n\nfunction setupSearchEvents(input, dropdown) {\n    const indexManager = createSearchIndexManager();\n    let currentResults = [];\n\n    const hasCachedResults = () => currentResults.length > 0;\n\n    const handleIndexRefresh = () => {\n        indexManager.markStale();\n    };\n\n    window.addEventListener('v2:search-index-refresh', handleIndexRefresh);\n\n    const updateResults = query => {\n        indexManager.refreshIfStale();\n        const { entries, index } = indexManager.getIndexState();\n        if (!query) {\n            currentResults = resolveDefaultEntries(index);\n        } else {\n            currentResults = findMatches(entries, query);\n        }\n        renderDropdown(dropdown, currentResults);\n        if (dropdown.dataset.count !== '0') {\n            setActiveOption(input, dropdown, 0);\n        }\n    };\n\n    input.addEventListener('input', e => {\n        e.stopPropagation();\n        const query = e.target.value.trim();\n        updateResults(query);\n        openDropdown(dropdown);\n        dispatchV2SearchEvent(query);\n    });\n\n    input.addEventListener('focus', () => {\n        if (!input.value && !hasCachedResults()) {\n            indexManager.refreshIfStale();\n        }\n        updateResults(input.value.trim());\n        openDropdown(dropdown);\n    });\n\n    input.addEventListener('blur', () => {\n        window.setTimeout(() => {\n            if (dropdown.contains(document.activeElement)) return;\n            closeDropdown(input, dropdown);\n        }, 120);\n    });\n\n    input.addEventListener('keydown', e => {\n        e.stopPropagation();\n        const options = getDropdownOptions(dropdown);\n        const activeIndex = dropdown.dataset.activeIndex ? Number(dropdown.dataset.activeIndex) : 0;\n\n        if (e.key === 'Enter') {\n            const option = options[activeIndex];\n            const entry = resolveEntryFromOption(option, indexManager.getIndexState().index);\n            applySelection(entry, input.value.trim(), input);\n            closeDropdown(input, dropdown);\n            return;\n        }\n\n        if (e.key === 'Escape') {\n            if (input.value) {\n                input.value = '';\n                updateResults('');\n                dispatchV2SearchEvent('');\n            }\n            closeDropdown(input, dropdown);\n            e.preventDefault();\n            return;\n        }\n\n        if (e.key === 'ArrowDown') {\n            if (!options.length) return;\n            e.preventDefault();\n            const next = activeIndex + 1 >= options.length ? 0 : activeIndex + 1;\n            setActiveOption(input, dropdown, next);\n            return;\n        }\n\n        if (e.key === 'ArrowUp') {\n            if (!options.length) return;\n            e.preventDefault();\n            const prev = activeIndex - 1 < 0 ? options.length - 1 : activeIndex - 1;\n            setActiveOption(input, dropdown, prev);\n        }\n    });\n\n    dropdown.addEventListener('mousedown', e => {\n        const option = e.target.closest('[data-value]');\n        if (option) {\n            e.preventDefault();\n        }\n    });\n\n    dropdown.addEventListener('click', e => {\n        const option = e.target.closest('[data-value]');\n        if (!option) return;\n        const entry = resolveEntryFromOption(option, indexManager.getIndexState().index);\n        applySelection(entry, input.value.trim(), input);\n        closeDropdown(input, dropdown);\n    });\n\n    dropdown.addEventListener('keydown', e => {\n        const options = getDropdownOptions(dropdown);\n        if (!options.length) return;\n        const activeElement = document.activeElement;\n        const currentIndex = options.indexOf(activeElement);\n\n        if (e.key === 'ArrowDown') {\n            e.preventDefault();\n            const next = currentIndex >= 0 ? currentIndex + 1 : 0;\n            const option = setActiveOption(input, dropdown, next >= options.length ? 0 : next);\n            option?.focus();\n        } else if (e.key === 'ArrowUp') {\n            e.preventDefault();\n            const prev = currentIndex > 0 ? currentIndex - 1 : options.length - 1;\n            const option = setActiveOption(input, dropdown, prev);\n            option?.focus();\n        } else if (e.key === 'Enter') {\n            e.preventDefault();\n            if (currentIndex >= 0 && options[currentIndex]) {\n                const entry = resolveEntryFromOption(options[currentIndex], indexManager.getIndexState().index);\n                applySelection(entry, input.value.trim(), input);\n                closeDropdown(input, dropdown);\n            }\n        } else if (e.key === 'Escape') {\n            e.preventDefault();\n            closeDropdown(input, dropdown);\n            input.focus();\n        }\n    });\n}\n\n/**\n * Initializes the V2 sidebar search UI.\n * @param {Object} options\n * @param {string} options.inputId Search input element id.\n * @returns {boolean} True when the V2 search was activated.\n */\nfunction setupV2Search({ inputId } = {}) {\n    if (!shouldEnableV2Search()) {\n        return false;\n    }\n    const input = document.getElementById(inputId || 'v2SidebarSearchInput');\n    if (!input) return false;\n\n    const dropdown = ensureDropdown(input);\n    if (!dropdown) return false;\n\n    setupSearchEvents(input, dropdown);\n    return true;\n}\n\nexport { setupV2Search, shouldEnableV2Search, createSearchIndexManager };\nexport default { setupV2Search, shouldEnableV2Search, createSearchIndexManager };\n","/**\n * Cine Power Planner V2 - Sidebar Logic\n * =====================================\n * Handles sidebar interactions, specifically search functionality\n * and theme toggles (bridging to legacy app).\n */\n\nimport { setupV2Search } from './search-module.js';\n\n// Polyfill global for legacy code\nconst global = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : {};\n\n\nconst SEARCH_CONTAINER_CLASS = 'v2-sidebar-search';\nconst SEARCH_INPUT_ID = 'v2SidebarSearchInput';\n\n// Theme Constants\nconst DARK_MODE_KEY = 'darkMode';\nconst PINK_MODE_KEY = 'cameraPowerPlanner_pinkMode';\nconst FALLBACK_PINK_KEY = 'pinkMode';\n\nconst TEXT_TO_KEY_MAP = {\n    'All Projects': 'v2.sidebar.nav.allProjects',\n    'Active Projects': 'v2.sidebar.nav.activeProjects',\n    'Archive': 'v2.sidebar.nav.archive',\n    'Auto Backups': 'v2.sidebar.nav.autoBackups',\n    'Device Library': 'v2.sidebar.nav.deviceLibrary',\n    'Contacts': 'v2.sidebar.nav.contacts',\n    'Auto Gear Rules': 'v2.sidebar.nav.autoGearRules',\n    'Owned Gear': 'v2.sidebar.nav.ownedGear',\n    'Create New Project': 'v2.sidebar.nav.createProject',\n    'Projects': 'v2.sidebar.nav.projectsSection',\n    'Tools': 'v2.sidebar.nav.toolsSection',\n    'Support': 'v2.sidebar.nav.supportSection',\n    'Help': 'v2.sidebar.nav.help',\n    'Settings': 'v2.sidebar.nav.settings'\n};\n\n/**\n * Translation Helper\n */\nfunction _t(path, params = {}, lang = null) {\n    const currentLang = lang || document.documentElement.lang || 'en';\n    let root = (window.texts && window.texts[currentLang]) ? window.texts[currentLang] : null;\n    if (!root && window.texts) root = window.texts['en'];\n\n    // Simple resolve\n    const resolve = (obj, p) => p.split('.').reduce((o, i) => o ? o[i] : null, obj);\n\n    let val = root ? resolve(root, path) : null;\n\n    // Fallback to English if missing in current lang\n    if (!val && currentLang !== 'en' && window.texts && window.texts['en']) {\n        val = resolve(window.texts['en'], path);\n    }\n\n    if (!val) return path;\n\n    if (typeof val === 'string') {\n        for (const [k, v] of Object.entries(params)) {\n            val = val.replace(`{${k}}`, v);\n        }\n    }\n    return val;\n}\n\nfunction initSidebar() {\n    console.log('[V2 Sidebar] Initializing...');\n\n    // 1. Get Main Sidebar Container [FIXED SELECTOR]\n    // In index.html, the container is <nav class=\"v2-sidebar\">\n    const sidebar = document.querySelector('.v2-sidebar');\n    if (!sidebar) {\n        console.error('[V2 Sidebar] .v2-sidebar not found. Cannot inject controls.');\n        return;\n    }\n\n    // 2. Inject Components in Order\n    // A. Header (Already in HTML usually, but check)\n    injectSidebarHeader(sidebar);\n\n    // B. Top Controls (Rows 1 & 2)\n    injectTopControls(sidebar);\n\n    // C. Search\n    injectSearchInput(sidebar);\n    const didSetupV2Search = setupV2Search({ inputId: SEARCH_INPUT_ID });\n    if (!didSetupV2Search) {\n        setupLegacySearchProxy(); // STRICT V1 Proxy\n    }\n\n    // 3. Initialize Logic\n    initThemes();\n    initNavigationLogic();\n    initMobileToggle(); // [New] Mobile Toggle\n    forceHelpCloseBinding();\n    interceptLegacyHelp(); // [New] Redirect Legacy Help\n\n    // 4. Initial Translation\n    const legacySelect = document.getElementById('languageSelect');\n    if (legacySelect) {\n        updateSidebarTranslations(legacySelect.value);\n    }\n}\n\nfunction injectSidebarHeader(container) {\n    if (container.querySelector('.v2-sidebar-header')) return;\n\n    const header = document.createElement('div');\n    header.className = 'v2-sidebar-header';\n\n    const logo = document.createElement('img');\n    logo.src = 'src/icons/Icon Bluenew.svg';\n    logo.className = 'v2-sidebar-logo';\n    logo.alt = 'Logo';\n\n    const title = document.createElement('h1'); // V2 uses h1 in HTML now\n    title.className = 'v2-sidebar-title';\n    title.innerHTML = 'Cine Power<br>Planner';\n\n    header.appendChild(logo);\n    header.appendChild(title);\n\n    // Insert at very top\n    container.insertBefore(header, container.firstChild);\n}\n\n/**\n * [Fix] Inject Top Controls in Single Row\n * All controls in one row: Language Selector + Theme Toggles + Hard Refresh\n */\n/**\n * [Refactor] Inject Controls at Bottom (Above Footer)\n * Language Selector + Theme Toggles + Hard Refresh\n */\nfunction injectTopControls(container) {\n    if (container.querySelector('.v2-sidebar-controls-container')) return;\n\n    const controlsContainer = document.createElement('div');\n    controlsContainer.className = 'v2-sidebar-controls-container';\n    // Add some padding/border if needed via CSS, or rely on existing styles\n    // controlsContainer.style.borderTop = '1px solid var(--v2-border-default)'; // Optional separation\n\n    // Single Row with all controls\n    const row1 = document.createElement('div');\n    row1.className = 'v2-controls-row-1';\n    injectLanguageSelector(row1); // Language Dropdown first\n    injectThemeControls(row1);    // Theme Buttons\n    injectHardRefresh(row1);      // Refresh Button\n\n    // Assemble (single row)\n    controlsContainer.appendChild(row1);\n\n    // Insert at bottom: Before Footer\n    const footer = container.querySelector('.v2-sidebar-footer');\n    if (footer) {\n        footer.insertAdjacentElement('beforebegin', controlsContainer);\n    } else {\n        // Fallback: append to end\n        container.appendChild(controlsContainer);\n    }\n}\n\n/**\n * [Fix 1.8] STRICT V1 Search Proxy\n *\n * DEEP DIVE: The \"Legacy Proxy\" Pattern\n *\n * The V2 Search Bar is a \"dumb\" UI component. It does NOT contain search logic itself.\n * Instead, it acts as a remote control for the invisible Legacy Search Input (#featureSearch).\n *\n * Why?\n * The legacy app uses a complex `fuse.js` implementation tightly coupled to the DOM of the\n * hidden V1 table. Rewriting that logic immediately would risk breaking the core tool.\n *\n * Mechanism:\n * 1. EVENT MIRRORING: Typing in V2 -> triggers 'input' event on V1 input.\n * 2. KEY FORWARDING: Arrow keys in V2 -> dispatched to V1 to navigate the dropdown results.\n * 3. FOCUS SYNC: Focusing V2 -> Focuses V1 (to trigger the library dropdown).\n *\n * This allows us to ship a modern UI *today* without rewriting the search engine *yesterday*.\n */\nfunction setupLegacySearchProxy() {\n    const input = document.getElementById(SEARCH_INPUT_ID);\n    const legacyInput = document.getElementById('featureSearch');\n    if (!input || !legacyInput) return;\n\n    // Sync Input: V2 -> Legacy\n    input.addEventListener('input', (e) => {\n        e.stopPropagation(); // Stop 'h'/'?' interference\n        legacyInput.value = e.target.value;\n        legacyInput.dispatchEvent(new Event('input', { bubbles: true }));\n        legacyInput.dispatchEvent(new Event('change', { bubbles: true })); // Ensure listeners fire\n    });\n\n    // Sync Focus: V2 -> Legacy (Opens Dropdown)\n    input.addEventListener('focus', () => {\n        legacyInput.dispatchEvent(new Event('focus', { bubbles: true }));\n    });\n\n    // Sync Blur\n    input.addEventListener('blur', () => {\n        // Small delay to allow clicks on dropdown\n        setTimeout(() => {\n            legacyInput.dispatchEvent(new Event('blur', { bubbles: true }));\n        }, 200);\n    });\n\n    // Sync Keys (Arrows, Enter, Escape)\n    input.addEventListener('keydown', (e) => {\n        // Stop 'h' or '?' from triggering global Help IF typing\n        e.stopPropagation();\n\n        // LIMIT FORWARDING to Navigation Keys only\n        const allowedKeys = ['ArrowUp', 'ArrowDown', 'Enter', 'Escape'];\n        if (!allowedKeys.includes(e.key)) return;\n\n        // Forward keys to legacy input for navigation\n        const keyEvent = new KeyboardEvent('keydown', {\n            key: e.key,\n            code: e.code,\n            keyCode: e.keyCode,\n            bubbles: true,\n            cancelable: true\n        });\n        legacyInput.dispatchEvent(keyEvent);\n    });\n\n    // [New] Dispatch V2 Search Event for Dashboard\n    input.addEventListener('input', (e) => {\n        const query = e.target.value.trim();\n        window.dispatchEvent(new CustomEvent('v2:search', {\n            detail: { query }\n        }));\n    });\n}\n\nfunction injectSearchInput(container) {\n    // Find insert point: After Controls\n    // const controls = container.querySelector('.v2-sidebar-controls-container');\n\n    // Check if already exists\n    if (container.querySelector(`.${SEARCH_CONTAINER_CLASS}`)) return;\n\n    const searchContainer = document.createElement('div');\n    searchContainer.className = SEARCH_CONTAINER_CLASS;\n    searchContainer.innerHTML = `\n            <div class=\"v2-search-input-wrapper\">\n                <svg class=\"v2-search-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <path d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n                </svg>\n                <input type=\"text\" id=\"${SEARCH_INPUT_ID}\" class=\"v2-search-input\" placeholder=\"${_t('v2.sidebar.search.placeholder')}\" aria-label=\"${_t('v2.sidebar.search.label')}\">\n            </div>\n        `;\n\n    // Insert after Header (Top), independent of controls\n    const header = container.querySelector('.v2-sidebar-header');\n    if (header) {\n        header.insertAdjacentElement('afterend', searchContainer);\n    } else {\n        // Fallback\n        const nav = container.querySelector('.v2-sidebar-nav');\n        if (nav) {\n            container.insertBefore(searchContainer, nav);\n        } else {\n            container.insertBefore(searchContainer, container.firstChild);\n        }\n    }\n\n    // [Fix 1.1] Move Legacy Dropdown Here\n    setTimeout(() => {\n        const legacyDropdown = document.getElementById('featureSearchDropdown');\n        const wrapper = searchContainer.querySelector('.v2-search-input-wrapper');\n        if (legacyDropdown && wrapper) {\n            wrapper.appendChild(legacyDropdown);\n            // Reset styles\n            legacyDropdown.style.top = '110%';\n            legacyDropdown.style.left = '0';\n            legacyDropdown.style.visibility = 'visible';\n            legacyDropdown.style.display = 'none'; // Initially hidden\n        }\n    }, 1000);\n}\n\n/**\n * [Fix 1.9] Force Help Close Button Binding\n * Binds a global click listener to intercept the close button\n */\nfunction forceHelpCloseBinding() {\n    document.addEventListener('click', (e) => {\n        // Check for the close button specifically or its connection to the help dialog\n        const btn = e.target.closest('#closeHelp');\n\n        if (btn) {\n            e.preventDefault();\n            e.stopImmediatePropagation();\n            closeHelpModal();\n        }\n    });\n}\n\nfunction closeHelpModal() {\n    const helpDialog = document.getElementById('helpDialog');\n    if (helpDialog) {\n        helpDialog.setAttribute('hidden', '');\n        helpDialog.style.display = 'none';\n        // Also try legacy global function\n        if (typeof global.closeDialog === 'function') {\n            global.closeDialog(helpDialog);\n        }\n    }\n}\n\n/**\n * [New] Intercept Legacy Help Triggers\n * Redirects legacy help button and shortcuts to V2 Help\n */\nfunction interceptLegacyHelp() {\n    // 1. Header Button\n    const helpBtn = document.getElementById('helpButton');\n    // 2. Sidebar Button\n    const v1HelpNav = document.querySelector('[data-nav-key=\"openHelpNav\"]');\n\n    const redirect = (e) => {\n        e.preventDefault();\n        e.stopImmediatePropagation();\n        window.location.hash = '/help';\n    };\n\n    if (helpBtn) {\n        helpBtn.addEventListener('click', redirect);\n    }\n\n    if (v1HelpNav) {\n        v1HelpNav.addEventListener('click', redirect);\n    }\n\n    // 3. Global Keyboard Shortcuts\n    document.addEventListener('keydown', (e) => {\n        // Ignore if in input\n        if (e.target.matches('input, textarea, [contenteditable]')) return;\n\n        // Shift+? or H or F1\n        if ((e.key === '?' && e.shiftKey) || e.key === 'H' || e.key === 'h' || e.key === 'F1') {\n            redirect(e);\n        }\n        // Ctrl+/ (Cmd+/)\n        if (e.key === '/' && (e.ctrlKey || e.metaKey)) {\n            redirect(e);\n        }\n    }, true); // Capture phase to beat legacy listeners\n}\n\n/**\n * [Fix 1.8] Navigation Logic\n *\n * DEEP DIVE: Navigation State Management\n *\n * This section handles the visual state of the sidebar to match the application routing.\n *\n * KEY CONCEPTS:\n * 1. URL SYNC: On load, it checks `window.location.hash` and highlights the matching link.\n * 2. EXCLUSIVITY: Only one link can be '.active' at a time.\n * 3. FEATURE FLAGS:\n *    - 'Auto Backups' is hidden unless `cineAutoRecover` is true in options.\n *    - This prevents feature pollution for users who haven't opted into unstable recoveries.\n */\nfunction initNavigationLogic() {\n    // Toggle Auto Backups link based on settings\n    const backupLink = document.getElementById('navAutoBackups');\n    if (backupLink) {\n        const autoRecover = localStorage.getItem('cineAutoRecover') === 'true';\n        backupLink.style.display = autoRecover ? 'flex' : 'none';\n    }\n\n    const navLinks = document.querySelectorAll('.v2-sidebar-nav .v2-sidebar-link');\n    navLinks.forEach(link => {\n        link.addEventListener('click', () => {\n            navLinks.forEach(l => l.classList.remove('active'));\n            link.classList.add('active');\n        });\n    });\n\n    // Set initial active state\n    const hash = window.location.hash;\n    if (hash) {\n        navLinks.forEach(link => {\n            if (link.getAttribute('href') === hash) {\n                link.classList.add('active');\n            }\n        });\n    }\n}\n\n/**\n * [New] Mobile Sidebar Toggle\n * Handles opening/closing sidebar on mobile\n */\nfunction initMobileToggle() {\n    const triggers = document.querySelectorAll('.v2-mobile-menu-toggle');\n    const app = document.getElementById('v2-app');\n    const overlay = document.querySelector('.v2-sidebar-overlay');\n\n\n    if (!app) return;\n\n    function openSidebar() {\n        app.classList.add('sidebar-open');\n    }\n\n    function closeSidebar() {\n        app.classList.remove('sidebar-open');\n    }\n\n    // 1. Bind Triggers (Hamburger Buttons)\n    triggers.forEach(btn => {\n        btn.addEventListener('click', (e) => {\n            e.preventDefault();\n            e.stopPropagation();\n            openSidebar();\n        });\n    });\n\n    // 2. Bind Overlay (Close on click)\n    if (overlay) {\n        overlay.addEventListener('click', closeSidebar);\n    }\n\n    // 3. Close on Navigation\n    // When a nav link is clicked (and we are on mobile), close sidebar\n    const navLinks = document.querySelectorAll('.v2-sidebar-nav .v2-sidebar-link');\n    navLinks.forEach(link => {\n        link.addEventListener('click', () => {\n            // Determine if we are on mobile (check if overlay is visible or check window width)\n            if (window.innerWidth <= 768) {\n                closeSidebar();\n            }\n        });\n    });\n\n    // 4. Close on Exit V2\n    const exitBtn = document.getElementById('v2ExitBtn');\n    if (exitBtn) {\n        exitBtn.addEventListener('click', closeSidebar);\n    }\n}\n\n// =====================\n// CONTROLS INJECTION\n// =====================\n\nfunction injectLanguageSelector(container) {\n    if (!container || container.querySelector('.v2-lang-select-wrapper')) return;\n\n    const legacySelect = document.getElementById('languageSelect');\n    const currentLang = legacySelect ? legacySelect.value : 'en';\n\n    const wrapper = document.createElement('div');\n    wrapper.className = 'v2-lang-select-wrapper';\n\n    // Full language names as requested\n    wrapper.innerHTML = `\n            <select class=\"v2-lang-select\" aria-label=\"Select Language\">\n                <option value=\"en\" ${currentLang === 'en' ? 'selected' : ''}>English</option>\n                <option value=\"de\" ${currentLang === 'de' ? 'selected' : ''}>Deutsch</option>\n                <option value=\"es\" ${currentLang === 'es' ? 'selected' : ''}>Espaol</option>\n                <option value=\"fr\" ${currentLang === 'fr' ? 'selected' : ''}>Franais</option>\n                <option value=\"it\" ${currentLang === 'it' ? 'selected' : ''}>Italiano</option>\n            </select>\n        `;\n\n    const select = wrapper.querySelector('select');\n    select.addEventListener('change', (e) => {\n        const newVal = e.target.value;\n        if (legacySelect) {\n            legacySelect.value = newVal;\n            legacySelect.dispatchEvent(new Event('change', { bubbles: true }));\n\n            if (typeof global.updateLanguage === 'function') {\n                global.updateLanguage(newVal);\n            }\n            updateSidebarTranslations(newVal);\n        }\n    });\n\n    // Sync back from legacy\n    if (legacySelect) {\n        legacySelect.addEventListener('change', () => {\n            if (select.value !== legacySelect.value) {\n                select.value = legacySelect.value;\n                updateSidebarTranslations(legacySelect.value);\n            }\n        });\n    }\n\n    container.appendChild(wrapper);\n}\n\nfunction injectHardRefresh(container) {\n    if (container.querySelector('#v2RefreshBtn')) return;\n\n    const btn = document.createElement('button');\n    btn.className = 'v2-tool-btn';\n    btn.id = 'v2RefreshBtn';\n    btn.title = 'Force reload';\n    btn.setAttribute('aria-label', 'Force reload');\n    btn.innerHTML = `\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\">\n                <polyline points=\"23 4 23 10 17 10\" stroke-linecap=\"round\" stroke-linejoin=\"round\" />\n                <path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\" stroke-linecap=\"round\" stroke-linejoin=\"round\" />\n            </svg>\n        `;\n\n    btn.addEventListener('click', () => {\n        const legacyBtn = document.getElementById('reloadButton');\n        if (legacyBtn) {\n            legacyBtn.click();\n        } else {\n            window.location.reload(true);\n        }\n    });\n\n    container.appendChild(btn);\n}\n\n// Note: injectDatabaseToggle was removed - device database is now\n// accessed via the Device Library view in the V2 sidebar navigation.\n\n/**\n * [New] Sidebar Translations\n * Updates sidebar text based on current language\n */\n/**\n * [New] Sidebar Translations\n * Updates sidebar text based on current language\n */\nfunction updateSidebarTranslations(lang) {\n    // Update Nav Links\n    const textElements = document.querySelectorAll('.v2-sidebar-link-text, .v2-sidebar-section-title');\n\n    textElements.forEach(el => {\n        if (!el.dataset.key) el.dataset.key = el.textContent.trim();\n        const originalText = el.dataset.key; // e.g. \"Settings\" or \"All Projects\"\n\n        const translationKey = TEXT_TO_KEY_MAP[originalText];\n        if (translationKey) {\n            el.textContent = _t(translationKey, {}, lang);\n        }\n    });\n\n    // Update Search Placeholder\n    const searchInput = document.getElementById(SEARCH_INPUT_ID);\n    if (searchInput) {\n        searchInput.placeholder = _t('v2.sidebar.search.placeholder', {}, lang);\n        searchInput.setAttribute('aria-label', _t('v2.sidebar.search.label', {}, lang));\n    }\n}\n\n// Expose for external calls\nglobal.updateSidebarTranslations = updateSidebarTranslations;\n\n// =====================\n// THEME HANDLING\n// =====================\n\nfunction initThemes() {\n    // Theme controls are injected via injectTopControls -> injectThemeControls\n    applyStoredThemes();\n}\n\nfunction resolveThemeVariant(isDark, isPink) {\n    if (isPink) {\n        return isDark ? 'pink-dark' : 'pink-light';\n    }\n    return isDark ? 'dark' : 'light';\n}\n\nfunction syncThemeVariantAttributes() {\n    const body = document.body;\n    const root = document.documentElement;\n    if (!body || !root) {\n        return;\n    }\n\n    const isDark = body.classList.contains('dark-mode');\n    const isPink = body.classList.contains('pink-mode');\n    const variant = resolveThemeVariant(isDark, isPink);\n    root.setAttribute('data-theme', variant);\n    body.setAttribute('data-theme', variant);\n\n    const themeVariantSelect = document.getElementById('themeVariantSelect');\n    if (themeVariantSelect && themeVariantSelect.value !== variant) {\n        themeVariantSelect.value = variant;\n    }\n}\n\nfunction injectThemeControls(container) {\n    // Prevent duplicate injection\n    if (container.querySelector('#v2ThemeToggleDark')) return;\n\n    // Dark Mode Toggle - V1 Style\n    const darkBtn = document.createElement('button');\n    darkBtn.className = 'v2-theme-toggle';\n    darkBtn.id = 'v2ThemeToggleDark';\n    darkBtn.setAttribute('aria-label', 'Toggle dark mode');\n    darkBtn.setAttribute('aria-pressed', 'false');\n    darkBtn.setAttribute('title', 'Toggle dark mode');\n    // Use V1 uicons glyphs for Moon and Sun\n    darkBtn.innerHTML = `\n            <span class=\"v2-icon-moon icon-glyph\" aria-hidden=\"true\" data-icon-font=\"uicons\">&#xEC7E;</span>\n            <span class=\"v2-icon-sun icon-glyph\" aria-hidden=\"true\" data-icon-font=\"uicons\" style=\"display:none\">&#xF1FE;</span>\n        `;\n    darkBtn.addEventListener('click', toggleDarkMode);\n\n    // Pink Mode Toggle - V1 Style with Capybara SVG\n    const pinkBtn = document.createElement('button');\n    pinkBtn.className = 'v2-theme-toggle';\n    pinkBtn.id = 'v2ThemeTogglePink';\n    pinkBtn.setAttribute('aria-label', 'Toggle pink mode');\n    pinkBtn.setAttribute('aria-pressed', 'false');\n    pinkBtn.setAttribute('title', 'Toggle pink mode');\n    pinkBtn.setAttribute('data-theme', 'pink');\n    // V1 Capybara SVG\n    pinkBtn.innerHTML = `\n            <span class=\"icon-glyph icon-svg pink-mode-icon\" aria-hidden=\"true\">\n                <svg viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\">\n                    <path d=\"m1 40c0-8 3-17 3-17a4.84 4.84 0 0 0-1.829-3.064 1 1 0 0 1 .45-1.716 19.438 19.438 0 0 1 4.379-.22c.579-2.317-1.19-3.963-2.782-4.938a1 1 0 0 1 .393-1.85 14.128 14.128 0 0 1 6.389.788c0-.958-1.147-2.145-2.342-3.122a1 1 0 0 1 .708-1.773 40.655 40.655 0 0 1 6.634.895 3.723 3.723 0 0 0-1.049-2.264 1 1 0 0 1 .823-1.652c6.151.378 9.226 1.916 9.226 1.916l10-1s8.472-2.311 15.954.5a1 1 0 0 1-.084 1.9c-1.455.394-2.87 1.143-2.87 2.6 0 0 4.426.738 5.675 4.114a1 1 0 0 1-1.228 1.317c-1.64-.48-4.273-.88-6.447.569Z\" fill=\"#805333\" />\n                    <path d=\"m30.18 42.82c1.073 2.7 2.6 9.993 3.357 13.8a2 2 0 0 1-1.964 2.38h-28.573a2 2 0 0 1-2-2v-18c0-2.55 10.03-22.11 23.99-23.87Z\" fill=\"#a56a43\" />\n                    <path d=\"m55.67 48.46-6.34 2.97a6 6 0 0 1-7.98-2.88l-.25-.54-.76-1.6a4.956 4.956 0 0 0-4.68-2.87c-.22.01-.44.02-.66.02a16.019 16.019 0 0 1-8.28-29.66c-1.81-2.97-3.45-8.03 2.03-12.49a2.1 2.1 0 0 1 2.5 0c4.23 3.45 4.21 7.25 3.16 10.17a16 16 0 0 1 15.91 11.36l5.31 11.31 2.92 6.22a6.008 6.008 0 0 1-2.88 7.99Z\" fill=\"#cb8252\" />\n                    <circle cx=\"42\" cy=\"26\" r=\"3\" fill=\"#2c2f38\" />\n                    <circle cx=\"54\" cy=\"43\" r=\"1\" fill=\"#805333\" />\n                    <path d=\"m58.55 40.47-2.92-6.22-14.53 13.76.25.54a6 6 0 0 0 7.98 2.88l6.34-2.97a6.008 6.008 0 0 0 2.88-7.99Zm-4.55 3.53a1 1 0 1 1 1-1 1 1 0 0 1-1 1Z\" fill=\"#cf976a\" />\n                    <circle cx=\"41\" cy=\"25\" r=\"1.25\" fill=\"#ecf0f1\" />\n                </svg>\n            </span>\n        `;\n    pinkBtn.addEventListener('click', togglePinkMode);\n\n    container.appendChild(darkBtn);\n    container.appendChild(pinkBtn);\n}\n\nfunction applyStoredThemes() {\n    const isDark = localStorage.getItem(DARK_MODE_KEY) === 'true';\n    updateDarkModeDisplay(isDark);\n    const isPink = localStorage.getItem(PINK_MODE_KEY) === 'true';\n    updatePinkModeDisplay(isPink);\n}\n\nfunction toggleDarkMode() {\n    const isDark = document.body.classList.contains('dark-mode');\n    const newState = !isDark;\n    updateDarkModeDisplay(newState);\n    localStorage.setItem(DARK_MODE_KEY, newState);\n}\n\nfunction updateDarkModeDisplay(enabled) {\n    document.body.classList.toggle('dark-mode', enabled);\n    document.body.classList.toggle('light-mode', !enabled);\n    const btn = document.getElementById('v2ThemeToggleDark');\n    if (btn) {\n        btn.classList.toggle('active', enabled);\n        const moon = btn.querySelector('.v2-icon-moon');\n        const sun = btn.querySelector('.v2-icon-sun');\n        if (moon && sun) {\n            moon.style.display = enabled ? 'none' : 'block';\n            sun.style.display = enabled ? 'block' : 'none';\n        }\n    }\n    syncThemeVariantAttributes();\n}\n\nfunction togglePinkMode() {\n    const isPink = document.body.classList.contains('pink-mode');\n    const newState = !isPink;\n    updatePinkModeDisplay(newState);\n    localStorage.setItem(PINK_MODE_KEY, newState);\n    localStorage.setItem(FALLBACK_PINK_KEY, newState);\n}\n\nfunction updatePinkModeDisplay(enabled) {\n    document.body.classList.toggle('pink-mode', enabled);\n    updateAppLogo(enabled);\n    const btn = document.getElementById('v2ThemeTogglePink');\n    if (btn) btn.classList.toggle('active', enabled);\n    syncThemeVariantAttributes();\n}\n\nfunction updateAppLogo(isPink) {\n    const logo = document.querySelector('.v2-sidebar-logo');\n    if (!logo) return;\n    logo.src = isPink ? 'src/icons/Icon Pinknew.svg' : 'src/icons/Icon Bluenew.svg';\n}\n\n// =====================\n// EXPORTS\n// =====================\nexport const V2Sidebar = {\n    init: initSidebar\n};\n\n// Expose to global scope\nif (typeof global !== 'undefined') {\n    global.cineV2Sidebar = V2Sidebar;\n}\n\nif (typeof window !== 'undefined') {\n    window.cineV2Sidebar = V2Sidebar;\n}\n","/**\n * Cine Power Planner V2 - Base View Class\n * ========================================\n * Base class for V2 views to handle common lifecycle and registration.\n */\n\nexport class View {\n    constructor(viewId) {\n        this.viewId = viewId;\n        this.container = null;\n        this.isInitialized = false;\n    }\n\n    /**\n     * Initialize the view\n     * - Finds or creates container\n     * - Registers with ViewManager\n     */\n    init() {\n        if (this.isInitialized) return;\n\n        console.log(`[View: ${this.viewId}] Initializing...`);\n\n        this.container = document.getElementById(this.viewId);\n\n        // Auto-create if missing (optional, but helpful)\n        if (!this.container) {\n            const app = document.querySelector('.v2-app') || document.body;\n            this.container = document.createElement('div');\n            this.container.id = this.viewId;\n            this.container.className = 'app-view';\n            app.appendChild(this.container);\n        }\n\n        // Register with ViewManager\n        // Map view-rules -> rules, view-settings -> settings, etc.\n        const shortName = this.viewId.replace(/^view-/, '');\n\n        if (window.cineViewManager) {\n            window.cineViewManager.registerView(shortName, {\n                onEnter: (params) => this.render(params),\n                onLeave: () => this.onLeave && this.onLeave()\n            });\n        }\n\n        this.isInitialized = true;\n    }\n\n    /**\n     * Render the view content\n     * @param {object} params - Route parameters\n     */\n    render(params) {\n        console.warn(`[View: ${this.viewId}] Render method not implemented`);\n    }\n\n    /**\n     * Called when leaving the view\n     */\n    onLeave() {\n        // Optional override\n    }\n\n    /**\n     * Helper to escape HTML safely\n     */\n    escapeHtml(str) {\n        if (!str) return '';\n        return String(str)\n            .replace(/&/g, '&amp;')\n            .replace(/</g, '&lt;')\n            .replace(/>/g, '&gt;')\n            .replace(/\"/g, '&quot;')\n            .replace(/'/g, '&#39;');\n    }\n}\n","import { View } from '../view.js';\n\nexport class RulesView extends View {\n    constructor() {\n        super('rules');\n        this.devicesLocal = {};\n    }\n\n    async render() {\n        if (!window.getAutoGearRules) {\n            // Core not ready? Retry.\n            this.container.innerHTML = `\n                <div class=\"v2-loading-state\">\n                    <div class=\"v2-spinner\"></div>\n                    <p class=\"v2-text-muted\">Loading Auto Gear Core...</p>\n                </div>\n            `;\n            setTimeout(() => this.render(), 500);\n            return;\n        }\n\n        const rules = window.getAutoGearRules() || [];\n        const rulesCount = rules.length;\n\n        const header = `\n            <div class=\"v2-view-header\">\n                <div>\n                    <h1 class=\"v2-view-title\">Auto Gear Rules</h1>\n                    <p class=\"v2-view-subtitle\">Define automatic equipment packages based on shoot conditions.</p>\n                </div>\n                <div class=\"v2-actions-group\">\n                    <button class=\"v2-btn v2-btn-secondary\" id=\"v2-ag-import\">Import</button>\n                    <button class=\"v2-btn v2-btn-secondary\" id=\"v2-ag-export\">Export</button>\n                    <button class=\"v2-btn v2-btn-primary\" id=\"v2-ag-add\">\n                        <span class=\"v2-icon\">add</span> New Rule\n                    </button>\n                </div>\n            </div>\n        `;\n\n        if (rulesCount === 0) {\n            this.container.innerHTML = header + `\n                <div class=\"v2-empty-state\">\n                    <div class=\"v2-empty-icon\">rule</div>\n                    <h3>No Rules Defined</h3>\n                    <p>Create rules to automatically add gear (like specific monitors for a director) based on the scenario.</p>\n                    <button class=\"v2-btn v2-btn-primary\" id=\"v2-ag-add-empty\">Create First Rule</button>\n                </div>\n            `;\n        } else {\n            this.container.innerHTML = header + `\n                <div class=\"v2-rules-grid\">\n                    ${rules.map((rule, idx) => this.renderRuleCard(rule, idx)).join('')}\n                </div>\n            `;\n        }\n\n        this.attachListeners();\n    }\n\n    renderRuleCard(rule, index) {\n        const actionCount = (rule.addItems || []).length;\n        const conditionCount = this.countConditions(rule);\n\n        return `\n            <div class=\"v2-card v2-rule-card\" data-index=\"${index}\">\n                <div class=\"v2-card-header\">\n                    <div class=\"v2-rule-title-group\">\n                        <div class=\"v2-rule-status ${rule.enabled ? 'active' : 'inactive'}\"></div>\n                        <h3 class=\"v2-card-title\">${this.escapeHtml(rule.name || 'Unnamed Rule')}</h3>\n                    </div>\n                     <div class=\"v2-card-actions\">\n                        <button class=\"v2-btn-icon\" data-action=\"edit\" data-index=\"${index}\" title=\"Edit\">edit</button>\n                        <button class=\"v2-btn-icon v2-danger-hover\" data-action=\"delete\" data-index=\"${index}\" title=\"Delete\">delete</button>\n                    </div>\n                </div>\n                <div class=\"v2-card-body\">\n                    <div class=\"v2-rule-meta\">\n                        <span class=\"v2-tag\">${rule.scenarioMode || 'All Scenarios'}</span>\n                        <span class=\"v2-tag v2-tag-outline\">${conditionCount} Conditions</span>\n                        <span class=\"v2-tag v2-tag-outline\">${actionCount} Actions</span>\n                    </div>\n                    ${rule.always ? '<div class=\"v2-badge v2-badge-accent\">Always Active</div>' : ''}\n                </div>\n            </div>\n        `;\n    }\n\n    countConditions(rule) {\n        let count = 0;\n        if (rule.scenarios && rule.scenarios.length) count += rule.scenarios.length;\n        if (rule.cameras && rule.cameras.length) count++;\n        if (rule.cameraHandles && rule.cameraHandles.length) count++;\n        if (rule.monitors && rule.monitors.length) count++;\n        return count; // Simplified count\n    }\n\n    attachListeners() {\n        const importBtn = this.container.querySelector('#v2-ag-import');\n        if (importBtn) importBtn.addEventListener('click', () => this.handleImport());\n\n        const exportBtn = this.container.querySelector('#v2-ag-export');\n        if (exportBtn) exportBtn.addEventListener('click', () => this.handleExport());\n\n        const addBtns = this.container.querySelectorAll('#v2-ag-add, #v2-ag-add-empty');\n        addBtns.forEach(btn => btn.addEventListener('click', () => this.showEditRuleModal({}, true)));\n\n        this.container.querySelectorAll('[data-action=\"edit\"]').forEach(btn => {\n            btn.addEventListener('click', (e) => {\n                const idx = parseInt(e.currentTarget.dataset.index, 10);\n                const rules = window.getAutoGearRules();\n                if (rules && rules[idx]) {\n                    this.showEditRuleModal(rules[idx], false, idx);\n                }\n            });\n        });\n\n        this.container.querySelectorAll('[data-action=\"delete\"]').forEach(btn => {\n            btn.addEventListener('click', (e) => {\n                const idx = parseInt(e.currentTarget.dataset.index, 10);\n                this.deleteRule(idx);\n            });\n        });\n    }\n\n    // --- Data Collection Helper ---\n    collectData() {\n        // Collect data from window.devices or fallback\n        const d = window.devices || {};\n        return {\n            cameras: Object.keys(d.cameras || {}).sort(),\n            monitors: Object.keys(d.monitors || {}).sort(),\n            video: Object.keys(d.video || {}).sort(), // Video Distribution\n            cameraHandles: this.getHardcodedOptions('cameraHandle'), // Predefined list\n            scenarios: window.SCENARIOS || ['Studio', 'Location', 'Handheld', 'Gimbal', 'Steadicam', 'Crane', 'Drone', 'Underwater', 'Car Mount'],\n            viewfinders: Object.keys(d.viewfinders || {}).sort(),\n            matteboxes: Object.keys(d.matteboxes || {}).sort(),\n            tripodHeads: Object.keys(d.tripodHeads || {}).sort(),\n            tripodBowls: ['75mm', '100mm', '150mm', 'Flat', 'Mitchell'], // Common bowls\n            wireless: Object.keys(d.wireless || {}).sort()\n        };\n    }\n\n    getHardcodedOptions(type) {\n        if (type === 'cameraHandle') {\n            return ['Blue Shape Top Handle', 'ARRI CCH-4', 'ARRI HEB-3', 'Wooden Camera Master Top Handle'];\n        }\n        if (type === 'deliveryResolution') {\n            return ['1080p', '2K', '4K UHD', '4K DCI', '6K', '8K'];\n        }\n        return [];\n    }\n\n    // --- Edit Modal ---\n    showEditRuleModal(rule, isNew, ruleIndex = -1) {\n        const data = this.collectData();\n\n        // Deep clone rule to avoid live edits\n        const currentRule = JSON.parse(JSON.stringify(rule));\n        if (!currentRule.scenarios) currentRule.scenarios = [];\n        if (!currentRule.addItems) currentRule.addItems = [];\n\n        // Determine Scenarios value\n        const scenarioVal = currentRule.scenarios || [];\n\n        const backdrop = document.createElement('div');\n        backdrop.className = 'v2-modal-backdrop';\n\n        backdrop.innerHTML = `\n            <div class=\"v2-modal v2-modal-lg\">\n                <div class=\"v2-modal-header\">\n                    <h2>${isNew ? 'New Rule' : 'Edit Rule'}</h2>\n                    <button class=\"v2-modal-close\">&times;</button>\n                </div>\n                <div class=\"v2-modal-body v2-layout-sidebar\">\n                    <div class=\"v2-sidebar-nav\">\n                        <button class=\"v2-nav-item active\" data-tab=\"general\">General</button>\n                        <button class=\"v2-nav-item\" data-tab=\"camera\">Camera</button>\n                        <button class=\"v2-nav-item\" data-tab=\"monitoring\">Monitoring</button>\n                        <button class=\"v2-nav-item\" data-tab=\"support\">Support</button>\n                        <button class=\"v2-nav-item\" data-tab=\"crew\">Crew</button>\n                        <button class=\"v2-nav-item\" data-tab=\"actions\">Actions</button>\n                    </div>\n                    <div class=\"v2-tab-content active\" id=\"tab-general\">\n                        <div class=\"v2-form-group\">\n                            <label>Rule Name</label>\n                            <input type=\"text\" class=\"v2-input\" id=\"rule-name\" value=\"${this.escapeHtml(currentRule.name || '')}\" placeholder=\"e.g. Director's Monitor\">\n                        </div>\n                        <div class=\"v2-form-check\">\n                            <input type=\"checkbox\" id=\"rule-enabled\" ${currentRule.enabled !== false ? 'checked' : ''}>\n                            <label for=\"rule-enabled\">Rule Enabled</label>\n                        </div>\n                        <div class=\"v2-form-check\">\n                            <input type=\"checkbox\" id=\"rule-always\" ${currentRule.always ? 'checked' : ''}>\n                            <label for=\"rule-always\">Always Apply (Ignore Scenarios)</label>\n                        </div>\n                        <hr class=\"v2-divider\">\n                        <div class=\"v2-form-group\">\n                            <label>Scenario Logic</label>\n                            <select class=\"v2-select\" id=\"rule-scenario-mode\">\n                                <option value=\"any\" ${currentRule.scenarioMode === 'any' ? 'selected' : ''}>Match ANY selected scenario</option>\n                                <option value=\"all\" ${currentRule.scenarioMode === 'all' ? 'selected' : ''}>Match ALL selected scenarios</option>\n                            </select>\n                        </div>\n                        <div class=\"v2-form-group\">\n                            <label>Scenarios</label>\n                            <div class=\"v2-checkbox-grid\">\n                                ${data.scenarios.map(s => `\n                                    <label class=\"v2-checkbox-label\">\n                                        <input type=\"checkbox\" class=\"scenario-check\" value=\"${s}\" ${scenarioVal.includes(s) ? 'checked' : ''}>\n                                        ${s}\n                                    </label>\n                                `).join('')}\n                            </div>\n                        </div>\n                        <div class=\"v2-form-group\">\n                             <label>Shooting Days (Optional)</label>\n                             <div class=\"v2-row-gap\">\n                                <select class=\"v2-select\" id=\"rule-days-cond\">\n                                    <option value=\"\">(Ignore)</option>\n                                    <option value=\"min\" ${currentRule.shootingDaysCondition === 'min' ? 'selected' : ''}>Minimum Days</option>\n                                    <option value=\"max\" ${currentRule.shootingDaysCondition === 'max' ? 'selected' : ''}>Maximum Days</option>\n                                </select>\n                                <input type=\"number\" class=\"v2-input v2-input-sm\" id=\"rule-days-val\" value=\"${currentRule.shootingDaysValue || ''}\" min=\"1\">\n                             </div>\n                        </div>\n                    </div>\n\n                    <div class=\"v2-tab-content\" id=\"tab-camera\" style=\"display:none;\">\n                        ${this.renderMultiSelect('Cameras', 'cameras', data.cameras, currentRule.cameras)}\n                        ${this.renderMultiSelect('Matteboxes', 'matteboxes', data.matteboxes, currentRule.matteboxes)}\n                        ${this.renderMultiSelect('Camera Handles', 'cameraHandles', data.cameraHandles, currentRule.cameraHandles)}\n                        ${this.renderMultiSelect('Viewfinders', 'viewfinders', data.viewfinders, currentRule.viewfinders)}\n                         <div class=\"v2-form-group\">\n                            <label>Delivery Resolution</label>\n                            <select class=\"v2-select\" id=\"rule-delivery-res\">\n                                <option value=\"\">(Any)</option>\n                                ${this.getHardcodedOptions('deliveryResolution').map(r => `<option value=\"${r}\" ${currentRule.deliveryResolution === r ? 'selected' : ''}>${r}</option>`).join('')}\n                            </select>\n                        </div>\n                    </div>\n\n                    <div class=\"v2-tab-content\" id=\"tab-monitoring\" style=\"display:none;\">\n                         ${this.renderMultiSelect('Monitors', 'monitors', data.monitors, currentRule.monitors)}\n                         ${this.renderMultiSelect('Video Distribution', 'videoDist', data.video, currentRule.videoDistribution)}\n                         ${this.renderMultiSelect('Wireless Video', 'wireless', data.wireless, currentRule.wireless)}\n                    </div>\n\n                    <div class=\"v2-tab-content\" id=\"tab-support\" style=\"display:none;\">\n                        ${this.renderMultiSelect('Tripod Heads', 'tripodHeads', data.tripodHeads, currentRule.tripodHeads)}\n                        ${this.renderMultiSelect('Tripod Bowls', 'tripodBowls', data.tripodBowls, currentRule.tripodBowls)}\n                    </div>\n\n                    <div class=\"v2-tab-content\" id=\"tab-crew\" style=\"display:none;\">\n                        <p class=\"v2-text-muted\">Requires specific crew members to be present/absent.</p>\n                         <div class=\"v2-form-group\">\n                            <label>Crew Present (Comma separated)</label>\n                            <input type=\"text\" class=\"v2-input\" id=\"rule-crew-present\" value=\"${(currentRule.crewPresent || []).join(', ')}\">\n                        </div>\n                        <div class=\"v2-form-group\">\n                            <label>Crew Absent (Comma separated)</label>\n                            <input type=\"text\" class=\"v2-input\" id=\"rule-crew-absent\" value=\"${(currentRule.crewAbsent || []).join(', ')}\">\n                        </div>\n                    </div>\n\n                    <div class=\"v2-tab-content\" id=\"tab-actions\" style=\"display:none;\">\n                        <h3>Items to Add</h3>\n                        <p class=\"v2-text-muted\">When rule matches, these items are added to the list.</p>\n                        \n                        <div class=\"v2-action-list\" id=\"rule-action-list\">\n                            ${this.renderActionListItems(currentRule.addItems)}\n                        </div>\n                        \n                        <div class=\"v2-add-item-row\">\n                            <input type=\"text\" class=\"v2-input\" id=\"new-item-name\" placeholder=\"Search item...\">\n                            <input type=\"number\" class=\"v2-input v2-input-sm\" id=\"new-item-qty\" value=\"1\" min=\"1\">\n                            <button class=\"v2-btn v2-btn-secondary\" id=\"btn-add-action-item\">Add</button>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"v2-modal-footer\">\n                    <button class=\"v2-btn v2-btn-ghost\" id=\"v2-modal-cancel\">Cancel</button>\n                    <button class=\"v2-btn v2-btn-primary\" id=\"v2-modal-save\">Save Rule</button>\n                </div>\n            </div>\n        `;\n\n        document.body.appendChild(backdrop);\n\n        // Bind Events\n        const close = () => {\n            backdrop.remove();\n        };\n\n        backdrop.querySelector('.v2-modal-close').onclick = close;\n        backdrop.querySelector('#v2-modal-cancel').onclick = close;\n\n        // Tabs\n        const tabs = backdrop.querySelectorAll('.v2-nav-item');\n        const contents = backdrop.querySelectorAll('.v2-tab-content');\n        tabs.forEach(t => {\n            t.onclick = () => {\n                tabs.forEach(x => x.classList.remove('active'));\n                contents.forEach(x => { x.style.display = 'none'; x.classList.remove('active'); });\n                t.classList.add('active');\n                const target = backdrop.querySelector(`#tab-${t.dataset.tab}`);\n                if (target) {\n                    target.style.display = 'block';\n                    // force layout check\n                    setTimeout(() => target.classList.add('active'), 10);\n                }\n            };\n        });\n\n        // Add Item Action\n        const actionListEl = backdrop.querySelector('#rule-action-list');\n        const addItemBtn = backdrop.querySelector('#btn-add-action-item');\n        const newItemName = backdrop.querySelector('#new-item-name');\n        const newItemQty = backdrop.querySelector('#new-item-qty');\n\n        addItemBtn.onclick = () => {\n            const name = newItemName.value.trim();\n            const qty = parseInt(newItemQty.value, 10);\n            if (name) {\n                currentRule.addItems.push({ name, qty });\n                actionListEl.innerHTML = this.renderActionListItems(currentRule.addItems);\n                newItemName.value = '';\n                this.bindRemoveActionEvents(actionListEl, currentRule);\n            }\n        };\n\n        this.bindRemoveActionEvents(actionListEl, currentRule);\n\n        // Save\n        backdrop.querySelector('#v2-modal-save').onclick = () => {\n            // Collect Form Data\n            const updatedRule = {\n                ...currentRule,\n                name: backdrop.querySelector('#rule-name').value.trim(),\n                enabled: backdrop.querySelector('#rule-enabled').checked,\n                always: backdrop.querySelector('#rule-always').checked,\n                scenarioMode: backdrop.querySelector('#rule-scenario-mode').value,\n                scenarios: Array.from(backdrop.querySelectorAll('.scenario-check:checked')).map(el => el.value),\n                shootingDaysCondition: backdrop.querySelector('#rule-days-cond').value,\n                shootingDaysValue: parseInt(backdrop.querySelector('#rule-days-val').value, 10) || 0,\n                // Multi-selects\n                cameras: this.collectMultiSelect(backdrop, 'cameras'),\n                matteboxes: this.collectMultiSelect(backdrop, 'matteboxes'),\n                cameraHandles: this.collectMultiSelect(backdrop, 'cameraHandles'),\n                viewfinders: this.collectMultiSelect(backdrop, 'viewfinders'),\n                monitors: this.collectMultiSelect(backdrop, 'monitors'),\n                videoDistribution: this.collectMultiSelect(backdrop, 'videoDist'),\n                wireless: this.collectMultiSelect(backdrop, 'wireless'),\n                tripodHeads: this.collectMultiSelect(backdrop, 'tripodHeads'),\n                tripodBowls: this.collectMultiSelect(backdrop, 'tripodBowls'),\n\n                deliveryResolution: backdrop.querySelector('#rule-delivery-res').value,\n                crewPresent: backdrop.querySelector('#rule-crew-present').value.split(',').map(s => s.trim()).filter(s => s),\n                crewAbsent: backdrop.querySelector('#rule-crew-absent').value.split(',').map(s => s.trim()).filter(s => s),\n            };\n\n            if (!updatedRule.name) {\n                alert('Rule name is required');\n                return;\n            }\n\n            this.saveRule(updatedRule, isNew, ruleIndex);\n            close();\n        };\n    }\n\n    renderMultiSelect(label, id, options, selected = []) {\n        if (!options || options.length === 0) return '';\n        const safeSelected = selected || [];\n        return `\n            <div class=\"v2-form-group\">\n                <label>${label}</label>\n                <div class=\"v2-multi-select-container\">\n                    ${options.map(opt => `\n                         <label class=\"v2-checkbox-label\">\n                            <input type=\"checkbox\" class=\"multi-${id}\" value=\"${this.escapeHtml(opt)}\" ${safeSelected.includes(opt) ? 'checked' : ''}>\n                            <span>${this.escapeHtml(opt)}</span>\n                        </label>\n                    `).join('')}\n                </div>\n            </div>\n        `;\n    }\n\n    collectMultiSelect(parent, id) {\n        return Array.from(parent.querySelectorAll(`.multi-${id}:checked`)).map(el => el.value);\n    }\n\n    renderActionListItems(items) {\n        if (!items || !items.length) return '<p class=\"v2-text-muted\">No items added yet.</p>';\n        return items.map((item, idx) => `\n            <div class=\"v2-action-item\">\n                <span class=\"v2-badge v2-badge-outline item-qty\">${item.qty}x</span>\n                <span class=\"item-name\">${this.escapeHtml(item.name)}</span>\n                <button class=\"v2-btn-icon-sm v2-danger-hover remove-action-item\" data-idx=\"${idx}\">&times;</button>\n            </div>\n        `).join('');\n    }\n\n    bindRemoveActionEvents(container, currentRule) {\n        container.querySelectorAll('.remove-action-item').forEach(btn => {\n            btn.onclick = (e) => {\n                const idx = parseInt(e.target.dataset.idx, 10);\n                currentRule.addItems.splice(idx, 1);\n                container.innerHTML = this.renderActionListItems(currentRule.addItems);\n                this.bindRemoveActionEvents(container, currentRule);\n            };\n        });\n    }\n\n    saveRule(rule, isNew, index) {\n        const rules = window.getAutoGearRules() || [];\n        if (isNew) {\n            rules.push(rule);\n        } else {\n            rules[index] = rule;\n        }\n\n        if (window.setAutoGearRules) {\n            window.setAutoGearRules(rules);\n            // Trigger autosave if possible\n            if (window.requestAutoSave) window.requestAutoSave();\n            this.render();\n        } else {\n            console.error('Core function setAutoGearRules not available');\n        }\n    }\n\n    deleteRule(index) {\n        if (!confirm('Are you sure you want to delete this rule?')) return;\n        const rules = window.getAutoGearRules() || [];\n        rules.splice(index, 1);\n        window.setAutoGearRules(rules);\n        if (window.requestAutoSave) window.requestAutoSave();\n        this.render();\n    }\n\n}\n\n// Instantiate and expose globally so bootstrap can init it\nif (typeof window !== 'undefined') {\n    window.cineRulesView = new RulesView();\n}\n","/**\n * Cine Power Planner V2 - Device Library View\n * ===========================================\n * Manages the Device Library view by integrating the legacy Device Manager.\n * \n * Strategy:\n * This view acts as a wrapper for the existing (Legacy) Device Manager logic.\n * Instead of rewriting the complex CRUD logic for devices, we simply:\n * 1. Create a modern V2 view structure with header and sections\n * 2. \"Borrow\" the DOM elements from the legacy #device-manager section.\n * 3. Reparent them into the V2 layout with proper styling.\n */\n\n(function (global) {\n    'use strict';\n\n    // =====================\n    // CONFIGURATION\n    // =====================\n    const CONTENT_CONTAINER_ID = 'v2-device-library-content';\n    const LEGACY_CONTAINER_ID = 'device-manager';\n\n    // =====================\n    // STATE\n    // =====================\n    let isInitialized = false;\n    let isReparented = false;\n    let legacyVisibilityState = null;\n\n    // =====================\n    // HELPER: Translations\n    // =====================\n    function _t(key) {\n        if (typeof window !== 'undefined' && window.texts) {\n            const langSelect = document.getElementById('languageSelect');\n            const lang = (langSelect && langSelect.value) ||\n                (typeof window.currentLanguage === 'string' && window.currentLanguage) ||\n                'en';\n\n            const dict = window.texts[lang] || window.texts['en'];\n            if (dict) {\n                return key.split('.').reduce((o, i) => (o ? o[i] : null), dict) || key;\n            }\n        }\n        return key;\n    }\n\n    // =====================\n    // DOM MANIPULATION\n    // =====================\n\n    /**\n     * Inject action buttons into the existing view-header (from index.html)\n     */\n    function injectHeaderActions() {\n        const viewSection = document.getElementById('view-devices');\n        if (!viewSection) return;\n\n        const existingHeader = viewSection.querySelector('.view-header');\n        if (!existingHeader) return;\n\n        // Check if actions already exist\n        let actionsContainer = existingHeader.querySelector('.view-header-actions');\n        if (!actionsContainer) {\n            actionsContainer = document.createElement('div');\n            actionsContainer.className = 'view-header-actions';\n            existingHeader.appendChild(actionsContainer);\n        }\n\n        // Clear and add our buttons\n        actionsContainer.innerHTML = `\n            <button class=\"v2-btn v2-btn-secondary\" id=\"v2-export-db-btn\" title=\"Export database to file\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"7 10 12 15 17 10\"/><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"/></svg>\n                <span>Export</span>\n            </button>\n            <button class=\"v2-btn v2-btn-secondary\" id=\"v2-import-db-btn\" title=\"Import database from file\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"17 8 12 3 7 8\"/><line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/></svg>\n                <span>Import</span>\n            </button>\n            <button class=\"v2-btn v2-btn-danger\" id=\"v2-reset-db-btn\" title=\"Reset to default database\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"1 4 1 10 7 10\"/><path d=\"M3.51 15a9 9 0 1 0 2.13-9.36L1 10\"/></svg>\n                <span>Reset</span>\n            </button>\n        `;\n    }\n\n    /**\n     * Move Legacy Device Manager elements into V2 View\n     */\n    function reparentLegacyContent() {\n        if (isReparented) return;\n\n        console.log('[DeviceLibraryView] Reparenting legacy content...');\n\n        const v2Container = document.getElementById(CONTENT_CONTAINER_ID);\n        const legacyContainer = document.getElementById(LEGACY_CONTAINER_ID);\n\n        if (!v2Container) {\n            console.error(`[DeviceLibraryView] V2 Container #${CONTENT_CONTAINER_ID} not found.`);\n            return;\n        }\n\n        if (!legacyContainer) {\n            console.error(`[DeviceLibraryView] Legacy Container #${LEGACY_CONTAINER_ID} not found.`);\n            return;\n        }\n\n        // --- HIERARCHY PRESERVATION FIX ---\n        // Instead of taking children OUT of #device-manager, we move #device-manager ITSELF\n        // into our view. This preserves event delegation on #device-manager.\n\n        // 1. Create a placeholder to know where to put it back later\n        legacyVisibilityState = legacyContainer.classList.contains('hidden');\n        const placeholder = document.createElement('div');\n        placeholder.id = 'device-manager-placeholder';\n        placeholder.style.display = 'none';\n        legacyContainer.parentNode.insertBefore(placeholder, legacyContainer);\n\n        // 2. Inject action buttons into existing header (not a new one)\n        injectHeaderActions();\n\n        // 3. Clear V2 content container (not creating header here anymore)\n        v2Container.innerHTML = '';\n\n        // 3. Create wrapper for content tiles\n        const contentWrapper = document.createElement('div');\n        contentWrapper.className = 'device-library-content-wrapper';\n\n        // 4. Move #device-manager into our container\n        legacyContainer.classList.remove('hidden');\n\n        // 5. Organize content into TWO SEPARATE TILES\n\n        // Tile 1: Add New Device Form\n        const formTile = document.createElement('section');\n        formTile.className = 'v2-card device-library-form-tile';\n        formTile.innerHTML = '<h2 class=\"tile-heading\">Add New Device</h2>';\n\n        // Tile 2: Existing Devices List\n        const listTile = document.createElement('section');\n        listTile.className = 'v2-card device-library-list-tile';\n        listTile.innerHTML = '<h2 class=\"tile-heading\">Existing Devices</h2>';\n\n        // 6. Process legacy children and move to appropriate tiles\n        const children = Array.from(legacyContainer.children);\n        children.forEach(child => {\n            // Hide all duplicate headings\n            if (child.id === 'deviceManagerHeading' || child.id === 'addDeviceHeading' || child.id === 'existingDevicesHeading') {\n                child.style.display = 'none';\n            }\n            // Hide legacy action buttons (now in header)\n            else if (child.id === 'exportDataBtn' || child.id === 'importDataBtn' || child.id === 'exportAndRevertBtn') {\n                child.style.display = 'none';\n            }\n            // Button group (Add New Device form) -> Form Tile\n            else if (child.classList.contains('button-group')) {\n                // Hide extra buttons within button-group (Export/Import/Reset now in header)\n                const extraButtons = child.querySelectorAll('#exportDataBtn, #importDataBtn, #exportAndRevertBtn');\n                extraButtons.forEach(btn => btn.style.display = 'none');\n\n                formTile.appendChild(child);\n            }\n            // Search and device list -> List Tile\n            else if (child.classList.contains('device-library-search') || child.id === 'deviceListContainer') {\n                if (child.classList.contains('device-library-search')) {\n                    const searchInput = child.querySelector('input');\n                    if (searchInput) {\n                        searchInput.classList.add('v2-input');\n                        const tVal = _t('searchPlaceholder');\n                        searchInput.placeholder = (tVal && tVal !== 'searchPlaceholder') ? tVal : 'Search all device categories...';\n                    }\n                }\n                listTile.appendChild(child);\n            }\n        });\n\n        // 7. Append tiles to wrapper\n        contentWrapper.appendChild(formTile);\n        contentWrapper.appendChild(listTile);\n\n        // 8. Add wrapper to container and legacy container for event delegation\n        v2Container.appendChild(contentWrapper);\n        v2Container.appendChild(legacyContainer); // Keep for event delegation, hidden\n        legacyContainer.style.display = 'none'; // Hide original container\n\n        // Apply V2 Classes to the tile content\n        applyV2Styles(formTile);\n        applyV2Styles(listTile);\n\n        // Apply V2 Classes\n        applyV2Styles(legacyContainer);\n\n        // Attach export/import button handlers\n        attachActionListeners();\n\n        // Trigger device list population\n        // Uses syncDeviceManagerCategories as the primary method (verified to work)\n        // Falls back to refreshDeviceLists or loadDeviceData if available\n        const triggerDeviceListPopulation = () => {\n            if (typeof window.syncDeviceManagerCategories === 'function') {\n                console.log('[DeviceLibraryView] Triggering syncDeviceManagerCategories...');\n                try {\n                    window.syncDeviceManagerCategories();\n                    return true;\n                } catch (e) {\n                    console.warn('[DeviceLibraryView] syncDeviceManagerCategories failed:', e);\n                }\n            }\n            if (typeof window.refreshDeviceLists === 'function') {\n                console.log('[DeviceLibraryView] Triggering refreshDeviceLists...');\n                try {\n                    window.refreshDeviceLists();\n                    return true;\n                } catch (e) {\n                    console.warn('[DeviceLibraryView] refreshDeviceLists failed:', e);\n                }\n            }\n            if (typeof window.loadDeviceData === 'function') {\n                console.log('[DeviceLibraryView] Triggering loadDeviceData...');\n                try {\n                    window.loadDeviceData();\n                    return true;\n                } catch (e) {\n                    console.warn('[DeviceLibraryView] loadDeviceData failed:', e);\n                }\n            }\n            console.warn('[DeviceLibraryView] No device list population function found');\n            return false;\n        };\n\n        // Try immediately and also with a small delay (in case functions aren't ready yet)\n        if (!triggerDeviceListPopulation()) {\n            setTimeout(triggerDeviceListPopulation, 100);\n        }\n\n        isReparented = true;\n        console.log('[DeviceLibraryView] Reparenting complete (Hierarchy Preserved).');\n    }\n\n\n\n    /**\n     * Apply V2 classes to legacy elements\n     */\n    function applyV2Styles(container) {\n        // Inputs\n        const inputs = container.querySelectorAll('input[type=\"text\"], input[type=\"number\"], input[type=\"search\"]');\n        inputs.forEach(el => el.classList.add('v2-input'));\n\n        // Selects\n        const selects = container.querySelectorAll('select');\n        selects.forEach(el => el.classList.add('v2-select'));\n\n        // Buttons\n        const buttons = container.querySelectorAll('button');\n        buttons.forEach(btn => {\n            if (btn.classList.contains('v2-btn')) return; // Skip already styled\n            btn.classList.add('v2-btn');\n\n            if (btn.textContent.toLowerCase().includes('add') ||\n                btn.textContent.toLowerCase().includes('save')) {\n                btn.classList.add('v2-btn-primary');\n            }\n        });\n\n        // Form Rows\n        const rows = container.querySelectorAll('.form-row');\n        rows.forEach(row => row.classList.add('v2-form-row'));\n\n        // Labels\n        const labels = container.querySelectorAll('label');\n        labels.forEach(label => label.classList.add('v2-label'));\n    }\n\n    /**\n     * Attach export/import button handlers\n     */\n    function handleExportClick() {\n        const legacyExportBtn = document.getElementById('exportDataBtn');\n        if (legacyExportBtn) {\n            legacyExportBtn.click();\n        }\n    }\n\n    function handleImportClick() {\n        const legacyImportBtn = document.getElementById('importDataBtn');\n        if (legacyImportBtn) {\n            legacyImportBtn.click();\n        }\n    }\n\n    function attachActionListeners() {\n        const exportBtn = document.getElementById('v2-export-db-btn');\n        const importBtn = document.getElementById('v2-import-db-btn');\n        const resetBtn = document.getElementById('v2-reset-db-btn');\n\n        if (exportBtn) {\n            exportBtn.removeEventListener('click', handleExportClick);\n            exportBtn.addEventListener('click', handleExportClick);\n        }\n\n        if (importBtn) {\n            importBtn.removeEventListener('click', handleImportClick);\n            importBtn.addEventListener('click', handleImportClick);\n        }\n\n        if (resetBtn) {\n            resetBtn.removeEventListener('click', handleResetClick);\n            resetBtn.addEventListener('click', handleResetClick);\n        }\n    }\n\n    function handleResetClick() {\n        // Trigger the legacy exportAndRevert button\n        const legacyBtn = document.getElementById('exportAndRevertBtn');\n        if (legacyBtn) {\n            legacyBtn.click();\n        } else {\n            console.warn('[DeviceLibraryView] Legacy reset button not found');\n        }\n    }\n\n    /**\n     * Restore Legacy Content (Cleanup)\n     */\n    function restoreLegacyContent() {\n        if (!isReparented) return;\n\n        const v2Container = document.getElementById(CONTENT_CONTAINER_ID);\n        const legacyContainer = document.getElementById(LEGACY_CONTAINER_ID); // This is now inside v2Container\n        const placeholder = document.getElementById('device-manager-placeholder');\n\n        if (legacyContainer) {\n            // 1. Move content out of panels back to legacyContainer root\n            const listContent = legacyContainer.querySelector('.device-list-panel .panel-content');\n            const formContent = legacyContainer.querySelector('.device-form-panel .panel-content');\n\n            if (listContent) {\n                while (listContent.firstChild) {\n                    legacyContainer.appendChild(listContent.firstChild);\n                }\n            }\n\n            if (formContent) {\n                while (formContent.firstChild) {\n                    legacyContainer.appendChild(formContent.firstChild);\n                }\n            }\n\n            // Remove panels\n            const panels = legacyContainer.querySelectorAll('.v2-panel');\n            panels.forEach(p => p.remove());\n\n            // Remove layout class\n            legacyContainer.classList.remove('device-library-layout');\n\n            // 2. Put #device-manager back to placeholder\n            if (legacyVisibilityState === true) {\n                legacyContainer.classList.add('hidden');\n            } else if (legacyVisibilityState === false) {\n                legacyContainer.classList.remove('hidden');\n            }\n\n            if (placeholder && placeholder.parentNode) {\n                placeholder.parentNode.insertBefore(legacyContainer, placeholder);\n                placeholder.remove();\n            } else {\n                // Fallback: append to body (should ideally not happen if flow is correct)\n                document.body.appendChild(legacyContainer);\n            }\n        }\n\n        if (v2Container) {\n            v2Container.innerHTML = '';\n        }\n\n        isReparented = false;\n        console.log('[DeviceLibraryView] Restored legacy content.');\n    }\n\n    // =====================\n    // INITIALIZATION\n    // =====================\n\n    /**\n     * Render the view\n     */\n    function render() {\n        reparentLegacyContent();\n    }\n\n    /**\n     * Initialize the view module\n     */\n    function init() {\n        if (isInitialized) return;\n\n        console.log('[DeviceLibraryView] Initializing...');\n\n        document.addEventListener('v2:viewchange', (e) => {\n            if (!e.detail) {\n                return;\n            }\n\n            if (e.detail.view === 'devices') {\n                render();\n                return;\n            }\n\n            if (isReparented) {\n                restoreLegacyContent();\n            }\n        });\n\n        // Listen for language changes\n        document.addEventListener('v2:languagechange', () => {\n            if (isReparented) {\n                // Re-render to update translations\n                restoreLegacyContent();\n                isReparented = false;\n                render();\n            }\n        });\n\n        isInitialized = true;\n        console.log('[DeviceLibraryView] Initialized');\n    }\n\n    // =====================\n    // PUBLIC API\n    // =====================\n    const DeviceLibraryView = {\n        init,\n        render,\n        restoreLegacyContent\n    };\n\n    global.cineV2DeviceLibrary = DeviceLibraryView;\n\n})(typeof window !== 'undefined' ? window : this);\n","/**\n * Cine Power Planner V2 - Avatar Editor Modal\n * ============================================\n * Provides a modal for cropping and zooming profile/contact avatars.\n * Features: drag-to-pan, zoom slider, keyboard navigation, touch support.\n */\n\n(function (global) {\n    'use strict';\n\n    // =====================\n    // CONSTANTS\n    // =====================\n    const AVATAR_MAX_DIMENSION = 256;\n    const AVATAR_VIEWPORT_SIZE = 200;\n    const ZOOM_MIN = 50;\n    const ZOOM_MAX = 250;\n    const ZOOM_STEP = 5;\n\n    // =====================\n    // STATE\n    // =====================\n    let isOpen = false;\n    let modalElement = null;\n    let editState = null;\n    let onSaveCallback = null;\n    let onDeleteCallback = null;\n    let onCancelCallback = null;\n\n    // =====================\n    // HELPER: Translation\n    // =====================\n    function _t(key) {\n        // Fallback defaults for avatar editor specific keys\n        const defaults = {\n            'avatarEditorTitle': 'Edit Photo',\n            'avatarEditorDescription': 'Drag to reposition, use slider to zoom',\n            'avatarEditorZoom': 'Zoom',\n            'buttonCancel': 'Cancel',\n            'buttonSave': 'Save',\n            'buttonRemovePhoto': 'Remove Photo',\n            'avatarUploadHint': 'Drop or click to upload'\n        };\n\n        if (typeof window !== 'undefined' && window.texts) {\n            const langSelect = document.getElementById('languageSelect');\n            const lang = (langSelect && langSelect.value) ||\n                (typeof window.currentLanguage === 'string' && window.currentLanguage) ||\n                'en';\n            const dict = window.texts[lang] || window.texts['en'];\n            if (dict) {\n                // Support nested keys with dot notation\n                const value = key.split('.').reduce((o, i) => (o ? o[i] : null), dict);\n                if (value && typeof value === 'string') {\n                    return value;\n                }\n            }\n        }\n        return defaults[key] || key;\n    }\n\n    // =====================\n    // ESCAPE HTML\n    // =====================\n    function escapeHtml(str) {\n        if (typeof str !== 'string') return '';\n        return str.replace(/&/g, '&amp;')\n            .replace(/</g, '&lt;')\n            .replace(/>/g, '&gt;')\n            .replace(/\"/g, '&quot;')\n            .replace(/'/g, '&#039;');\n    }\n\n    // =====================\n    // CREATE MODAL HTML\n    // =====================\n    function createModalHtml(hasExistingAvatar) {\n        return `\n            <div class=\"avatar-editor-modal\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"avatar-editor-title\">\n                <div class=\"avatar-editor-backdrop\"></div>\n                <div class=\"avatar-editor-surface\">\n                    <header class=\"avatar-editor-header\">\n                        <div class=\"avatar-editor-header-main\">\n                            <h2 id=\"avatar-editor-title\" class=\"avatar-editor-title\">${escapeHtml(_t('avatarEditorTitle'))}</h2>\n                            <p class=\"avatar-editor-description\">${escapeHtml(_t('avatarEditorDescription'))}</p>\n                        </div>\n                        <button type=\"button\" class=\"avatar-editor-close\" aria-label=\"Close\">\n                            <span class=\"icon\">close</span>\n                        </button>\n                    </header>\n                    <div class=\"avatar-editor-body\">\n                        <div class=\"avatar-editor-viewport\" id=\"avatarEditorViewport\" tabindex=\"0\">\n                            <img class=\"avatar-editor-image\" id=\"avatarEditorImage\" alt=\"\" draggable=\"false\" />\n                            <div class=\"avatar-editor-placeholder\" id=\"avatarEditorPlaceholder\">\n                                <span class=\"icon\">add_a_photo</span>\n                                <span>${escapeHtml(_t('avatarUploadHint'))}</span>\n                            </div>\n                            <input type=\"file\" id=\"avatarEditorFileInput\" accept=\"image/png,image/jpeg,image/webp,image/gif\" class=\"visually-hidden\" tabindex=\"-1\" />\n                        </div>\n                        <div class=\"avatar-editor-controls\" id=\"avatarEditorControls\">\n                            <label class=\"avatar-editor-zoom-label\">\n                                <span class=\"icon\">zoom_out</span>\n                                <input type=\"range\" id=\"avatarEditorZoom\" min=\"${ZOOM_MIN}\" max=\"${ZOOM_MAX}\" step=\"${ZOOM_STEP}\" value=\"100\" aria-label=\"${escapeHtml(_t('avatarEditorZoom'))}\" />\n                                <span class=\"icon\">zoom_in</span>\n                            </label>\n                        </div>\n                    </div>\n                    <footer class=\"avatar-editor-footer\">\n                        <button type=\"button\" class=\"avatar-editor-btn avatar-editor-btn-danger\" id=\"avatarEditorDelete\" ${hasExistingAvatar ? '' : 'disabled'}>\n                            ${escapeHtml(_t('buttonRemovePhoto'))}\n                        </button>\n                        <div class=\"avatar-editor-primary-actions\">\n                            <button type=\"button\" class=\"avatar-editor-btn avatar-editor-btn-secondary\" id=\"avatarEditorCancel\">\n                                ${escapeHtml(_t('buttonCancel'))}\n                            </button>\n                            <button type=\"button\" class=\"avatar-editor-btn avatar-editor-btn-primary\" id=\"avatarEditorSave\">\n                                ${escapeHtml(_t('buttonSave'))}\n                            </button>\n                        </div>\n                    </footer>\n                </div>\n            </div>\n        `;\n    }\n\n    // =====================\n    // EDIT STATE MANAGEMENT\n    // =====================\n    function initializeEditState(dataUrl, image) {\n        const viewportSize = AVATAR_VIEWPORT_SIZE;\n        const baseScale = Math.max(\n            viewportSize / image.naturalWidth,\n            viewportSize / image.naturalHeight\n        );\n\n        editState = {\n            active: true,\n            dataUrl,\n            image,\n            mime: parseDataUrlMimeType(dataUrl),\n            viewportSize,\n            baseScale,\n            zoom: 1,\n            offsetX: (viewportSize - image.naturalWidth * baseScale) / 2,\n            offsetY: (viewportSize - image.naturalHeight * baseScale) / 2,\n            pointerId: null,\n            pointerStartX: 0,\n            pointerStartY: 0,\n            offsetStartX: 0,\n            offsetStartY: 0,\n            displayWidth: 0,\n            displayHeight: 0\n        };\n\n        updateEditMetrics();\n    }\n\n    function parseDataUrlMimeType(dataUrl) {\n        if (typeof dataUrl !== 'string' || !dataUrl.startsWith('data:')) return 'image/png';\n        const mimeEnd = dataUrl.indexOf(';');\n        if (mimeEnd === -1) return 'image/png';\n        return dataUrl.substring(5, mimeEnd) || 'image/png';\n    }\n\n    function clampOffsets() {\n        if (!editState) return;\n        const minX = Math.min(0, editState.viewportSize - editState.displayWidth);\n        const minY = Math.min(0, editState.viewportSize - editState.displayHeight);\n        editState.offsetX = Math.max(minX, Math.min(0, editState.offsetX));\n        editState.offsetY = Math.max(minY, Math.min(0, editState.offsetY));\n    }\n\n    function updateEditMetrics() {\n        if (!editState || !editState.image) return;\n\n        const width = editState.image.naturalWidth || editState.image.width || 0;\n        const height = editState.image.naturalHeight || editState.image.height || 0;\n        const displayWidth = width * editState.baseScale * editState.zoom;\n        const displayHeight = height * editState.baseScale * editState.zoom;\n\n        editState.displayWidth = displayWidth;\n        editState.displayHeight = displayHeight;\n        clampOffsets();\n\n        const imageEl = document.getElementById('avatarEditorImage');\n        if (imageEl) {\n            imageEl.style.width = `${displayWidth}px`;\n            imageEl.style.height = `${displayHeight}px`;\n            imageEl.style.transform = `translate(${editState.offsetX}px, ${editState.offsetY}px)`;\n        }\n    }\n\n    // =====================\n    // CROP & EXPORT\n    // =====================\n    function exportCroppedResult() {\n        if (!editState || !editState.image) return '';\n\n        const scale = editState.baseScale * editState.zoom;\n        if (!scale) return '';\n\n        const cropSize = editState.viewportSize / scale;\n        const sourceX = Math.max(0, Math.min(\n            editState.image.naturalWidth - cropSize,\n            (-editState.offsetX) / scale\n        ));\n        const sourceY = Math.max(0, Math.min(\n            editState.image.naturalHeight - cropSize,\n            (-editState.offsetY) / scale\n        ));\n\n        const canvas = document.createElement('canvas');\n        canvas.width = AVATAR_MAX_DIMENSION;\n        canvas.height = AVATAR_MAX_DIMENSION;\n        const ctx = canvas.getContext('2d');\n        if (!ctx) return '';\n\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\n        ctx.drawImage(\n            editState.image,\n            sourceX,\n            sourceY,\n            cropSize,\n            cropSize,\n            0,\n            0,\n            canvas.width,\n            canvas.height\n        );\n\n        const mime = editState.mime && editState.mime.startsWith('image/')\n            ? editState.mime\n            : 'image/png';\n\n        try {\n            return canvas.toDataURL(mime);\n        } catch (error) {\n            try {\n                return canvas.toDataURL('image/png');\n            } catch (fallbackError) {\n                return '';\n            }\n        }\n    }\n\n    // =====================\n    // EVENT HANDLERS\n    // =====================\n    function handleZoomChange(event) {\n        if (!editState || !editState.active) return;\n\n        const value = Number(event?.target?.value) || 100;\n        const normalized = Math.max(ZOOM_MIN, value) / 100;\n\n        // Keep center point stable\n        const prevWidth = editState.displayWidth || 1;\n        const prevHeight = editState.displayHeight || 1;\n        const centerX = -editState.offsetX + editState.viewportSize / 2;\n        const centerY = -editState.offsetY + editState.viewportSize / 2;\n        const ratioX = centerX / prevWidth;\n        const ratioY = centerY / prevHeight;\n\n        editState.zoom = normalized;\n        updateEditMetrics();\n\n        const targetCenterX = editState.displayWidth * ratioX;\n        const targetCenterY = editState.displayHeight * ratioY;\n        editState.offsetX = -(targetCenterX - editState.viewportSize / 2);\n        editState.offsetY = -(targetCenterY - editState.viewportSize / 2);\n        clampOffsets();\n        updateEditMetrics();\n    }\n\n    function handlePointerDown(event) {\n        if (!editState || !editState.active) return;\n        if (editState.pointerId !== null) return;\n\n        const viewport = document.getElementById('avatarEditorViewport');\n        if (!viewport) return;\n\n        editState.pointerId = event.pointerId;\n        editState.pointerStartX = event.clientX;\n        editState.pointerStartY = event.clientY;\n        editState.offsetStartX = editState.offsetX;\n        editState.offsetStartY = editState.offsetY;\n\n        try {\n            viewport.setPointerCapture(event.pointerId);\n        } catch (error) {\n            void error;\n        }\n        event.preventDefault();\n    }\n\n    function handlePointerMove(event) {\n        if (!editState || !editState.active) return;\n        if (editState.pointerId !== event.pointerId) return;\n\n        const deltaX = event.clientX - editState.pointerStartX;\n        const deltaY = event.clientY - editState.pointerStartY;\n        editState.offsetX = editState.offsetStartX + deltaX;\n        editState.offsetY = editState.offsetStartY + deltaY;\n        clampOffsets();\n        updateEditMetrics();\n        event.preventDefault();\n    }\n\n    function handlePointerUp(event) {\n        if (!editState || !editState.active) return;\n        if (editState.pointerId !== event.pointerId) return;\n\n        editState.pointerId = null;\n        const viewport = document.getElementById('avatarEditorViewport');\n        if (viewport) {\n            try {\n                viewport.releasePointerCapture(event.pointerId);\n            } catch (error) {\n                void error;\n            }\n        }\n        event.preventDefault();\n    }\n\n    function handleKeyDown(event) {\n        if (!editState || !editState.active) return;\n\n        const step = event.shiftKey ? 10 : 2;\n        let moved = false;\n\n        switch (event.key) {\n            case 'ArrowUp':\n                editState.offsetY += step;\n                moved = true;\n                break;\n            case 'ArrowDown':\n                editState.offsetY -= step;\n                moved = true;\n                break;\n            case 'ArrowLeft':\n                editState.offsetX += step;\n                moved = true;\n                break;\n            case 'ArrowRight':\n                editState.offsetX -= step;\n                moved = true;\n                break;\n            default:\n                break;\n        }\n\n        if (moved) {\n            clampOffsets();\n            updateEditMetrics();\n            event.preventDefault();\n        }\n    }\n\n    function handleFileSelect(event) {\n        const file = event?.target?.files?.[0];\n        if (!file) return;\n\n        loadImageFile(file);\n        if (event.target) event.target.value = '';\n    }\n\n    function handleDrop(event) {\n        event.preventDefault();\n        event.stopPropagation();\n\n        const viewport = document.getElementById('avatarEditorViewport');\n        if (viewport) viewport.classList.remove('drag-over');\n\n        const file = event.dataTransfer?.files?.[0];\n        if (file) {\n            loadImageFile(file);\n        }\n    }\n\n    function handleDragOver(event) {\n        event.preventDefault();\n        event.stopPropagation();\n        const viewport = document.getElementById('avatarEditorViewport');\n        if (viewport) viewport.classList.add('drag-over');\n    }\n\n    function handleDragLeave(event) {\n        event.preventDefault();\n        event.stopPropagation();\n        const viewport = document.getElementById('avatarEditorViewport');\n        if (viewport) viewport.classList.remove('drag-over');\n    }\n\n    function loadImageFile(file) {\n        // Use profile module if available for optimization\n        if (global.CINE_CONTACTS_PROFILE_MODULE && typeof global.CINE_CONTACTS_PROFILE_MODULE.readAvatarFile === 'function') {\n            global.CINE_CONTACTS_PROFILE_MODULE.readAvatarFile(\n                file,\n                (dataUrl) => loadImageFromDataUrl(dataUrl),\n                (error) => console.warn('Failed to read avatar file:', error)\n            );\n        } else {\n            // Fallback to FileReader\n            const reader = new FileReader();\n            reader.onload = (e) => {\n                if (typeof e.target?.result === 'string') {\n                    loadImageFromDataUrl(e.target.result);\n                }\n            };\n            reader.onerror = () => console.warn('Failed to read file');\n            reader.readAsDataURL(file);\n        }\n    }\n\n    function loadImageFromDataUrl(dataUrl) {\n        if (!dataUrl) return;\n\n        const image = new Image();\n        image.decoding = 'async';\n        image.onload = () => {\n            if (!image.naturalWidth || !image.naturalHeight) {\n                console.warn('Invalid image dimensions');\n                return;\n            }\n\n            initializeEditState(dataUrl, image);\n\n            const imageEl = document.getElementById('avatarEditorImage');\n            const placeholder = document.getElementById('avatarEditorPlaceholder');\n            const controls = document.getElementById('avatarEditorControls');\n            const viewport = document.getElementById('avatarEditorViewport');\n            const zoomInput = document.getElementById('avatarEditorZoom');\n            const deleteBtn = document.getElementById('avatarEditorDelete');\n\n            if (imageEl) imageEl.src = dataUrl;\n            if (placeholder) placeholder.classList.add('hidden');\n            if (viewport) viewport.classList.add('has-image');\n            if (controls) controls.classList.remove('hidden');\n            if (zoomInput) zoomInput.value = '100';\n            if (deleteBtn) deleteBtn.disabled = false;\n        };\n        image.onerror = () => console.warn('Failed to load image');\n        image.src = dataUrl;\n    }\n\n    // =====================\n    // PUBLIC API\n    // =====================\n    function open(options = {}) {\n        if (isOpen) close();\n\n        const {\n            avatar = '',\n            onSave = null,\n            onDelete = null,\n            onCancel = null\n        } = options;\n\n        onSaveCallback = onSave;\n        onDeleteCallback = onDelete;\n        onCancelCallback = onCancel;\n\n        const hasAvatar = Boolean(avatar);\n        const container = document.createElement('div');\n        container.innerHTML = createModalHtml(hasAvatar);\n        modalElement = container.firstElementChild;\n        document.body.appendChild(modalElement);\n\n        // Bind events\n        const backdrop = modalElement.querySelector('.avatar-editor-backdrop');\n        const closeBtn = modalElement.querySelector('.avatar-editor-close');\n        const cancelBtn = document.getElementById('avatarEditorCancel');\n        const saveBtn = document.getElementById('avatarEditorSave');\n        const deleteBtn = document.getElementById('avatarEditorDelete');\n        const viewport = document.getElementById('avatarEditorViewport');\n        const zoomInput = document.getElementById('avatarEditorZoom');\n        const fileInput = document.getElementById('avatarEditorFileInput');\n\n        if (backdrop) backdrop.addEventListener('click', () => close());\n        if (closeBtn) closeBtn.addEventListener('click', () => close());\n        if (cancelBtn) cancelBtn.addEventListener('click', handleCancel);\n        if (saveBtn) saveBtn.addEventListener('click', handleSave);\n        if (deleteBtn) deleteBtn.addEventListener('click', handleDelete);\n\n        if (viewport) {\n            viewport.addEventListener('pointerdown', handlePointerDown);\n            viewport.addEventListener('pointermove', handlePointerMove);\n            viewport.addEventListener('pointerup', handlePointerUp);\n            viewport.addEventListener('pointercancel', handlePointerUp);\n            viewport.addEventListener('keydown', handleKeyDown);\n            viewport.addEventListener('drop', handleDrop);\n            viewport.addEventListener('dragover', handleDragOver);\n            viewport.addEventListener('dragleave', handleDragLeave);\n            viewport.addEventListener('click', (e) => {\n                if (!editState?.active && fileInput) {\n                    fileInput.click();\n                }\n            });\n        }\n\n        if (zoomInput) zoomInput.addEventListener('input', handleZoomChange);\n        if (fileInput) fileInput.addEventListener('change', handleFileSelect);\n\n        // Load existing avatar if provided\n        if (avatar) {\n            loadImageFromDataUrl(avatar);\n        }\n\n        // Show modal with animation\n        requestAnimationFrame(() => {\n            if (modalElement) modalElement.classList.add('open');\n        });\n\n        isOpen = true;\n\n        // Focus viewport for keyboard navigation\n        setTimeout(() => {\n            if (viewport) viewport.focus();\n        }, 100);\n    }\n\n    function close() {\n        if (!isOpen || !modalElement) return;\n\n        modalElement.classList.remove('open');\n        setTimeout(() => {\n            if (modalElement && modalElement.parentNode) {\n                modalElement.parentNode.removeChild(modalElement);\n            }\n            modalElement = null;\n            editState = null;\n            isOpen = false;\n            onSaveCallback = null;\n            onDeleteCallback = null;\n            onCancelCallback = null;\n        }, 200);\n    }\n\n    function handleSave() {\n        let result = '';\n        if (editState && editState.active) {\n            result = exportCroppedResult();\n        }\n        if (typeof onSaveCallback === 'function') {\n            onSaveCallback(result);\n        }\n        close();\n    }\n\n    function handleDelete() {\n        if (typeof onDeleteCallback === 'function') {\n            onDeleteCallback();\n        }\n        close();\n    }\n\n    function handleCancel() {\n        if (typeof onCancelCallback === 'function') {\n            onCancelCallback();\n        }\n        close();\n    }\n\n    // =====================\n    // EXPORT\n    // =====================\n    const AvatarEditorModal = {\n        open,\n        close,\n        isOpen: () => isOpen\n    };\n\n    global.cineAvatarEditorModal = AvatarEditorModal;\n\n})(typeof window !== 'undefined' ? window : this);\n","/**\n * Download Manager Helper\n * =======================\n * Centralizes file download logic to ensure consistent behavior across browsers\n * and prevent common \"corruption\" issues caused by premature revocation of Object URLs\n * or race conditions during the download trigger.\n * \n * Capabilities:\n * - Supports modern File System Access API (showSaveFilePicker) where available.\n * - robust Blob/Anchor fallback with proper cleanup timing.\n * - Legacy IE11/Edge support via msSaveOrOpenBlob (optional).\n */\n\n/**\n * Trigger a file download.\n * @param {string|Blob} content - The file content (string or Blob).\n * @param {string} fileName - The default file name.\n * @param {object} options - Configuration options.\n * @param {string} [options.mimeType='text/plain'] - MIME type of the content.\n * @param {string} [options.charset='utf-8'] - Charset (if content is string).\n * @returns {Promise<boolean>} - Resolves true if download triggered, false otherwise.\n */\nexport async function downloadFile(content, fileName, options = {}) {\n    const config = {\n        mimeType: 'text/plain',\n        charset: 'utf-8',\n        ...options\n    };\n\n    // 1. Normalize Content to Blob\n    let blob;\n    if (content instanceof Blob) {\n        blob = content;\n    } else {\n        const type = `${config.mimeType};charset=${config.charset}`;\n        try {\n            blob = new Blob([content], { type });\n        } catch (e) {\n            console.warn('[DownloadManager] Blob creation failed', e);\n            return false;\n        }\n    }\n\n    // 2. Try File System Access API (Modern Secure Contexts)\n    // Only works if triggered by user gesture.\n    if (typeof window.showSaveFilePicker === 'function') {\n        try {\n            const handle = await window.showSaveFilePicker({\n                suggestedName: fileName,\n                types: [{\n                    description: 'File',\n                    accept: { [config.mimeType]: ['.' + fileName.split('.').pop()] },\n                }],\n            });\n            const writable = await handle.createWritable();\n            await writable.write(blob);\n            await writable.close();\n            return true;\n        } catch (err) {\n            // User cancelled or not supported (e.g. cross-origin iframe)\n            if (err.name !== 'AbortError') {\n                console.warn('[DownloadManager] File System Access API failed, falling back', err);\n            } else {\n                return false; // User explicitly cancelled\n            }\n        }\n    }\n\n    // 3. Fallback: msSaveOrOpenBlob (IE/Edge Legacy)\n    if (typeof navigator !== 'undefined' && typeof navigator.msSaveOrOpenBlob === 'function') {\n        return navigator.msSaveOrOpenBlob(blob, fileName);\n    }\n\n    // 4. Fallback: Classic Anchor Tag\n    // We delay the revocation to ensure the browser has time to capture the download.\n    try {\n        const url = URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.style.display = 'none';\n        link.href = url;\n        link.download = fileName;\n\n        document.body.appendChild(link);\n        link.click();\n\n        // Cleanup with delay\n        setTimeout(() => {\n            document.body.removeChild(link);\n            URL.revokeObjectURL(url);\n        }, 2000); // 2s delay to be safe\n\n        return true;\n    } catch (e) {\n        console.warn('[DownloadManager] Anchor download failed', e);\n        return false;\n    }\n}\n","/**\n * Cine Power Planner V2 - Contacts View\n * =====================================\n * Manages the \"Contacts\" view in the V2 UI.\n * Features: User profile, contact list, import/export, avatar editing.\n */\n\nimport { downloadFile } from '../../modules/helpers/download-manager.js';\n\n(function (global) {\n    'use strict';\n\n    // =====================\n    // CONFIGURATION\n    // =====================\n    const VIEW_ID = 'view-contacts';\n    const USER_PROFILE_STORAGE_KEY = 'cameraPowerPlanner_userProfile';\n\n    // =====================\n    // STATE\n    // =====================\n    let isInitialized = false;\n    let userProfile = null;\n    let profileSaveTimer = null;\n\n    // =====================\n    // HELPER: ESCAPE HTML\n    // =====================\n    function escapeHtml(str) {\n        if (typeof str !== 'string') return '';\n        return str.replace(/&/g, '&amp;')\n            .replace(/</g, '&lt;')\n            .replace(/>/g, '&gt;')\n            .replace(/\"/g, '&quot;')\n            .replace(/'/g, '&#039;');\n    }\n\n    function _t(key) {\n        // Fallback defaults for v2-specific keys and missing translations\n        const defaults = {\n            'contactsViewTitle': 'Contacts',\n            'contactsViewSubtitle': 'Production Directory',\n            'buttonAddContact': 'Add Contact',\n            'buttonImportVCard': 'Import vCard',\n            'buttonExportContacts': 'Export',\n            'contactsEmptyTitle': 'No contacts yet',\n            'contactsEmptyText': 'Add crew members to reuse them across projects.',\n            'buttonAddFirstContact': 'Add Your First Contact',\n            'contactUnnamed': 'Unnamed',\n            'contactNoRole': 'No role specified',\n            'modalTitleNewContact': 'New Contact',\n            'modalTitleEditContact': 'Edit Contact',\n            'modalTitleDeleteContact': 'Delete Contact',\n            'confirmDeleteContact': 'Are you sure you want to delete this contact?',\n            'buttonCancel': 'Cancel',\n            'buttonDeleteRed': 'Delete',\n            'buttonSaveContact': 'Save',\n            'buttonEdit': 'Edit',\n            'buttonDelete': 'Delete',\n            'buttonUploadPhoto': 'Upload Photo',\n            'buttonRemovePhoto': 'Remove',\n            'avatarHint': 'Drag & drop or click to upload',\n            'sectionBasicInfo': 'Basic Information',\n            'sectionContactDetails': 'Contact Details',\n            'labelName': 'Name',\n            'labelRole': 'Role',\n            'labelPhone': 'Phone',\n            'labelEmail': 'Email',\n            'labelWebsite': 'Website',\n            'labelNotes': 'Notes',\n            'placeholderFullName': 'Full name',\n            'placeholderRole': 'e.g. DoP, 1st AC',\n            'placeholderPhone': '+1 234 567 890',\n            'placeholderEmail': 'name@example.com',\n            'placeholderWebsite': 'https://',\n            'placeholderNotes': 'Additional notes...',\n            'alertEnterName': 'Please enter a name',\n            'statusUnavailable': 'Contacts module not loaded.',\n            'profileSectionTitle': 'Your Profile',\n            'profileSectionDescription': 'Add your details to appear as \"User\" in gear assignments.',\n            'importSuccess': 'Imported {added} contacts, updated {updated}',\n            'exportFilename': 'contacts.vcf'\n        };\n\n        if (typeof window !== 'undefined' && window.texts) {\n            const langSelect = document.getElementById('languageSelect');\n            const lang = (langSelect && langSelect.value) ||\n                (typeof window.currentLanguage === 'string' && window.currentLanguage) ||\n                'en';\n            const dict = window.texts[lang] || window.texts['en'];\n            if (dict) {\n                // Support nested keys with dot notation (e.g. 'contacts.userProfileHeading')\n                const value = key.split('.').reduce((o, i) => (o ? o[i] : null), dict);\n                if (value && typeof value === 'string') {\n                    return value;\n                }\n            }\n        }\n        return defaults[key] || key;\n    }\n\n    // =====================\n    // PROFILE MANAGEMENT\n    // =====================\n    function loadUserProfile() {\n        try {\n            const stored = localStorage.getItem(USER_PROFILE_STORAGE_KEY);\n            if (stored) {\n                const parsed = JSON.parse(stored);\n                userProfile = {\n                    name: typeof parsed.name === 'string' ? parsed.name : '',\n                    role: typeof parsed.role === 'string' ? parsed.role : '',\n                    phone: typeof parsed.phone === 'string' ? parsed.phone : '',\n                    email: typeof parsed.email === 'string' ? parsed.email : '',\n                    avatar: typeof parsed.avatar === 'string' ? parsed.avatar : ''\n                };\n                return;\n            }\n        } catch (e) {\n            console.warn('[ContactsView] Failed to load profile:', e);\n        }\n        userProfile = { name: '', role: '', phone: '', email: '', avatar: '' };\n    }\n\n    function saveUserProfile() {\n        try {\n            localStorage.setItem(USER_PROFILE_STORAGE_KEY, JSON.stringify(userProfile));\n        } catch (e) {\n            console.warn('[ContactsView] Failed to save profile:', e);\n        }\n    }\n\n    function scheduleProfileSave() {\n        if (profileSaveTimer) clearTimeout(profileSaveTimer);\n        profileSaveTimer = setTimeout(() => {\n            saveUserProfile();\n            profileSaveTimer = null;\n        }, 400);\n    }\n\n    // =====================\n    // EXPORT\n    // =====================\n    function exportAllContacts() {\n        const contactsModule = global.cineFeaturesContacts;\n        if (!contactsModule) return;\n\n        const contacts = contactsModule.loadStoredContacts();\n        if (!contacts || contacts.length === 0) {\n            alert('No contacts to export.');\n            return;\n        }\n\n        const vcards = contactsModule.generateAllContactsVCard\n            ? contactsModule.generateAllContactsVCard(contacts)\n            : '';\n\n        if (!vcards) {\n            alert('Failed to generate vCard data.');\n            return;\n        }\n\n        downloadFile(vcards, _t('exportFilename'), { mimeType: 'text/vcard' })\n            .then(success => {\n                if (!success) {\n                    alert('Download failed. Please check your browser settings.');\n                }\n            });\n    }\n\n    // =====================\n    // VCARD IMPORT\n    // =====================\n    function handleImportFile(file) {\n        if (!file) return;\n\n        const reader = new FileReader();\n        reader.onload = (e) => {\n            const text = e.target?.result;\n            if (typeof text !== 'string') return;\n\n            const contactsModule = global.cineFeaturesContacts;\n            if (!contactsModule) {\n                alert('Contacts module not loaded.');\n                return;\n            }\n\n            // Use methods from the feature module\n            if (!contactsModule.parseVCard || !contactsModule.mergeImportedContacts) {\n                console.error('[ContactsView] Import functions missing from contacts module.');\n                alert('Import functionality unavailable.');\n                return;\n            }\n\n            const parsed = contactsModule.parseVCard(text);\n            if (!parsed || parsed.length === 0) {\n                alert('No valid contacts found in file.');\n                return;\n            }\n\n            const existing = contactsModule.loadStoredContacts();\n            const result = contactsModule.mergeImportedContacts({\n                existing,\n                imported: parsed\n            });\n\n            if (contactsModule.saveContactsToStorage(result.contacts)) {\n                const msg = _t('importSuccess')\n                    .replace('{added}', result.added)\n                    .replace('{updated}', result.updated);\n                alert(msg);\n                ContactsView.render();\n            }\n        };\n        reader.readAsText(file);\n    }\n\n    // =====================\n    // PUBLIC API\n    // =====================\n    const ContactsView = {\n        container: null,\n\n        init() {\n            try {\n                this.container = document.getElementById(VIEW_ID);\n                if (!this.container) {\n                    this.createViewContainer();\n                }\n\n                // Load user profile\n                loadUserProfile();\n\n                if (!isInitialized) {\n                    console.log('[ContactsView] Initializing...');\n                    document.addEventListener('v2:viewchange', (e) => {\n                        if (e.detail && e.detail.view === 'contacts') {\n                            this.render();\n                        }\n                    });\n\n                    // Listen for language changes\n                    document.addEventListener('v2:languagechange', () => {\n                        if (this.isVisible()) this.render();\n                    });\n\n                    isInitialized = true;\n                    console.log('[ContactsView] Initialized');\n                }\n            } catch (e) {\n                console.error('[ContactsView] Init failed:', e);\n            }\n        },\n\n        isVisible() {\n            return this.container && !this.container.classList.contains('hidden') && this.container.style.display !== 'none';\n        },\n\n        createViewContainer() {\n            const app = document.querySelector('.v2-app') || document.body;\n            const view = document.createElement('div');\n            view.id = VIEW_ID;\n            view.className = 'app-view';\n            app.appendChild(view);\n            this.container = view;\n        },\n\n        render() {\n            try {\n                if (!this.container) {\n                    this.init();\n                    if (!this.container) return;\n                }\n\n                // Reload profile in case it was updated elsewhere\n                loadUserProfile();\n\n                // Load contacts using the existing module\n                const contactsModule = global.cineFeaturesContacts;\n                if (!contactsModule) {\n                    this.container.innerHTML = `\n                        <div class=\"view-empty-state\">\n                            <p>${_t('statusUnavailable')}</p>\n                        </div>\n                    `;\n                    return;\n                }\n\n                const contacts = contactsModule.loadStoredContacts();\n\n                // Header with actions\n                const header = `\n                    <header class=\"view-header swiss-header\">\n                        <div class=\"header-content\">\n                            <h1 class=\"swiss-title\">${_t('contactsViewTitle')}</h1>\n                            <div class=\"swiss-subtitle\">\n                                <span class=\"count-badge\">${contacts ? contacts.length : 0}</span>\n                                ${_t('contactsViewSubtitle')}\n                            </div>\n                        </div>\n                        <div class=\"view-header-actions contacts-toolbar\">\n                            <button class=\"v2-btn v2-btn-secondary\" id=\"btn-import-vcard\">\n                                <span class=\"icon\">upload_file</span>\n                                <span>${_t('buttonImportVCard')}</span>\n                            </button>\n                            <button class=\"v2-btn v2-btn-secondary\" id=\"btn-export-contacts\" ${!contacts || contacts.length === 0 ? 'disabled' : ''}>\n                                <span class=\"icon\">download</span>\n                                <span>${_t('buttonExportContacts')}</span>\n                            </button>\n                            <button class=\"v2-btn v2-btn-primary\" id=\"btn-add-contact\">\n                                <span class=\"icon\">add</span>\n                                <span>${_t('buttonAddContact')}</span>\n                            </button>\n                            <input type=\"file\" id=\"import-vcard-input\" accept=\".vcf,.vcard,text/vcard\" class=\"visually-hidden\" />\n                        </div>\n                    </header>\n                `;\n\n                let contentHtml = '<div class=\"view-content swiss-content\">';\n\n                // Profile Section\n                contentHtml += this.renderProfileSection();\n\n                // Contacts Grid\n                if (!contacts || contacts.length === 0) {\n                    contentHtml += `\n                        <div class=\"view-empty-state swiss-empty-state\">\n                             <div class=\"swiss-empty-icon\">\n                                <span class=\"icon\">group_off</span>\n                            </div>\n                            <h2>${_t('contactsEmptyTitle')}</h2>\n                            <p>${_t('contactsEmptyText')}</p>\n                            <button class=\"v2-btn v2-btn-primary\" id=\"btn-add-contact-empty\">\n                                ${_t('buttonAddFirstContact')}\n                            </button>\n                        </div>\n                    `;\n                } else {\n                    contentHtml += '<div class=\"swiss-grid\">';\n                    contacts.forEach(contact => {\n                        contentHtml += this.renderContactCard(contact);\n                    });\n                    contentHtml += '</div>';\n                }\n\n                contentHtml += '</div>'; // End view-content\n\n                this.container.innerHTML = header + contentHtml;\n                this.attachListeners();\n\n            } catch (err) {\n                console.error('[ContactsView] Render failed', err);\n                if (this.container) {\n                    this.container.innerHTML = `<div class=\"swiss-error-state\"><p>Error loading view: ${err.message}</p></div>`;\n                }\n            }\n        },\n\n        renderProfileSection() {\n            const initials = userProfile.name\n                ? userProfile.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()\n                : '';\n\n            const avatarHtml = userProfile.avatar\n                ? `<img src=\"${userProfile.avatar}\" alt=\"${escapeHtml(userProfile.name)}\" class=\"avatar-img\">`\n                : `<span class=\"avatar-initials\">${initials || '<span class=\"icon\">person</span>'}</span>`;\n\n            const roles = [\n                'DoP', '1st AC', '2nd AC', 'Camera Operator', 'DIT', 'Data Wrangler',\n                'VTR/Playback', 'Gaffer', 'Best Boy', 'Key Grip', 'Grip', 'Sound Mixer',\n                'Boom Operator', 'PA', 'Director', 'Producer', 'Line Producer', 'Production Manager'\n            ];\n\n            const roleOptions = roles.map(r =>\n                `<option value=\"${r}\" ${userProfile.role === r ? 'selected' : ''}>${r}</option>`\n            ).join('');\n\n            return `\n                <section class=\"swiss-profile-section\">\n                    <header class=\"swiss-profile-header\">\n                        <h3>${_t('profileSectionTitle')}</h3>\n                        <p>${_t('profileSectionDescription')}</p>\n                    </header>\n                    <div class=\"swiss-profile-card\">\n                        <div class=\"swiss-card-main\">\n                            <div class=\"swiss-card-identity\">\n                                <div class=\"swiss-avatar\" id=\"profile-avatar-container\" tabindex=\"0\" role=\"button\" aria-label=\"Change profile photo\">\n                                    ${avatarHtml}\n                                </div>\n                            </div>\n                            <div class=\"swiss-profile-form\">\n                                <div class=\"swiss-profile-field\">\n                                    <label for=\"profile-name\">${_t('labelName')}</label>\n                                    <input type=\"text\" id=\"profile-name\" value=\"${escapeHtml(userProfile.name)}\" placeholder=\"${_t('placeholderFullName')}\" autocomplete=\"name\">\n                                </div>\n                                <div class=\"swiss-profile-field\">\n                                    <label for=\"profile-role\">${_t('labelRole')}</label>\n                                    <select id=\"profile-role\">\n                                        <option value=\"\">Select role...</option>\n                                        ${roleOptions}\n                                    </select>\n                                </div>\n                                <div class=\"swiss-profile-field\">\n                                    <label for=\"profile-phone\">${_t('labelPhone')}</label>\n                                    <input type=\"tel\" id=\"profile-phone\" value=\"${escapeHtml(userProfile.phone)}\" placeholder=\"${_t('placeholderPhone')}\" autocomplete=\"tel\">\n                                </div>\n                                <div class=\"swiss-profile-field\">\n                                    <label for=\"profile-email\">${_t('labelEmail')}</label>\n                                    <input type=\"email\" id=\"profile-email\" value=\"${escapeHtml(userProfile.email)}\" placeholder=\"${_t('placeholderEmail')}\" autocomplete=\"email\">\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </section>\n            `;\n        },\n\n        renderContactCard(contact) {\n            const initials = contact.name\n                ? contact.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()\n                : '?';\n\n            const avatarHtml = contact.avatar\n                ? `<img src=\"${contact.avatar}\" alt=\"${escapeHtml(contact.name)}\" class=\"avatar-img\">`\n                : `<span class=\"avatar-initials\">${initials}</span>`;\n\n            // Contact Actions (Clean links)\n            const phoneLink = contact.phone ? `<a href=\"tel:${escapeHtml(contact.phone)}\" class=\"swiss-link\" onclick=\"event.stopPropagation()\">${escapeHtml(contact.phone)}</a>` : '<span class=\"swiss-placeholder\"></span>';\n            const emailLink = contact.email ? `<a href=\"mailto:${escapeHtml(contact.email)}\" class=\"swiss-link\" onclick=\"event.stopPropagation()\">${escapeHtml(contact.email)}</a>` : '<span class=\"swiss-placeholder\"></span>';\n\n            // Website link logic - shorten for display\n            let displayWebsite = contact.website || '';\n            if (displayWebsite.includes('://')) displayWebsite = displayWebsite.split('://')[1];\n            if (displayWebsite.endsWith('/')) displayWebsite = displayWebsite.slice(0, -1);\n\n            const websiteLink = contact.website ? `<a href=\"${escapeHtml(contact.website)}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"swiss-link\" onclick=\"event.stopPropagation()\">${escapeHtml(displayWebsite)}</a>` : '<span class=\"swiss-placeholder\"></span>';\n\n            return `\n                <div class=\"swiss-card contact-card\" data-contact-id=\"${escapeHtml(contact.id)}\" tabindex=\"0\" role=\"button\">\n                    <div class=\"swiss-card-actions-overlay\">\n                         <button class=\"swiss-icon-btn btn-edit-contact\" title=\"${_t('buttonEdit')}\">\n                            <span class=\"icon\">edit</span>\n                        </button>\n                         <button class=\"swiss-icon-btn btn-delete-contact\" title=\"${_t('buttonDelete')}\">\n                            <span class=\"icon\">delete</span>\n                        </button>\n                    </div>\n                    <div class=\"swiss-card-main\">\n                        <div class=\"swiss-card-identity\">\n                            <div class=\"swiss-avatar\">\n                                ${avatarHtml}\n                            </div>\n                            <div class=\"swiss-identity-text\">\n                                <h3 class=\"swiss-name\">${escapeHtml(contact.name || _t('contactUnnamed'))}</h3>\n                                <div class=\"swiss-role\">${escapeHtml(contact.role || _t('contactNoRole'))}</div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"swiss-card-data-grid\">\n                        <div class=\"data-cell\">\n                            <span class=\"data-label\">${_t('labelPhone')}</span>\n                            <span class=\"data-value\">${phoneLink}</span>\n                        </div>\n                        <div class=\"data-cell\">\n                            <span class=\"data-label\">${_t('labelEmail')}</span>\n                            <span class=\"data-value\">${emailLink}</span>\n                        </div>\n                        <div class=\"data-cell\">\n                            <span class=\"data-label\">${_t('labelWebsite')}</span>\n                            <span class=\"data-value\">${websiteLink}</span>\n                        </div>\n                        ${contact.notes ? `\n                        <div class=\"data-cell notes-cell\">\n                            <span class=\"data-label\">${_t('labelNotes')}</span>\n                            <span class=\"data-value notes-text\">${escapeHtml(contact.notes)}</span>\n                        </div>\n                        ` : `\n                        <div class=\"data-cell\">\n                            <span class=\"data-label\">${_t('labelNotes')}</span>\n                            <span class=\"data-value\"><span class=\"swiss-placeholder\"></span></span>\n                        </div>\n                        `}\n                    </div>\n                </div>\n            `;\n        },\n\n        attachListeners() {\n            // Header actions\n            const addBtn = this.container.querySelector('#btn-add-contact');\n            const addBtnEmpty = this.container.querySelector('#btn-add-contact-empty');\n            const importBtn = this.container.querySelector('#btn-import-vcard');\n            const importInput = this.container.querySelector('#import-vcard-input');\n            const exportBtn = this.container.querySelector('#btn-export-contacts');\n\n            if (addBtn) addBtn.onclick = () => this.showEditModal(null);\n            if (addBtnEmpty) addBtnEmpty.onclick = () => this.showEditModal(null);\n\n            if (importBtn && importInput) {\n                importBtn.onclick = () => importInput.click();\n                importInput.onchange = (e) => {\n                    const file = e.target.files?.[0];\n                    if (file) handleImportFile(file);\n                    e.target.value = '';\n                };\n            }\n\n            if (exportBtn) exportBtn.onclick = exportAllContacts;\n\n            // Profile section\n            this.attachProfileListeners();\n\n            // Contact cards\n            this.container.querySelectorAll('.contact-card').forEach(card => {\n                card.onclick = (e) => {\n                    if (e.target.closest('button') || e.target.closest('a')) return;\n                    this.showEditModal(card.dataset.contactId);\n                };\n            });\n\n            this.container.querySelectorAll('.btn-edit-contact').forEach(btn => {\n                btn.onclick = (e) => {\n                    e.stopPropagation();\n                    const card = e.target.closest('.contact-card');\n                    this.showEditModal(card.dataset.contactId);\n                };\n            });\n\n            this.container.querySelectorAll('.btn-delete-contact').forEach(btn => {\n                btn.onclick = (e) => {\n                    e.stopPropagation();\n                    const card = e.target.closest('.contact-card');\n                    this.showDeleteConfirmation(card.dataset.contactId);\n                };\n            });\n        },\n\n        attachProfileListeners() {\n            const nameInput = this.container.querySelector('#profile-name');\n            const roleSelect = this.container.querySelector('#profile-role');\n            const phoneInput = this.container.querySelector('#profile-phone');\n            const emailInput = this.container.querySelector('#profile-email');\n            const avatarContainer = this.container.querySelector('#profile-avatar-container');\n\n            const handleProfileInput = (field, value) => {\n                userProfile[field] = value;\n                scheduleProfileSave();\n            };\n\n            if (nameInput) {\n                nameInput.oninput = () => handleProfileInput('name', nameInput.value);\n            }\n            if (roleSelect) {\n                roleSelect.onchange = () => handleProfileInput('role', roleSelect.value);\n            }\n            if (phoneInput) {\n                phoneInput.oninput = () => handleProfileInput('phone', phoneInput.value);\n            }\n            if (emailInput) {\n                emailInput.oninput = () => handleProfileInput('email', emailInput.value);\n            }\n\n            if (avatarContainer) {\n                avatarContainer.onclick = () => this.openProfileAvatarEditor();\n                avatarContainer.onkeydown = (e) => {\n                    if (e.key === 'Enter' || e.key === ' ') {\n                        e.preventDefault();\n                        this.openProfileAvatarEditor();\n                    }\n                };\n            }\n        },\n\n        openProfileAvatarEditor() {\n            if (global.cineAvatarEditorModal) {\n                global.cineAvatarEditorModal.open({\n                    avatar: userProfile.avatar || '',\n                    onSave: (dataUrl) => {\n                        userProfile.avatar = dataUrl;\n                        saveUserProfile();\n                        this.render();\n                    },\n                    onDelete: () => {\n                        userProfile.avatar = '';\n                        saveUserProfile();\n                        this.render();\n                    }\n                });\n            } else {\n                // Fallback: simple file input\n                const input = document.createElement('input');\n                input.type = 'file';\n                input.accept = 'image/*';\n                input.onchange = (e) => {\n                    const file = e.target.files?.[0];\n                    if (!file) return;\n\n                    if (global.CINE_CONTACTS_PROFILE_MODULE?.readAvatarFile) {\n                        global.CINE_CONTACTS_PROFILE_MODULE.readAvatarFile(\n                            file,\n                            (dataUrl) => {\n                                userProfile.avatar = dataUrl;\n                                saveUserProfile();\n                                this.render();\n                            },\n                            (err) => console.warn('Avatar read error:', err)\n                        );\n                    } else {\n                        const reader = new FileReader();\n                        reader.onload = (ev) => {\n                            userProfile.avatar = ev.target?.result || '';\n                            saveUserProfile();\n                            this.render();\n                        };\n                        reader.readAsDataURL(file);\n                    }\n                };\n                input.click();\n            }\n        },\n\n        showDeleteConfirmation(contactId) {\n            const backdrop = document.createElement('div');\n            backdrop.className = 'v2-modal-backdrop';\n\n            backdrop.innerHTML = `\n                <div class=\"v2-modal\" style=\"max-width: 400px;\">\n                    <div class=\"v2-modal-header\">\n                        <h3 class=\"v2-modal-title\">${_t('modalTitleDeleteContact')}</h3>\n                        <button type=\"button\" class=\"v2-modal-close v2-btn v2-btn-ghost\"><span class=\"icon\">close</span></button>\n                    </div>\n                    <div class=\"v2-modal-body\" style=\"padding: 24px;\">\n                        <p>${_t('confirmDeleteContact')}</p>\n                    </div>\n                    <div class=\"v2-modal-footer\">\n                        <button type=\"button\" class=\"v2-btn v2-btn-secondary\" id=\"btn-cancel-delete\">${_t('buttonCancel')}</button>\n                        <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"btn-confirm-delete\" style=\"background-color: var(--v2-status-error); border-color: var(--v2-status-error);\">${_t('buttonDeleteRed')}</button>\n                    </div>\n                </div>\n            `;\n\n            document.body.appendChild(backdrop);\n            requestAnimationFrame(() => backdrop.classList.add('open'));\n\n            const close = () => {\n                backdrop.classList.remove('open');\n                setTimeout(() => backdrop.remove(), 200);\n            };\n\n            backdrop.querySelector('.v2-modal-close').onclick = close;\n            backdrop.querySelector('#btn-cancel-delete').onclick = close;\n            backdrop.querySelector('#btn-confirm-delete').onclick = () => {\n                this.deleteContact(contactId);\n                close();\n            };\n        },\n\n        deleteContact(id) {\n            const module = global.cineFeaturesContacts;\n            if (!module) return;\n\n            const existing = module.loadStoredContacts();\n            const filtered = existing.filter(c => c.id !== id);\n\n            if (module.saveContactsToStorage(filtered)) {\n                this.render();\n            } else {\n                alert('Failed to delete contact.');\n            }\n        },\n\n        showEditModal(contactId) {\n            const module = global.cineFeaturesContacts;\n            if (!module) return;\n\n            let contact = {};\n            let isNew = true;\n\n            if (contactId) {\n                const existing = module.loadStoredContacts();\n                const found = existing.find(c => c.id === contactId);\n                if (found) {\n                    contact = { ...found };\n                    isNew = false;\n                }\n            }\n\n            // Defaults\n            if (isNew) {\n                contact = {\n                    name: '',\n                    role: '',\n                    phone: '',\n                    email: '',\n                    website: '',\n                    notes: '',\n                    avatar: ''\n                };\n            }\n\n            // Remove existing modal if any\n            const existingModal = document.querySelector('.v2-modal-backdrop');\n            if (existingModal) existingModal.remove();\n\n            const backdrop = document.createElement('div');\n            backdrop.className = 'v2-modal-backdrop';\n\n            const roles = [\n                'DoP', '1st AC', '2nd AC', 'Camera Operator', 'DIT', 'Data Wrangler',\n                'VTR/Playback', 'Gaffer', 'Best Boy', 'Key Grip', 'Grip', 'Sound Mixer',\n                'Boom Operator', 'PA', 'Director', 'Producer', 'Line Producer', 'Production Manager',\n                'Rental House', 'Post House', 'Agency', 'Client'\n            ];\n\n            backdrop.innerHTML = `\n                <div class=\"v2-modal contact-modal\">\n                    <div class=\"v2-modal-header\">\n                        <h3 class=\"v2-modal-title\">${isNew ? _t('modalTitleNewContact') : _t('modalTitleEditContact')}</h3>\n                        <button type=\"button\" class=\"v2-modal-close v2-btn v2-btn-ghost\"><span class=\"icon\">close</span></button>\n                    </div>\n                    <div class=\"v2-modal-body contacts-modal-body\">\n                        \n                        <!-- Avatar Upload Section -->\n                        <div class=\"avatar-upload-section\" id=\"avatarDropZone\">\n                            <div class=\"avatar-preview\" id=\"modalAvatarPreview\">\n                                ${contact.avatar ? `<img src=\"${contact.avatar}\">` : '<span class=\"icon\">person</span>'}\n                            </div>\n                            <div class=\"avatar-buttons\">\n                                <label class=\"v2-btn v2-btn-sm v2-btn-secondary\">\n                                    <span class=\"icon\" style=\"font-size:14px; margin-right:4px;\">upload</span>\n                                    ${_t('buttonUploadPhoto')}\n                                    <input type=\"file\" id=\"avatarUploadInput\" accept=\"image/*\" hidden>\n                                </label>\n                                <button type=\"button\" class=\"v2-btn v2-btn-sm v2-btn-ghost text-danger\" id=\"removeAvatarBtn\" ${!contact.avatar ? 'disabled' : ''}>\n                                    ${_t('buttonRemovePhoto')}\n                                </button>\n                            </div>\n                            <div class=\"avatar-hint\">${_t('avatarHint')}</div>\n                        </div>\n\n                        <!-- Basic Info Section -->\n                        <div class=\"contact-form-section\">\n                            <div class=\"contact-form-section-title\">\n                                <span class=\"icon\">badge</span>\n                                ${_t('sectionBasicInfo')}\n                            </div>\n                            \n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label\">${_t('labelName')}</label>\n                                <div class=\"v2-input-group\">\n                                    <span class=\"input-icon\"><span class=\"icon\">person</span></span>\n                                    <input type=\"text\" id=\"contactName\" class=\"v2-input\" value=\"${escapeHtml(contact.name)}\" placeholder=\"${_t('placeholderFullName')}\" required>\n                                </div>\n                            </div>\n\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label\">${_t('labelRole')}</label>\n                                <div class=\"v2-input-group\">\n                                    <span class=\"input-icon\"><span class=\"icon\">work</span></span>\n                                    <input type=\"text\" id=\"contactRole\" class=\"v2-input\" value=\"${escapeHtml(contact.role)}\" list=\"roleList\" placeholder=\"${_t('placeholderRole')}\">\n                                </div>\n                                <datalist id=\"roleList\">\n                                    ${roles.map(r => `<option value=\"${r}\">`).join('')}\n                                </datalist>\n                            </div>\n                        </div>\n\n                        <!-- Contact Details Section -->\n                        <div class=\"contact-form-section\">\n                            <div class=\"contact-form-section-title\">\n                                <span class=\"icon\">contacts</span>\n                                ${_t('sectionContactDetails')}\n                            </div>\n\n                            <div class=\"detail-row-group\">\n                                <div class=\"v2-form-group\">\n                                    <label class=\"v2-label\">${_t('labelPhone')}</label>\n                                    <div class=\"v2-input-group\">\n                                        <span class=\"input-icon\"><span class=\"icon\">call</span></span>\n                                        <input type=\"tel\" id=\"contactPhone\" class=\"v2-input\" value=\"${escapeHtml(contact.phone)}\" placeholder=\"${_t('placeholderPhone')}\">\n                                    </div>\n                                </div>\n                                \n                                <div class=\"v2-form-group\">\n                                    <label class=\"v2-label\">${_t('labelEmail')}</label>\n                                    <div class=\"v2-input-group\">\n                                        <span class=\"input-icon\"><span class=\"icon\">mail</span></span>\n                                        <input type=\"email\" id=\"contactEmail\" class=\"v2-input\" value=\"${escapeHtml(contact.email)}\" placeholder=\"${_t('placeholderEmail')}\">\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label\">${_t('labelWebsite')}</label>\n                                <div class=\"v2-input-group\">\n                                    <span class=\"input-icon\"><span class=\"icon\">language</span></span>\n                                    <input type=\"url\" id=\"contactWebsite\" class=\"v2-input\" value=\"${escapeHtml(contact.website)}\" placeholder=\"${_t('placeholderWebsite')}\">\n                                </div>\n                            </div>\n                        </div>\n\n                        <!-- Notes Section -->\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('labelNotes')}</label>\n                            <textarea id=\"contactNotes\" class=\"v2-input\" rows=\"3\" placeholder=\"${_t('placeholderNotes')}\">${escapeHtml(contact.notes)}</textarea>\n                        </div>\n\n                    </div>\n                    <div class=\"v2-modal-footer\">\n                        <button type=\"button\" class=\"v2-btn v2-btn-secondary\" id=\"btn-cancel-contact\">${_t('buttonCancel')}</button>\n                        <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"btn-save-contact\">\n                            <span class=\"icon\" style=\"font-size:16px; margin-right:4px;\">save</span>\n                            ${_t('buttonSaveContact')}\n                        </button>\n                    </div>\n                </div>\n            `;\n\n            document.body.appendChild(backdrop);\n            requestAnimationFrame(() => backdrop.classList.add('open'));\n\n            // --- Modal Events ---\n            const close = () => {\n                backdrop.classList.remove('open');\n                setTimeout(() => backdrop.remove(), 200);\n            };\n\n            backdrop.querySelector('.v2-modal-close').onclick = close;\n            backdrop.querySelector('#btn-cancel-contact').onclick = close;\n\n            // Avatar Handling\n            const avatarInput = backdrop.querySelector('#avatarUploadInput');\n            const avatarPreview = backdrop.querySelector('#modalAvatarPreview');\n            const removeAvatarBtn = backdrop.querySelector('#removeAvatarBtn');\n            let currentAvatar = contact.avatar || '';\n\n            avatarInput.onchange = (e) => {\n                const file = e.target.files[0];\n                if (!file) return;\n\n                // Use the profile module's helpers if available, or basic reader\n                if (global.CINE_CONTACTS_PROFILE_MODULE) {\n                    global.CINE_CONTACTS_PROFILE_MODULE.readAvatarFile(file, (dataUrl) => {\n                        currentAvatar = dataUrl;\n                        avatarPreview.innerHTML = `<img src=\"${dataUrl}\">`;\n                        removeAvatarBtn.disabled = false;\n                    }, (err) => {\n                        alert('Error reading image: ' + err);\n                    });\n                } else {\n                    // Fallback\n                    const reader = new FileReader();\n                    reader.onload = (ev) => {\n                        currentAvatar = ev.target.result;\n                        avatarPreview.innerHTML = `<img src=\"${currentAvatar}\">`;\n                        removeAvatarBtn.disabled = false;\n                    };\n                    reader.readAsDataURL(file);\n                }\n            };\n\n            removeAvatarBtn.onclick = () => {\n                currentAvatar = '';\n                avatarPreview.innerHTML = '<span class=\"icon\">person</span>';\n                removeAvatarBtn.disabled = true;\n                avatarInput.value = '';\n            };\n\n            // Drag and Drop support for avatar\n            const avatarDropZone = backdrop.querySelector('#avatarDropZone');\n\n            const handleAvatarFile = (file) => {\n                if (!file || !file.type.startsWith('image/')) return;\n\n                if (global.CINE_CONTACTS_PROFILE_MODULE) {\n                    global.CINE_CONTACTS_PROFILE_MODULE.readAvatarFile(file, (dataUrl) => {\n                        currentAvatar = dataUrl;\n                        avatarPreview.innerHTML = `<img src=\"${dataUrl}\">`;\n                        removeAvatarBtn.disabled = false;\n                    }, (err) => {\n                        alert('Error reading image: ' + err);\n                    });\n                } else {\n                    const reader = new FileReader();\n                    reader.onload = (ev) => {\n                        currentAvatar = ev.target.result;\n                        avatarPreview.innerHTML = `<img src=\"${currentAvatar}\">`;\n                        removeAvatarBtn.disabled = false;\n                    };\n                    reader.readAsDataURL(file);\n                }\n            };\n\n            avatarDropZone.addEventListener('dragover', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                avatarDropZone.classList.add('drag-over');\n            });\n\n            avatarDropZone.addEventListener('dragleave', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                avatarDropZone.classList.remove('drag-over');\n            });\n\n            avatarDropZone.addEventListener('drop', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                avatarDropZone.classList.remove('drag-over');\n\n                const file = e.dataTransfer?.files?.[0];\n                if (file) {\n                    handleAvatarFile(file);\n                }\n            });\n\n            // Save\n            backdrop.querySelector('#btn-save-contact').onclick = () => {\n                const name = backdrop.querySelector('#contactName').value.trim();\n                if (!name) {\n                    alert(_t('alertEnterName'));\n                    return;\n                }\n\n                // Construct new object\n                const entry = {\n                    id: contactId || undefined,\n                    name: name,\n                    role: backdrop.querySelector('#contactRole').value.trim(),\n                    phone: backdrop.querySelector('#contactPhone').value.trim(),\n                    email: backdrop.querySelector('#contactEmail').value.trim(),\n                    website: backdrop.querySelector('#contactWebsite').value.trim(),\n                    notes: backdrop.querySelector('#contactNotes').value.trim(),\n                    avatar: currentAvatar\n                };\n\n                const allContacts = module.loadStoredContacts();\n\n                let updatedList;\n                if (isNew) {\n                    const normalized = module.normalizeContactEntry(entry);\n                    updatedList = [...allContacts, normalized];\n                } else {\n                    updatedList = allContacts.map(c => {\n                        if (c.id === contactId) {\n                            return module.normalizeContactEntry({ ...c, ...entry });\n                        }\n                        return c;\n                    });\n                }\n\n                // Sort\n                updatedList = module.sortContacts(updatedList);\n\n                if (module.saveContactsToStorage(updatedList)) {\n                    this.render();\n                    close();\n                } else {\n                    alert('Failed to save contact.');\n                }\n            };\n        }\n    };\n\n    global.cineContactsView = ContactsView;\n\n})(typeof window !== 'undefined' ? window : this);\n","(function () {\n    'use strict';\n\n    const VIEW_ID = 'view-settings';\n\n    let isInitialized = false;\n\n    // =====================\n    // HELPERS\n    // =====================\n    function _t(key) {\n        if (typeof window !== 'undefined' && window.texts) {\n            // 1. Get current language\n            const langSelect = document.getElementById('languageSelect');\n            const lang = (langSelect && langSelect.value) ||\n                (typeof window.currentLanguage === 'string' && window.currentLanguage) ||\n                'en';\n\n            // 2. Get correct dictionary\n            const dict = window.texts[lang] || window.texts['en'];\n\n            if (dict) {\n                return key.split('.').reduce((o, i) => (o ? o[i] : null), dict) || key;\n            }\n        }\n        return key;\n    }\n\n    // Map V2 element IDs to Legacy element IDs and types\n    const SETTINGS_MAP = [\n        // --- General ---\n        { v2: 'v2-settings-language', legacy: 'settingsLanguage', type: 'value' },\n        { v2: 'v2-settings-temp-unit', legacy: 'settingsTemperatureUnit', type: 'value' },\n        { v2: 'v2-settings-focus-scale', legacy: 'settingsFocusScale', type: 'value' },\n        { v2: 'v2-settings-dark-mode', legacy: 'settingsDarkMode', type: 'checkbox' },\n        { v2: 'v2-settings-pink-mode', legacy: 'settingsPinkMode', type: 'checkbox' },\n        { v2: 'v2-settings-accent-color', legacy: 'accentColorInput', type: 'color' },\n        { v2: 'v2-settings-font-size', legacy: 'settingsFontSize', type: 'value' },\n        { v2: 'v2-settings-font-family', legacy: 'settingsFontFamily', type: 'value' },\n\n        // Camera Constants\n        { v2: 'v2-cam-color-a', legacy: 'cameraColorA', type: 'color' },\n        { v2: 'v2-cam-color-b', legacy: 'cameraColorB', type: 'color' },\n        { v2: 'v2-cam-color-c', legacy: 'cameraColorC', type: 'color' },\n        { v2: 'v2-cam-color-d', legacy: 'cameraColorD', type: 'color' },\n        { v2: 'v2-cam-color-e', legacy: 'cameraColorE', type: 'color' },\n\n        // --- Accessibility ---\n        { v2: 'v2-settings-high-contrast', legacy: 'settingsHighContrast', type: 'checkbox' },\n        { v2: 'v2-settings-reduce-motion', legacy: 'settingsReduceMotion', type: 'checkbox' },\n        { v2: 'v2-settings-relaxed-spacing', legacy: 'settingsRelaxedSpacing', type: 'checkbox' },\n\n        // Mount Voltages\n        { v2: 'v2-volt-v-high', legacy: 'mountVoltageVHigh', type: 'value' },\n        { v2: 'v2-volt-v-low', legacy: 'mountVoltageVLow', type: 'value' },\n        { v2: 'v2-volt-gold-high', legacy: 'mountVoltageGoldHigh', type: 'value' },\n        { v2: 'v2-volt-gold-low', legacy: 'mountVoltageGoldLow', type: 'value' },\n        { v2: 'v2-volt-b-high', legacy: 'mountVoltageBHigh', type: 'value' },\n        { v2: 'v2-volt-b-low', legacy: 'mountVoltageBLow', type: 'value' },\n\n        // --- Backup & Restore ---\n        { v2: 'v2-settings-auto-backup', legacy: 'settingsShowAutoBackups', type: 'checkbox' },\n        { v2: 'v2-settings-backup-retention', legacy: 'autoGearBackupRetention', type: 'value' },\n\n        // --- Logging ---\n        { v2: 'v2-settings-log-level', legacy: 'loggingLevelFilter', type: 'value' },\n        { v2: 'v2-settings-log-history', legacy: 'loggingHistoryLimit', type: 'value' },\n        { v2: 'v2-settings-log-filter', legacy: 'loggingNamespaceFilter', type: 'value' },\n        { v2: 'v2-settings-log-console', legacy: 'loggingConsoleOutput', type: 'checkbox' },\n        { v2: 'v2-settings-log-capture', legacy: 'loggingCaptureConsole', type: 'checkbox' },\n        { v2: 'v2-settings-log-errors', legacy: 'loggingCaptureErrors', type: 'checkbox' },\n        { v2: 'v2-settings-log-persist', legacy: 'loggingPersistSession', type: 'checkbox' },\n    ];\n\n    const SettingsView = {\n        init() {\n            this.container = document.getElementById(VIEW_ID);\n            if (!this.container) {\n                console.error(`[SettingsView] Container element with ID '${VIEW_ID}' not found.`);\n                return;\n            }\n\n            if (!isInitialized) {\n                console.log('[SettingsView] Initializing...');\n\n                // View Change Listener\n                document.addEventListener('v2:viewchange', (e) => {\n                    if (e.detail && e.detail.view === 'settings') {\n                        this.render();\n                    }\n                });\n\n                // Language Change Listener (Standard DOM event from Legacy Shim)\n                const legacySelect = document.getElementById('languageSelect');\n                if (legacySelect) {\n                    legacySelect.addEventListener('change', () => {\n                        // Re-render if currently visible to apply translations\n                        if (this.isVisible()) {\n                            this.render();\n                        }\n                    });\n                }\n\n                // Also listen for custom v2 event if invoked programmatically (e.g. from Sidebar)\n                document.addEventListener('v2:languagechange', () => {\n                    if (this.isVisible()) {\n                        this.render();\n                    }\n                });\n\n                isInitialized = true;\n            }\n        },\n\n        isVisible() {\n            return this.container && this.container.classList.contains('active');\n        },\n\n        render() {\n            if (!this.container) {\n                this.init();\n                if (!this.container) return;\n            }\n\n            // Generate HTML (Always regenerate to apply new translations)\n            this.container.innerHTML = this.getTemplate();\n\n            // Initialize Logic (Re-attach listeners to new DOM)\n            this.attachListeners();\n            this.syncFromLegacy();\n            this.initTabs();\n            this.initRehearsalSync();\n            this.initStatusObservers();\n            this.initBackupDiffSync();\n            this.initLogViewerSync();\n        },\n\n        getTemplate() {\n            return `\n            <div class=\"v2-modal-header\">\n                <h2>${_t('settingsHeading')}</h2>\n                <button class=\"v2-modal-close\" id=\"v2-settings-close\" aria-label=\"${_t('buttonClose')}\">\n                    <span class=\"icon\">close</span>\n                </button>\n            </div>\n            \n            <nav class=\"v2-tabs-nav v2-settings-tabs-nav\" role=\"tablist\" aria-label=\"${_t('settingsHeading')}\">\n                <button type=\"button\" class=\"v2-tab-btn active\" data-tab=\"general\" role=\"tab\" aria-selected=\"true\" aria-controls=\"v2-panel-general\">\n                    ${_t('settingsTabGeneral')}\n                </button>\n                <button type=\"button\" class=\"v2-tab-btn\" data-tab=\"backup\" role=\"tab\" aria-selected=\"false\" aria-controls=\"v2-panel-backup\">\n                    ${_t('settingsTabBackup')}\n                </button>\n                <button type=\"button\" class=\"v2-tab-btn\" data-tab=\"data\" role=\"tab\" aria-selected=\"false\" aria-controls=\"v2-panel-data\">\n                    ${_t('settingsTabData')}\n                </button>\n                <button type=\"button\" class=\"v2-tab-btn\" data-tab=\"about\" role=\"tab\" aria-selected=\"false\" aria-controls=\"v2-panel-about\">\n                    ${_t('settingsTabAbout')}\n                </button>\n            </nav>\n\n            <div class=\"v2-settings-body\">\n                ${this.getGeneralTabHtml()}\n                ${this.getBackupTabHtml()}\n                ${this.getDataTabHtml()}\n                ${this.getAboutTabHtml()}\n            </div>\n            <div class=\"v2-settings-footer\">\n                <button class=\"v2-btn v2-btn-primary\" id=\"v2-settings-done\">${_t('buttonClose')}</button>\n            </div>\n            \n            <!-- Modals -->\n            ${this.getBackupDiffModalHtml()}\n            ${this.getRehearsalModalHtml()}\n        `;\n        },\n\n        getGeneralTabHtml() {\n            return `\n            <div class=\"v2-settings-panel active\" id=\"v2-panel-general\">\n                <h2>${_t('settingsTabGeneral')}</h2>\n                \n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">language</span> ${_t('generalSectionLanguageHeading')}</h3>\n                    <div class=\"v2-form-grid\">\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('languageSetting')}</label>\n                            <select class=\"v2-select\" id=\"v2-settings-language\">\n                                <option value=\"en\">English</option>\n                                <option value=\"de\">Deutsch</option>\n                                <option value=\"es\">Espaol</option>\n                                <option value=\"fr\">Franais</option>\n                                <option value=\"it\">Italiano</option>\n                            </select>\n                        </div>\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('temperatureUnitSetting')}</label>\n                            <select class=\"v2-select\" id=\"v2-settings-temp-unit\">\n                                <option value=\"celsius\">${_t('temperatureUnitCelsius')}</option>\n                                <option value=\"fahrenheit\">${_t('temperatureUnitFahrenheit')}</option>\n                            </select>\n                        </div>\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('focusScaleSetting')}</label>\n                            <select class=\"v2-select\" id=\"v2-settings-focus-scale\">\n                                <option value=\"metric\">${_t('focusScaleMetric')}</option>\n                                <option value=\"imperial\">${_t('focusScaleImperial')}</option>\n                            </select>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">palette</span> ${_t('generalSectionAppearanceHeading')}</h3>\n                    <div class=\"v2-checkbox-group\">\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('darkModeSetting')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-dark-mode\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('pinkModeSetting')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-pink-mode\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                    </div>\n                    <div class=\"v2-form-group\" style=\"margin-top: 1rem;\">\n                        <label class=\"v2-label\">${_t('accentColorSetting')}</label>\n                        <div class=\"v2-color-input-wrapper\">\n                            <input type=\"color\" class=\"v2-color-input\" id=\"v2-settings-accent-color\">\n                            <button class=\"v2-btn v2-btn-sm v2-btn-secondary\" id=\"v2-accent-reset\">${_t('buttonReset')}</button>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">battery_charging_full</span> ${_t('mountVoltageSettingsHeading')}</h3>\n                    <p>${_t('mountVoltageDescription')}</p>\n                    \n                    <div class=\"v2-form-grid v2-voltage-grid\">\n                        \n                        <!-- V-Mount -->\n                        <div class=\"v2-voltage-card\">\n                            <h4>${_t('mountVoltageCardLabelV')}</h4>\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label v2-voltage-label-small\">${_t('mountVoltageHighLabel')}</label>\n                                <input type=\"number\" class=\"v2-input\" id=\"v2-volt-v-high\" step=\"0.1\" min=\"0\">\n                            </div>\n                            <div class=\"v2-form-group\" style=\"margin-top: 0.5rem;\">\n                                <label class=\"v2-label v2-voltage-label-small\">${_t('mountVoltageLowLabel')}</label>\n                                <input type=\"number\" class=\"v2-input\" id=\"v2-volt-v-low\" step=\"0.1\" min=\"0\">\n                            </div>\n                        </div>\n\n                        <!-- Gold Mount -->\n                        <div class=\"v2-voltage-card\">\n                            <h4>${_t('mountVoltageCardLabelGold')}</h4>\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label v2-voltage-label-small\">${_t('mountVoltageHighLabel')}</label>\n                                <input type=\"number\" class=\"v2-input\" id=\"v2-volt-gold-high\" step=\"0.1\" min=\"0\">\n                            </div>\n                             <div class=\"v2-form-group\" style=\"margin-top: 0.5rem;\">\n                                <label class=\"v2-label v2-voltage-label-small\">${_t('mountVoltageLowLabel')}</label>\n                                <input type=\"number\" class=\"v2-input\" id=\"v2-volt-gold-low\" step=\"0.1\" min=\"0\">\n                            </div>\n                        </div>\n\n                        <!-- B-Mount -->\n                        <div class=\"v2-voltage-card\">\n                            <h4>${_t('mountVoltageCardLabelB')}</h4>\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label v2-voltage-label-small\">${_t('mountVoltageHighLabel')}</label>\n                                <input type=\"number\" class=\"v2-input\" id=\"v2-volt-b-high\" step=\"0.1\" min=\"0\">\n                            </div>\n                             <div class=\"v2-form-group\" style=\"margin-top: 0.5rem;\">\n                                <label class=\"v2-label v2-voltage-label-small\">${_t('mountVoltageLowLabel')}</label>\n                                <input type=\"number\" class=\"v2-input\" id=\"v2-volt-b-low\" step=\"0.1\" min=\"0\">\n                            </div>\n                        </div>\n                    </div>\n                     <div style=\"margin-top: 1rem;\">\n                        <button class=\"v2-btn v2-btn-sm v2-btn-secondary\" id=\"v2-volt-reset\">${_t('mountVoltageReset')}</button>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">color_lens</span> ${_t('generalSectionCameraColorsHeading')}</h3>\n                    <p>${_t('cameraColorSettingDescription')}</p>\n                    <div class=\"v2-camera-colors-grid\">\n                        <div class=\"v2-color-field\">\n                            <label>${_t('cameraColorALabel')}</label>\n                            <input type=\"color\" class=\"v2-color-input\" id=\"v2-cam-color-a\">\n                        </div>\n                        <div class=\"v2-color-field\">\n                            <label>${_t('cameraColorBLabel')}</label>\n                            <input type=\"color\" class=\"v2-color-input\" id=\"v2-cam-color-b\">\n                        </div>\n                        <div class=\"v2-color-field\">\n                            <label>${_t('cameraColorCLabel')}</label>\n                            <input type=\"color\" class=\"v2-color-input\" id=\"v2-cam-color-c\">\n                        </div>\n                        <div class=\"v2-color-field\">\n                            <label>${_t('cameraColorDLabel')}</label>\n                            <input type=\"color\" class=\"v2-color-input\" id=\"v2-cam-color-d\">\n                        </div>\n                        <div class=\"v2-color-field\">\n                            <label>${_t('cameraColorELabel')}</label>\n                            <input type=\"color\" class=\"v2-color-input\" id=\"v2-cam-color-e\">\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">tune</span> ${_t('generalSectionInterfaceHeading')}</h3>\n                    <p>${_t('generalSectionInterfaceHelp')}</p>\n                    <div class=\"v2-checkbox-group\">\n                        <label class=\"v2-toggle-row\">\n                             <span class=\"v2-toggle-label\">${_t('checkboxHighContrast')}</span>\n                             <div class=\"v2-toggle-switch\">\n                                 <input type=\"checkbox\" id=\"v2-settings-high-contrast\">\n                                 <span class=\"v2-toggle-slider\"></span>\n                             </div>\n                        </label>\n                        <label class=\"v2-toggle-row\">\n                             <span class=\"v2-toggle-label\">${_t('checkboxReduceMotion')}</span>\n                             <div class=\"v2-toggle-switch\">\n                                 <input type=\"checkbox\" id=\"v2-settings-reduce-motion\">\n                                 <span class=\"v2-toggle-slider\"></span>\n                             </div>\n                        </label>\n                         <label class=\"v2-toggle-row\">\n                             <span class=\"v2-toggle-label\">${_t('checkboxRelaxedSpacing')}</span>\n                             <div class=\"v2-toggle-switch\">\n                                 <input type=\"checkbox\" id=\"v2-settings-relaxed-spacing\">\n                                 <span class=\"v2-toggle-slider\"></span>\n                             </div>\n                        </label>\n                    </div>\n                    \n                    <div class=\"v2-form-group\" style=\"margin-top: 1rem;\">\n                        <label class=\"v2-label\">${_t('fontSizeSetting')}</label>\n                        <select class=\"v2-select\" id=\"v2-settings-font-size\">\n                            <option value=\"13px\">Small (13px)</option>\n                            <option value=\"14px\">Medium (14px)</option>\n                            <option value=\"15px\">Large (15px)</option>\n                            <option value=\"16px\">X-Large (16px)</option>\n                        </select>\n                         <p class=\"v2-help-text\">${_t('fontSizeSettingHelp')}</p>\n                    </div>\n                     <div class=\"v2-form-group\">\n                        <label class=\"v2-label\">${_t('fontFamilySetting')}</label>\n                        <select class=\"v2-select\" id=\"v2-settings-font-family\">\n                            <option value=\"Inter, system-ui, sans-serif\">Inter (Default)</option>\n                            <option value=\"Roboto, sans-serif\">Roboto</option>\n                            <option value=\"Open Sans, sans-serif\">Open Sans</option>\n                            <option value=\"system-ui, sans-serif\">System UI</option>\n                        </select>\n                         <p class=\"v2-help-text\">${_t('fontFamilySettingHelp')}</p>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">verified</span> ${_t('generalSectionBrandingHeading')}</h3>\n                    <p>${_t('logoSettingHelp')}</p>\n                    <div class=\"v2-branding-preview\" id=\"v2-branding-preview\" style=\"margin-bottom: 1rem; padding: 1rem; border: 1px dashed var(--v2-border-default); border-radius: var(--v2-radius-sm); text-align: center;\">\n                        <span style=\"color: var(--v2-text-muted);\">${_t('brandingNoLogo')}</span>\n                    </div>\n                    <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-branding-upload\">\n                        <span class=\"icon\">upload</span> ${_t('buttonUploadSvg')}\n                    </button>\n                    <!-- Legacy File Input is hidden and clicked via proxy -->\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">history_edu</span> ${_t('documentationTrackerHeading')}</h3>\n                    <p>${_t('documentationTrackerDescription')}</p>\n                    <div class=\"v2-doc-tracker-list\" id=\"v2-doc-tracker-list\" style=\"margin: 1rem 0; border: 1px solid var(--v2-border-default); border-radius: var(--v2-radius-sm); min-height: 50px;\">\n                        <!-- Mirrored Items -->\n                        <p style=\"padding: 1rem; color: var(--v2-text-muted); text-align: center;\">${_t('documentationTrackerEmptyShort')}</p>\n                    </div>\n                    <button class=\"v2-btn v2-btn-sm v2-btn-primary\" id=\"v2-btn-doc-tracker-add\">\n                        ${_t('documentationTrackerAddRelease')}\n                    </button>\n                </div>\n            </div>\n        `;\n        },\n\n        getBackupTabHtml() {\n            return `\n            <div class=\"v2-settings-panel\" id=\"v2-panel-backup\" hidden>\n                <h2>${_t('settingsTabBackup')}</h2>\n                \n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">cloud_sync</span> ${_t('settingsBackupAutomatedHeading')}</h3>\n                    <div class=\"v2-form-group\">\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('checkboxAutoBackupList')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-auto-backup\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                    </div>\n                    <div class=\"v2-form-group\" style=\"margin-top: 1rem;\">\n                        <label class=\"v2-label\">${_t('labelBackupRetention')}</label>\n                        <input type=\"number\" class=\"v2-input\" id=\"v2-settings-backup-retention\" min=\"1\" max=\"50\" style=\"max-width: 120px;\">\n                    </div>\n                    <!-- Compare Versions (Diff) -->\n                    <div style=\"margin-top: 1rem;\">\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-backup-diff\">\n                            <span class=\"icon\">compare_arrows</span>\n                            ${_t('buttonCompareVersions')}\n                        </button>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">save</span> ${_t('settingsBackupManualHeading')}</h3>\n                    <div class=\"v2-form-row-inline\">\n                        <button class=\"v2-btn v2-btn-primary\" id=\"v2-btn-backup\">\n                            <span class=\"icon\">download</span>\n                            ${_t('buttonDownloadBackup')}\n                        </button>\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-restore\">\n                            <span class=\"icon\">upload</span>\n                            ${_t('buttonRestore')}\n                        </button>\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-restore-rehearsal\">\n                            <span class=\"icon\">science</span>\n                            ${_t('buttonRestoreRehearsal')}\n                        </button>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\" style=\"border-color: var(--v2-status-error);\">\n                    <h3 style=\"color: var(--v2-status-error);\"><span class=\"icon\">warning</span> ${_t('settingsBackupDangerHeading')}</h3>\n                    <p>${_t('settingsFactoryResetHelp')}</p>\n                    <button class=\"v2-btn v2-btn-danger\" id=\"v2-btn-factory-reset\">\n                        <span class=\"icon\">delete_forever</span>\n                        ${_t('buttonFactoryReset')}\n                    </button>\n                </div>\n            </div>\n        `;\n        },\n\n        getBackupDiffModalHtml() {\n            return `\n            <div class=\"v2-modal-backdrop\" id=\"v2-backup-diff-modal\" style=\"display: none;\">\n                <div class=\"v2-modal\" role=\"dialog\" aria-modal=\"true\" style=\"max-width: 700px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;\">\n                    <div class=\"v2-modal-header\">\n                        <h3>${_t('backupDiffModalTitle')}</h3>\n                        <button class=\"v2-btn-icon\" data-action=\"close-diff\">close</button>\n                    </div>\n                    <div class=\"v2-modal-content\" style=\"overflow-y: auto;\">\n                        <p style=\"color: var(--v2-text-secondary); margin-bottom: 1.5rem;\">\n                            ${_t('backupDiffModalSubtitle')}\n                        </p>\n                        \n                        <div class=\"v2-form-grid\">\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label\">${_t('labelBaselineVersion')}</label>\n                                <select class=\"v2-select\" id=\"v2-diff-primary\"></select>\n                            </div>\n                            <div class=\"v2-form-group\">\n                                <label class=\"v2-label\">${_t('labelComparisonVersion')}</label>\n                                <select class=\"v2-select\" id=\"v2-diff-secondary\"></select>\n                            </div>\n                        </div>\n\n                        <div id=\"v2-diff-summary\" style=\"margin: 1rem 0; font-weight: 500;\"></div>\n\n                        <!-- Diff List Mirror -->\n                        <div class=\"v2-diff-list-container\" style=\"border: 1px solid var(--v2-border-default); border-radius: var(--v2-radius-sm); padding: 0.5rem; min-height: 100px; max-height: 300px; overflow-y: auto;\">\n                            <ul id=\"v2-diff-list\" style=\"list-style: none; padding: 0; margin: 0;\"></ul>\n                            <p id=\"v2-diff-empty\" style=\"text-align: center; color: var(--v2-text-muted); padding: 2rem;\">\n                                ${_t('backupDiffEmptyState')}\n                            </p>\n                        </div>\n\n                        <div class=\"v2-form-group\" style=\"margin-top: 1rem;\">\n                            <label class=\"v2-label\">${_t('labelIncidentNotes')}</label>\n                            <textarea class=\"v2-textarea\" id=\"v2-diff-notes\" rows=\"3\" placeholder=\"${_t('placeholderIncidentNotes')}\"></textarea>\n                        </div>\n                    </div>\n                    <div class=\"v2-modal-footer\">\n                        <button class=\"v2-btn v2-btn-secondary\" data-action=\"close-diff\">${_t('buttonClose')}</button>\n                        <button class=\"v2-btn v2-btn-primary\" id=\"v2-btn-diff-export\">${_t('buttonExportLog')}</button>\n                    </div>\n                </div>\n            </div>\n        `;\n        },\n\n        getDataTabHtml() {\n            return `\n            <div class=\"v2-settings-panel\" id=\"v2-panel-data\" hidden>\n                <h2>${_t('settingsTabData')}</h2>\n                \n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">storage</span> ${_t('settingsDataStorageStatusHeading')}</h3>\n                    <div class=\"v2-key-value-list\">\n                         <div class=\"v2-kv-item\">\n                            <span class=\"v2-kv-label\">${_t('labelLatestProjectSave')}</span>\n                            <span class=\"v2-kv-value\" id=\"v2-status-last-project\">---</span>\n                        </div>\n                        <div class=\"v2-kv-item\">\n                            <span class=\"v2-kv-label\">${_t('labelLatestAutoBackup')}</span>\n                            <span class=\"v2-kv-value\" id=\"v2-status-last-auto\">---</span>\n                        </div>\n                         <div class=\"v2-kv-item\">\n                            <span class=\"v2-kv-label\">${_t('labelLatestFullBackup')}</span>\n                            <span class=\"v2-kv-value\" id=\"v2-status-last-full\">---</span>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">sd_storage</span> ${_t('settingsDataPersistenceHeading')}</h3>\n                    <p>${_t('textManageLocalData')}</p>\n                    <div class=\"v2-form-row-inline\" style=\"margin-bottom: 1rem;\">\n                        <button class=\"v2-btn v2-btn-primary\" id=\"v2-btn-data-backup\">\n                            <span class=\"icon\">download</span>\n                            ${_t('buttonDownloadFullBackup')}\n                        </button>\n                    </div>\n                    <p>${_t('textRequestPersistence')}</p>\n                    <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-storage-persist\">\n                        ${_t('buttonRequestPersistence')}\n                    </button>\n                    <p id=\"v2-status-persistence\" style=\"margin-top: 0.5rem; color: var(--v2-text-secondary); font-size: 0.9rem;\">\n                        ${_t('statusCheckingPersistence')}\n                    </p>\n                </div>\n\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">terminal</span> ${_t('settingsDataLoggingHeading')}</h3>\n                    <div class=\"v2-form-grid\">\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('labelLogLevel')}</label>\n                            <select class=\"v2-select\" id=\"v2-settings-log-level\">\n                                <option value=\"all\">${_t('optionLogLevelAll')}</option>\n                                <option value=\"info\">${_t('optionLogLevelInfo')}</option>\n                                <option value=\"warn\">${_t('optionLogLevelWarn')}</option>\n                                <option value=\"error\">${_t('optionLogLevelError')}</option>\n                            </select>\n                        </div>\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('labelHistoryLimit')}</label>\n                            <input type=\"number\" class=\"v2-input\" id=\"v2-settings-log-history\" min=\"50\" max=\"2000\" step=\"50\">\n                        </div>\n                         <div class=\"v2-form-group\" style=\"grid-column: span 2;\">\n                            <label class=\"v2-label\">${_t('labelNamespaceFilter')}</label>\n                            <input type=\"search\" class=\"v2-input\" id=\"v2-settings-log-filter\" placeholder=\"e.g. storage, backup\">\n                        </div>\n                    </div>\n                    <div class=\"v2-checkbox-group\" style=\"margin-top: 1rem;\">\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('checkboxMirrorConsole')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-log-console\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('checkboxCaptureConsole')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-log-capture\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('checkboxCaptureGlobalErrors')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-log-errors\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                        <label class=\"v2-toggle-row\">\n                            <span class=\"v2-toggle-label\">${_t('checkboxPersistSession')}</span>\n                            <div class=\"v2-toggle-switch\">\n                                <input type=\"checkbox\" id=\"v2-settings-log-persist\">\n                                <span class=\"v2-toggle-slider\"></span>\n                            </div>\n                        </label>\n                    </div>\n                    \n                    <!-- Log Viewer Mirror -->\n                    <div class=\"v2-log-viewer\" style=\"margin-top: 1rem; border: 1px solid var(--v2-border-default); background: var(--v2-surface-muted); height: 200px; overflow-y: auto; padding: 0.5rem; font-family: monospace; font-size: 0.85rem; border-radius: var(--v2-radius-sm);\">\n                        <ol id=\"v2-log-history-list\" style=\"margin: 0; padding-left: 1.5rem;\">\n                            <!-- Mirrored Items -->\n                        </ol>\n                         <p id=\"v2-log-empty\" style=\"text-align: center; color: var(--v2-text-muted); display: none;\">${_t('textNoLogEntries')}</p>\n                    </div>\n\n                    <div class=\"v2-form-row\" style=\"margin-top: 1rem;\">\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-export-log\">${_t('buttonExportLog')}</button>\n                    </div>\n                </div>\n            </div>\n        `;\n        },\n\n        getAboutTabHtml() {\n            // We'll read the version from legacy\n            const legacyVersion = document.getElementById('aboutVersion')?.textContent || 'v2.0';\n\n            return `\n            <div class=\"v2-settings-panel\" id=\"v2-panel-about\" hidden>\n                <h2>${_t('settingsTabAbout')}</h2>\n                <div class=\"v2-settings-card\">\n                    <h3><span class=\"icon\">info</span> ${_t('appTitle')}</h3>\n                    <p class=\"v2-text-lead\" style=\"font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;\">${legacyVersion}</p>\n                    <p>${_t('appCreator')}</p>\n                    \n                    <div class=\"v2-form-row-inline\" style=\"margin-top: 1.5rem;\">\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-support\">${_t('buttonSupport')}</button>\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-bug\">${_t('buttonReportBug')}</button>\n                        <button class=\"v2-btn v2-btn-secondary\" id=\"v2-btn-feature\">${_t('buttonSuggestFeature')}</button>\n                    </div>\n                </div>\n            </div>\n        `;\n        },\n\n        getRehearsalModalHtml() {\n            return `\n            <div class=\"v2-modal-backdrop\" id=\"v2-rehearsal-modal\" style=\"display: none;\">\n                <div class=\"v2-modal\" role=\"dialog\" aria-modal=\"true\" style=\"max-width: 600px; width: 90%;\">\n                    <div class=\"v2-modal-header\">\n                        <h3>${_t('buttonRestoreRehearsal')}</h3>\n                        <button class=\"v2-btn-icon\" data-action=\"close-rehearsal\">close</button>\n                    </div>\n                    <div class=\"v2-modal-content\">\n                        <p style=\"color: var(--v2-text-secondary); margin-bottom: 1.5rem;\">\n                            ${_t('rehearsalModalSubtitle')}\n                        </p>\n\n                        <!-- Source Selection -->\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('rehearsalModalSourceLabel')}</label>\n                            <div class=\"v2-radio-group\" id=\"v2-rehearsal-mode-group\">\n                                <label class=\"v2-radio-label\">\n                                    <input type=\"radio\" class=\"v2-radio\" name=\"v2RehearsalMode\" value=\"backup\" checked>\n                                    ${_t('rehearsalModalSourceBackup')}\n                                </label>\n                                <label class=\"v2-radio-label\">\n                                    <input type=\"radio\" class=\"v2-radio\" name=\"v2RehearsalMode\" value=\"project\">\n                                    ${_t('rehearsalModalSourceProject')}\n                                </label>\n                            </div>\n                        </div>\n\n                        <!-- File Input -->\n                        <div class=\"v2-form-group\" style=\"margin-top: 1.5rem;\">\n                            <label class=\"v2-label\">${_t('labelSelectFile')}</label>\n                            <div style=\"display: flex; gap: 1rem; align-items: center;\">\n                                <button class=\"v2-btn v2-btn-secondary\" id=\"v2-rehearsal-browse-btn\">\n                                    <span class=\"icon\">folder_open</span>\n                                    ${_t('buttonChooseFile')}\n                                </button>\n                                <span id=\"v2-rehearsal-filename\" style=\"color: var(--v2-text-secondary); font-style: italic;\">${_t('labelNoFileSelected')}</span>\n                            </div>\n                        </div>\n\n                        <!-- Legacy Status Mirror -->\n                        <div id=\"v2-rehearsal-status\" style=\"margin-top: 1rem; font-weight: 500;\"></div>\n\n                        <!-- Table Mirror -->\n                        <div style=\"margin-top: 1.5rem; border: 1px solid var(--v2-border-default); border-radius: var(--v2-radius-md); overflow: hidden;\">\n                            <table class=\"v2-table\" style=\"width: 100%;\">\n                                <thead style=\"background: var(--v2-surface-muted);\">\n                                    <tr>\n                                        <th style=\"padding: 0.75rem; text-align: left;\">${_t('tableHeaderData')}</th>\n                                        <th style=\"padding: 0.75rem; text-align: left;\">${_t('tableHeaderDifference')}</th>\n                                    </tr>\n                                </thead>\n                                <tbody id=\"v2-rehearsal-table-body\">\n                                    <!-- Mirrored rows will go here -->\n                                    <tr><td colspan=\"2\" style=\"padding: 1rem; text-align: center; color: var(--v2-text-muted);\">Load a file to compare...</td></tr>\n                                </tbody>\n                            </table>\n                        </div>\n\n                        <div class=\"v2-modal-footer\" style=\"margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem;\">\n                            <!-- Abort is effectively Close, triggers restoreRehearsalAbort -->\n                            <button class=\"v2-btn v2-btn-secondary\" id=\"v2-rehearsal-abort-btn\">Abort Rehearsal</button>\n                            <button class=\"v2-btn v2-btn-primary\" id=\"v2-rehearsal-proceed-btn\">Resume Restore</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n        },\n\n        attachListeners() {\n            // Tab Switching\n            const tabs = this.container.querySelectorAll('.v2-tab-btn');\n            const panels = this.container.querySelectorAll('.v2-settings-panel');\n\n            tabs.forEach(tab => {\n                tab.addEventListener('click', () => {\n                    // Deactivate all\n                    tabs.forEach(t => {\n                        t.classList.remove('active');\n                        t.setAttribute('aria-selected', 'false');\n                    });\n                    panels.forEach(p => p.hidden = true);\n\n                    // Activate clicked\n                    tab.classList.add('active');\n                    tab.setAttribute('aria-selected', 'true');\n                    const targetId = `v2-panel-${tab.dataset.tab}`;\n                    const target = document.getElementById(targetId);\n                    if (target) target.hidden = false;\n                });\n            });\n\n            // Sync Logic for Map Items\n            SETTINGS_MAP.forEach(item => {\n                const v2El = document.getElementById(item.v2);\n                if (!v2El) return; // Element not found (e.g. might be in a hidden modal not yet rendered, or just missing)\n\n                const legacyEl = document.getElementById(item.legacy);\n                if (!legacyEl) {\n                    console.warn(`[SettingsView] Legacy element '${item.legacy}' not found.`);\n                    return;\n                }\n\n                v2El.addEventListener('change', (e) => {\n                    if (item.type === 'checkbox') {\n                        legacyEl.checked = e.target.checked;\n                    } else {\n                        legacyEl.value = e.target.value;\n                    }\n\n                    // Trigger events on legacy element\n                    legacyEl.dispatchEvent(new Event('change', { bubbles: true }));\n                    legacyEl.dispatchEvent(new Event('input', { bubbles: true }));\n\n                    // Trigger Save for specific elements that require application via applySettingsAndCloseDialog\n                    const SAVE_REQUIRED_IDS = [\n                        'settingsLanguage',\n                        'settingsTemperatureUnit',\n                        'settingsFocusScale',\n                        'settingsFontSize',\n                        'settingsFontFamily',\n                        'mountVoltageVHigh', 'mountVoltageVLow',\n                        'mountVoltageGoldHigh', 'mountVoltageGoldLow',\n                        'mountVoltageBHigh', 'mountVoltageBLow'\n                    ];\n\n                    if (SAVE_REQUIRED_IDS.includes(item.legacy)) {\n                        const saveBtn = document.getElementById('settingsSave');\n                        if (saveBtn) saveBtn.click();\n                    }\n                });\n            });\n\n            // Special handling for Logo Upload (File Input)\n            const legacyLogo = document.getElementById('settingsLogo');\n            if (legacyLogo) {\n                legacyLogo.addEventListener('change', () => {\n                    const saveBtn = document.getElementById('settingsSave');\n                    if (saveBtn) saveBtn.click();\n                });\n            }\n\n            // Button Actions (Proxy to Legacy)\n            const bindClick = (v2Id, legacyId) => {\n                const v2Btn = document.getElementById(v2Id);\n                const legacyBtn = document.getElementById(legacyId);\n                if (v2Btn && legacyBtn) {\n                    v2Btn.addEventListener('click', () => legacyBtn.click());\n                }\n            };\n\n            bindClick('v2-btn-reset-accent', 'accentColorReset');\n            bindClick('v2-btn-reset-voltages', 'mountVoltageReset');\n            bindClick('v2-btn-backup', 'backupSettings');\n            bindClick('v2-btn-restore', 'restoreSettings');\n            bindClick('v2-btn-factory-reset', 'factoryResetButton');\n            bindClick('v2-btn-data-backup', 'storageBackupNow');\n            bindClick('v2-btn-storage-persist', 'storagePersistenceRequest');\n            bindClick('v2-btn-export-log', 'loggingExportBtn');\n            bindClick('v2-btn-support', 'supportLink');\n            bindClick('v2-btn-bug', 'reportBugLink');\n            bindClick('v2-btn-feature', 'suggestFeatureLink');\n            bindClick('v2-btn-local-font', 'localFontsButton');\n            bindClick('v2-btn-branding-upload', 'settingsLogo');\n            bindClick('v2-btn-doc-tracker-add', 'documentationTrackerAddRelease');\n\n            // Backup Diff Button\n            const diffBtn = document.getElementById('v2-btn-backup-diff');\n            if (diffBtn) {\n                diffBtn.addEventListener('click', () => {\n                    // 1. Open Modal\n                    const modal = document.getElementById('v2-backup-diff-modal');\n                    if (modal) modal.style.display = 'flex';\n                    // 2. Trigger Legacy Toggle to ensure hidden sections are initialized if needed\n                    const legBtn = document.getElementById('backupDiffToggleButton');\n                    if (legBtn) legBtn.click();\n                });\n            }\n\n            // Close Diff Modal\n            const closeDiffBtns = this.container.querySelectorAll('[data-action=\"close-diff\"]');\n            closeDiffBtns.forEach(btn => {\n                btn.addEventListener('click', () => {\n                    const modal = document.getElementById('v2-backup-diff-modal');\n                    if (modal) modal.style.display = 'none';\n                    // Trigger legacy toggle close (optional, to keep state synced)\n                    const legBtn = document.getElementById('backupDiffToggleButton');\n                    if (legBtn) legBtn.click();\n                });\n            });\n\n            // Restore Rehearsal Modal\n            const rehearsalTrigger = document.getElementById('v2-btn-restore-rehearsal');\n            const rehearsalModal = document.getElementById('v2-rehearsal-modal');\n            const closeRehearsalBtns = this.container.querySelectorAll('[data-action=\"close-rehearsal\"]');\n\n            if (rehearsalTrigger && rehearsalModal) {\n                rehearsalTrigger.addEventListener('click', () => {\n                    // Click legacy button to init logic\n                    const legacyBtn = document.getElementById('restoreRehearsalButton');\n                    if (legacyBtn) legacyBtn.click();\n\n                    rehearsalModal.style.display = 'flex';\n                });\n            }\n\n            closeRehearsalBtns.forEach(btn => {\n                btn.addEventListener('click', () => {\n                    if (rehearsalModal) rehearsalModal.style.display = 'none';\n                    const legacyClose = document.getElementById('restoreRehearsalClose');\n                    if (legacyClose) legacyClose.click();\n                });\n            });\n        },\n\n        syncFromLegacy() {\n            SETTINGS_MAP.forEach(item => {\n                const v2El = document.getElementById(item.v2);\n                const legacyEl = document.getElementById(item.legacy);\n\n                if (v2El && legacyEl) {\n                    if (item.type === 'checkbox') {\n                        v2El.checked = legacyEl.checked;\n                    } else if (item.type === 'value' || item.type === 'color') {\n                        v2El.value = legacyEl.value;\n                    }\n                }\n            });\n        },\n\n        initStatusObservers() {\n            const obsConfigs = [\n                { legacyId: 'storageStatusLastProjectValue', v2Id: 'v2-status-last-project' },\n                { legacyId: 'storageStatusLastAutoBackupValue', v2Id: 'v2-status-last-auto' },\n                { legacyId: 'storageStatusLastFullBackupValue', v2Id: 'v2-status-last-full' },\n                { legacyId: 'storagePersistenceStatus', v2Id: 'v2-status-persistence' }\n            ];\n\n            const observer = new MutationObserver(() => {\n                obsConfigs.forEach(cfg => {\n                    const leg = document.getElementById(cfg.legacyId);\n                    const v2 = document.getElementById(cfg.v2Id);\n                    if (leg && v2) {\n                        v2.textContent = leg.textContent;\n                    }\n                });\n            });\n\n            obsConfigs.forEach(cfg => {\n                const leg = document.getElementById(cfg.legacyId);\n                if (leg) {\n                    observer.observe(leg, { childList: true, characterData: true, subtree: true });\n                    const v2 = document.getElementById(cfg.v2Id);\n                    if (v2) v2.textContent = leg.textContent;\n                }\n            });\n\n            // Branding & Doc Tracker\n            const extraObsConfigs = [\n                { legacyId: 'localFontsStatus', v2Id: 'v2-status-local-font' }\n            ];\n            const extraObserver = new MutationObserver(() => {\n                extraObsConfigs.forEach(cfg => {\n                    const leg = document.getElementById(cfg.legacyId);\n                    const v2 = document.getElementById(cfg.v2Id);\n                    if (leg && v2) v2.textContent = leg.textContent;\n                });\n            });\n            extraObsConfigs.forEach(cfg => {\n                const leg = document.getElementById(cfg.legacyId);\n                if (leg) extraObserver.observe(leg, { childList: true, characterData: true, subtree: true });\n            });\n\n            // Branding Preview\n            const legacyLogoPreview = document.getElementById('settingsLogoPreview');\n            const v2LogoPreview = document.getElementById('v2-branding-preview');\n            if (legacyLogoPreview && v2LogoPreview) {\n                const logoObs = new MutationObserver(() => {\n                    if (legacyLogoPreview.hidden || legacyLogoPreview.innerHTML.trim() === '') {\n                        v2LogoPreview.innerHTML = '<span style=\"color: var(--v2-text-muted);\">No custom logo set</span>';\n                    } else {\n                        v2LogoPreview.innerHTML = legacyLogoPreview.innerHTML;\n                        const img = v2LogoPreview.querySelector('img, svg');\n                        if (img) {\n                            img.style.maxWidth = '100%';\n                            img.style.height = 'auto';\n                        }\n                    }\n                });\n                logoObs.observe(legacyLogoPreview, { childList: true, attributes: true, subtree: true });\n                if (!legacyLogoPreview.hidden && legacyLogoPreview.innerHTML.trim() !== '') {\n                    v2LogoPreview.innerHTML = legacyLogoPreview.innerHTML;\n                }\n            }\n\n            // Doc Tracker\n            const legacyDocList = document.getElementById('documentationTrackerList');\n            const v2DocList = document.getElementById('v2-doc-tracker-list');\n            if (legacyDocList && v2DocList) {\n                const docObs = new MutationObserver(() => {\n                    if (legacyDocList.children.length === 0) {\n                        v2DocList.innerHTML = '<p style=\"padding: 1rem; color: var(--v2-text-muted); text-align: center;\">No releases tracked.</p>';\n                    } else {\n                        v2DocList.innerHTML = '';\n                        Array.from(legacyDocList.children).forEach(item => {\n                            const clone = item.cloneNode(true);\n                            clone.style.padding = '0.5rem';\n                            clone.style.borderBottom = '1px solid var(--v2-border-subtle)';\n                            v2DocList.appendChild(clone);\n                        });\n                    }\n                });\n                docObs.observe(legacyDocList, { childList: true, subtree: true });\n            }\n        },\n\n        initTabs() {\n            const activeTab = this.container.querySelector('.v2-tab-btn.active');\n            if (activeTab) {\n                const targetId = `v2-panel-${activeTab.dataset.tab}`;\n                const targetPanel = document.getElementById(targetId);\n                if (targetPanel) targetPanel.hidden = false;\n            }\n        },\n\n        initRehearsalSync() {\n            const v2Radios = document.querySelectorAll('input[name=\"v2RehearsalMode\"]');\n            const legacyRadios = document.getElementsByName('restoreRehearsalMode');\n\n            v2Radios.forEach(v2Radio => {\n                v2Radio.addEventListener('change', () => {\n                    legacyRadios.forEach(legRadio => {\n                        if (legRadio.value === v2Radio.value) {\n                            legRadio.checked = true;\n                            legRadio.dispatchEvent(new Event('change', { bubbles: true }));\n                        }\n                    });\n                });\n            });\n\n            const browseBtn = document.getElementById('v2-rehearsal-browse-btn');\n            const legacyBrowse = document.getElementById('restoreRehearsalBrowse');\n            if (browseBtn && legacyBrowse) {\n                browseBtn.addEventListener('click', () => legacyBrowse.click());\n            }\n\n            const proceedBtn = document.getElementById('v2-rehearsal-proceed-btn');\n            const abortBtn = document.getElementById('v2-rehearsal-abort-btn');\n\n            if (proceedBtn) {\n                proceedBtn.addEventListener('click', () => {\n                    // FIXED ID: restoreRehearsalProceed (not Button)\n                    const legProceed = document.getElementById('restoreRehearsalProceed');\n                    if (legProceed) legProceed.click();\n                    document.getElementById('v2-rehearsal-modal').style.display = 'none';\n                });\n            }\n            if (abortBtn) {\n                abortBtn.addEventListener('click', () => {\n                    // FIXED ID: restoreRehearsalAbort (not Button)\n                    const legAbort = document.getElementById('restoreRehearsalAbort');\n                    if (legAbort) legAbort.click();\n                });\n            }\n\n            // Sync Table\n            const legacyTableBody = document.getElementById('restoreRehearsalTableBody');\n            const v2TableBody = document.getElementById('v2-rehearsal-table-body');\n            const legacyFilename = document.getElementById('restoreRehearsalFileName');\n            const v2Filename = document.getElementById('v2-rehearsal-filename');\n            const legacyProceedBtn = document.getElementById('restoreRehearsalProceed');\n\n            if (legacyTableBody && v2TableBody) {\n                const observer = new MutationObserver(() => {\n                    v2TableBody.innerHTML = '';\n                    Array.from(legacyTableBody.children).forEach(row => {\n                        const cells = row.querySelectorAll('td');\n                        if (cells.length >= 4) {\n                            const metric = cells[0].textContent;\n                            const diff = cells[3].innerHTML;\n                            const newRow = document.createElement('tr');\n                            newRow.innerHTML = `\n                            <td style=\"padding: 0.75rem;\"><strong>${metric}</strong></td>\n                            <td style=\"padding: 0.75rem;\">${diff}</td>\n                        `;\n                            v2TableBody.appendChild(newRow);\n                        }\n                    });\n\n                    if (proceedBtn && legacyProceedBtn) {\n                        proceedBtn.disabled = legacyProceedBtn.disabled;\n                        if (legacyProceedBtn.style.display === 'none') {\n                            proceedBtn.style.display = 'none';\n                        } else {\n                            proceedBtn.style.display = 'inline-block';\n                        }\n                    }\n                });\n\n                observer.observe(legacyTableBody, { childList: true, subtree: true });\n\n                if (legacyProceedBtn) {\n                    const btnObserver = new MutationObserver(() => {\n                        if (proceedBtn) {\n                            proceedBtn.disabled = legacyProceedBtn.disabled;\n                            if (legacyProceedBtn.style.display === 'none') {\n                                proceedBtn.style.display = 'none';\n                            } else {\n                                proceedBtn.style.display = 'inline-block';\n                            }\n                        }\n                    });\n                    btnObserver.observe(legacyProceedBtn, { attributes: true });\n\n                    // Initial Sync\n                    if (proceedBtn) {\n                        proceedBtn.disabled = legacyProceedBtn.disabled;\n                        if (legacyProceedBtn.style.display === 'none') {\n                            proceedBtn.style.display = 'none';\n                        } else {\n                            proceedBtn.style.display = 'inline-block';\n                        }\n                    }\n                }\n            }\n\n            if (legacyFilename && v2Filename) {\n                const observer = new MutationObserver(() => {\n                    v2Filename.textContent = legacyFilename.textContent;\n                });\n                observer.observe(legacyFilename, { childList: true, characterData: true, subtree: true });\n            }\n        },\n\n        initBackupDiffSync() {\n            // Dropdowns\n            const v2Primary = document.getElementById('v2-diff-primary');\n            const v2Secondary = document.getElementById('v2-diff-secondary');\n            const legPrimary = document.getElementById('backupDiffPrimary');\n            const legSecondary = document.getElementById('backupDiffSecondary');\n\n            const syncSelects = () => {\n                if (v2Primary && legPrimary) {\n                    v2Primary.innerHTML = legPrimary.innerHTML;\n                    v2Primary.value = legPrimary.value;\n                }\n                if (v2Secondary && legSecondary) {\n                    v2Secondary.innerHTML = legSecondary.innerHTML;\n                    v2Secondary.value = legSecondary.value;\n                }\n            };\n\n            // Initial sync\n            syncSelects();\n\n            // Observe dropdowns\n            if (legPrimary && legSecondary) {\n                const obs = new MutationObserver(syncSelects);\n                obs.observe(legPrimary, { childList: true });\n                obs.observe(legSecondary, { childList: true });\n            }\n\n            // Bind V2 change to Legacy\n            if (v2Primary) {\n                v2Primary.addEventListener('change', () => {\n                    if (legPrimary) {\n                        legPrimary.value = v2Primary.value;\n                        legPrimary.dispatchEvent(new Event('change', { bubbles: true }));\n                    }\n                });\n            }\n            if (v2Secondary) {\n                v2Secondary.addEventListener('change', () => {\n                    if (legSecondary) {\n                        legSecondary.value = v2Secondary.value;\n                        legSecondary.dispatchEvent(new Event('change', { bubbles: true }));\n                    }\n                });\n            }\n\n            // Sync Summary & List\n            const legSummary = document.getElementById('backupDiffSummary');\n            const v2Summary = document.getElementById('v2-diff-summary');\n            if (legSummary && v2Summary) {\n                const obs = new MutationObserver(() => { v2Summary.innerHTML = legSummary.innerHTML; });\n                obs.observe(legSummary, { childList: true, subtree: true });\n            }\n\n            const legList = document.getElementById('backupDiffList');\n            const v2List = document.getElementById('v2-diff-list');\n            if (legList && v2List) {\n                const obs = new MutationObserver(() => {\n                    v2List.innerHTML = legList.innerHTML;\n                    // Adjust styles if needed\n                    Array.from(v2List.querySelectorAll('li')).forEach(li => {\n                        li.style.padding = '0.5rem';\n                        li.style.borderBottom = '1px solid var(--v2-border-subtle)';\n                    });\n                });\n                obs.observe(legList, { childList: true, subtree: true });\n            }\n\n            // Bind Export\n            const v2Export = document.getElementById('v2-btn-diff-export');\n            const legExport = document.getElementById('backupDiffExport');\n            if (v2Export && legExport) {\n                v2Export.addEventListener('click', () => legExport.click());\n            }\n\n            // Sync Notes\n            const v2Notes = document.getElementById('v2-diff-notes');\n            const legNotes = document.getElementById('backupDiffNotes');\n            if (v2Notes && legNotes) {\n                // Initial\n                v2Notes.value = legNotes.value;\n\n                // Bind V2 -> Legacy\n                v2Notes.addEventListener('input', () => {\n                    legNotes.value = v2Notes.value;\n                    legNotes.dispatchEvent(new Event('input', { bubbles: true }));\n                });\n\n                // Bind Legacy -> V2 (if changed by reset)\n                const obs = new MutationObserver(() => {\n                    if (document.activeElement !== v2Notes) {\n                        v2Notes.value = legNotes.value;\n                    }\n                });\n                obs.observe(legNotes, { attributes: true, attributeFilter: ['value'] }); // Note: value attribute only updates if set via setAttribute, rarely used for textareas. Logic reliance on input events is safer.\n\n                // Fallback polling or event listener on legacy if needed, but usually Notes are one-way user input.\n                legNotes.addEventListener('input', () => {\n                    if (document.activeElement !== v2Notes) {\n                        v2Notes.value = legNotes.value;\n                    }\n                });\n            }\n        },\n\n        initLogViewerSync() {\n            // Sync Log List\n            const legList = document.getElementById('loggingHistory');\n            const v2List = document.getElementById('v2-log-history-list');\n\n            if (legList && v2List) {\n                const obs = new MutationObserver(() => {\n                    v2List.innerHTML = legList.innerHTML;\n                    // Style adjustments for V2 monospace look\n                    Array.from(v2List.querySelectorAll('li')).forEach(li => {\n                        li.style.padding = '0.25rem 0';\n                        li.style.borderBottom = '1px dashed var(--v2-border-subtle)';\n                    });\n                });\n                obs.observe(legList, { childList: true, subtree: true });\n                // Initial\n                v2List.innerHTML = legList.innerHTML;\n            }\n        }\n    };\n\n    // Export to global for bootstrap\n    if (typeof window !== 'undefined') {\n        window.cineSettingsView = SettingsView;\n    }\n\n})(typeof window !== 'undefined' ? window : this);\n","/**\n * Cine Power Planner V2 - Owned Gear View\n * =======================================\n * Manages the \"Owned Gear\" view in the V2 UI.\n */\n\n(function (global) {\n    'use strict';\n\n    // =====================\n    // CONFIGURATION\n    // =====================\n    const VIEW_ID = 'view-own-gear';\n\n    // =====================\n    // STATE\n    // =====================\n    let isInitialized = false;\n\n    // =====================\n    // HELPER: ESCAPE HTML\n    // =====================\n    function escapeHtml(str) {\n        if (typeof str !== 'string') return '';\n        return str.replace(/&/g, '&amp;')\n            .replace(/</g, '&lt;')\n            .replace(/>/g, '&gt;')\n            .replace(/\"/g, '&quot;')\n            .replace(/'/g, '&#039;');\n    }\n\n    function _t(key) {\n        if (typeof window !== 'undefined' && window.texts) {\n            const langSelect = document.getElementById('languageSelect');\n            const lang = (langSelect && langSelect.value) ||\n                (typeof window.currentLanguage === 'string' && window.currentLanguage) ||\n                'en';\n\n            const dict = window.texts[lang] || window.texts['en'];\n\n            if (dict) {\n                return key.split('.').reduce((o, i) => (o ? o[i] : null), dict) || key;\n            }\n        }\n        return key;\n    }\n\n    // =====================\n    // PUBLIC API\n    // =====================\n    const OwnGearView = {\n        container: null,\n\n        init() {\n            try {\n                this.container = document.getElementById(VIEW_ID);\n                if (!this.container) {\n                    // Try to create it if it doesn't exist\n                    this.createViewContainer();\n                }\n\n                if (!isInitialized) {\n                    console.log('[OwnGearView] Initializing...');\n                    document.addEventListener('v2:viewchange', (e) => {\n                        if (e.detail && e.detail.view === 'ownGear') {\n                            this.render();\n                        }\n                    });\n\n                    // Listen for language changes\n                    document.addEventListener('v2:languagechange', () => {\n                        if (this.isVisible()) this.render();\n                    });\n\n                    isInitialized = true;\n                    console.log('[OwnGearView] Initialized');\n                }\n            } catch (e) {\n                console.error('[OwnGearView] Init failed:', e);\n            }\n        },\n\n        isVisible() {\n            // Check if container is part of DOM and active\n            return this.container && !this.container.classList.contains('hidden') && this.container.style.display !== 'none';\n        },\n\n        createViewContainer() {\n            const container = document.querySelector('.v2-main') || document.querySelector('.v2-app') || document.body;\n            const view = document.createElement('section'); // Semantic HTML\n            view.id = VIEW_ID;\n            view.className = 'app-view';\n\n            // Should be hidden by default until activated\n            // CSS handles .app-view:not(.active) { display: none }\n\n            container.appendChild(view);\n            this.container = view;\n        },\n\n        render() {\n            try {\n                if (!this.container) {\n                    this.init();\n                    if (!this.container) return; // Still not there? Bail.\n                }\n\n                // Load items using the legacy store\n                // We'll use the cineFeaturesOwnGear global which exposes the API directly\n                const features = global.cineFeaturesOwnGear;\n\n                if (!features) {\n                    this.container.innerHTML = `\n                        <div class=\"v2-empty-state\">\n                            <p>${_t('statusUnavailable') || 'Module not available'}</p>\n                        </div>\n                    `;\n                    return;\n                }\n\n                const items = features.loadStoredOwnGearItems();\n\n                const header = `\n                    <header class=\"view-header\">\n                        <div class=\"header-content\">\n                            <h1>${_t('ownGearViewTitle')}</h1>\n                            <p class=\"header-subtitle\">${_t('ownGearViewSubtitle')}</p>\n                        </div>\n                        <div class=\"view-header-actions\">\n                            <button class=\"v2-btn v2-btn-primary\" id=\"btn-add-own-gear\">\n                                <span class=\"icon\">add</span>\n                                <span>${_t('buttonAddGearItem')}</span>\n                            </button>\n                        </div>\n                    </header>\n                `;\n\n                let contentHtml = '<div class=\"view-content\">';\n\n                if (!items || items.length === 0) {\n                    contentHtml += `\n                        <div class=\"own-gear-empty-state\">\n                            <span class=\"icon\">inventory_2</span>\n                            <h3>${_t('ownGearEmptyTitle')}</h3>\n                            <p>${_t('ownGearEmptyText')}</p>\n                            <button class=\"v2-btn v2-btn-primary\" id=\"btn-add-own-gear-empty\">\n                                ${_t('buttonAddFirstGearItem')}\n                            </button>\n                        </div>\n                    `;\n                } else {\n                    contentHtml += '<div class=\"own-gear-list\">';\n                    items.forEach(item => {\n                        contentHtml += this.renderItemRow(item);\n                    });\n                    contentHtml += '</div>';\n                }\n\n                contentHtml += '</div>'; // End view-content\n\n                this.container.innerHTML = header + contentHtml;\n                this.attachListeners();\n\n            } catch (err) {\n                console.error('[OwnGearView] Render failed', err);\n                if (this.container) {\n                    this.container.innerHTML = `<div class=\"v2-error-state\"><p>Error loading view: ${err.message}</p></div>`;\n                }\n            }\n        },\n\n        renderItemRow(item) {\n            return `\n                <div class=\"own-gear-item-card\" data-item-id=\"${escapeHtml(item.id)}\">\n                    <div class=\"own-gear-item-info\">\n                        <div class=\"own-gear-item-name\">${escapeHtml(item.name)}</div>\n                        ${item.notes ? `<div class=\"own-gear-item-notes\">${escapeHtml(item.notes)}</div>` : ''}\n                    </div>\n                     <div class=\"own-gear-item-meta\">\n                        ${item.quantity ? `<span class=\"own-gear-badge qty-badge\">${_t('labelQtyPrefix')}${escapeHtml(item.quantity)}</span>` : ''}\n                        ${item.source ? `<span class=\"own-gear-badge source-badge\">${_t('labelSourcePrefix')}${escapeHtml(item.source)}</span>` : ''}\n                    </div>\n                    <div class=\"own-gear-item-actions\">\n                        <button class=\"v2-btn v2-btn-icon v2-btn-ghost btn-edit-own-gear\" title=\"${_t('buttonEdit')}\" data-id=\"${escapeHtml(item.id)}\">\n                            <span class=\"icon\">edit</span>\n                        </button>\n                        <button class=\"v2-btn v2-btn-icon v2-btn-ghost btn-delete-own-gear\" title=\"${_t('buttonDelete')}\" data-id=\"${escapeHtml(item.id)}\">\n                            <span class=\"icon\">delete</span>\n                        </button>\n                    </div>\n                </div>\n            `;\n        },\n\n        attachListeners() {\n            const addBtn = this.container.querySelector('#btn-add-own-gear');\n            const addBtnEmpty = this.container.querySelector('#btn-add-own-gear-empty');\n\n            if (addBtn) addBtn.onclick = () => this.showEditModal(null);\n            if (addBtnEmpty) addBtnEmpty.onclick = () => this.showEditModal(null);\n\n            this.container.querySelectorAll('.btn-edit-own-gear').forEach(btn => {\n                btn.onclick = (e) => {\n                    e.stopPropagation();\n                    const id = e.currentTarget.dataset.id;\n                    if (id) this.showEditModal(id);\n                };\n            });\n\n            this.container.querySelectorAll('.btn-delete-own-gear').forEach(btn => {\n                btn.onclick = (e) => {\n                    e.stopPropagation();\n                    const id = e.currentTarget.dataset.id;\n                    if (id && confirm(_t('confirmDeleteGearItem'))) {\n                        this.deleteItem(id);\n                    }\n                };\n            });\n        },\n\n        deleteItem(id) {\n            const features = global.cineFeaturesOwnGear;\n            if (!features) return;\n\n            const existing = features.loadStoredOwnGearItems();\n            const filtered = existing.filter(i => i.id !== id);\n\n            if (features.persistOwnGearItems(filtered)) {\n                this.render();\n            } else {\n                alert(_t('alertSaveItemFailed'));\n            }\n        },\n\n        showEditModal(itemId) {\n            const features = global.cineFeaturesOwnGear;\n            if (!features) return;\n\n            let item = {};\n            let isNew = true;\n\n            if (itemId) {\n                const existing = features.loadStoredOwnGearItems();\n                const found = existing.find(i => i.id === itemId);\n                if (found) {\n                    item = { ...found };\n                    isNew = false;\n                }\n            }\n\n            // Defaults\n            if (isNew) {\n                item = {\n                    name: '',\n                    quantity: '',\n                    notes: '',\n                    source: ''\n                };\n            }\n\n            // Remove existing modal if any\n            const existingModal = document.querySelector('.v2-modal-backdrop');\n            if (existingModal) existingModal.remove();\n\n            const backdrop = document.createElement('div');\n            backdrop.className = 'v2-modal-backdrop';\n\n            backdrop.innerHTML = `\n                <div class=\"v2-modal\">\n                    <div class=\"v2-modal-header\">\n                        <h3 class=\"v2-modal-title\">${isNew ? _t('modalTitleNewGearItem') : _t('modalTitleEditGearItem')}</h3>\n                        <button type=\"button\" class=\"v2-modal-close v2-btn v2-btn-ghost\"><span class=\"icon\">close</span></button>\n                    </div>\n                    <div class=\"v2-modal-body own-gear-modal-body\">\n                        \n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('labelItemName')}</label>\n                            <input type=\"text\" id=\"ownGearName\" class=\"v2-input\" value=\"${escapeHtml(item.name)}\" placeholder=\"${_t('placeholderGearName')}\" required>\n                        </div>\n\n                         <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('labelQuantity')}</label>\n                            <input type=\"number\" id=\"ownGearQuantity\" class=\"v2-input\" value=\"${escapeHtml(item.quantity)}\" placeholder=\"${_t('placeholderGearQty')}\">\n                        </div>\n\n                        <div class=\"v2-form-group\">\n                            <label class=\"v2-label\">${_t('labelNotes')}</label>\n                            <textarea id=\"ownGearNotes\" class=\"v2-input\" rows=\"3\" placeholder=\"${_t('placeholderGearNotes')}\">${escapeHtml(item.notes)}</textarea>\n                        </div>\n\n                    </div>\n                    <div class=\"v2-modal-footer\">\n                        <button type=\"button\" class=\"v2-btn v2-btn-secondary\" id=\"btn-cancel-own-gear\">${_t('buttonCancel')}</button>\n                        <button type=\"button\" class=\"v2-btn v2-btn-primary\" id=\"btn-save-own-gear\">${_t('buttonSaveGearItem')}</button>\n                    </div>\n                </div>\n            `;\n\n            document.body.appendChild(backdrop);\n            requestAnimationFrame(() => backdrop.classList.add('open'));\n\n            // --- Modal Events ---\n            const close = () => {\n                backdrop.classList.remove('open');\n                setTimeout(() => backdrop.remove(), 200);\n            };\n\n            const nameInput = backdrop.querySelector('#ownGearName');\n            nameInput.focus();\n\n            backdrop.querySelector('.v2-modal-close').onclick = close;\n            backdrop.querySelector('#btn-cancel-own-gear').onclick = close;\n\n            // Save\n            backdrop.querySelector('#btn-save-own-gear').onclick = () => {\n                const name = nameInput.value.trim();\n                if (!name) {\n                    alert(_t('alertEnterName'));\n                    return;\n                }\n\n                // Construct new object\n                const entry = {\n                    id: itemId || undefined,\n                    name: name,\n                    quantity: backdrop.querySelector('#ownGearQuantity').value.trim(),\n                    notes: backdrop.querySelector('#ownGearNotes').value.trim()\n                };\n\n                // Use features to normalize and save\n                const allItems = features.loadStoredOwnGearItems();\n\n                let finalItem;\n                if (isNew) {\n                    finalItem = features.normalizeOwnGearRecord(entry);\n                } else {\n                    finalItem = features.normalizeOwnGearRecord({ ...item, ...entry });\n                }\n\n                if (!finalItem) {\n                    alert(_t('alertInvalidItemData'));\n                    return;\n                }\n\n                let updatedList;\n                if (isNew) {\n                    updatedList = [...allItems, finalItem];\n                } else {\n                    updatedList = allItems.map(i => i.id === itemId ? finalItem : i);\n                }\n\n                if (features.persistOwnGearItems(updatedList)) {\n                    this.render();\n                    close();\n                } else {\n                    alert(_t('alertSaveItemFailed'));\n                }\n            };\n        }\n    };\n\n    global.cineOwnGearView = OwnGearView;\n\n})(typeof window !== 'undefined' ? window : this);\n","/**\n * Cine Power Planner V2 - Help Data\n * =================================\n * Content for the V2 Help Center.\n */\n\n(function (global) {\n    'use strict';\n\n    const v2HelpData = [\n        {\n            id: 'v2-welcome',\n            titleKey: 'helpV2WelcomeTitle',\n            keywordsKey: 'helpV2WelcomeKeywords',\n            iconKey: 'overview',\n            contentKey: 'helpV2WelcomeContent'\n        },\n        {\n            id: 'v2-projects',\n            titleKey: 'helpV2ProjectsTitle',\n            keywordsKey: 'helpV2ProjectsKeywords',\n            iconKey: 'load',\n            contentKey: 'helpV2ProjectsContent'\n        },\n        {\n            id: 'v2-sidebar-search',\n            titleKey: 'helpV2SidebarSearchTitle',\n            keywordsKey: 'helpV2SidebarSearchKeywords',\n            iconKey: 'distance',\n            contentKey: 'helpV2SidebarSearchContent'\n        },\n        {\n            id: 'v2-device-library',\n            titleKey: 'helpV2DeviceLibraryTitle',\n            keywordsKey: 'helpV2DeviceLibraryKeywords',\n            iconKey: 'camera',\n            contentKey: 'helpV2DeviceLibraryContent'\n        },\n        {\n            id: 'v2-contacts',\n            titleKey: 'helpV2ContactsTitle',\n            keywordsKey: 'helpV2ContactsKeywords',\n            iconKey: 'contacts',\n            contentKey: 'helpV2ContactsContent'\n        },\n        {\n            id: 'v2-settings',\n            titleKey: 'helpV2SettingsTitle',\n            keywordsKey: 'helpV2SettingsKeywords',\n            iconKey: 'settingsData',\n            contentKey: 'helpV2SettingsContent'\n        },\n        {\n            id: 'v2-save-share-backup',\n            titleKey: 'helpV2SaveShareBackupTitle',\n            keywordsKey: 'helpV2SaveShareBackupKeywords',\n            iconKey: 'settingsBackup',\n            contentKey: 'helpV2SaveShareBackupContent'\n        },\n        {\n            id: 'v2-auto-gear',\n            titleKey: 'helpV2AutoGearTitle',\n            keywordsKey: 'helpV2AutoGearKeywords',\n            iconKey: 'settingsAutoGear',\n            contentKey: 'helpV2AutoGearContent'\n        },\n        {\n            id: 'v2-print-export',\n            titleKey: 'helpV2PrintExportTitle',\n            keywordsKey: 'helpV2PrintExportKeywords',\n            iconKey: 'fileExport',\n            contentKey: 'helpV2PrintExportContent'\n        }\n    ];\n\n    // Migrated Legacy Topics\n    const migratedTopics = [\n        {\n            id: 'v2-quick-start',\n            titleKey: 'helpV2QuickStartTitle',\n            keywordsKey: 'helpV2QuickStartKeywords',\n            iconKey: 'check',\n            contentKey: 'helpV2QuickStartContent'\n        },\n        {\n            id: 'v2-data-safety',\n            titleKey: 'helpV2DataSafetyTitle',\n            keywordsKey: 'helpV2DataSafetyKeywords',\n            iconKey: 'settingsBackup',\n            contentKey: 'helpV2DataSafetyContent'\n        },\n        {\n            id: 'v2-shortcuts',\n            titleKey: 'helpV2ShortcutsTitle',\n            keywordsKey: 'helpV2ShortcutsKeywords',\n            iconKey: 'resetView',\n            contentKey: 'helpV2ShortcutsContent'\n        },\n        {\n            id: 'v2-features',\n            titleKey: 'helpV2FeaturesTitle',\n            keywordsKey: 'helpV2FeaturesKeywords',\n            iconKey: 'gearList',\n            contentKey: 'helpV2FeaturesContent'\n        }\n    ];\n\n    // Combine\n    v2HelpData.push(...migratedTopics);\n\n    // Expose\n    global.cineV2HelpData = v2HelpData;\n\n})(typeof window !== 'undefined' ? window : this);\n","/**\n * Cine Power Planner V2 - Help Service\n * ====================================\n * Single source of truth for help content, merging V2 guides and V1 reference topics.\n */\n\n(function (global) {\n    'use strict';\n\n    // V2 \"Getting Started\" Content (Hardcoded for now, could be moved to localization later)\n    // V2 Content (Loaded from help-data.js)\n    const V2_TOPICS = global.cineV2HelpData || [];\n    const DEFAULT_HELP_ICON = 'overview';\n    // Map help topics to local Uicon glyph keys for consistent iconography.\n    const HELP_ICON_KEYS = {\n        projectManagement: 'load',\n        saveShareBackup: 'settingsBackup',\n        deviceConfiguration: 'camera',\n        powerCalculation: 'batteryBolt',\n        connectionDiagram: 'plug',\n        gearList: 'gearList',\n        contacts: 'contacts',\n        ownGear: 'camera',\n        settings: 'settingsGeneral',\n        offlineUse: 'wifi',\n        troubleshooting: 'feedback',\n        shortcuts: 'resetView',\n        pinkMode: 'sun'\n    };\n\n    function getTranslations() {\n        if (!global.texts) return null;\n        const lang =\n            global.currentLanguage ||\n            global.currentLang ||\n            global.document?.documentElement?.lang ||\n            'en';\n        return global.texts[lang] || global.texts.en || null;\n    }\n\n    function translate(key) {\n        const translations = getTranslations();\n        if (!translations) return key;\n        return translations[key] || key;\n    }\n\n    function resolveHelpIcon(iconKey) {\n        const iconSet = global.ICON_GLYPHS;\n        if (iconSet && iconKey && iconSet[iconKey]) {\n            return iconSet[iconKey];\n        }\n        if (iconSet && iconSet[DEFAULT_HELP_ICON]) {\n            return iconSet[DEFAULT_HELP_ICON];\n        }\n        return null;\n    }\n\n    function normalizeV2Topic(topic) {\n        const title = topic.titleKey ? translate(topic.titleKey) : topic.title;\n        const keywords = topic.keywordsKey ? translate(topic.keywordsKey) : topic.keywords;\n        const content = topic.contentKey ? translate(topic.contentKey) : topic.content;\n        return {\n            ...topic,\n            title,\n            keywords,\n            content,\n            icon: resolveHelpIcon(topic.iconKey || topic.icon || DEFAULT_HELP_ICON)\n        };\n    }\n\n    // Helper to categorize topics\n    function getCategorizedV2Topics() {\n        const essentials = ['v2-quick-start', 'v2-shortcuts', 'v2-data-safety', 'v2-features'];\n\n        const v2Topics = V2_TOPICS.map(normalizeV2Topic);\n        return {\n            essentials: v2Topics.filter(t => essentials.includes(t.id)),\n            guides: v2Topics.filter(t => !essentials.includes(t.id))\n        };\n    }\n\n    /**\n     * Parse simple Markdown-like syntax from translation strings into HTML\n     */\n    function parseMarkdown(text) {\n        if (!text) return '';\n        // Basic inline formatting\n        let html = text\n            .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n            .replace(/\\*(.*?)\\*/g, '<em>$1</em>')\n            .replace(/`(.*?)`/g, '<code>$1</code>');\n\n        // Split by double newlines to handle paragraphs and lists\n        return html.split(/\\n\\n+/).map(block => {\n            if (block.trim().startsWith('- ')) {\n                const items = block.trim().split(/\\n/).map(line => {\n                    return `<li>${line.replace(/^- /, '')}</li>`;\n                }).join('');\n                return `<ul>${items}</ul>`;\n            }\n            return `<p>${block}</p>`;\n        }).join('');\n    }\n\n    /**\n     * Get V1 help topics from localization system\n     */\n    function getV1Topics() {\n        // Try to access the localization helper globally\n        // It might be 'cineCoreLocalization' or a similar exposure\n        let localization = global.cineCoreLocalization ||\n            global.cineCoreLocalizationBridge || // Agent: Added bridge check\n            (global.cineModuleBase && global.cineModuleBase.resolveLocalization && global.cineModuleBase.resolveLocalization());\n\n        if (!localization || typeof localization.getString !== 'function') {\n            // Fallback 1: global.getText\n            if (typeof global.getText === 'function') {\n                localization = {\n                    getString: (key) => global.getText(key)\n                };\n            }\n            // Fallback 2: global.texts (Direct access)\n            else if (global.texts) {\n                // Helper to resolve dot notation\n                const resolveKey = (obj, path) => {\n                    return path.split('.').reduce((prev, curr) => prev && prev[curr], obj);\n                };\n\n                const lang = global.currentLanguage || global.currentLang || 'en';\n                const texts = global.texts[lang] || global.texts.en;\n\n                localization = {\n                    getString: (key) => resolveKey(texts, key) || ''\n                };\n            }\n            else {\n                console.warn('[HelpService] Localization module not found. V1 topics unavailable.');\n                return [];\n            }\n        }\n\n        const topicOrder = [\n            'projectManagement',\n            'saveShareBackup',\n            'deviceConfiguration',\n            'powerCalculation',\n            'connectionDiagram',\n            'gearList',\n            'contacts',\n            'ownGear',\n            'settings',\n            'offlineUse',\n            'troubleshooting',\n            'shortcuts',\n            'pinkMode'\n        ];\n\n        const lang = global.currentLanguage || global.currentLang || global.document?.documentElement?.lang || 'en';\n        const localizedTexts = global.texts && (global.texts[lang] || global.texts.en);\n        const localizedHelpTopics = localizedTexts && localizedTexts.helpTopics;\n        const availableKeys = localizedHelpTopics && typeof localizedHelpTopics === 'object'\n            ? Object.keys(localizedHelpTopics)\n            : [];\n        const orderedKeys = availableKeys.length\n            ? [\n                ...topicOrder.filter(key => availableKeys.includes(key)),\n                ...availableKeys.filter(key => !topicOrder.includes(key))\n            ]\n            : topicOrder;\n\n        return orderedKeys.map(key => {\n            const localizedTopic = localizedHelpTopics && localizedHelpTopics[key];\n            const title = (localizedTopic && localizedTopic.title) || localization.getString(`helpTopics.${key}.title`);\n            const content = (localizedTopic && localizedTopic.content) || localization.getString(`helpTopics.${key}.content`);\n\n            if (!title) return null;\n\n            return {\n                id: `v1-${key}`,\n                category: 'reference',\n                title: title,\n                // Keywords could be enriched here if we had a mapping, for now title + content is search source\n                keywords: title,\n                icon: resolveHelpIcon(HELP_ICON_KEYS[key] || DEFAULT_HELP_ICON),\n                content: parseMarkdown(content)\n            };\n        }).filter(item => item !== null);\n    }\n\n    /**\n     * Get all help sections, organized or flat\n     */\n    function getAllSections() {\n        const guideTopics = V2_TOPICS.map(normalizeV2Topic);\n        const refTopics = getV1Topics();\n\n        return [\n            ...guideTopics,\n            ...refTopics\n        ];\n    }\n\n    /**\n     * Get sections grouped by category for sidebar\n     */\n    function getGroupedSections() {\n        const v2 = getCategorizedV2Topics();\n\n        return {\n            essentials: {\n                title: translate('helpGroupEssentials'),\n                items: v2.essentials\n            },\n            guide: {\n                title: translate('helpGroupGuides'),\n                items: v2.guides\n            },\n            reference: {\n                title: translate('helpGroupReference'),\n                items: getV1Topics()\n            }\n        };\n    }\n\n    // Public API\n    global.cineHelpService = {\n        getAllSections,\n        getGroupedSections\n    };\n\n})(typeof window !== 'undefined' ? window : this);\n","/**\n * Cine Power Planner V2 - Help View\n * =================================\n * Manages the Help Center view using the Help Service.\n */\n\n'use strict';\n\nconst TOC_ID = 'v2HelpToc';\nconst CONTENT_ID = 'v2HelpContent';\nconst SEARCH_ID = 'v2HelpSearch';\nconst SEARCH_STATUS_ID = 'v2HelpSearchStatus';\n\nlet observer = null;\nlet isInitialized = false;\nlet performSearch = null;\n\nfunction getElement(id) {\n    return document.getElementById(id);\n}\n\nfunction _t(key) {\n    if (typeof window !== 'undefined' && window.texts) {\n        const langSelect = document.getElementById('languageSelect');\n        const lang = (langSelect && langSelect.value) ||\n            (typeof window.currentLanguage === 'string' && window.currentLanguage) ||\n            'en';\n        const dict = window.texts[lang] || window.texts['en'];\n        if (dict) {\n            return dict[key] || key;\n        }\n    }\n    return key;\n}\n\nfunction formatSearchStatus(template, count, query) {\n    let message = template.replace('{count}', String(count));\n    if (query && message.indexOf('{query}') !== -1) {\n        message = message.replace('{query}', query);\n    }\n    return message;\n}\n\n// Prefer shared icon markup helpers to keep Uicon glyphs consistent across V2.\nfunction getIconMarkup(iconGlyph, className) {\n    if (!iconGlyph) return '';\n    const iconMarkup = window.iconMarkup || (window.cineIcons && window.cineIcons.iconMarkup);\n    if (typeof iconMarkup === 'function') {\n        return iconMarkup(iconGlyph, className);\n    }\n    const char = iconGlyph.char || iconGlyph;\n    if (!char) return '';\n    return `<span class=\"icon-glyph ${className || ''}\" aria-hidden=\"true\" data-icon-font=\"uicons\">${char}</span>`;\n}\n\n/**\n * Render the Help Content from Service\n */\nfunction renderContent() {\n    const target = getElement(CONTENT_ID);\n    if (!target) return [];\n\n    target.innerHTML = '';\n    const tocInfo = [];\n\n    const service = window.cineHelpService;\n    if (!service) {\n        target.innerHTML = `<div class=\"v2-empty-state\"><p>${_t('helpServiceUnavailable')}</p></div>`;\n        return [];\n    }\n\n    const grouped = service.getGroupedSections();\n\n    const categories = [\n        grouped.essentials,\n        grouped.guide,\n        grouped.reference\n    ].filter(category => category && category.items.length > 0);\n\n    categories.forEach((category, index) => {\n        renderCategory(target, category.title, category.items, tocInfo);\n\n        if (index < categories.length - 1) {\n            const divider = document.createElement('hr');\n            divider.className = 'v2-help-divider';\n            target.appendChild(divider);\n        }\n    });\n\n    // Add Empty State container for Search\n    const emptyState = document.createElement('div');\n    emptyState.id = 'v2HelpNoResults';\n    emptyState.className = 'v2-help-no-results';\n    emptyState.style.display = 'none';\n    const noResultsIcon = getIconMarkup(\n        window.ICON_GLYPHS && window.ICON_GLYPHS.distance,\n        'v2-help-no-results-icon'\n    );\n    emptyState.innerHTML = `\n        <div class=\"v2-help-no-results-content\">\n            ${noResultsIcon}\n            <h3>${_t('helpSearchNoResultsTitle')}</h3>\n            <p>${_t('helpSearchNoResultsHint')}</p>\n        </div>\n    `;\n    target.appendChild(emptyState);\n\n    return tocInfo;\n}\n\n/**\n * Helper to render a category of topics\n */\nfunction renderCategory(container, title, items, tocList) {\n    // Add Category info to TOC list for headers\n    tocList.push({ type: 'header', title: title });\n\n    items.forEach(item => {\n        const section = document.createElement('section');\n        section.className = 'v2-help-section';\n        section.id = item.id;\n        // Add keywords for search\n        section.setAttribute('data-keywords', (item.keywords || '') + ' ' + (item.title || ''));\n\n        const header = document.createElement('h2');\n        if (item.icon) {\n            header.innerHTML = getIconMarkup(item.icon, 'v2-help-icon');\n            header.appendChild(document.createTextNode(item.title || ''));\n        } else {\n            header.textContent = item.title;\n        }\n\n        const content = document.createElement('div');\n        content.className = 'v2-help-content-body';\n        content.innerHTML = item.content;\n\n        section.appendChild(header);\n        section.appendChild(content);\n        container.appendChild(section);\n\n        tocList.push({\n            type: 'item',\n            id: item.id,\n            title: item.title,\n            keywords: item.keywords,\n            icon: item.icon // Pass icon to TOC\n        });\n    });\n}\n\n/**\n * Build the Table of Contents (Supporting Categories)\n */\nfunction buildToc(tocInfo) {\n    const tocContainer = getElement(TOC_ID);\n    if (!tocContainer) return;\n\n    tocContainer.innerHTML = '';\n    const ul = document.createElement('ul');\n\n    tocInfo.forEach(item => {\n        if (item.type === 'header') {\n            const li = document.createElement('li');\n            li.className = 'v2-help-toc-header';\n            li.textContent = item.title;\n            ul.appendChild(li);\n        } else {\n            const li = document.createElement('li');\n            const link = document.createElement('a');\n            link.href = `#${item.id}`;\n            link.className = 'v2-help-toc-link';\n            link.dataset.target = item.id; // Helper for scroll spy\n            link.dataset.title = item.title || '';\n            link.dataset.keywords = item.keywords || '';\n\n            // Add icon if available\n            if (item.icon) {\n                link.innerHTML = getIconMarkup(item.icon, 'v2-toc-icon');\n                link.appendChild(document.createTextNode(item.title || ''));\n            } else {\n                link.textContent = item.title;\n            }\n\n            link.addEventListener('click', (e) => {\n                e.preventDefault();\n                const targetSection = document.getElementById(item.id);\n                if (targetSection) {\n                    targetSection.scrollIntoView({ behavior: 'smooth' });\n                    // Removed history.pushState to avoid conflicting with SPA router\n                }\n                // Manual active state set (observer will correct it shortly if needed)\n                updateActiveLink(item.id);\n            });\n\n            li.appendChild(link);\n            ul.appendChild(li);\n        }\n    });\n\n    tocContainer.appendChild(ul);\n}\n\nfunction updateActiveLink(id) {\n    document.querySelectorAll('.v2-help-toc-link').forEach(l => {\n        if (l.dataset.target === id) {\n            l.classList.add('active');\n        } else {\n            l.classList.remove('active');\n        }\n    });\n}\n\n/**\n * Initialize Scroll Spy using IntersectionObserver\n */\nfunction initScrollSpy() {\n    if (observer) observer.disconnect();\n\n    const options = {\n        root: getElement(CONTENT_ID),\n        rootMargin: '-10% 0px -80% 0px', // Trigger when section is near top\n        threshold: 0\n    };\n\n    const callback = (entries) => {\n        entries.forEach(entry => {\n            if (entry.isIntersecting) {\n                updateActiveLink(entry.target.id);\n            }\n        });\n    };\n\n    observer = new IntersectionObserver(callback, options);\n    document.querySelectorAll('.v2-help-section').forEach(section => {\n        observer.observe(section);\n    });\n}\n\n/**\n * Initialize search functionality\n */\nfunction initSearch() {\n    const searchInput = getElement(SEARCH_ID);\n    if (!searchInput) return;\n\n    const updateTocHeaderVisibility = (tocList) => {\n        if (!tocList) return;\n        let currentHeader = null;\n        let hasVisibleItems = false;\n\n        Array.from(tocList.children).forEach(item => {\n            if (item.classList.contains('v2-help-toc-header')) {\n                if (currentHeader) {\n                    currentHeader.style.display = hasVisibleItems ? 'block' : 'none';\n                }\n                currentHeader = item;\n                hasVisibleItems = false;\n            } else if (currentHeader && item.style.display !== 'none') {\n                hasVisibleItems = true;\n            }\n        });\n\n        if (currentHeader) {\n            currentHeader.style.display = hasVisibleItems ? 'block' : 'none';\n        }\n    };\n\n    // Create Clear Button\n    const clearBtn = document.createElement('button');\n    clearBtn.className = 'v2-help-search-clear';\n    clearBtn.style.display = 'none';\n    clearBtn.type = 'button';\n    clearBtn.setAttribute('aria-label', _t('helpSearchClearLabel'));\n    clearBtn.title = _t('helpSearchClearLabel');\n    clearBtn.innerHTML = getIconMarkup(\n        window.ICON_GLYPHS && window.ICON_GLYPHS.resetView,\n        'v2-help-search-clear-icon'\n    );\n\n    const liveRegion = document.createElement('div');\n    liveRegion.id = SEARCH_STATUS_ID;\n    liveRegion.className = 'visually-hidden';\n    liveRegion.setAttribute('aria-live', 'polite');\n    liveRegion.setAttribute('aria-atomic', 'true');\n    liveRegion.setAttribute('role', 'status');\n\n    // Append to container (assuming container is relative/flex)\n    searchInput.parentNode.appendChild(clearBtn);\n    searchInput.parentNode.appendChild(liveRegion);\n\n    performSearch = () => {\n        const query = searchInput.value.trim();\n        const term = query.toLowerCase();\n        const sections = document.querySelectorAll('.v2-help-section');\n        const noResults = getElement('v2HelpNoResults');\n        const tocContainer = getElement(TOC_ID);\n        const tocList = tocContainer ? tocContainer.querySelector('ul') : null;\n        let hasVisible = false;\n        let visibleCount = 0;\n\n        sections.forEach(section => {\n            const text = section.innerText.toLowerCase();\n            const keywords = (section.dataset.keywords || '').toLowerCase();\n            const match = text.includes(term) || keywords.includes(term);\n\n            section.style.display = match ? 'block' : 'none';\n            if (match) {\n                hasVisible = true;\n                visibleCount += 1;\n            }\n        });\n\n        document.querySelectorAll('.v2-help-toc-link').forEach(link => {\n            const targetSection = document.getElementById(link.dataset.target);\n            const isVisible = targetSection && targetSection.style.display !== 'none';\n            const listItem = link.parentElement;\n            if (listItem) {\n                listItem.style.display = isVisible ? 'block' : 'none';\n            }\n        });\n        updateTocHeaderVisibility(tocList);\n\n        // Toggle Dividers visibility based on search (hide if searching)\n        document.querySelectorAll('.v2-help-divider').forEach(div => {\n            div.style.display = term ? 'none' : 'block';\n        });\n\n        // Show/Hide No Results\n        if (noResults) {\n            noResults.style.display = !hasVisible && term ? 'flex' : 'none';\n        }\n\n        // Toggle Clear Button\n        clearBtn.style.display = term.length > 0 ? 'block' : 'none';\n\n        if (liveRegion) {\n            const statusTemplate = term\n                ? _t('helpSearchStatusWithQuery')\n                : _t('helpSearchStatusAll');\n            liveRegion.textContent = formatSearchStatus(statusTemplate, visibleCount, query);\n        }\n    };\n\n    searchInput.addEventListener('input', () => {\n        if (performSearch) {\n            performSearch();\n        }\n    });\n\n    clearBtn.addEventListener('click', () => {\n        searchInput.value = '';\n        if (performSearch) {\n            performSearch();\n        }\n        searchInput.focus();\n    });\n}\n\nfunction updateSearchLabels() {\n    const clearBtn = document.querySelector('.v2-help-search-clear');\n    if (!clearBtn) return;\n    const label = _t('helpSearchClearLabel');\n    clearBtn.setAttribute('aria-label', label);\n    clearBtn.title = label;\n}\n\n/**\n * Initialize the view\n */\nfunction init() {\n    if (isInitialized) return;\n\n    console.log('[HelpView] Initializing...');\n\n    if (window.cineViewManager) {\n        window.cineViewManager.registerView('help', {\n            onEnter: () => enter(),\n            onLeave: () => { }\n        });\n    }\n\n    refresh();\n    initSearch();\n    document.addEventListener('v2:languagechange', () => {\n        refresh();\n        updateSearchLabels();\n        if (performSearch) {\n            performSearch();\n        }\n    });\n\n    isInitialized = true;\n}\n\n/**\n * Refresh logic (useful for language changes)\n */\nfunction refresh() {\n    const tocInfo = renderContent();\n    if (tocInfo) {\n        buildToc(tocInfo);\n        // Re-init spy after content render\n        setTimeout(() => initScrollSpy(), 100);\n    }\n    if (performSearch) {\n        performSearch();\n    }\n}\n\n/**\n * Prepare view when entering\n */\nfunction enter() {\n    if (!isInitialized) {\n        init();\n    } else {\n        // Optional check for language update could go here\n    }\n}\n\nexport const cineHelpView = {\n    init,\n    enter,\n    refresh\n};\n\nwindow.cineHelpView = cineHelpView;\n","import { dataVault } from '../../modules/storage/DataVault.js';\nimport { storageRepo } from '../../modules/storage/StorageRepository.js';\nimport { unwrapMetadata } from '../../modules/storage/SyncMetadata.js';\n\nconst VIEW_ID = 'backups';\n\n/**\n * Resolve a localized translation string by key.\n * @param {string} key - Dot-delimited translation key.\n * @returns {string}\n */\nfunction _t(key) {\n    if (typeof window !== 'undefined' && window.texts) {\n        const langSelect = document.getElementById('languageSelect');\n        const lang = (langSelect && langSelect.value)\n            || (typeof window.currentLanguage === 'string' && window.currentLanguage)\n            || 'en';\n        const dict = window.texts[lang] || window.texts.en;\n        if (dict) {\n            return key.split('.').reduce((o, i) => (o ? o[i] : null), dict) || key;\n        }\n    }\n    return key;\n}\n\n/**\n * Replace template tokens in a localized string.\n * @param {string} template - String containing {tokens}.\n * @param {Record<string, string>} tokens - Replacement tokens.\n * @returns {string}\n */\nfunction formatTemplate(template, tokens = {}) {\n    if (typeof template !== 'string') return '';\n    return template.replace(/\\{(\\w+)\\}/gu, (match, token) => {\n        if (Object.prototype.hasOwnProperty.call(tokens, token)) {\n            return String(tokens[token]);\n        }\n        return match;\n    });\n}\n\n/**\n * Normalize a snapshot filename into a human-readable label.\n * @param {string} filename - Raw filename from the vault.\n * @returns {string}\n */\nfunction formatSnapshotLabel(filename) {\n    return String(filename || '')\n        .replace(/\\.json$/i, '')\n        .replace(/^snapshot_/, '');\n}\n\n/**\n * Build a safe filename for the pre-restore safety snapshot.\n * @param {string} projectId - Project identifier.\n * @returns {string}\n */\nfunction buildSafetySnapshotName(projectId) {\n    const timestamp = new Date().toISOString().replace(/[^\\d]/gu, '-');\n    const base = projectId ? `${projectId}-restore-safety` : 'restore-safety';\n    return `${base}-${timestamp}`;\n}\n\n/**\n * Render a loading spinner with accessible labels.\n * @returns {HTMLDivElement}\n */\nfunction createLoadingSpinner() {\n    const spinner = document.createElement('div');\n    spinner.className = 'v2-spinner';\n    spinner.setAttribute('role', 'status');\n    spinner.setAttribute('aria-live', 'polite');\n    spinner.setAttribute('aria-label', _t('backupVaultLoading'));\n    return spinner;\n}\n\n/**\n * Create a styled empty-state block.\n * @param {string} title - Primary message.\n * @param {string} [subtitle] - Secondary message.\n * @returns {HTMLDivElement}\n */\nfunction createEmptyState(title, subtitle) {\n    const wrapper = document.createElement('div');\n    wrapper.className = 'v2-empty-state';\n    const titleEl = document.createElement('p');\n    titleEl.textContent = title;\n    wrapper.appendChild(titleEl);\n    if (subtitle) {\n        const subtitleEl = document.createElement('p');\n        subtitleEl.className = 'subtext';\n        subtitleEl.textContent = subtitle;\n        wrapper.appendChild(subtitleEl);\n    }\n    return wrapper;\n}\n\n/**\n * Create a styled error-state block.\n * @param {string} message - Error message to display.\n * @returns {HTMLDivElement}\n */\nfunction createErrorState(message) {\n    const wrapper = document.createElement('div');\n    wrapper.className = 'v2-error-state';\n    wrapper.textContent = message;\n    return wrapper;\n}\n\n/**\n * Build a standard action button.\n * @param {string} label - Button label text.\n * @param {string} className - CSS classes to apply.\n * @param {() => void} onClick - Click handler.\n * @param {string} [ariaLabel] - Optional aria-label.\n * @returns {HTMLButtonElement}\n */\nfunction createActionButton(label, className, onClick, ariaLabel) {\n    const button = document.createElement('button');\n    button.type = 'button';\n    button.className = className;\n    button.textContent = label;\n    if (ariaLabel) {\n        button.setAttribute('aria-label', ariaLabel);\n        button.setAttribute('title', ariaLabel);\n    }\n    button.addEventListener('click', onClick);\n    return button;\n}\n\n/**\n * Create a safety snapshot before overwriting an existing project.\n * @param {string} projectId - Project identifier.\n * @returns {Promise<boolean>}\n */\nasync function createSafetySnapshot(projectId) {\n    if (!projectId) {\n        return true;\n    }\n    try {\n        const existing = await storageRepo.loadProject(projectId);\n        if (!existing || !existing.data) {\n            return true;\n        }\n        const wrapped = existing.meta\n            ? { _meta: existing.meta, data: existing.data }\n            : existing.data;\n        const snapshotName = buildSafetySnapshotName(projectId);\n        await dataVault.saveSnapshot(snapshotName, wrapped);\n        return true;\n    } catch (error) {\n        console.warn('Failed to capture safety snapshot before restore', error);\n        return false;\n    }\n}\n\nexport const cineBackupsView = {\n    /**\n     * Register and expose the backups view.\n     * @returns {void}\n     */\n    init() {\n        // Register with View Manager\n        // Assuming global.cineViewManager exists based on bootstrap.js\n        if (window.cineViewManager) {\n            window.cineViewManager.registerView(VIEW_ID, {\n                onEnter: () => this.render(),\n                onLeave: () => { }\n            });\n        }\n\n        // Expose to sidebar\n        const navItem = document.getElementById('navAutoBackups');\n        if (navItem) {\n            navItem.style.display = 'flex'; // Reveal the menu item\n        }\n    },\n\n    /**\n     * Render the backups view and load vault entries.\n     * @returns {Promise<void>}\n     */\n    async render() {\n        const container = document.querySelector('.v2-main')\n            || document.querySelector('.v2-app')\n            || document.body;\n        let viewSection = document.getElementById(`view-${VIEW_ID}`);\n        if (!viewSection) {\n            viewSection = document.createElement('section');\n            viewSection.id = `view-${VIEW_ID}`;\n            viewSection.className = 'app-view';\n            viewSection.innerHTML = `\n                <header class=\"view-header\">\n                    <button class=\"v2-mobile-menu-toggle\" aria-label=\"${_t('menuToggleLabel')}\">\n                        <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                            <line x1=\"3\" y1=\"12\" x2=\"21\" y2=\"12\"></line>\n                            <line x1=\"3\" y1=\"6\" x2=\"21\" y2=\"6\"></line>\n                            <line x1=\"3\" y1=\"18\" x2=\"21\" y2=\"18\"></line>\n                        </svg>\n                    </button>\n                    <h1>${_t('backupVaultHeading')}</h1>\n                </header>\n                <div class=\"view-content\">\n                    <div class=\"v2-backup-list\" id=\"backupList\">\n                        <div class=\"v2-empty-state\">${_t('backupVaultLoading')}</div>\n                    </div>\n                </div>\n            `;\n            container.appendChild(viewSection);\n        }\n\n        const listContainer = viewSection.querySelector('#backupList');\n        listContainer.replaceChildren(createLoadingSpinner());\n\n        try {\n            const snapshots = await dataVault.listSnapshots();\n\n            if (snapshots.length === 0) {\n                listContainer.replaceChildren(\n                    createEmptyState(\n                        _t('backupVaultEmptyTitle'),\n                        _t('backupVaultEmptySubtitle'),\n                    ),\n                );\n                return;\n            }\n\n            const list = document.createElement('ul');\n            list.className = 'v2-list';\n            for (const filename of snapshots) {\n                const displayName = formatSnapshotLabel(filename);\n                const listItem = document.createElement('li');\n                listItem.className = 'v2-list-item';\n                const content = document.createElement('div');\n                content.className = 'v2-list-content';\n                const title = document.createElement('div');\n                title.className = 'v2-list-title';\n                title.textContent = displayName;\n                content.appendChild(title);\n\n                const actions = document.createElement('div');\n                actions.className = 'v2-list-actions';\n                const restoreLabel = _t('buttonRestore');\n                const restoreAria = formatTemplate(_t('backupVaultRestoreAriaLabel'), {\n                    name: displayName,\n                });\n                const deleteLabel = _t('buttonDelete');\n                const deleteAria = formatTemplate(_t('backupVaultDeleteAriaLabel'), {\n                    name: displayName,\n                });\n                actions.appendChild(\n                    createActionButton(\n                        restoreLabel,\n                        'v2-btn v2-btn-sm',\n                        () => this.restore(filename, displayName),\n                        restoreAria,\n                    ),\n                );\n                actions.appendChild(\n                    createActionButton(\n                        deleteLabel,\n                        'v2-btn v2-btn-sm v2-btn-danger',\n                        () => this.delete(filename, displayName),\n                        deleteAria,\n                    ),\n                );\n\n                listItem.appendChild(content);\n                listItem.appendChild(actions);\n                list.appendChild(listItem);\n            }\n            listContainer.replaceChildren(list);\n\n        } catch (e) {\n            const message = formatTemplate(_t('backupVaultLoadError'), {\n                message: e && e.message ? e.message : _t('backupVaultLoadErrorFallback'),\n            });\n            listContainer.replaceChildren(createErrorState(message));\n        }\n    },\n\n    /**\n     * Restore a selected snapshot into storage.\n     * @param {string} filename - Snapshot filename to restore.\n     * @param {string} [label] - Human-friendly label.\n     * @returns {Promise<void>}\n     */\n    async restore(filename, label = '') {\n        const confirmationMessage = formatTemplate(_t('backupVaultRestoreConfirm'), {\n            name: label || filename,\n        });\n        if (!confirm(confirmationMessage)) return;\n\n        try {\n            const snapshot = await dataVault.restoreSnapshot(filename);\n            const { data: projectData, meta } = unwrapMetadata(snapshot);\n            const fallbackId = filename.replace(/\\.json$/i, '');\n            const projectId = (meta && meta.docId) || (projectData && projectData.id) || fallbackId;\n\n            if (!projectData) {\n                alert(_t('backupVaultUnknownFormat'));\n                return;\n            }\n\n            const safetySnapshotOk = await createSafetySnapshot(projectId);\n            if (!safetySnapshotOk) {\n                alert(_t('restoreBackupFailed'));\n                return;\n            }\n\n            const sanitizedMeta = meta ? { ...meta, lock: null } : null;\n            const result = await storageRepo.saveProject(projectId, projectData, sanitizedMeta);\n            if (!result || result.success === false) {\n                const reason = result && result.error === 'PROJECT_LOCKED'\n                    ? _t('backupVaultRestoreLocked')\n                    : _t('backupVaultRestoreUnknownError');\n                alert(formatTemplate(_t('backupVaultRestoreFailed'), { reason }));\n                return;\n            }\n\n            alert(_t('backupVaultRestoreSuccess'));\n            // Reload or navigate\n        } catch (e) {\n            const message = formatTemplate(_t('backupVaultRestoreError'), {\n                message: e && e.message ? e.message : _t('backupVaultRestoreUnknownError'),\n            });\n            alert(message);\n        }\n    },\n\n    /**\n     * Delete a snapshot from the vault.\n     * @param {string} filename - Snapshot filename to remove.\n     * @param {string} [label] - Human-friendly label.\n     * @returns {Promise<void>}\n     */\n    async delete(filename, label = '') {\n        const confirmationMessage = formatTemplate(_t('backupVaultDeleteConfirm'), {\n            name: label || filename,\n        });\n        if (!confirm(confirmationMessage)) return;\n        try {\n            await dataVault.deleteSnapshot(filename);\n            await this.render(); // Refresh list\n        } catch (error) {\n            const message = formatTemplate(_t('backupVaultDeleteError'), {\n                message: error && error.message ? error.message : _t('backupVaultDeleteErrorFallback'),\n            });\n            alert(message);\n        }\n    }\n};\n\n// Expose global for inline onclick handlers\nwindow.cineBackupsView = cineBackupsView;\n"],"file":"v2-ui-BJrcNSEM.js"}